<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MERCADO ELÉCTRICO ESPAÑOL - Precios y Comparativas</title>
  
  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* ===== RESET AND BASE STYLES ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ===== TYPOGRAPHY ===== */
    h1, h2, h3 {
      text-transform: uppercase;
      font-weight: 700;
    }

    h1 {
      text-align: center;
      margin: 30px 0;
      font-size: clamp(1.8rem, 4vw, 2.5rem);
      color: #2c3e50;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
      margin: 20px 0;
      font-size: clamp(1.5rem, 3.5vw, 2rem);
      color: #2980b9;
    }

    h3 {
      margin: 0 0 20px 0;
      font-size: 1.4rem;
      color: #34495e;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
    }

    /* ===== LAYOUT ===== */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .full-width {
      grid-column: 1 / -1;
    }

    /* ===== CARDS ===== */
    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      padding: 25px;
      text-align: center;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      scroll-margin-top: 80px;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    }

    /* ===== ALERT STYLES ===== */
    #alerta {
      font-size: 1.2rem;
      font-weight: 600;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    #weather {
      font-size: 1.1rem;
      margin: 15px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #3498db;
    }

    /* ===== CHART AND MAP STYLES ===== */
    .chart-container {
      position: relative;
      height: 400px;
      width: 100%;
      margin: 20px 0;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }

    #map {
      height: 450px;
      width: 100%;
      border: 2px solid #ddd;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }

    /* ===== CHART CONTROLS ===== */
    .chart-controls {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      margin: 20px 0;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .chart-controls label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: 600;
      padding: 8px 16px;
      margin: 0;
      border-radius: 20px;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      background: #ffffff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      white-space: nowrap;
      font-size: 0.9rem;
      color: #666;
      min-width: auto;
    }
    
    .chart-controls label:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      border-color: #3498db;
    }
    
    .chart-controls label.active {
      background: linear-gradient(45deg, #3498db, #5dade2);
      color: white;
      border-color: #3498db;
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
    }
    
    .chart-controls input[type="checkbox"] {
      margin-right: 8px;
      transform: scale(1.1);
      accent-color: currentColor;
    }

    /* ===== FORM CONTROLS ===== */
    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .input-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    input[type="text"], input[type="number"] {
      padding: 12px 16px;
      font-size: 1rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      width: 220px;
      max-width: 100%;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      background: rgba(255, 255, 255, 0.9);
    }

    input[type="text"]:focus, input[type="number"]:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    button {
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 600;
      color: white;
      background: linear-gradient(45deg, #3498db, #2980b9);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
      background: linear-gradient(45deg, #2980b9, #3498db);
    }

    button:active {
      transform: translateY(0);
    }

    /* ===== RESULTS ===== */
    #resultado-ahorro {
      margin-top: 20px;
      padding: 20px;
      background: linear-gradient(45deg, #e8f5e8, #f0f8ff);
      border-radius: 12px;
      border-left: 5px solid #27ae60;
      font-size: 1.1rem;
      line-height: 1.8;
    }

    /* ===== FOOTER ===== */
    .footer {
      text-align: center;
      margin-top: 40px;
      padding: 30px 20px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      font-size: 0.9rem;
      color: #7f8c8d;
      box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
    }

    .footer a {
      color: #3498db;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s ease;
    }

    .footer a:hover {
      color: #2980b9;
    }

    /* ===== DISCLAIMER ===== */
    .disclaimer {
      background: linear-gradient(135deg, #fff9e6, #ffeaa7);
      border: 2px solid #fdcb6e;
      border-radius: 10px;
      margin: 30px auto;
      padding: 20px;
      max-width: 1200px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(253, 203, 110, 0.3);
    }

    .disclaimer h3 {
      color: #d63031;
      margin-bottom: 15px;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .disclaimer p {
      color: #2d3436;
      line-height: 1.6;
      font-size: 1rem;
      margin-bottom: 10px;
    }

    .disclaimer .highlight {
      font-weight: bold;
      color: #d63031;
    }

    /* ===== LOADING ANIMATION ===== */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ===== INFO BANNER STYLES ===== */
    .info-banner {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      color: white;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    .info-banner::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><radialGradient id="a" cx="50" cy="50" r="50"><stop offset="0" stop-color="rgba(255,255,255,.1)"/><stop offset="1" stop-color="rgba(255,255,255,0)"/></radialGradient></defs><rect width="100" height="20" fill="url(%23a)"/></svg>');
      pointer-events: none;
    }

    .banner-content {
      position: relative;
      z-index: 1;
    }

    .banner-content h2 {
      margin-bottom: 20px;
      font-size: 1.8rem;
      text-align: center;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      color: #ffffff;
      font-weight: 800;
    }

    .banner-content p {
      text-align: center;
      font-size: 1.15rem;
      margin-bottom: 25px;
      line-height: 1.7;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      color: #ecf0f1;
      font-weight: 500;
    }

    .banner-content strong {
      color: #f39c12;
      font-weight: 700;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    /* ===== HEADER WITH CLOCK STYLES ===== */
    .header-with-clock {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }

    .info-panel {
      width: 100%;
      max-width: 600px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.25);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .time-location-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      align-items: stretch;
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 2px solid transparent;
      min-height: 80px;
    }

    .clock-info {
      border-color: rgba(52, 152, 219, 0.3);
    }

    .location-info {
      border-color: rgba(243, 156, 18, 0.3);
    }

    .info-icon {
      font-size: 1.8rem;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: linear-gradient(45deg, #f8f9fa, #e9ecef);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .clock-info .info-icon {
      background: linear-gradient(45deg, #3498db, #2980b9);
      color: white;
    }

    .location-info .info-icon {
      background: linear-gradient(45deg, #f39c12, #e67e22);
      color: white;
    }

    .info-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
    }

    .info-label {
      font-size: 1rem;
      color: #6c757d;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .info-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: #2c3e50;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .header-with-clock {
        gap: 15px;
      }
      
      .info-panel {
        max-width: 100%;
        padding: 16px;
      }
      
      .time-location-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .info-item {
        padding: 12px;
        gap: 10px;
        min-height: 70px;
      }
      
      .info-icon {
        width: 40px;
        height: 40px;
        font-size: 1.5rem;
      }
      
      .info-value {
        font-size: 1.2rem;
      }
    }

    @media (max-width: 480px) {
      .info-panel {
        padding: 12px;
      }
      
      .info-item {
        padding: 10px;
        gap: 8px;
        min-height: 60px;
      }
      
      .info-icon {
        width: 35px;
        height: 35px;
        font-size: 1.3rem;
      }
    }

    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
      margin-top: 25px;
    }

    .feature-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255, 255, 255, 0.15);
      padding: 15px 20px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: white;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: left;
      min-height: 60px;
    }

    .feature-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.4);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .feature-btn:active {
      transform: translateY(-1px);
      transition: transform 0.1s;
    }

    .feature-icon {
      font-size: 1.8rem;
      flex-shrink: 0;
      filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.3));
    }

    .feature-btn span:last-child {
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      line-height: 1.3;
    }

    /* ===== SCROLL ANIMATION ===== */
    .scroll-highlight {
      animation: highlightPulse 2s ease-in-out;
    }

    @keyframes highlightPulse {
      0% { 
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }
      50% { 
        box-shadow: 0 0 30px rgba(52, 152, 219, 0.6), 0 0 60px rgba(52, 152, 219, 0.3);
        transform: scale(1.02);
      }
      100% { 
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transform: scale(1);
      }
    }

    /* ===== INFO BOXES ===== */
    .info-box {
      background: linear-gradient(45deg, #e8f4fd, #f0f8ff);
      border: 2px solid #3498db;
      border-radius: 12px;
      padding: 15px;
      margin: 15px 0;
      text-align: left;
      font-size: 0.95rem;
    }

    .info-box strong {
      color: #2c3e50;
    }

    .info-box ol, .info-box ul {
      margin: 10px 0;
      padding-left: 20px;
    }

    .info-box li {
      margin: 5px 0;
      line-height: 1.4;
    }

    .tips-box {
      background: linear-gradient(45deg, #fff3e0, #ffeaa7);
      border: 2px solid #f39c12;
      border-radius: 12px;
      padding: 15px;
      margin-top: 20px;
      text-align: left;
    }

    .tips-box h4 {
      color: #e67e22;
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .tips-box ul {
      margin: 0;
      padding-left: 20px;
    }

    .tips-box li {
      margin: 5px 0;
      color: #d35400;
      font-weight: 500;
    }

    /* ===== SMOOTH SCROLL ===== */
    html {
      scroll-behavior: smooth;
    }


    /* ===== RESPONSIVE DESIGN ===== */
    @media (max-width: 900px) {
      .container {
        padding: 10px;
      }
      .grid {
        grid-template-columns: 1fr;
        gap: 18px;
      }
      .card {
        padding: 16px;
      }
      .chart-container {
        height: 250px;
      }
      .controls {
        flex-direction: column;
        gap: 12px;
      }
      input[type="text"], input[type="number"] {
        width: 100%;
        max-width: 260px;
      }
      #map {
        height: 250px;
      }
      /* Calculadora de electrodomésticos */
      #calculadora-ahorro > div[style*="display: grid"] {
        grid-template-columns: 1fr;
        gap: 15px !important;
      }
      #calculadora-ahorro .card, #calculadora-ahorro {
        padding: 10px !important;
      }
      #calculadora-ahorro .info-box {
        text-align: center;
      }
      #calculadora-ahorro > div[style*="display: grid"] > div {
        min-width: 0 !important;
        width: 100% !important;
        margin: 0 auto !important;
      }
      #calculadora-ahorro select, #calculadora-ahorro input[type="number"], #calculadora-ahorro input[type="text"] {
        font-size: 1rem;
        width: 100% !important;
        min-width: 0 !important;
        max-width: 100% !important;
      }
      #calculadora-ahorro button {
        width: 100%;
        font-size: 1rem;
      }
      /* Centrado de cuadros informativos */
      .info-box, .tips-box {
        margin-left: auto;
        margin-right: auto;
        text-align: center;
      }
      .info-banner, .disclaimer, .footer {
        margin-left: auto;
        margin-right: auto;
      }
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 1.3rem;
        margin: 14px 0;
      }
      .card {
        padding: 8px;
      }
      .chart-container {
        height: 160px;
      }
      #calculadora-ahorro .info-box {
        font-size: 0.92rem;
        padding: 8px;
      }
      .info-box, .tips-box {
        font-size: 0.92rem;
        padding: 8px;
      }
      .features-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
    }

    /* Animaciones personalizadas */
    @keyframes slideUp {
      from { 
        transform: translateX(-50%) translateY(100%); 
        opacity: 0; 
      }
      to { 
        transform: translateX(-50%) translateY(0); 
        opacity: 1; 
      }
    }
    
    @keyframes slideDown {
      from { 
        transform: translateX(-50%) translateY(0); 
        opacity: 1; 
      }
      to { 
        transform: translateX(-50%) translateY(100%); 
        opacity: 0; 
      }
    }
    
    @keyframes slideInRight {
      from { 
        transform: translateX(100%); 
        opacity: 0; 
      }
      to { 
        transform: translateX(0); 
        opacity: 1; 
      }
    }
    
    @keyframes slideOutRight {
      from { 
        transform: translateX(0); 
        opacity: 1; 
      }
      to { 
        transform: translateX(100%); 
        opacity: 0; 
      }
    }
    
    @keyframes fadeInScale {
      from { 
        transform: translate(-50%, -50%) scale(0.7); 
        opacity: 0; 
      }
      to { 
        transform: translate(-50%, -50%) scale(1); 
        opacity: 1; 
      }
    }
    
    @keyframes fadeOutScale {
      from { 
        transform: translate(-50%, -50%) scale(1); 
        opacity: 1; 
      }
      to { 
        transform: translate(-50%, -50%) scale(0.7); 
        opacity: 0; 
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header principal mejorado -->
    <div style="
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 25px 20px;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      text-align: center;
      position: relative;
      overflow: hidden;
    ">
      <!-- Efecto de brillo sutil -->
      <div style="
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        pointer-events: none;
      "></div>
      
      <!-- Título principal -->
      <h1 style="
        color: white;
        margin: 0 0 15px 0;
        font-size: clamp(1.8rem, 4vw, 2.8rem);
        font-weight: 700;
        text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
        position: relative;
        z-index: 1;
      ">
        🇪🇸 ⚡ MERCADO ELÉCTRICO ESPAÑOL ⚡ 🇪🇸
      </h1>
      
      <!-- Subtítulo -->
      <p style="
        color: rgba(255,255,255,0.9);
        margin: 0 0 20px 0;
        font-size: 1.1rem;
        font-weight: 500;
        position: relative;
        z-index: 1;
      ">
        Precios y Comparativas en Tiempo Real
      </p>
      
      <!-- Indicador de estado mejorado -->
      <div id="api-status" style="
        display: inline-block;
        background: linear-gradient(45deg, #27ae60, #2ecc71);
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 0.95rem;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        border: 2px solid rgba(255,255,255,0.2);
        position: relative;
        z-index: 1;
        transition: all 0.3s ease;
      ">
        ✅ Datos oficiales obtenidos (8/8/2025)
      </div>
    </div>
    
    <!-- Banner informativo -->
    <div class="info-banner">
      <div class="banner-content">
        <div class="header-with-clock">
          <h2>📊 Dashboard del Mercado Eléctrico</h2>
        </div>
        <p>Analiza <strong>precios oficiales PVPC</strong> y compara todas las <strong>comercializadoras españolas</strong> para encontrar la mejor tarifa y optimizar tu factura eléctrica.</p>
        
        <!-- Explicación del sistema eléctrico español -->
        <div style="background: linear-gradient(135deg, #2c3e50, #34495e); padding: 25px; border-radius: 15px; margin: 20px 0; color: white; box-shadow: 0 8px 25px rgba(44, 62, 80, 0.4);">
          <h3 style="margin: 0 0 20px 0; text-align: center; font-size: 1.6rem; font-weight: 700; color: #ffffff;">⚡ ¿Cómo funciona el mercado eléctrico español?</h3>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <div style="background: rgba(255,255,255,0.12); padding: 22px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
              <h4 style="margin: 0 0 12px 0; color: #ffffff; font-size: 1.1rem; font-weight: 600;">📈 PVPC - Precio de Referencia</h4>
              <p style="margin: 0; font-size: 1rem; line-height: 1.6; color: #f8f9fa;">
                Es el <strong style="color: #ffd700;">precio oficial regulado</strong> que marca el gobierno, cambia cada hora según el mercado eléctrico.
                <br><br>
                <span style="color: #ff6b6b; font-weight: 700; background: rgba(255,107,107,0.2); padding: 2px 6px; border-radius: 4px;">⚠️ IMPORTANTE:</span> <strong style="color: #ffffff;">NO es una tarifa que puedas contratar.</strong> Es la referencia oficial del estado para medir si las comercializadoras son caras o baratas.
              </p>
            </div>
            
            <div style="background: rgba(255,255,255,0.12); padding: 22px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
              <h4 style="margin: 0 0 12px 0; color: #ffffff; font-size: 1.1rem; font-weight: 600;">🏢 Comercializadoras de Referencia (COR)</h4>
              <p style="margin: 0; font-size: 1rem; line-height: 1.6; color: #f8f9fa;">
                Son las <strong style="color: #74b9ff;">únicas que pueden aplicar PVPC</strong>:
                <br>• Iberdrola (Curenergía)
                <br>• Endesa (Energía XXI)
                <br>• Naturgy (Com. Regulada)
                <br>• EDP, Viesgo
                <br><br>
                <strong style="color: #55efc4;">Precio final = PVPC + margen regulado pequeño</strong>
              </p>
            </div>
            
            <div style="background: rgba(255,255,255,0.15); padding: 18px; border-radius: 10px;">
              <h4 style="margin: 0 0 10px 0; color: #ecf0f1;">� Comercializadoras Libres</h4>
              <p style="margin: 0; font-size: 1rem; line-height: 1.6; color: #f8f9fa;">
                Tienen <strong>precios propios independientes</strong> del PVPC:
                <br>• Precios fijos
                <br>• Indexados al mercado
                <br>• Promociones especiales
                <br><br>
                <strong>Pueden ser mejores o peores que PVPC</strong> según tu consumo y horarios.
              </p>
            </div>
          </div>
          
          <div style="background: rgba(255,255,255,0.15); padding: 22px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.25);">
            <h4 style="margin: 0 0 15px 0; color: #ffffff; font-size: 1.2rem; font-weight: 600;">🎯 Metodología de Comparación</h4>
            <p style="margin: 0; font-size: 1.1rem; font-weight: 600; line-height: 1.5; color: #f8f9fa;">
              Comparamos las tarifas reales de las comercializadoras <strong style="color: #ffd700;">CONTRA el precio PVPC oficial de referencia</strong>.
              <br>
              Te mostramos cuánto ahorras (o pagas de más) respecto al precio oficial que marca el gobierno.
            </p>
          </div>
        </div>
        
        <div class="features-grid">
          <button class="feature-btn" onclick="scrollToSection('grafico-precios')">
            <span class="feature-icon">⚡</span>
            <span>Precios PVPC hora a hora</span>
          </button>
          <button class="feature-btn" onclick="scrollToSection('comparativa-companias')">
            <span class="feature-icon">📊</span>
            <span>¿Qué comercializadora elegir HOY?</span>
          </button>
          <button class="feature-btn" onclick="scrollToSection('companias-electricas')">
            <span class="feature-icon">🏢</span>
            <span>Todas las comercializadoras</span>
          </button>
          <button class="feature-btn" onclick="scrollToSection('calculadora-ahorro')">
            <span class="feature-icon">💰</span>
            <span>Calcula tu ahorro personalizado</span>
          </button>
          <a href="meteorologia.html" class="feature-btn" style="
            display: flex;
            align-items: center;
            text-decoration: none;
            color: inherit;
          ">
            <span class="feature-icon">🌤️💰</span>
            <span>METEOROLOGÍA Y AHORRO</span>
          </a>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Price Alert Card -->
      <div class="card">
        <h3>💰 Estado del Precio</h3>
        <div id="alerta">
          <span class="loading"></span>Cargando precios...
        </div>
      </div>
    </div>

    <!-- Price Chart Card -->
    <div class="card full-width" id="grafico-precios">
      <h3>📊 Precios PVPC España - Precio Oficial por Horas</h3>
      <div style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #3498db;">
        <p style="margin: 0 0 8px 0; font-size: 0.9rem; color: #2c3e50;"><strong>💡 Precio oficial del gobierno</strong> - PVPC es el precio regulado que marca el estado español cada hora como referencia del mercado.</p>
        <p style="margin: 0; font-size: 0.9rem; color: #2c3e50;"><strong>📊 Uso como referencia:</strong> Usamos estos precios oficiales como base para comparar y mostrar si las comercializadoras te ofrecen mejor o peor precio que la referencia gubernamental.</p>
      </div>
      <div style="text-align: center; margin-bottom: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
        <button onclick="refreshPriceData()" style="
          background: linear-gradient(45deg, #27ae60, #2ecc71);
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 8px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 700;
          transition: all 0.3s ease;
          box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(39, 174, 96, 0.5)'" 
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(39, 174, 96, 0.4)'">
          🎯 OBTENER PRECIOS REALES
        </button>
        <button onclick="generateNewRealisticData()" style="
          background: linear-gradient(45deg, #8e44ad, #9b59b6);
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 8px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 700;
          transition: all 0.3s ease;
          box-shadow: 0 4px 15px rgba(142, 68, 173, 0.4);
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(142, 68, 173, 0.5)'" 
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(142, 68, 173, 0.4)'">
          📈 VER SIMULACIÓN
        </button>
        <button onclick="showHistoricalAverage()" style="
          background: linear-gradient(45deg, #f39c12, #e67e22);
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 8px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 700;
          transition: all 0.3s ease;
          box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(243, 156, 18, 0.5)'" 
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(243, 156, 18, 0.4)'">
          📊 PROMEDIO HISTÓRICO
        </button>
      </div>
      <div style="text-align: center; margin-bottom: 15px;">
        <div style="font-size: 0.95rem; color: #2c3e50; max-width: 750px; margin: 0 auto; line-height: 1.5; background: linear-gradient(45deg, #f8f9fa, #e9ecef); padding: 15px 25px; border-radius: 12px; border: 2px solid #dee2e6; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <strong style="color: #27ae60; font-size: 1.05rem;">🎯 PRECIOS REALES (TARIFA PVPC):</strong> Datos oficiales hora por hora de Red Eléctrica de España para la tarifa regulada PVPC<br>
          <strong style="color: #8e44ad; font-size: 1.05rem;">📈 SIMULACIÓN:</strong> Predicción realista basada en patrones actuales del mercado<br>
          <strong style="color: #f39c12; font-size: 1.05rem;">📊 PROMEDIO HISTÓRICO:</strong> Media de precios de días similares (mismo tipo de día y estación)<br>
        </div>
      </div>
      <div id="current-hour-indicator" style="text-align: center; margin-bottom: 10px;">
        <div style="display: inline-block; background: linear-gradient(45deg, #2196F3, #1976D2); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; box-shadow: 0 3px 10px rgba(33, 150, 243, 0.4); border: 2px solid #1565C0;">
          ⚡ HORA ACTUAL: <span id="current-hour-text">--:--</span> | La columna azul muestra el precio ahora
        </div>
      </div>
      <div class="chart-container">
        <canvas id="grafico"></canvas>
      </div>
    </div>

    <!-- Company Comparison Chart -->
    <div class="card full-width" id="comparativa-companias">
      <h3>� ¿Cuánto más o menos pagas HOY con tu tarifa?</h3>
      <div class="info-box">
        <p><strong>🎯 Comparación contra precio oficial:</strong> Introduce tu patrón de consumo y ve cuánto pagarías con cada comercializadora comparado contra el precio PVPC oficial del gobierno (usado como referencia de mercado).</p>
        <p><strong>🏢 COR vs Libres:</strong> Las Comercializadoras de Referencia aplican PVPC + margen pequeño. Las libres tienen precios propios que pueden ser mejores o peores según tu consumo.</p>
        <p><strong>💰 Resultado práctico:</strong> Conoce los márgenes de ahorro o sobrecosto de cada comercializadora respecto al precio oficial PVPC para tomar decisiones informadas.</p>
      </div>
      
      <!-- Control de consumo diario -->
      <div style="background: linear-gradient(135deg, #e67e22, #d35400); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
        <h4 style="margin: 0 0 15px 0;">⚡ Configura tu consumo de HOY</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Consumo total del día:</label>
            <input type="number" id="daily-consumption" value="10" min="1" max="100" step="0.5" style="
              width: 100%;
              padding: 10px;
              border: none;
              border-radius: 8px;
              font-size: 1rem;
              background: white;
              color: #2c3e50;
            " onchange="updateUserComparison()">
            <small style="opacity: 0.9;">kWh por día</small>
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">¿Cuándo consumes más?</label>
            <select id="consumption-pattern" style="
              width: 100%;
              padding: 10px;
              border: none;
              border-radius: 8px;
              font-size: 1rem;
              background: white;
              color: #2c3e50;
            " onchange="updateUserComparison()">
              <option value="flat">🏠 Plano (uniforme)</option>
              <option value="residential" selected>⏰ Residencial (mañana/tarde/noche)</option>
              <option value="business">� Comercial (horario laboral)</option>
              <option value="work-day">💼 Día laboral (mañana y noche)</option>
            </select>
          </div>
        </div>
        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; font-size: 0.9rem;">
          💡 <strong>Consejo:</strong> Un hogar medio consume entre 8-15 kWh/día. Ajusta estos valores según tu factura eléctrica.
        </div>
      </div>
      
      <!-- Selector de tu tarifa actual -->
      <div style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
        <h4 style="margin: 0 0 15px 0;">🏠 ¿Cuál es tu tarifa actual?</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Tu compañía:</label>
            <select id="user-company-selector" style="
              width: 100%;
              padding: 10px;
              border: none;
              border-radius: 8px;
              font-size: 1rem;
              background: white;
              color: #2c3e50;
            " onchange="updateUserTariffSelector()">
              <option value="">-- Selecciona tu compañía --</option>
              <option value="iberdrola-cor">🏛️ Iberdrola COR (Tarifa regulada)</option>
              <option value="endesa-cor">🏛️ Endesa Energía XXI (Tarifa regulada)</option>
              <option value="naturgy-cor">🏛️ Naturgy Iberia (Tarifa regulada)</option>
              <option value="edp-cor">🏛️ EDP Comercial. Últ. Recurso</option>
              <option value="repsol-cor">🏛️ Repsol Comercial. Últ. Recurso</option>
              <option value="iberdrola">🟦 Iberdrola (Mercado libre)</option>
              <option value="endesa">🔵 Endesa (Mercado libre)</option>
              <option value="naturgy">🟢 Naturgy (Mercado libre)</option>
              <option value="repsol">🟡 Repsol (Mercado libre)</option>
              <option value="totalenergies">🟣 TotalEnergies</option>
              <option value="holaluz">☀️ Holaluz</option>
              <option value="asenergy">⚡ Asenergy</option>
              <option value="edp">🔷 EDP (Mercado libre)</option>
              <option value="factorenergia">📊 Factor Energía</option>
              <option value="lucera">💡 Lucera</option>
              <option value="somenergia">🌱 Som Energia</option>
            </select>
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Tu tarifa:</label>
            <select id="user-tariff-selector" style="
              width: 100%;
              padding: 10px;
              border: none;
              border-radius: 8px;
              font-size: 1rem;
              background: white;
              color: #2c3e50;
              display: none;
            " onchange="updateUserComparison()">
              <option value="">-- Selecciona tu tarifa --</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Resultado de la comparación -->
      <div id="user-comparison-result">
        <div style="text-align: center; padding: 40px; color: #7f8c8d;">
          <span style="font-size: 3rem;">⬆️</span>
          <p>Selecciona tu tarifa actual para ver la comparación</p>
        </div>
      </div>
    </div>

    <!-- Spanish Energy Companies Card -->
    <div class="card full-width" id="companias-electricas">
      <h3>⚡ Comercializadoras en España - Toda la información</h3>
      <div class="info-box">
        <p><strong>🏢 Tipos de comercializadoras:</strong> Aprende las diferencias entre Comercializadoras de Referencia (COR) que aplican PVPC y las del mercado libre con precios propios.</p>
        <p><strong>📊 Información completa:</strong> Consulta características, precios orientativos y contacto de todas las comercializadoras disponibles en España.</p>
        <p><strong>💡 Toma la mejor decisión:</strong> Datos actualizados para ayudarte a elegir la comercializadora que mejor se adapte a tu consumo.</p>
      </div>
      
      <!-- Explicación tipos de comercializadoras -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div style="background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 18px; border-radius: 12px;">
          <h4 style="margin: 0 0 10px 0;">🏛️ Comercializadoras de Referencia (COR)</h4>
          <p style="margin: 0 0 8px 0; font-size: 0.9rem; line-height: 1.4;"><strong>Las únicas que pueden aplicar PVPC:</strong></p>
          <ul style="margin: 0; padding-left: 0; list-style: none; font-size: 0.9rem;">
            <li style="margin-bottom: 4px;">🏢 Iberdrola (Curenergía)</li>
            <li style="margin-bottom: 4px;">🏢 Endesa (Energía XXI)</li>
            <li style="margin-bottom: 4px;">🏢 Naturgy (Comercializadora Regulada)</li>
            <li style="margin-bottom: 4px;">🏢 EDP, Viesgo</li>
          </ul>
          <p style="margin: 8px 0 0 0; font-size: 0.85rem; opacity: 0.9;"><strong>Precio:</strong> PVPC + margen regulado pequeño</p>
        </div>
        
        <div style="background: linear-gradient(135deg, #e67e22, #f39c12); color: white; padding: 18px; border-radius: 12px;">
          <h4 style="margin: 0 0 10px 0;">🆓 Comercializadoras Libres</h4>
          <p style="margin: 0 0 8px 0; font-size: 0.9rem; line-height: 1.4;"><strong>Precios propios independientes del PVPC:</strong></p>
          <ul style="margin: 0; padding-left: 0; list-style: none; font-size: 0.9rem;">
            <li style="margin-bottom: 4px;">💰 Precios fijos todo el año</li>
            <li style="margin-bottom: 4px;">📈 Indexados con descuentos</li>
            <li style="margin-bottom: 4px;">🎁 Promociones especiales</li>
            <li style="margin-bottom: 4px;">⏰ Tarifas por horas</li>
          </ul>
          <p style="margin: 8px 0 0 0; font-size: 0.85rem; opacity: 0.9;"><strong>Pueden ser mejores o peores que PVPC</strong></p>
        </div>
      </div>
      
      <!-- Selector de compañía -->
      <div class="controls" style="margin-bottom: 20px;">
        <div class="input-group">
          <select id="company-selector" style="
            padding: 12px 16px;
            border: 2px solid #3498db;
            border-radius: 8px;
            background: white;
            font-size: 1rem;
            color: #2c3e50;
            cursor: pointer;
            width: 100%;
            max-width: 400px;
          " onchange="showCompanyInfoOnly()">
            <option value="">Selecciona tu comercializadora como aparece en tu factura...</option>
            <option value="iberdrola-cor">🏛️ Iberdrola Comercialización de Último Recurso</option>
            <option value="endesa-cor">🏛️ Endesa Energía XXI</option>
            <option value="naturgy-cor">🏛️ Naturgy Iberia</option>
            <option value="edp-cor">🏛️ EDP Comercial Último Recurso</option>
            <option value="repsol-cor">🏛️ Repsol Comercial Último Recurso</option>
            <option value="curenergia-cor">🏛️ Curenergia (COR)</option>
            <option value="iberdrola">🟦 Iberdrola Clientes</option>
            <option value="endesa">🔵 Endesa Energía</option>
            <option value="naturgy">🟢 Naturgy</option>
            <option value="repsol">🟡 Repsol</option>
            <option value="totalenergies">🟣 TotalEnergies</option>
            <option value="holaluz">☀️ Holaluz</option>
            <option value="edp">⚡ EDP Energía</option>
            <option value="asenergy">🔋 Asenergy</option>
            <option value="factorenergia">📊 Factor Energía</option>
            <option value="lucera">💡 Lucera Energía</option>
            <option value="somenergia">🌱 Som Energia</option>
            <option value="octopus">🐙 Octopus Energy</option>
            <option value="nexus">🔌 Nexus Energía</option>
            <option value="gana">💰 Gana Energía</option>
            <option value="pepeenergy">🌟 Pepe Energy</option>
          </select>
        </div>
      </div>
      
      <!-- Información de la compañía seleccionada (solo informativa) -->
      <div id="company-info-display">
        <div style="text-align: center; padding: 40px; color: #7f8c8d;">
          <span style="font-size: 3rem;">🏢</span>
          <p>Selecciona una compañía para ver información detallada sobre sus tarifas</p>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Hourly Tariff Comparison Calculator -->
      <div class="card" id="calculadora-ahorro">
        <h3>💰 Calculadora de Costo Real por Electrodoméstico - ¿Cuánto Pagas HOY?</h3>
        <div class="info-box">
          <p><strong>🎯 Función:</strong> Calcula el costo exacto en euros y céntimos por usar un electrodoméstico específico en un horario concreto de HOY.</p>
          <p><strong>� Resultado:</strong> Costo real de tu consumo con recomendaciones de mejores horarios para ahorrar dinero.</p>
          <p><strong>💡 Utilidad:</strong> Descubre cuánto pagas realmente y optimiza tus horarios de consumo para reducir tu factura.</p>
        </div>
        
        <!-- Configuración del electrodoméstico y horario -->
        <div style="display: grid; grid-template-columns: 1fr 350px; gap: 20px; margin-bottom: 20px;">
          <!-- Columna izquierda: Configuración -->
          <div style="background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; padding: 25px; border-radius: 12px;">
            <h4 style="margin: 0 0 20px 0;">⚡ Configura tu Electrodoméstico y Horario</h4>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
              <!-- Electrodoméstico -->
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Electrodoméstico:</label>
                <select id="appliance-selector" style="
                  width: 100%;
                  padding: 12px;
                  border: none;
                  border-radius: 8px;
                  font-size: 1rem;
                  background: white;
                  color: #2c3e50;
                " onchange="updateApplianceConsumption()">
                  <option value="">-- Selecciona electrodoméstico --</option>
                  <option value="lavadora" data-consumption="2.0">🧺 Lavadora (2.0 kWh/ciclo)</option>
                  <option value="lavavajillas" data-consumption="1.5">🍽️ Lavavajillas (1.5 kWh/ciclo)</option>
                  <option value="secadora" data-consumption="4.0">👕 Secadora (4.0 kWh/ciclo)</option>
                  <option value="horno" data-consumption="2.5">🍞 Horno (2.5 kWh/hora)</option>
                  <option value="aire-acondicionado" data-consumption="2.0">❄️ Aire acondicionado (2.0 kWh/hora)</option>
                  <option value="calefaccion" data-consumption="3.0">🔥 Calefacción eléctrica (3.0 kWh/hora)</option>
                  <option value="coche-electrico" data-consumption="25.0">🚗 Carga coche eléctrico (25.0 kWh)</option>
                  <option value="bomba-calor" data-consumption="3.5">♨️ Bomba de calor (3.5 kWh/hora)</option>
                  <option value="personalizado" data-consumption="0">🔧 Personalizado</option>
                </select>
              </div>
              
              <!-- Consumo -->
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Consumo (kWh):</label>
                <input type="number" id="appliance-consumption" value="2.0" min="0.1" max="100" step="0.1" style="
                  width: 100%;
                  padding: 12px;
                  border: none;
                  border-radius: 8px;
                  font-size: 1rem;
                  background: white;
                  color: #2c3e50;
                " onchange="updateApplianceConsumption()">
                <small style="opacity: 0.9;">kWh del electrodoméstico</small>
              </div>
            </div>
            
            <!-- Selector de Compañía y Tarifa -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
              <!-- Compañía -->
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">🏢 Tu Compañía:</label>
                <select id="hourly-company-selector" style="
                  width: 100%;
                  padding: 12px;
                  border: none;
                  border-radius: 8px;
                  font-size: 1rem;
                  background: white;
                  color: #2c3e50;
                " onchange="updateHourlyTariff()">
                  <option value="pvpc">PVPC (Tarifa regulada)</option>
                  <option value="iberdrola-cor">🏛️ Iberdrola Comercialización de Último Recurso</option>
                  <option value="endesa-cor">🏛️ Endesa Energía XXI</option>
                  <option value="naturgy-cor">🏛️ Naturgy Iberia</option>
                  <option value="edp-cor">🏛️ EDP Comercial Último Recurso</option>
                  <option value="repsol-cor">🏛️ Repsol Comercial Último Recurso</option>
                  <option value="curenergia-cor">🏛️ Curenergia (COR)</option>
                  <option value="iberdrola">🟦 Iberdrola Clientes</option>
                  <option value="endesa">🔵 Endesa Energía</option>
                  <option value="naturgy">🟢 Naturgy</option>
                  <option value="repsol">🟡 Repsol</option>
                  <option value="totalenergies">🟣 TotalEnergies</option>
                  <option value="holaluz">☀️ Holaluz</option>
                  <option value="edp">⚡ EDP Energía</option>
                  <option value="asenergy">🔋 Asenergy</option>
                  <option value="factorenergia">📊 Factor Energía</option>
                  <option value="lucera">💡 Lucera Energía</option>
                  <option value="somenergia">🌱 Som Energia</option>
                  <option value="octopus">🐙 Octopus Energy</option>
                  <option value="nexus">🔌 Nexus Energía</option>
                  <option value="gana">💰 Gana Energía</option>
                  <option value="pepeenergy">🌟 Pepe Energy</option>
                </select>
              </div>
              
              <!-- Tarifa -->
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">📊 Tu Tarifa:</label>
                <select id="hourly-tariff-selector" style="
                  width: 100%;
                  padding: 12px;
                  border: none;
                  border-radius: 8px;
                  font-size: 1rem;
                  background: white;
                  color: #2c3e50;
                " onchange="updateHourlyTariff()">
                  <option value="2.0A">PVPC 2.0A (Sin discriminación)</option>
                  <option value="2.0DHA">PVPC 2.0DHA (Discriminación horaria)</option>
                  <option value="2.0DHS">PVPC 2.0DHS (Supervalle)</option>
                </select>
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
              <!-- Hora y minutos de inicio -->
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">⏰ Hora de inicio:</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                  <select id="start-hour" style="
                    width: 100%;
                    padding: 10px;
                    border: none;
                    border-radius: 6px;
                    font-size: 0.95rem;
                    background: white;
                    color: #2c3e50;
                  " onchange="updateTimeDisplay()">
                    <option value="0">00</option>
                    <option value="1">01</option>
                    <option value="2">02</option>
                    <option value="3">03</option>
                    <option value="4">04</option>
                    <option value="5">05</option>
                    <option value="6">06</option>
                    <option value="7">07</option>
                    <option value="8">08</option>
                    <option value="9">09</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12" selected>12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                  </select>
                  <select id="start-minute" style="
                    width: 100%;
                    padding: 10px;
                    border: none;
                    border-radius: 6px;
                    font-size: 0.95rem;
                    background: white;
                    color: #2c3e50;
                  " onchange="updateTimeDisplay()">
                    <option value="0" selected>00</option>
                    <option value="15">15</option>
                    <option value="30">30</option>
                    <option value="45">45</option>
                  </select>
                </div>
                <small style="opacity: 0.8; font-size: 0.8rem;">Hora : Minutos</small>
              </div>
              
              <!-- Duración del funcionamiento -->
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">⏱️ Duración funcionamiento:</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                  <select id="duration-hours" style="
                    width: 100%;
                    padding: 10px;
                    border: none;
                    border-radius: 6px;
                    font-size: 0.95rem;
                    background: white;
                    color: #2c3e50;
                  " onchange="updateTimeDisplay()">
                    <option value="0">0h</option>
                    <option value="1" selected>1h</option>
                    <option value="2">2h</option>
                    <option value="3">3h</option>
                    <option value="4">4h</option>
                    <option value="5">5h</option>
                    <option value="6">6h</option>
                    <option value="7">7h</option>
                    <option value="8">8h</option>
                    <option value="9">9h</option>
                    <option value="10">10h</option>
                    <option value="11">11h</option>
                    <option value="12">12h</option>
                  </select>
                  <select id="duration-minutes" style="
                    width: 100%;
                    padding: 10px;
                    border: none;
                    border-radius: 6px;
                    font-size: 0.95rem;
                    background: white;
                    color: #2c3e50;
                  " onchange="updateTimeDisplay()">
                    <option value="0" selected>0m</option>
                    <option value="15">15m</option>
                    <option value="30">30m</option>
                    <option value="45">45m</option>
                  </select>
                </div>
                <small style="opacity: 0.8; font-size: 0.8rem;">Horas : Minutos</small>
              </div>
            </div>
          </div>
          
          <!-- Columna derecha: Resumen y acción -->
          <div style="display: flex; flex-direction: column; gap: 15px;">
            <!-- Panel de resumen -->
            <div style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; border-radius: 12px; flex: 1;">
              <h4 style="margin: 0 0 15px 0;">📋 Resumen</h4>
              
              <!-- Hora de finalización -->
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem;">🏁 Finaliza a las:</label>
                <input type="text" id="end-time-display" readonly style="
                  width: 100%;
                  padding: 10px;
                  border: none;
                  border-radius: 6px;
                  font-size: 1.1rem;
                  background: rgba(255,255,255,0.9);
                  color: #2c3e50;
                  text-align: center;
                  font-weight: bold;
                " value="13:00">
              </div>
              
              <!-- Duración -->
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem;">⏱️ Duración:</label>
                <input type="text" id="duration-display" readonly style="
                  width: 100%;
                  padding: 10px;
                  border: none;
                  border-radius: 6px;
                  font-size: 1rem;
                  background: rgba(255,255,255,0.8);
                  color: #2c3e50;
                  text-align: center;
                  font-weight: bold;
                " value="1 hora">
              </div>
              
              <!-- Información adicional -->
              <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 6px; font-size: 0.85rem;">
                💡 <strong>Tip:</strong> Selecciona tu compañía y tarifa actual para conocer el costo exacto de usar electrodomésticos en horarios específicos.
              </div>
            </div>
            
            <!-- Botón de acción -->
            <div style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 20px; border-radius: 12px; text-align: center;">
              <button onclick="calculateTimingAndComparison()" style="
                background: rgba(255,255,255,0.2);
                color: white;
                border: 2px solid white;
                padding: 15px 25px;
                border-radius: 25px;
                cursor: pointer;
                font-size: 1.1rem;
                font-weight: 700;
                width: 100%;
                transition: all 0.3s ease;
              " onmouseover="this.style.background='white'; this.style.color='#e74c3c'" 
                 onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.color='white'">
                💰 CALCULAR COSTO REAL
              </button>
              <div style="margin-top: 10px; font-size: 0.8rem; opacity: 0.9;">
                Descubre cuánto pagas con tu tarifa actual
              </div>
            </div>
          </div>
        </div>
        
        <!-- Resultado de la comparación -->
        <div id="hourly-comparison-result">
          <div style="text-align: center; padding: 40px; color: #7f8c8d;">
            <span style="font-size: 3rem;">⚡</span>
            <p>Configura tu electrodoméstico y horario para ver la comparación de tarifas</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Disclaimer -->
  <div class="disclaimer">
    <h3>⚠️ DISCLAIMER - AVISO IMPORTANTE</h3>
    <p>
      La información presentada en esta plataforma ha sido desarrollada con el <span class="highlight">máximo cuidado y atención al detalle</span>. 
      Sin embargo, reconocemos que <span class="highlight">pueden existir errores</span> en los datos, cálculos o interpretaciones.
    </p>
    <p>
      <span class="highlight">Esta información debe considerarse únicamente como referencia orientativa</span> y no constituye asesoramiento financiero, energético o comercial profesional. 
      Los precios de la electricidad, condiciones meteorológicas y tarifas pueden variar y cambiar sin previo aviso.
    </p>
    <p>
      <strong>Recomendamos verificar siempre los datos con fuentes oficiales</strong> como OMIE, REE, AEMET y las comercializadoras eléctricas antes de tomar decisiones importantes. 
      El uso de esta información es bajo su propia responsabilidad.
    </p>
  </div>

  <div class="footer">
    <p>© 2025 PRECIO DE LA ELECTRICIDAD Y METEOROLOGÍA. TODOS LOS DERECHOS RESERVADOS.</p>
    <p>Desarrollado con ❤️ por <a href="https://github.com/adriancubasalvarez" target="_blank">Adrián Cubas</a></p>
  </div>

  <script>
// ===== GLOBAL VARIABLES =====
let globalPrices = [];
let weatherChart = null;
let priceChart = null;
let comparisonChart = null;
let map = null;

// ===== SISTEMA DE CACHÉ SIMPLIFICADO PARA GITHUB PAGES =====
const CACHE_CONFIG = {
  ELECTRICITY_TTL: 30 * 60 * 1000,     // 30 minutos (más frecuente para GitHub Pages)
  WEATHER_TTL: 15 * 60 * 1000,         // 15 minutos (más frecuente)
  MAX_WEATHER_CALLS_PER_DAY: 800       // Límite de seguridad
};

class SimpleCache {
  constructor() {
    this.prefix = 'precio_luz_';
    this.sessionCounters = new Map(); // Usar Map en memoria en lugar de localStorage
  }

  // Verificar si podemos hacer más llamadas meteorológicas (solo en sesión actual)
  canMakeWeatherCall() {
    const today = new Date().toDateString();
    const sessionKey = `weather_calls_${today}`;
    const current = this.sessionCounters.get(sessionKey) || 0;
    
    if (current >= CACHE_CONFIG.MAX_WEATHER_CALLS_PER_DAY) {
      console.warn(`⚠️ Límite de llamadas meteorológicas alcanzado en esta sesión: ${current}/${CACHE_CONFIG.MAX_WEATHER_CALLS_PER_DAY}`);
      return false;
    }
    
    return true;
  }

  // Incrementar contador de llamadas meteorológicas (solo en sesión)
  incrementWeatherCallCounter() {
    const today = new Date().toDateString();
    const sessionKey = `weather_calls_${today}`;
    const current = this.sessionCounters.get(sessionKey) || 0;
    this.sessionCounters.set(sessionKey, current + 1);
    console.log(`🌤️ Llamadas meteorológicas en esta sesión: ${current + 1}/${CACHE_CONFIG.MAX_WEATHER_CALLS_PER_DAY}`);
  }

  // Caché temporal en sessionStorage (se pierde al recargar - perfecto para GitHub Pages)
  set(key, data, ttl = CACHE_CONFIG.ELECTRICITY_TTL) {
    const expirationTime = Date.now() + ttl;
    const cacheData = {
      data: data,
      expiration: expirationTime,
      timestamp: Date.now()
    };
    
    try {
      // Solo usar sessionStorage para datos críticos, no localStorage
      sessionStorage.setItem(this.prefix + key, JSON.stringify(cacheData));
      console.log(`💾 Datos guardados en caché temporal: ${key} (expira en ${Math.round(ttl/60000)} min)`);
      return true;
    } catch (error) {
      console.warn('⚠️ Error guardando en caché temporal:', error);
      return false;
    }
  }

  // Obtener datos del caché temporal
  get(key) {
    try {
      const stored = sessionStorage.getItem(this.prefix + key);
      if (!stored) return null;

      const cacheData = JSON.parse(stored);
      
      if (Date.now() > cacheData.expiration) {
        sessionStorage.removeItem(this.prefix + key);
        console.log(`⌛ Caché temporal expirado eliminado: ${key}`);
        return null;
      }

      const ageMinutes = Math.round((Date.now() - cacheData.timestamp) / 60000);
      console.log(`✅ Datos obtenidos del caché temporal: ${key} (${ageMinutes} min de antigüedad)`);
      return cacheData.data;
    } catch (error) {
      console.warn('⚠️ Error leyendo caché temporal:', error);
      return null;
    }
  }

  // Eliminar entrada del caché
  delete(key) {
    try {
      sessionStorage.removeItem(this.prefix + key);
    } catch (error) {
      console.warn('⚠️ Error eliminando caché:', error);
    }
  }

  // Limpiar todo el caché de la sesión
  clearAll() {
    try {
      const keys = Object.keys(sessionStorage);
      keys.forEach(key => {
        if (key.startsWith(this.prefix)) {
          sessionStorage.removeItem(key);
        }
      });
      this.sessionCounters.clear();
      console.log('🧹 Caché de sesión limpiado');
    } catch (error) {
      console.warn('⚠️ Error limpiando caché:', error);
    }
  }

  // Obtener estadísticas simples
  getStats() {
    const today = new Date().toDateString();
    const sessionKey = `weather_calls_${today}`;
    const weatherCalls = this.sessionCounters.get(sessionKey) || 0;
    
    return {
      weatherCallsToday: weatherCalls,
      remainingWeatherCalls: CACHE_CONFIG.MAX_WEATHER_CALLS_PER_DAY - weatherCalls,
      cacheType: 'Session (GitHub Pages optimized)'
    };
  }
}

// Instancia global del caché simplificado
const cache = new SimpleCache();

// === FUNCIONES DE RESPALDO GARANTIZADO ===
function forceLoadBackupPrices() {
  console.log('🔧 Forzando carga de precios de respaldo...');
  
  try {
    const alertElement = document.getElementById("alerta");
    const canvasElement = document.getElementById("grafico");
    
    if (!canvasElement) {
      console.error('❌ Canvas del gráfico no encontrado');
      return;
    }
    
    const ctx = canvasElement.getContext("2d");
    
    // Generar datos de respaldo inmediatamente
    const backupData = generateImmediateBackupPrices();
    
    if (backupData && backupData.prices && backupData.prices.length > 0) {
      globalPrices = backupData.prices;
      updatePriceAlert(backupData.prices, backupData);
      renderPriceChart(ctx, backupData.labels, backupData.prices, backupData.colors);
      
      // Actualizar comparación de tarifas
      const comparisonData = calculateTariffComparison(backupData.prices, 'respaldo');
      renderTariffComparison(comparisonData);
      
      updateApiStatus('offline', 'Datos de respaldo cargados correctamente');
      console.log('✅ Precios de respaldo cargados exitosamente');
    }
  } catch (error) {
    console.error('❌ Error en forceLoadBackupPrices:', error);
  }
}

function forceLoadBackupWeather() {
  console.log('🔧 Forzando carga de datos meteorológicos de respaldo...');
  
  try {
    const weatherElement = document.getElementById("weather");
    const weatherCanvasElement = document.getElementById("weather-chart");
    
    if (!weatherElement || !weatherCanvasElement) {
      console.error('❌ Elementos meteorológicos no encontrados');
      return;
    }
    
    const weatherCtx = weatherCanvasElement.getContext("2d");
    
    // Generar datos meteorológicos de respaldo inmediatamente
    const mockWeatherData = generateMockWeatherData();
    updateWeatherDisplay(weatherElement, mockWeatherData);
    renderWeatherChart(weatherCtx, mockWeatherData);
    setupWeatherControls();
    
    console.log('✅ Datos meteorológicos de respaldo cargados exitosamente');
  } catch (error) {
    console.error('❌ Error en forceLoadBackupWeather:', error);
  }
}

function generateImmediateBackupPrices() {
  console.log('📊 Generando precios de respaldo inmediatos...');
  
  const today = new Date();
  const isWeekend = [0, 6].includes(today.getDay());
  const currentHour = today.getHours();
  
  // Patrones realistas de precios PVPC
  const basePattern = isWeekend ? 
    [0.075, 0.068, 0.062, 0.060, 0.065, 0.085, 0.105, 0.135, 0.125, 0.105, 0.095, 0.085, 
     0.085, 0.075, 0.085, 0.095, 0.115, 0.145, 0.165, 0.155, 0.135, 0.115, 0.095, 0.085] :
    [0.085, 0.078, 0.072, 0.070, 0.075, 0.095, 0.125, 0.165, 0.145, 0.125, 0.115, 0.105,
     0.095, 0.085, 0.095, 0.115, 0.135, 0.165, 0.195, 0.175, 0.155, 0.135, 0.115, 0.095];
  
  const labels = [];
  const prices = [];
  const colors = [];
  
  for (let i = 0; i < 24; i++) {
    labels.push(`${i.toString().padStart(2, '0')}:00`);
    
    // Agregar pequeña variación aleatoria
    const variation = (Math.random() - 0.5) * 0.01;
    const finalPrice = Math.max(0.045, basePattern[i] + variation);
    prices.push(parseFloat(finalPrice.toFixed(4)));
    
    // Colores según precio y hora actual
    if (i === currentHour) {
      colors.push("#2196F3"); // Azul para hora actual
    } else if (finalPrice <= 0.08) {
      colors.push("#27ae60"); // Verde
    } else if (finalPrice <= 0.12) {
      colors.push("#f39c12"); // Naranja
    } else {
      colors.push("#e67e22"); // Rojo
    }
  }
  
  return {
    labels,
    prices,
    colors,
    date: today.toLocaleDateString('es-ES'),
    isWeekend,
    source: 'Datos de respaldo'
  };
}

function updateCacheStatus() {
  const cacheElement = document.getElementById("cache-status");
  if (!cacheElement) return;
  
  const stats = cache.getStats();
  const weatherCalls = stats.weatherCallsToday;
  const usagePercentage = Math.round((weatherCalls / CACHE_CONFIG.MAX_WEATHER_CALLS_PER_DAY) * 100);
  
  // Color y estado según el uso
  let statusColor = '#27ae60'; // Verde
  let statusText = 'Óptimo';
  
  if (usagePercentage > 80) {
    statusColor = '#e74c3c'; // Rojo
    statusText = 'Alto uso';
  } else if (usagePercentage > 60) {
    statusColor = '#f39c12'; // Naranja
    statusText = 'Uso medio';
  }
  
  cacheElement.innerHTML = `💾 API Calls: ${weatherCalls}/800 (${statusText})`;
  cacheElement.style.background = `linear-gradient(45deg, ${statusColor}, ${statusColor}dd)`;
  cacheElement.style.borderColor = statusColor;
}

// ===== COMPARACIÓN DIARIA CON CONSUMO REAL =====

function calculateTariffComparison(pvpcPrices, dataSource = null) {
  console.log('🔧 Iniciando calculateTariffComparison con:', {
    pvpcPricesLength: pvpcPrices?.length,
    dataSource,
    firstPrice: pvpcPrices?.[0],
    lastPrice: pvpcPrices?.[pvpcPrices?.length - 1]
  });

  if (!pvpcPrices || pvpcPrices.length === 0) {
    console.error('❌ No hay precios PVPC disponibles');
    return null;
  }

  const currentHour = new Date().getHours();
  const currentPVPCPrice = pvpcPrices[currentHour];
  const isWeekend = [0, 6].includes(new Date().getDay());
  const dailyAveragePVPC = pvpcPrices.reduce((a, b) => a + b, 0) / 24;
  
  // Obtener configuración de consumo del usuario
  const dailyConsumption = parseFloat(document.getElementById('daily-consumption')?.value || 10);
  const consumptionPattern = document.getElementById('consumption-pattern')?.value || 'residential';
  
  console.log('📊 Configuración inicial:', {
    currentHour,
    currentPVPCPrice,
    dailyAveragePVPC,
    dailyConsumption,
    consumptionPattern
  });
  
  // Generar distribución horaria del consumo
  const hourlyConsumption = generateHourlyConsumption(dailyConsumption, consumptionPattern);
  
  if (!hourlyConsumption || hourlyConsumption.length !== 24) {
    console.error('❌ Error generando distribución horaria del consumo');
    return null;
  }
  
  console.log('✅ Distribución horaria generada:', hourlyConsumption.slice(0, 3), '...');
  
  // Verificar si estamos usando datos oficiales de REE
  const isOfficialData = dataSource && (dataSource.includes('ESIOS') || dataSource.includes('REE') || dataSource.includes('oficial'));
  
  console.log(`🔍 Calculando costes del día completo con ${dailyConsumption} kWh (patrón: ${consumptionPattern})`);
  console.log(`📊 PVPC actual: ${formatPrice(currentPVPCPrice)} €/kWh | Promedio día: ${formatPrice(dailyAveragePVPC)} €/kWh`);
  console.log(`🏛️ Datos oficiales REE: ${isOfficialData ? 'SÍ' : 'NO'}`);
  
  const comparisons = [];
  
  // Calcular coste PVPC del día completo
  const pvpcDailyCost = calculateDailyCost(hourlyConsumption, pvpcPrices);
  console.log('💰 Coste PVPC del día:', pvpcDailyCost);
  
  if (!SPANISH_ENERGY_COMPANIES) {
    console.error('❌ SPANISH_ENERGY_COMPANIES no está definido');
    return null;
  }
  
  console.log('🏢 Procesando', Object.keys(SPANISH_ENERGY_COMPANIES).length, 'compañías...');
  
  Object.entries(SPANISH_ENERGY_COMPANIES).forEach(([companyKey, company]) => {
    Object.entries(company.tarifas).forEach(([tariffName, tariff]) => {
      console.log(`🔧 Calculando: ${company.name} - ${tariffName}`);
      
      // Calcular precios por hora para esta tarifa
      const tariffHourlyPrices = calculateTariffHourlyPrices(tariff, pvpcPrices);
      
      // Calcular coste total del día con esta tarifa
      const tariffDailyCost = calculateDailyCost(tariffHourlyPrices, hourlyConsumption);
      
      // Calcular ahorros vs PVPC
      const dailySavings = pvpcDailyCost - tariffDailyCost;
      const dailySavingsPercent = (dailySavings / pvpcDailyCost) * 100;
      
      // Precio medio de la tarifa en el día
      const tariffAveragePrice = tariffHourlyPrices.reduce((a, b) => a + b, 0) / 24;
      
      // Generar recomendación
      let recommendation = '';
      if (dailySavingsPercent > 10) {
        recommendation = '🟢 EXCELENTE AHORRO HOY';
      } else if (dailySavingsPercent > 2) {
        recommendation = '🟡 LIGERO AHORRO HOY';
      } else if (dailySavingsPercent > -2) {
        recommendation = '🟠 SIMILAR AL PVPC HOY';
      } else {
        recommendation = '🔴 MÁS CARO HOY';
      }
      
      // Método de cálculo
      let calculationMethod = '';
      if (tariff.tipo === "Tarifa fija" && tariff.precio_fijo) {
        calculationMethod = `Precio fijo: ${formatPrice(tariff.precio_fijo)} €/kWh`;
      } else if (tariff.periodos) {
        calculationMethod = `Discriminación horaria aplicada a ${dailyConsumption} kWh`;
      } else if (tariff.margen_fijo) {
        calculationMethod = `PVPC + ${formatPrice(tariff.margen_fijo)} €/kWh de margen`;
      } else {
        calculationMethod = 'Sigue exactamente el PVPC oficial';
      }
      
      console.log(`📊 ${company.name} - ${tariffName}: ${tariffDailyCost.toFixed(2)} € hoy (${dailySavingsPercent.toFixed(1)}% vs PVPC)`);
      
      comparisons.push({
        company: company.name,
        companyKey,
        tariffName,
        tariff,
        dailyCost: tariffDailyCost,
        dailySavings: dailySavings,
        dailySavingsPercent: dailySavingsPercent,
        averagePrice: tariffAveragePrice,
        currentPrice: tariffHourlyPrices[currentHour],
        recommendation,
        calculationMethod,
        hourlyPrices: tariffHourlyPrices,
        isOfficialComparison: isOfficialData
      });
    });
  });
  
  // Ordenar por ahorro diario (mejor primero)
  comparisons.sort((a, b) => b.dailySavings - a.dailySavings);
  
  console.log(`✅ Comparación completa: ${comparisons.length} tarifas analizadas`);
  console.log(`🥇 Mejor opción: ${comparisons[0]?.company} - ${comparisons[0]?.tariffName} (ahorra ${comparisons[0]?.dailySavings.toFixed(2)} € hoy)`);
  console.log(`🥉 Peor opción: ${comparisons[comparisons.length - 1]?.company} - ${comparisons[comparisons.length - 1]?.tariffName} (cuesta ${Math.abs(comparisons[comparisons.length - 1]?.dailySavings).toFixed(2)} € más)`);
  
  return {
    pvpcDailyCost: pvpcDailyCost,
    pvpcAveragePrice: dailyAveragePVPC,
    pvpcCurrentPrice: currentPVPCPrice,
    dailyConsumption: dailyConsumption,
    consumptionPattern: consumptionPattern,
    comparisons,
    bestOption: comparisons[0],
    worstOption: comparisons[comparisons.length - 1],
    isOfficialData,
    dataSource,
    timestamp: new Date().toISOString(),
    currentHour
  };
}

function renderTariffComparison(comparisonData) {
  const container = document.getElementById('company-comparison-chart');
  if (!container) {
    console.error('❌ No se encontró el contenedor company-comparison-chart');
    return;
  }
  
  if (!comparisonData) {
    console.error('❌ No hay datos de comparación para renderizar');
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <span style="font-size: 3rem;">❌</span>
        <p>Error: No se pudieron generar las comparaciones de tarifas</p>
        <button onclick="forceUpdateComparison()" style="
          background: #3498db; color: white; border: none; padding: 10px 20px; 
          border-radius: 5px; cursor: pointer; margin-top: 10px;
        ">🔄 Reintentar</button>
      </div>
    `;
    return;
  }
  
  console.log('📊 Renderizando comparación con datos:', comparisonData);
  
  // Almacenar datos para análisis personalizado
  currentPricesData = {
    pvpcPrice: comparisonData.pvpcCurrentPrice,
    pvpcDailyAverage: comparisonData.pvpcAveragePrice,
    comparisons: comparisonData.comparisons,
    isOfficialData: comparisonData.isOfficialData,
    hourlyPrices: globalPrices // Usar los precios globales
  };
  
  const { pvpcAveragePrice, pvpcCurrentPrice, comparisons, bestOption, worstOption, isOfficialData, dataSource } = comparisonData;
  
  console.log('💰 Datos de renderizado:', {
    pvpcCurrentPrice,
    pvpcAveragePrice,
    comparisonsCount: comparisons.length,
    bestOption: bestOption ? `${bestOption.company} - ${bestOption.tariffName}` : 'No definido',
    worstOption: worstOption ? `${worstOption.company} - ${worstOption.tariffName}` : 'No definido'
  });
  
  container.innerHTML = `
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
      <h3 style="margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 2rem;">⚡</span>
        <span>Comparación Oficial vs PVPC ${isOfficialData ? '(Datos REE)' : '(Simulación)'}</span>
      </h3>
      
      ${isOfficialData ? `
        <div style="background: rgba(39, 174, 96, 0.3); padding: 10px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #27ae60;">
          <strong>🏛️ DATOS OFICIALES REE</strong> - Comparación basada en precios reales de Red Eléctrica de España
        </div>
      ` : `
        <div style="background: rgba(243, 156, 18, 0.3); padding: 10px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f39c12;">
          <strong>📊 SIMULACIÓN</strong> - Comparación basada en datos de respaldo realistas
        </div>
      `}
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">PVPC Ahora</div>
          <div style="font-size: 1.4rem; font-weight: bold;">${formatPrice(pvpcCurrentPrice)} €/kWh</div>
        </div>
        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">PVPC Promedio Hoy</div>
          <div style="font-size: 1.4rem; font-weight: bold;">${formatPrice(pvpcAveragePrice)} €/kWh</div>
        </div>
        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">Mejor Opción</div>
          <div style="font-size: 1.1rem; font-weight: bold;">${bestOption.company}</div>
          <div style="font-size: 0.9rem; opacity: 0.8;">${bestOption.tariffName}</div>
          <div style="font-size: 1rem; color: #00ff88;">Ahorra ${bestOption.dailySavingsPercent.toFixed(1)}%</div>
        </div>
        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">Tarifas Analizadas</div>
          <div style="font-size: 1.4rem; font-weight: bold;">${comparisons.length}</div>
          <div style="font-size: 0.9rem; opacity: 0.8;">de ${Object.keys(SPANISH_ENERGY_COMPANIES).length} compañías</div>
        </div>
      </div>
      
      <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
        <h4 style="margin: 0 0 10px 0; font-size: 1.1rem;">📊 Resumen de Comparación</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; font-size: 0.9rem;">
          <div>🟢 Tarifas que ahorran vs PVPC: <strong>${comparisons.filter(c => c.dailySavingsPercent > 0).length}</strong></div>
          <div>🔴 Tarifas más caras que PVPC: <strong>${comparisons.filter(c => c.dailySavingsPercent <= 0).length}</strong></div>
          <div>💰 Mejor ahorro posible: <strong>${bestOption.dailySavingsPercent.toFixed(1)}%</strong></div>
          <div>📈 Peor opción: <strong>${worstOption.dailySavingsPercent.toFixed(1)}%</strong> (${worstOption.company})</div>
        </div>
      </div>
    </div>
    
    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #3498db;">
      <p style="margin: 0; font-size: 0.9rem; color: #2c3e50;">
        <strong>ℹ️ Información importante:</strong> Esta comparación se basa en el precio PVPC oficial ${isOfficialData ? 'obtenido de Red Eléctrica de España (REE)' : 'usando datos de simulación realista'}. 
        Los precios mostrados son orientativos y pueden variar según condiciones específicas de cada comercializadora. 
        ${isOfficialData ? 'Los datos son oficiales y se actualizan en tiempo real.' : 'Para obtener datos oficiales, use el botón "OBTENER PRECIOS REALES".'}
      </p>
    </div>
  `;
  
  // Si hay un usuario seleccionado, actualizar su análisis
  const userCompanySelector = document.getElementById('user-company-selector');
  const userTariffSelector = document.getElementById('user-tariff-selector');
  
  if (userCompanySelector && userCompanySelector.value && userTariffSelector && userTariffSelector.value) {
    setTimeout(() => {
      generateUserAnalysis(userCompanySelector.value, userTariffSelector.value);
    }, 100);
  }
}

// Funciones helper para el cálculo de costos diarios
function generateHourlyConsumption(dailyConsumption, pattern) {
  // Validación de entrada
  const consumption = parseFloat(dailyConsumption) || 10;
  if (consumption <= 0) {
    console.warn('⚠️ Consumo diario inválido, usando valor por defecto:', consumption);
    return new Array(24).fill(10/24); // 10 kWh distribuidos uniformemente
  }
  
  const patterns = {
    'flat': new Array(24).fill(1/24), // Consumo plano
    'residential': [
      0.02, 0.01, 0.01, 0.01, 0.01, 0.02, // 00-05: muy bajo
      0.03, 0.05, 0.06, 0.04, 0.03, 0.03, // 06-11: mañana
      0.04, 0.04, 0.05, 0.05, 0.06, 0.07, // 12-17: tarde
      0.08, 0.09, 0.08, 0.06, 0.04, 0.03  // 18-23: noche/pico
    ],
    'business': [
      0.01, 0.01, 0.01, 0.01, 0.01, 0.02, // 00-05: cerrado
      0.04, 0.06, 0.08, 0.09, 0.08, 0.07, // 06-11: apertura
      0.06, 0.07, 0.08, 0.09, 0.08, 0.07, // 12-17: horario comercial
      0.06, 0.04, 0.03, 0.02, 0.01, 0.01  // 18-23: cierre
    ],
    'work-day': [
      0.01, 0.01, 0.01, 0.01, 0.01, 0.02, // 00-05: dormido
      0.04, 0.06, 0.03, 0.02, 0.02, 0.02, // 06-11: preparación y trabajo
      0.02, 0.02, 0.02, 0.02, 0.02, 0.03, // 12-17: trabajo fuera
      0.05, 0.08, 0.09, 0.08, 0.06, 0.04  // 18-23: regreso a casa
    ]
  };
  
  const selectedPattern = patterns[pattern] || patterns['residential'];
  const hourlyConsumption = selectedPattern.map(ratio => consumption * ratio);
  
  // Validar que todos los valores son números válidos
  const validConsumption = hourlyConsumption.map(value => {
    const num = parseFloat(value);
    return isNaN(num) || num < 0 ? 0 : num;
  });
  
  // Verificar que la suma total sea correcta
  const total = validConsumption.reduce((sum, val) => sum + val, 0);
  if (Math.abs(total - consumption) > 0.01) {
    console.warn('⚠️ Ajustando distribución horaria para que sume el total exacto');
    const factor = consumption / total;
    return validConsumption.map(val => val * factor);
  }
  
  return validConsumption;
}

function calculateTariffHourlyPrices(tariff, pvpcHourlyPrices) {
  return pvpcHourlyPrices.map((pvpcPrice, hour) => {
    return calculateTariffPriceForHour(tariff, pvpcPrice, hour);
  });
}

function calculateDailyCost(hourlyConsumption, hourlyPrices) {
  // Validación de entrada
  if (!Array.isArray(hourlyConsumption) || !Array.isArray(hourlyPrices)) {
    console.warn('⚠️ Datos inválidos en calculateDailyCost:', { hourlyConsumption, hourlyPrices });
    return 0;
  }
  
  if (hourlyConsumption.length !== hourlyPrices.length) {
    console.warn('⚠️ Arrays de diferente longitud en calculateDailyCost');
    return 0;
  }
  
  const totalCost = hourlyConsumption.reduce((total, consumption, hour) => {
    const price = parseFloat(hourlyPrices[hour]) || 0;
    const cons = parseFloat(consumption) || 0;
    const hourCost = cons * price;
    
    if (isNaN(hourCost)) {
      console.warn('⚠️ Costo inválido en hora', hour, { consumption: cons, price, hourCost });
      return total;
    }
    
    return total + hourCost;
  }, 0);
  
  // Validación del resultado final
  if (isNaN(totalCost) || totalCost < 0) {
    console.warn('⚠️ Costo total inválido:', totalCost);
    return 0;
  }
  
  return totalCost;
}

function updateDailyComparison() {
  console.log('🔄 Actualizando comparación diaria...');
  console.log('📊 Estado de globalPrices:', {
    exists: !!globalPrices,
    type: typeof globalPrices,
    hasArray: Array.isArray(globalPrices),
    hasPvpc: !!(globalPrices && globalPrices.pvpc),
    pvpcLength: globalPrices?.pvpc?.length || 0,
    firstThreePrices: globalPrices?.pvpc?.slice(0, 3) || globalPrices?.slice(0, 3)
  });
  
  let pvpcPrices = null;
  
  // Verificar estructura de datos y extraer precios PVPC
  if (globalPrices && globalPrices.pvpc && globalPrices.pvpc.length > 0) {
    pvpcPrices = globalPrices.pvpc;
    console.log('✅ Usando globalPrices.pvpc');
  } else if (Array.isArray(globalPrices) && globalPrices.length > 0) {
    pvpcPrices = globalPrices;
    console.log('✅ Usando globalPrices como array directo');
  } else {
    console.log('⚠️ No hay datos de precios disponibles, generando datos por defecto');
    
    // Generar datos de respaldo
    const hourlyPrices = [];
    for (let hour = 0; hour < 24; hour++) {
      // Patrón realista de precios españoles
      let price = 0.12; // precio base
      if (hour >= 0 && hour < 8) price *= 0.8; // valle
      else if ((hour >= 10 && hour < 14) || (hour >= 18 && hour < 22)) price *= 1.4; // punta
      else price *= 1.0; // llano
      hourlyPrices.push(price);
    }
    pvpcPrices = hourlyPrices;
    globalPrices = { pvpc: hourlyPrices };
    console.log('✅ Datos de respaldo generados');
  }
  
  // Recalcular y actualizar la comparación
  const comparisonData = calculateTariffComparison(pvpcPrices);
  renderTariffComparison(comparisonData);
}

function getSavingsColor(savings) {
  if (savings > 5) return '#27ae60';
  if (savings > 0) return '#f39c12';
  if (savings > -5) return '#e67e22';
  return '#e74c3c';
}

// Función para forzar actualización de la comparación
function forceUpdateComparison() {
  console.log('🔄 Forzando actualización de comparación...');
  
  // Verificar que el botón existe
  if (!event || !event.target) {
    console.error('❌ Error: No se puede acceder al botón');
    return;
  }
  
  // Actualizar botón para mostrar que está cargando
  const button = event.target;
  const originalText = button.innerHTML;
  button.innerHTML = '⏳ Actualizando...';
  button.disabled = true;
  
  // Verificar que los elementos necesarios existan
  const canvasElement = document.getElementById("grafico");
  const alertElement = document.getElementById("alerta");
  
  if (!canvasElement) {
    console.error('❌ Error: Canvas del gráfico no encontrado');
    button.innerHTML = '❌ Canvas no encontrado';
    button.disabled = false;
    return;
  }
  
  if (!alertElement) {
    console.error('❌ Error: Elemento de alerta no encontrado');
    button.innerHTML = '❌ Elementos no encontrados';
    button.disabled = false;
    return;
  }
  
  // Limpiar datos existentes para forzar recarga
  cache.delete('electricity_prices');
  globalPrices = [];
  currentPricesData = null;
  
  // Recargar datos
  loadElectricityPrices().then(() => {
    console.log('✅ Comparación actualizada');
    button.innerHTML = originalText;
    button.disabled = false;
  }).catch((error) => {
    console.error('❌ Error actualizando comparación:', error);
    button.innerHTML = '❌ Error - Reintentar';
    button.disabled = false;
    
    // Mostrar error más específico en consola
    console.error('📝 Detalles del error:', {
      message: error.message,
      stack: error.stack,
      globalPricesLength: globalPrices ? globalPrices.length : 'undefined',
      canvasExists: !!canvasElement,
      alertExists: !!alertElement
    });
  });
}

// ===== NUEVA COMPARACIÓN USUARIO VS PVPC =====

function updateUserTariffSelector() {
  const companySelector = document.getElementById('user-company-selector');
  const tariffSelector = document.getElementById('user-tariff-selector');
  
  if (!companySelector || !tariffSelector) return;
  
  const selectedCompany = companySelector.value;
  
  if (!selectedCompany) {
    tariffSelector.style.display = 'none';
    tariffSelector.innerHTML = '<option value="">-- Selecciona tu tarifa --</option>';
    updateUserComparison();
    return;
  }
  
  tariffSelector.style.display = 'block';
  tariffSelector.innerHTML = '<option value="">-- Selecciona tu tarifa --</option>';
  
  if (selectedCompany === 'pvpc') {
    tariffSelector.innerHTML += `
      <option value="2.0TD">2.0TD (Discriminación horaria)</option>
      <option value="2.0A">2.0A (Sin discriminación)</option>
    `;
  } else if (SPANISH_ENERGY_COMPANIES && SPANISH_ENERGY_COMPANIES[selectedCompany]) {
    const company = SPANISH_ENERGY_COMPANIES[selectedCompany];
    Object.keys(company.tarifas).forEach(tariffName => {
      tariffSelector.innerHTML += `<option value="${tariffName}">${tariffName}</option>`;
    });
  }
  
  updateUserComparison();
}

function updateUserComparison() {
  const companySelector = document.getElementById('user-company-selector');
  const tariffSelector = document.getElementById('user-tariff-selector');
  const consumptionInput = document.getElementById('daily-consumption');
  const patternSelector = document.getElementById('consumption-pattern');
  const resultContainer = document.getElementById('user-comparison-result');
  
  if (!companySelector || !tariffSelector || !consumptionInput || !patternSelector || !resultContainer) {
    console.error('❌ No se encontraron todos los elementos necesarios');
    return;
  }
  
  const selectedCompany = companySelector.value;
  const selectedTariff = tariffSelector.value;
  const dailyConsumption = parseFloat(consumptionInput.value) || 10;
  const pattern = patternSelector.value || 'residential';
  
  if (!selectedCompany || !selectedTariff) {
    resultContainer.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #7f8c8d;">
        <span style="font-size: 3rem;">⬆️</span>
        <p>Selecciona tu tarifa actual para ver la comparación</p>
      </div>
    `;
    return;
  }
  
  // Obtener precios PVPC
  let pvpcPrices = null;
  if (globalPrices && globalPrices.pvpc && globalPrices.pvpc.length > 0) {
    pvpcPrices = globalPrices.pvpc;
  } else if (Array.isArray(globalPrices) && globalPrices.length > 0) {
    pvpcPrices = globalPrices;
  } else {
    // Generar datos de respaldo
    pvpcPrices = [];
    for (let hour = 0; hour < 24; hour++) {
      let price = 0.12;
      if (hour >= 0 && hour < 8) price *= 0.8;
      else if ((hour >= 10 && hour < 14) || (hour >= 18 && hour < 22)) price *= 1.4;
      pvpcPrices.push(price);
    }
  }
  
  // Generar distribución horaria del consumo
  const hourlyConsumption = generateHourlyConsumption(dailyConsumption, pattern);
  
  // Calcular costo PVPC
  const pvpcDailyCost = calculateDailyCost(hourlyConsumption, pvpcPrices);
  
  // Calcular costo de la tarifa del usuario
  let userTariffCost = 0;
  let userTariffName = '';
  let companyName = '';
  
  if (selectedCompany === 'pvpc') {
    userTariffCost = pvpcDailyCost; // Es la misma tarifa
    userTariffName = selectedTariff;
    companyName = 'PVPC';
  } else {
    const company = SPANISH_ENERGY_COMPANIES[selectedCompany];
    if (company && company.tarifas[selectedTariff]) {
      const tariff = company.tarifas[selectedTariff];
      const userHourlyPrices = calculateTariffHourlyPrices(tariff, pvpcPrices);
      userTariffCost = calculateDailyCost(hourlyConsumption, userHourlyPrices);
      userTariffName = selectedTariff;
      companyName = company.name;
    }
  }
  
  // Calcular diferencia
  const difference = userTariffCost - pvpcDailyCost;
  const percentageDiff = pvpcDailyCost > 0 ? (difference / pvpcDailyCost) * 100 : 0;
  
  // Validación de valores calculados
  if (isNaN(userTariffCost) || isNaN(pvpcDailyCost) || isNaN(difference)) {
    console.error('❌ Error en cálculos:', { userTariffCost, pvpcDailyCost, difference });
    resultContainer.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c; background: #ffeaa7; border-radius: 12px;">
        <span style="font-size: 3rem;">⚠️</span>
        <p><strong>Error en el cálculo</strong></p>
        <p>Por favor, actualiza los datos o selecciona otra tarifa</p>
      </div>
    `;
    return;
  }
  
  // Generar resultado visual
  let resultIcon = '';
  let resultColor = '';
  let resultText = '';
  
  if (Math.abs(difference) < 0.01) {
    resultIcon = '🟰';
    resultColor = '#95a5a6';
    resultText = 'IDÉNTICO AL PVPC';
  } else if (difference > 0) {
    resultIcon = '📈';
    resultColor = '#e74c3c';
    resultText = `PAGAS ${Math.abs(difference).toFixed(2)}€ MÁS vs PVPC HOY`;
  } else {
    resultIcon = '📉';
    resultColor = '#27ae60';
    resultText = `AHORRAS ${Math.abs(difference).toFixed(2)}€ vs PVPC HOY`;
  }
  
  resultContainer.innerHTML = `
    <div style="background: linear-gradient(135deg, ${resultColor}, ${adjustColor(resultColor, -20)}); color: white; padding: 30px; border-radius: 12px; text-align: center;">
      <div style="font-size: 4rem; margin-bottom: 15px;">${resultIcon}</div>
      <h3 style="margin: 0 0 20px 0; font-size: 1.8rem;">${resultText}</h3>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 20px;">
        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">Tu Tarifa HOY</div>
          <div style="font-size: 1.6rem; font-weight: bold;">${userTariffCost.toFixed(2)} €</div>
          <div style="font-size: 0.8rem; opacity: 0.8;">${companyName} - ${userTariffName}</div>
        </div>
        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">PVPC HOY</div>
          <div style="font-size: 1.6rem; font-weight: bold;">${pvpcDailyCost.toFixed(2)} €</div>
          <div style="font-size: 0.8rem; opacity: 0.8;">Tarifa regulada</div>
        </div>
        <div style="background: rgba(255,255,255,0.3); padding: 15px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">Diferencia</div>
          <div style="font-size: 1.6rem; font-weight: bold;">${difference > 0 ? '+' : ''}${difference.toFixed(2)} €</div>
          <div style="font-size: 0.8rem; opacity: 0.8;">${percentageDiff > 0 ? '+' : ''}${percentageDiff.toFixed(1)}%</div>
        </div>
      </div>
      
      <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; font-size: 0.9rem;">
        💡 <strong>Con ${dailyConsumption} kWh hoy:</strong> 
        ${Math.abs(difference) < 0.01 
          ? 'Tu tarifa tiene el mismo costo que PVPC' 
          : difference > 0 
            ? `Pagas ${difference.toFixed(2)} € más que con PVPC (${(difference * 365).toFixed(0)} €/año)` 
            : `Ahorras ${Math.abs(difference).toFixed(2)} € vs PVPC (${(Math.abs(difference) * 365).toFixed(0)} €/año)`}
      </div>
    </div>
    
    <!-- Gráfico de comparación por horas -->
    <div style="background: white; padding: 20px; border-radius: 12px; margin-top: 20px;">
      <h4 style="margin: 0 0 15px 0; color: #2c3e50;">📊 Comparación por Horas del Día</h4>
      <canvas id="user-comparison-chart" width="400" height="200"></canvas>
    </div>
  `;
  
  // Generar gráfico
  setTimeout(() => generateUserComparisonChart(pvpcPrices, hourlyConsumption, selectedCompany, selectedTariff), 100);
}

function generateUserComparisonChart(pvpcPrices, hourlyConsumption, companyKey, tariffName) {
  const canvas = document.getElementById('user-comparison-chart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  // Preparar datos
  const hours = Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`);
  
  // Función helper para detectar si es una comercializadora que aplica PVPC
  function isCORCompany(companyKey) {
    return companyKey === 'pvpc' || companyKey.endsWith('-cor');
  }
  
  let userHourlyPrices = pvpcPrices; // Por defecto PVPC puro
  
  // Si es una COR o compañía del mercado libre, aplicar sus márgenes
  if (SPANISH_ENERGY_COMPANIES[companyKey] && companyKey !== 'pvpc') {
    const company = SPANISH_ENERGY_COMPANIES[companyKey];
    if (company.tarifas[tariffName]) {
      userHourlyPrices = calculateTariffHourlyPrices(company.tarifas[tariffName], pvpcPrices);
    }
  }
  
  // Calcular costos por hora
  const pvpcHourlyCosts = pvpcPrices.map((price, hour) => price * hourlyConsumption[hour]);
  const userHourlyCosts = userHourlyPrices.map((price, hour) => price * hourlyConsumption[hour]);
  
  // Configurar gráfico
  if (window.userComparisonChart) {
    window.userComparisonChart.destroy();
  }
  
  window.userComparisonChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: hours,
      datasets: [
        {
          label: 'PVPC',
          data: pvpcHourlyCosts,
          borderColor: '#3498db',
          backgroundColor: 'rgba(52, 152, 219, 0.1)',
          borderWidth: 2,
          fill: true
        },
        {
          label: `Tu Tarifa (${tariffName})`,
          data: userHourlyCosts,
          borderColor: '#e74c3c',
          backgroundColor: 'rgba(231, 76, 60, 0.1)',
          borderWidth: 2,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Costo por Hora (€)'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Hora del Día'
          }
        }
      },
      plugins: {
        legend: {
          display: true,
          position: 'top'
        }
      }
    }
  });
}

function adjustColor(color, percent) {
  const num = parseInt(color.replace("#",""), 16);
  const amt = Math.round(2.55 * percent);
  const R = (num >> 16) + amt;
  const G = (num >> 8 & 0x00FF) + amt;
  const B = (num & 0x0000FF) + amt;
  return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 + (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255)).toString(16).slice(1);
}

// ===== ANÁLISIS PERSONALIZADO DEL USUARIO =====

// Variable global para almacenar datos actuales
let currentPricesData = null;

// Función para inicializar datos por defecto si no hay datos reales
function initializeDefaultPricesData() {
  if (!currentPricesData) {
    console.log('🔧 Inicializando datos por defecto...');
    
    // Si tenemos datos globales, usarlos
    if (globalPrices && globalPrices.length > 0) {
      const dailyAverage = globalPrices.reduce((a, b) => a + b, 0) / globalPrices.length;
      currentPricesData = {
        pvpcPrice: globalPrices[new Date().getHours()] || 0.12,
        pvpcDailyAverage: dailyAverage || 0.12,
        hourlyPrices: globalPrices,
        isOfficialData: false
      };
      console.log('✅ Usando datos de globalPrices para análisis');
    } else {
      // Generar datos realistas por defecto si no hay nada
      const hourlyPrices = generateRealisticPriceData();
      const dailyAverage = hourlyPrices.reduce((a, b) => a + b, 0) / hourlyPrices.length;
      
      currentPricesData = {
        pvpcPrice: hourlyPrices[new Date().getHours()] || 0.12,
        pvpcDailyAverage: dailyAverage,
        hourlyPrices: hourlyPrices,
        isOfficialData: false
      };
      
      // También actualizar globalPrices para coherencia
      globalPrices = hourlyPrices;
      
      console.log('✅ Datos realistas generados para análisis');
    }
    
    console.log('� Datos por defecto:', {
      pvpcPrice: currentPricesData.pvpcPrice,
      dailyAverage: currentPricesData.pvpcDailyAverage,
      hourlyPricesCount: currentPricesData.hourlyPrices.length
    });
  }
}

// Función auxiliar para generar datos de precio realistas
function generateRealisticPriceData() {
  const basePrice = 0.12; // €/kWh base
  const hourlyPrices = [];
  
  for (let hour = 0; hour < 24; hour++) {
    let multiplier = 1.0;
    
    // Horas valle (más barato)
    if (hour >= 0 && hour < 8) {
      multiplier = 0.7 + Math.random() * 0.2; // 0.7-0.9
    }
    // Horas punta (más caro)
    else if ((hour >= 10 && hour < 14) || (hour >= 18 && hour < 22)) {
      multiplier = 1.3 + Math.random() * 0.4; // 1.3-1.7
    }
    // Horas llano
    else {
      multiplier = 0.9 + Math.random() * 0.3; // 0.9-1.2
    }
    
    hourlyPrices.push(basePrice * multiplier);
  }
  
  return hourlyPrices;
}

function updateUserCompanyComparison() {
  const companySelector = document.getElementById('user-company-selector');
  const tariffSelector = document.getElementById('user-tariff-selector');
  const analysisContainer = document.getElementById('user-analysis');
  
  if (!companySelector || !tariffSelector || !analysisContainer) {
    console.error('❌ Error: No se encontraron los elementos del selector');
    return;
  }
  
  const selectedCompany = companySelector.value;
  console.log('🔍 Compañía seleccionada:', selectedCompany);
  
  if (!selectedCompany) {
    tariffSelector.style.display = 'none';
    analysisContainer.style.display = 'none';
    tariffSelector.innerHTML = '<option value="">-- Selecciona tu tarifa --</option>';
    return;
  }
  
  // Actualizar selector de tarifas
  updateTariffSelector(selectedCompany);
}

function handleTariffSelection() {
  const companySelector = document.getElementById('user-company-selector');
  const tariffSelector = document.getElementById('user-tariff-selector');
  
  if (!companySelector || !tariffSelector) {
    console.error('❌ Error: No se encontraron los selectores');
    return;
  }
  
  const selectedCompany = companySelector.value;
  const selectedTariff = tariffSelector.value;
  
  console.log('🎯 Tarifa seleccionada:', selectedCompany, selectedTariff);
  
  if (selectedCompany && selectedTariff) {
    // Intentar inicializar datos por defecto si no hay datos reales
    if (!currentPricesData) {
      initializeDefaultPricesData();
    }
    
    if (currentPricesData) {
      console.log('✅ Generando análisis...');
      generateUserAnalysis(selectedCompany, selectedTariff);
    } else {
      console.log('⚠️ No hay datos de precios disponibles');
      const analysisContainer = document.getElementById('user-analysis');
      if (analysisContainer) {
        analysisContainer.innerHTML = `
          <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; text-align: center;">
            <p><strong>❌ Sin datos de precios</strong></p>
            <p>Por favor, presiona <strong>"OBTENER PRECIOS REALES"</strong> primero para cargar los datos PVPC.</p>
            <button onclick="refreshPriceData()" style="
              background: #27ae60; 
              color: white; 
              border: none; 
              padding: 10px 20px; 
              border-radius: 6px; 
              cursor: pointer; 
              margin-top: 10px;
              font-weight: bold;
            ">
              🔄 Cargar Datos Ahora
            </button>
          </div>
        `;
        analysisContainer.style.display = 'block';
      }
    }
  } else {
    console.log('⚠️ Faltan selecciones:', {
      company: !!selectedCompany,
      tariff: !!selectedTariff
    });
  }
}

function updateTariffSelector(companyKey) {
  const tariffSelector = document.getElementById('user-tariff-selector');
  
  if (!tariffSelector) {
    console.error('❌ Error: No se encontró el selector de tarifas');
    return;
  }
  
  console.log('🔧 Actualizando selector para:', companyKey);
  
  // Limpiar opciones y mostrar loading
  tariffSelector.innerHTML = '<option value="">⏳ Cargando tarifas...</option>';
  tariffSelector.style.display = 'block';
  
  // Pequeño delay para efecto visual
  setTimeout(() => {
    tariffSelector.innerHTML = '<option value="">-- Selecciona tu tarifa --</option>';
    
    // Función helper para detectar si es una comercializadora que aplica PVPC
    function isCORCompany(companyKey) {
      return companyKey === 'pvpc' || companyKey.endsWith('-cor');
    }
    
    if (isCORCompany(companyKey)) {
      tariffSelector.innerHTML += `
        <option value="2.0TD">2.0TD (Discriminación horaria)</option>
        <option value="2.0A">2.0A (Sin discriminación)</option>
      `;
      console.log('✅ Tarifas PVPC/COR añadidas para:', companyKey);
    } else if (SPANISH_ENERGY_COMPANIES && SPANISH_ENERGY_COMPANIES[companyKey]) {
      const company = SPANISH_ENERGY_COMPANIES[companyKey];
      console.log('🏢 Compañía encontrada:', company.name);
      
      const tariffs = Object.keys(company.tarifas);
      if (tariffs.length === 0) {
        tariffSelector.innerHTML += '<option value="">No hay tarifas disponibles</option>';
      } else {
        tariffs.forEach(tariffName => {
          tariffSelector.innerHTML += `<option value="${tariffName}">${tariffName}</option>`;
        });
        console.log('✅ Tarifas de', company.name, 'añadidas:', tariffs);
      }
    } else {
      console.error('❌ Error: Compañía no encontrada en SPANISH_ENERGY_COMPANIES:', companyKey);
      tariffSelector.innerHTML += '<option value="">❌ Error: Compañía no encontrada</option>';
    }
    
    console.log('👁️ Selector de tarifas actualizado y mostrado');
  }, 200);
}

function generateUserAnalysis(companyKey, tariffName) {
  console.log('📊 Generando análisis para:', companyKey, tariffName);
  
  let usingFallbackData = false;
  if (!currentPricesData) {
    console.log('⚠️ No hay datos reales, usando datos por defecto para análisis');
    initializeDefaultPricesData();
    usingFallbackData = true;
    
    if (!currentPricesData) {
      console.log('❌ Error: No se pudieron inicializar datos por defecto');
      const analysisContainer = document.getElementById('user-analysis');
      if (analysisContainer) {
        analysisContainer.innerHTML = `
          <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; text-align: center;">
            <p><strong>❌ Error en análisis</strong></p>
            <p>No se pudieron cargar los datos necesarios. Presiona "OBTENER PRECIOS REALES" para intentar de nuevo.</p>
            <button onclick="refreshPriceData()" style="
              background: #27ae60; 
              color: white; 
              border: none; 
              padding: 10px 20px; 
              border-radius: 6px; 
              cursor: pointer; 
              margin-top: 10px;
              font-weight: bold;
            ">
              🔄 Cargar Datos Reales
            </button>
          </div>
        `;
        analysisContainer.style.display = 'block';
      }
      return;
    }
  }
  
  const analysisContainer = document.getElementById('user-analysis');
  const currentHour = new Date().getHours();
  const pvpcPrice = currentPricesData.pvpcPrice;
  const pvpcDailyAverage = currentPricesData.pvpcDailyAverage;
  
  let userCurrentPrice = 0;
  let userDailyAverage = 0;
  let companyName = '';
  let tariffInfo = null;
  let recommendations = [];
  
  if (companyKey === 'pvpc') {
    console.log('🏛️ Analizando tarifa PVPC:', tariffName);
    
    if (tariffName === '2.0TD') {
      // PVPC con discriminación horaria
      const period = getCurrentPVPCPeriod(currentHour);
      userCurrentPrice = pvpcPrice; // El precio PVPC ya incluye la discriminación
      userDailyAverage = pvpcDailyAverage;
      companyName = 'PVPC 2.0TD (Regulada)';
      
      recommendations.push({
        icon: '🏛️',
        title: 'Tarifa regulada con discriminación horaria',
        text: `Estás en período ${period.name} (${period.hours}). Precio oficial del Estado.`
      });
      
      recommendations.push({
        icon: '⏰',
        title: 'Optimiza tus horarios',
        text: 'Usa electrodomésticos de 00:00-08:00 (valle) para máximo ahorro.'
      });
      
      recommendations.push({
        icon: '💡',
        title: 'Evita horas punta',
        text: 'Reduce consumo de 10:00-14:00 y 18:00-22:00 (período más caro).'
      });
      
    } else if (tariffName === '2.0A') {
      // PVPC sin discriminación horaria
      userCurrentPrice = pvpcPrice;
      userDailyAverage = pvpcDailyAverage;
      companyName = 'PVPC 2.0A (Regulada)';
      
      recommendations.push({
        icon: '🏛️',
        title: 'Tarifa regulada sin discriminación',
        text: 'Precio único durante todo el día. Oficial del Estado.'
      });
      
      recommendations.push({
        icon: '💭',
        title: 'Considera 2.0TD',
        text: 'Podrías ahorrar con discriminación horaria si puedes cambiar horarios de consumo.'
      });
    }
    
  } else {
    console.log('🏢 Analizando compañía comercial:', companyKey);
    
    const company = SPANISH_ENERGY_COMPANIES[companyKey];
    if (!company) {
      console.error('❌ Compañía no encontrada:', companyKey);
      return;
    }
    
    companyName = company.name;
    tariffInfo = company.tarifas[tariffName];
    
    if (!tariffInfo) {
      console.error('❌ Tarifa no encontrada:', tariffName);
      return;
    }
    
    // Calcular precio actual de la tarifa del usuario
    const calculation = calculateTariffPrice(tariffInfo, pvpcPrice, pvpcDailyAverage);
    userCurrentPrice = calculation.currentPrice;
    userDailyAverage = calculation.dailyAverage;
    
    // Generar recomendaciones específicas
    recommendations = generateUserRecommendations(tariffInfo, pvpcPrice, pvpcDailyAverage, calculation);
  }
  
  // Calcular ahorros/costes vs PVPC
  const currentSavings = ((pvpcPrice - userCurrentPrice) / pvpcPrice) * 100;
  const dailySavings = ((pvpcDailyAverage - userDailyAverage) / pvpcDailyAverage) * 100;
  
  // Calcular ahorro mensual estimado (30 kWh promedio)
  const monthlyUsage = 30; // kWh
  const monthlyCostUser = userDailyAverage * monthlyUsage;
  const monthlyCostPVPC = pvpcDailyAverage * monthlyUsage;
  const monthlyDifference = monthlyCostPVPC - monthlyCostUser;
  
  console.log('💰 Análisis completado:', {
    userCurrentPrice,
    pvpcPrice,
    currentSavings,
    monthlyDifference
  });
  
  // Renderizar análisis
  analysisContainer.innerHTML = `
    <div style="background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; padding: 20px; border-radius: 12px;">
      <h4 style="margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 1.5rem;">🔍</span>
        <span>Tu Análisis Personal - ${companyName}</span>
      </h4>
      
      ${usingFallbackData ? `
        <div style="background: rgba(255, 193, 7, 0.2); border: 2px solid rgba(255, 193, 7, 0.6); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 1.2rem;">⚠️</span>
            <div>
              <strong>Análisis con datos de ejemplo</strong><br>
              <span style="font-size: 0.9rem; opacity: 0.9;">Presiona "OBTENER PRECIOS REALES" para un análisis preciso con datos actuales de REE.</span>
            </div>
          </div>
        </div>
      ` : ''}
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">Tu precio ahora</div>
          <div style="font-size: 1.4rem; font-weight: bold;">${formatPrice(userCurrentPrice)} €/kWh</div>
          <div style="font-size: 0.85rem; margin-top: 5px;">
            ${currentSavings > 0 ? '💚' : '❌'} ${currentSavings > 0 ? '+' : ''}${currentSavings.toFixed(1)}% vs PVPC
          </div>
        </div>
        
        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">PVPC ahora</div>
          <div style="font-size: 1.4rem; font-weight: bold;">${formatPrice(pvpcPrice)} €/kWh</div>
          <div style="font-size: 0.85rem; margin-top: 5px; opacity: 0.8;">Precio oficial</div>
        </div>
        
        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">Ahorro/Coste mensual</div>
          <div style="font-size: 1.4rem; font-weight: bold; color: ${monthlyDifference > 0 ? '#00ff88' : '#ff6b6b'};">
            ${monthlyDifference > 0 ? '+' : ''}${monthlyDifference.toFixed(2)}€
          </div>
          <div style="font-size: 0.85rem; margin-top: 5px;">vs PVPC (${monthlyUsage} kWh)</div>
        </div>
      </div>
      
      <div style="display: grid; gap: 15px;">
        ${recommendations.map(rec => `
          <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; border-left: 4px solid #fff;">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
              <span style="font-size: 1.5rem;">${rec.icon}</span>
              <div>
                <div style="font-weight: bold; margin-bottom: 5px;">${rec.title}</div>
                <div style="opacity: 0.95; line-height: 1.4;">${rec.text}</div>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
      
      <!-- Gráfico comparativo de horarios -->
      <div style="margin-top: 20px; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
        <h5 style="margin: 0 0 15px 0;">📊 Comparación por horas hoy</h5>
        <div id="hourly-comparison-chart" style="height: 200px;">
          <canvas id="hourly-comparison-canvas"></canvas>
        </div>
      </div>
    </div>
  `;
  
  analysisContainer.style.display = 'block';
  
  // Generar gráfico comparativo por horas (con pequeño delay para asegurar DOM)
  setTimeout(() => {
    generateHourlyComparisonChart(companyKey, tariffName);
  }, 100);
}

function calculateTariffPrice(tariff, pvpcPrice, pvpcDailyAverage) {
  const currentHour = new Date().getHours();
  const isWeekend = [0, 6].includes(new Date().getDay());
  
  let currentPrice = 0;
  let dailyAverage = 0;
  
  if (tariff.tipo === "Tarifa fija" && tariff.precio_fijo) {
    currentPrice = tariff.precio_fijo;
    dailyAverage = tariff.precio_fijo;
    
  } else if (tariff.tipo === "Tarifa plana fin de semana" && tariff.precio_laborable && tariff.precio_festivo !== undefined) {
    currentPrice = isWeekend ? tariff.precio_festivo : tariff.precio_laborable;
    dailyAverage = (tariff.precio_laborable * 5 + tariff.precio_festivo * 2) / 7;
    
  } else if (tariff.periodos) {
    let factor = 1.0;
    if (currentHour >= 10 && currentHour < 14 || currentHour >= 18 && currentHour < 22) {
      factor = tariff.periodos.punta?.factor || 1.25;
    } else if (currentHour >= 0 && currentHour < 8) {
      factor = tariff.periodos.valle?.factor || 0.75;
    } else {
      factor = tariff.periodos.llano?.factor || 1.0;
    }
    
    currentPrice = pvpcPrice * factor;
    
    const puntaHours = 8;
    const valleHours = 8;
    const llanoHours = 8;
    
    dailyAverage = (pvpcDailyAverage * tariff.periodos.punta.factor * puntaHours + 
                   pvpcDailyAverage * tariff.periodos.valle.factor * valleHours + 
                   pvpcDailyAverage * tariff.periodos.llano.factor * llanoHours) / 24;
    
  } else if (tariff.margen_fijo) {
    currentPrice = pvpcPrice + tariff.margen_fijo;
    dailyAverage = pvpcDailyAverage + tariff.margen_fijo;
    
  } else {
    currentPrice = pvpcPrice;
    dailyAverage = pvpcDailyAverage;
  }
  
  return { currentPrice, dailyAverage };
}

function generateUserRecommendations(tariff, pvpcPrice, pvpcDailyAverage, calculation) {
  const recommendations = [];
  const currentHour = new Date().getHours();
  
  // Comparación con PVPC
  const savings = ((pvpcPrice - calculation.currentPrice) / pvpcPrice) * 100;
  
  if (savings > 10) {
    recommendations.push({
      icon: '💚',
      title: 'Excelente elección',
      text: `Tu tarifa te ahorra un ${savings.toFixed(1)}% comparado con PVPC en este momento.`
    });
  } else if (savings > 0) {
    recommendations.push({
      icon: '👍',
      title: 'Buena tarifa',
      text: `Ahorras un ${savings.toFixed(1)}% vs PVPC ahora, pero podrías optimizar más.`
    });
  } else {
    recommendations.push({
      icon: '⚠️',
      title: 'Pagando más que PVPC',
      text: `Estás pagando un ${Math.abs(savings).toFixed(1)}% más que la tarifa regulada en este momento.`
    });
  }
  
  // Recomendaciones específicas por tipo de tarifa
  if (tariff.periodos) {
    const bestPeriod = getBestPeriodForTariff(tariff, currentHour);
    recommendations.push({
      icon: '⏰',
      title: 'Optimiza tus horarios',
      text: `Con discriminación horaria, ${bestPeriod.advice}`
    });
  }
  
  if (tariff.tipo === "Tarifa fija") {
    recommendations.push({
      icon: '📊',
      title: 'Precio fijo',
      text: 'No necesitas preocuparte por horarios, pero vigila si el mercado baja mucho.'
    });
  }
  
  // Recomendación de cambio si es conveniente
  if (savings < -15) {
    recommendations.push({
      icon: '🔄',
      title: 'Considera cambiar a PVPC',
      text: 'El precio regulado te podría ahorrar significativamente este mes.'
    });
  }
  
  return recommendations;
}

function getBestPeriodForTariff(tariff, currentHour) {
  const periods = tariff.periodos;
  const factors = [
    { name: 'valle', factor: periods.valle.factor, hours: periods.valle.horas },
    { name: 'llano', factor: periods.llano.factor, hours: periods.llano.horas },
    { name: 'punta', factor: periods.punta.factor, hours: periods.punta.horas }
  ];
  
  const bestPeriod = factors.sort((a, b) => a.factor - b.factor)[0];
  
  return {
    name: bestPeriod.name,
    factor: bestPeriod.factor,
    advice: `aprovecha el período ${bestPeriod.name} (${bestPeriod.hours}) para mayor ahorro.`
  };
}

function getCurrentPVPCPeriod(hour) {
  if (hour >= 10 && hour < 14 || hour >= 18 && hour < 22) {
    return {
      name: 'Punta (P1)',
      hours: '10:00-14:00 y 18:00-22:00',
      description: 'Período más caro'
    };
  } else if (hour >= 0 && hour < 8) {
    return {
      name: 'Valle (P3)', 
      hours: '00:00-08:00',
      description: 'Período más barato'
    };
  } else {
    return {
      name: 'Llano (P2)',
      hours: '08:00-10:00, 14:00-18:00, 22:00-24:00', 
      description: 'Período intermedio'
    };
  }
}

function findBestHours(hourlyPrices) {
  if (!hourlyPrices || hourlyPrices.length === 0) {
    return ['02:00-06:00']; // Default
  }
  
  const sorted = hourlyPrices.map((price, hour) => ({ hour, price }))
                            .sort((a, b) => a.price - b.price);
  
  return sorted.slice(0, 3).map(item => `${item.hour.toString().padStart(2, '0')}:00`);
}

function generateHourlyComparisonChart(companyKey, tariffName) {
  console.log('📊 Generando gráfico comparativo para:', companyKey, tariffName);
  
  const canvas = document.getElementById('hourly-comparison-canvas');
  if (!canvas) {
    console.error('❌ Canvas no encontrado para gráfico comparativo');
    return;
  }
  
  if (!currentPricesData) {
    console.log('⚠️ No hay datos de precios, inicializando datos por defecto...');
    initializeDefaultPricesData();
  }
  
  if (!currentPricesData) {
    console.log('❌ Error: No se pudieron obtener datos para el gráfico');
    
    // Mostrar mensaje de error
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth;
    canvas.height = 200;
    
    ctx.fillStyle = 'rgba(255,255,255,0.9)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#e74c3c';
    ctx.font = 'bold 16px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('❌ Error al cargar datos para gráfico', canvas.width / 2, canvas.height / 2 - 15);
    ctx.font = '14px Arial';
    ctx.fillStyle = '#7f8c8d';
    ctx.fillText('Presiona "OBTENER PRECIOS REALES" para cargar datos', canvas.width / 2, canvas.height / 2 + 15);
    return;
  }
  
  // Preparar datos para el gráfico
  const hours = Array.from({ length: 24 }, (_, i) => `${i.toString().padStart(2, '0')}:00`);
  const pvpcPrices = [];
  const userPrices = [];
  
  // Usar los precios por hora si están disponibles, sino usar el precio base para todas las horas
  const baseHourlyPrices = currentPricesData.hourlyPrices && currentPricesData.hourlyPrices.length === 24 
    ? currentPricesData.hourlyPrices 
    : Array.from({ length: 24 }, () => currentPricesData.pvpcPrice);
  
  for (let hour = 0; hour < 24; hour++) {
    const pvpcPrice = baseHourlyPrices[hour] || currentPricesData.pvpcPrice;
    pvpcPrices.push(pvpcPrice);
    
    // Calcular precio del usuario para esta hora
    let userPrice = pvpcPrice;
    
    if (companyKey === 'pvpc') {
      userPrice = pvpcPrice; // PVPC es igual
    } else {
      const company = SPANISH_ENERGY_COMPANIES[companyKey];
      if (company && company.tarifas[tariffName]) {
        const tariff = company.tarifas[tariffName];
        const calculation = calculateTariffPriceForHour(tariff, pvpcPrice, hour);
        userPrice = calculation.hourlyPrice;
      }
    }
    
    userPrices.push(userPrice);
  }
  
  // Destruir gráfico anterior si existe
  if (window.hourlyComparisonChart) {
    window.hourlyComparisonChart.destroy();
  }
  
  // Función helper para detectar si es una comercializadora que aplica PVPC
  function isCORCompany(companyKey) {
    return companyKey === 'pvpc' || companyKey.endsWith('-cor');
  }
  
  // Obtener información de la compañía
  const companyName = isCORCompany(companyKey) ? 
    (SPANISH_ENERGY_COMPANIES[companyKey]?.name || 'PVPC') : 
    (SPANISH_ENERGY_COMPANIES[companyKey]?.name || companyKey);
  const companyColor = isCORCompany(companyKey) ? '#3498db' : '#e74c3c';
  
  // Crear nuevo gráfico
  const ctx = canvas.getContext('2d');
  window.hourlyComparisonChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: hours,
      datasets: [
        {
          label: '🏛️ PVPC (Oficial REE)',
          data: pvpcPrices,
          borderColor: '#3498db',
          backgroundColor: 'rgba(52, 152, 219, 0.1)',
          borderWidth: 3,
          fill: false,
          tension: 0.2,
          pointBackgroundColor: '#3498db',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2,
          pointRadius: 4
        },
        {
          label: `${companyName} - ${tariffName}`,
          data: userPrices,
          borderColor: companyColor,
          backgroundColor: companyColor.replace('rgb', 'rgba').replace(')', ', 0.1)'),
          borderWidth: 3,
          fill: false,
          tension: 0.2,
          pointBackgroundColor: companyColor,
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2,
          pointRadius: 4
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: `Comparación ${companyName} vs PVPC por horas`,
          font: { size: 14, weight: 'bold' },
          color: '#2c3e50'
        },
        legend: {
          display: true,
          position: 'top',
          labels: {
            font: { size: 12 },
            usePointStyle: true
          }
        },
        tooltip: {
          mode: 'index',
          intersect: false,
          backgroundColor: 'rgba(0,0,0,0.8)',
          titleColor: '#ffffff',
          bodyColor: '#ffffff',
          borderColor: '#3498db',
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              const price = context.parsed.y;
              const isPVPC = context.datasetIndex === 0;
              
              if (isPVPC) {
                return `${context.dataset.label}: ${formatPrice(price)} €/kWh`;
              } else {
                const pvpcPrice = pvpcPrices[context.dataIndex];
                const savings = ((pvpcPrice - price) / pvpcPrice * 100);
                const savingsText = savings > 5 ? ` (💚 ${savings.toFixed(1)}% ahorro)` : 
                                   savings < -5 ? ` (❌ ${Math.abs(savings).toFixed(1)}% más caro)` : 
                                   ` (≈ similar al PVPC)`;
                return `${context.dataset.label}: ${formatPrice(price)} €/kWh${savingsText}`;
              }
            },
            title: function(context) {
              const hour = context[0].dataIndex;
              const currentHour = new Date().getHours();
              const isCurrentHour = hour === currentHour;
              return `${context[0].label}${isCurrentHour ? ' ⚡ AHORA' : ''}`;
            }
          }
        }
      },
      scales: {
        x: {
          title: { 
            display: true, 
            text: 'Hora del día',
            font: { size: 12, weight: 'bold' }
          },
          grid: { 
            display: true, 
            color: 'rgba(0,0,0,0.1)',
            lineWidth: 1
          },
          ticks: {
            font: { size: 11 }
          }
        },
        y: {
          title: { 
            display: true, 
            text: 'Precio (€/kWh)',
            font: { size: 12, weight: 'bold' }
          },
          grid: { 
            display: true, 
            color: 'rgba(0,0,0,0.1)',
            lineWidth: 1
          },
          ticks: {
            font: { size: 11 },
            callback: function(value) {
              return formatPrice(value) + ' €';
            }
          }
        }
      },
      interaction: {
        mode: 'nearest',
        axis: 'x',
        intersect: false
      },
      elements: {
        point: {
          hoverRadius: 8
        }
      }
    }
  });
  
  console.log('✅ Gráfico comparativo generado exitosamente');
}

// Función auxiliar para calcular precio por hora específica
function calculateTariffPriceForHour(tariff, pvpcPrice, hour) {
  const isWeekend = [0, 6].includes(new Date().getDay());
  
  let hourlyPrice = 0;
  
  // Validación de entrada
  if (!tariff || isNaN(pvpcPrice) || pvpcPrice < 0) {
    console.warn('⚠️ Datos inválidos en calculateTariffPriceForHour:', { tariff, pvpcPrice, hour });
    return pvpcPrice || 0.12; // Precio de respaldo
  }
  
  if (tariff.tipo === "Tarifa fija" && tariff.precio_fijo) {
    hourlyPrice = parseFloat(tariff.precio_fijo) || 0.12;
    
  } else if (tariff.tipo === "Tarifa plana fin de semana" && tariff.precio_laborable && tariff.precio_festivo !== undefined) {
    hourlyPrice = isWeekend ? (parseFloat(tariff.precio_festivo) || 0.10) : (parseFloat(tariff.precio_laborable) || 0.12);
    
  } else if (tariff.periodos) {
    let factor = 1.0;
    if (hour >= 10 && hour < 14 || hour >= 18 && hour < 22) {
      factor = tariff.periodos.punta?.factor || 1.25;
    } else if (hour >= 0 && hour < 8) {
      factor = tariff.periodos.valle?.factor || 0.75;
    } else {
      factor = tariff.periodos.llano?.factor || 1.0;
    }
    
    hourlyPrice = pvpcPrice * factor;
    
  } else if (tariff.margen_fijo) {
    hourlyPrice = pvpcPrice + (parseFloat(tariff.margen_fijo) || 0.015);
    
  } else {
    hourlyPrice = pvpcPrice;
  }
  
  // Asegurar que el resultado es un número válido
  if (isNaN(hourlyPrice) || hourlyPrice < 0) {
    console.warn('⚠️ Precio calculado inválido, usando respaldo:', hourlyPrice);
    hourlyPrice = pvpcPrice || 0.12;
  }
  
  return hourlyPrice; // Devolver solo el número, no un objeto
}

// ===== INFORMACIÓN DE COMPAÑÍAS ELÉCTRICAS ESPAÑOLAS (Orden alfabético) =====
const SPANISH_ENERGY_COMPANIES = {
  pvpc: {
    name: "PVPC (Precio Voluntario para el Pequeño Consumidor)",
    logo: "🏛️",
    description: "Tarifa regulada por el Estado español. Es la referencia oficial del mercado eléctrico español y se actualiza cada hora según la oferta y demanda.",
    tipo_compania: "Regulada por el Estado",
    regulacion: "Real Decreto 216/2014",
    tarifas: {
      "2.0TD - Con discriminación horaria": {
        tipo: "Discriminación horaria (3 períodos)",
        descripcion: "Tarifa con 3 tramos horarios: Valle (más barato), Llano (precio medio) y Punta (más caro). Ideal para adaptar tu consumo.",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00 (días laborables)", factor: 1.0, descripcion: "Horas más caras del día" },
          llano: { horas: "08:00-10:00, 14:00-18:00, 22:00-24:00", factor: 1.0, descripcion: "Precio intermedio" },
          valle: { horas: "00:00-08:00 (todos los días) + fines de semana completos", factor: 1.0, descripcion: "Horas más baratas" }
        },
        consejo: "Usa electrodomésticos de alto consumo durante las horas valle (madrugada y fines de semana) para ahorrar hasta un 50%",
        ventajas: ["Precio transparente y oficial", "Sin permanencia", "Ahorro programando consumo", "Acceso directo al mercado mayorista"],
        inconvenientes: ["Precio variable por horas", "Requiere planificación", "Facturas menos predecibles"]
      },
      "2.0A - Sin discriminación horaria": {
        tipo: "Precio único las 24 horas",
        descripcion: "Mismo precio durante todo el día. Simplicidad máxima sin necesidad de planificar el consumo por horarios.",
        precio_base: "Precio medio del mercado mayorista",
        consejo: "Ideal si no puedes o no quieres adaptar tus hábitos de consumo a diferentes horarios",
        ventajas: ["Simplicidad total", "Precio transparente", "Sin permanencia", "Facturas más predecibles"],
        inconvenientes: ["No aprovechas horas baratas", "Menor potencial de ahorro"]
      }
    },
    informacion_adicional: {
      como_contratar: "A través de comercializadoras de referencia o directamente con distribuidoras",
      quien_puede: "Consumidores con potencia contratada ≤ 10 kW",
      actualizacion: "Precios actualizados cada hora según el mercado mayorista OMIE",
      regulacion_completa: "Establecida por la CNMC (Comisión Nacional de los Mercados y la Competencia)"
    }
  },
  
  // === COMERCIALIZADORAS DE REFERENCIA (COR) - Aplican PVPC ===
  "iberdrola-cor": {
    name: "Iberdrola COR",
    logo: "🏛️",
    description: "Comercializadora de Referencia del grupo Iberdrola. Aplica estrictamente las tarifas PVPC reguladas por el Estado.",
    tipo_compania: "Comercializadora de Referencia (COR)",
    tarifas: {
      "2.0TD - Con discriminación horaria": {
        tipo: "PVPC con discriminación horaria + margen COR",
        descripcion: "Tarifa PVPC oficial con 3 períodos horarios + margen regulado",
        precio_base: "PVPC + margen regulado",
        margen_fijo: 0.003, // 0.3 céntimos/kWh - margen típico COR
        es_cor: true,
        consejo: "Tarifa regulada oficial con mínimo sobrecosto - aprovecha horas valle para ahorrar"
      },
      "2.0A - Sin discriminación horaria": {
        tipo: "PVPC sin discriminación + margen COR",
        descripcion: "Tarifa PVPC oficial con precio único + margen regulado",
        precio_base: "PVPC + margen regulado",
        margen_fijo: 0.003, // 0.3 céntimos/kWh - margen típico COR
        es_cor: true,
        consejo: "Precio oficial fijo las 24h + margen mínimo regulado - máxima tranquilidad"
      }
    }
  },
  
  "endesa-cor": {
    name: "Endesa Energía XXI",
    logo: "🏛️", 
    description: "Comercializadora de Referencia del grupo Endesa. Aplica tarifas PVPC con los márgenes mínimos permitidos.",
    tipo_compania: "Comercializadora de Referencia (COR)",
    tarifas: {
      "2.0TD - Con discriminación horaria": {
        tipo: "PVPC con discriminación horaria + margen COR",
        descripcion: "Tarifa PVPC oficial con 3 períodos horarios + margen regulado",
        precio_base: "PVPC + margen regulado",
        margen_fijo: 0.004, // 0.4 céntimos/kWh - margen típico COR
        es_cor: true,
        consejo: "COR de Endesa con PVPC oficial - usa horas valle (00:00-08:00) para mayor ahorro"
      },
      "2.0A - Sin discriminación horaria": {
        tipo: "PVPC sin discriminación + margen COR", 
        descripcion: "Tarifa PVPC oficial con precio único + margen regulado",
        precio_base: "PVPC + margen regulado",
        margen_fijo: 0.004, // 0.4 céntimos/kWh - margen típico COR
        es_cor: true,
        consejo: "Tarifa regulada sin horarios - consume cuando quieras con margen mínimo"
      }
    }
  },
  
  "naturgy-cor": {
    name: "Naturgy Iberia",
    logo: "🏛️",
    description: "Comercializadora de Referencia del grupo Naturgy. Ofrece las tarifas PVPC reguladas oficiales.",
    tipo_compania: "Comercializadora de Referencia (COR)", 
    tarifas: {
      "2.0TD - Con discriminación horaria": {
        tipo: "PVPC con discriminación horaria + margen COR",
        descripcion: "Tarifa PVPC oficial con 3 períodos horarios + margen regulado",
        precio_base: "PVPC + margen regulado",
        margen_fijo: 0.0035, // 0.35 céntimos/kWh - margen típico COR
        es_cor: true,
        consejo: "COR de Naturgy con precios oficiales - optimiza consumo en horario valle"
      },
      "2.0A - Sin discriminación horaria": {
        tipo: "PVPC sin discriminación + margen COR",
        descripcion: "Tarifa PVPC oficial con precio único + margen regulado", 
        precio_base: "PVPC + margen regulado",
        margen_fijo: 0.0035, // 0.35 céntimos/kWh - margen típico COR
        es_cor: true,
        consejo: "Simplicidad total con precio regulado único - sin horarios que recordar"
      }
    }
  },
  
  "edp-cor": {
    name: "EDP Comercializadora de Último Recurso",
    logo: "🏛️",
    description: "Comercializadora de Referencia de EDP. Aplica exclusivamente tarifas PVPC reguladas por el Estado.",
    tipo_compania: "Comercializadora de Referencia (COR)",
    tarifas: {
      "2.0TD - Con discriminación horaria": {
        tipo: "PVPC con discriminación horaria + margen COR",
        descripcion: "Tarifa PVPC oficial con 3 períodos horarios + margen regulado",
        precio_base: "PVPC + margen regulado",
        margen_fijo: 0.0025, // 0.25 céntimos/kWh - margen típico COR
        es_cor: true,
        consejo: "EDP COR con menor margen regulado - máximo ahorro en tarifa oficial"
      },
      "2.0A - Sin discriminación horaria": {
        tipo: "PVPC sin discriminación + margen COR",
        descripcion: "Tarifa PVPC oficial con precio único + margen regulado",
        precio_base: "PVPC + margen regulado",
        margen_fijo: 0.0025, // 0.25 céntimos/kWh - margen típico COR
        es_cor: true,
        consejo: "El margen COR más bajo - tarifa regulada con mínimo sobrecosto"
      }
    }
  },
  
  "repsol-cor": {
    name: "Repsol Comercializadora de Último Recurso", 
    logo: "🏛️",
    description: "Comercializadora de Referencia de Repsol. Ofrece únicamente tarifas PVPC con márgenes regulados mínimos.",
    tipo_compania: "Comercializadora de Referencia (COR)",
    tarifas: {
      "2.0TD - Con discriminación horaria": {
        tipo: "PVPC con discriminación horaria + margen COR",
        descripcion: "Tarifa PVPC oficial con 3 períodos horarios + margen regulado", 
        precio_base: "PVPC + margen regulado",
        margen_fijo: 0.003, // 0.3 céntimos/kWh - margen típico COR
        es_cor: true,
        consejo: "Repsol COR con precios oficiales - planifica consumo en valle para ahorrar"
      },
      "2.0A - Sin discriminación horaria": {
        tipo: "PVPC sin discriminación + margen COR",
        descripcion: "Tarifa PVPC oficial con precio único + margen regulado",
        precio_base: "PVPC + margen regulado",
        margen_fijo: 0.003, // 0.3 céntimos/kWh - margen típico COR
        es_cor: true,
        consejo: "Tarifa regulada única - predictibilidad con margen oficial mínimo"
      }
    }
  },
  
  // === COMPAÑÍAS DE MERCADO LIBRE ===
  asenergy: {
    name: "Asenergy",
    logo: "⚡",
    description: "Comercializadora independiente especializada en tarifas competitivas",
    tarifas: {
      "Tarifa Indexada": {
        tipo: "Precio indexado al mercado",
        descripcion: "Precio que sigue el mercado mayorista + margen competitivo",
        margen_fijo: 0.015,
        consejo: "Sigue los precios PVPC oficiales con margen mínimo"
      },
      "Tarifa con Discriminación Horaria": {
        tipo: "Discriminación horaria",
        descripcion: "3 períodos con precios diferenciados",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00", factor: 1.25 },
          llano: { horas: "8:00-10:00, 14:00-18:00, 22:00-24:00", factor: 1.0 },
          valle: { horas: "00:00-8:00", factor: 0.75 }
        },
        consejo: "Aprovecha las horas valle para electrodomésticos de alto consumo"
      },
      "Tarifa Verde Plus": {
        tipo: "Energía renovable indexada",
        descripcion: "Electricidad de origen renovable + precio de mercado",
        margen_fijo: 0.02,
        consejo: "Consume limpio siguiendo los precios más bajos del mercado"
      }
    }
  },
  iberdrola: {
    name: "Iberdrola",
    logo: "🟦",
    description: "Una de las principales eléctricas de España",
    tarifas: {
      "One Luz": {
        tipo: "Discriminación horaria",
        descripcion: "Tarifa con 3 períodos horarios diferentes",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00", factor: 1.3 },
          llano: { horas: "8:00-10:00, 14:00-18:00, 22:00-24:00", factor: 1.0 },
          valle: { horas: "00:00-8:00", factor: 0.7 }
        },
        consejo: "Usa electrodomésticos entre 00:00-08:00 para máximo ahorro"
      },
      "Tempo Happy": {
        tipo: "Tarifa plana fin de semana",
        descripcion: "Gratis los fines de semana de 00:00 a 24:00",
        precio_laborable: 0.25,
        precio_festivo: 0.0,
        consejo: "Concentra el consumo máximo en sábados y domingos"
      }
    }
  },
  endesa: {
    name: "Endesa",
    logo: "🔵",
    description: "Mayor distribuidora eléctrica de España",
    tarifas: {
      "One Luz": {
        tipo: "Discriminación horaria",
        descripcion: "3 períodos con precios diferenciados",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00", factor: 1.25 },
          llano: { horas: "8:00-10:00, 14:00-18:00, 22:00-24:00", factor: 1.0 },
          valle: { horas: "00:00-8:00", factor: 0.75 }
        },
        consejo: "Programa electrodomésticos para madrugada (00:00-08:00)"
      },
      "Tempo Fijo": {
        tipo: "Tarifa fija",
        descripcion: "Precio fijo durante 12 meses",
        precio_fijo: 0.28,
        consejo: "Ideal si quieres previsibilidad total en tu factura"
      }
    }
  },
  naturgy: {
    name: "Naturgy (Gas Natural Fenosa)",
    logo: "🟢",
    description: "Anteriormente Gas Natural Fenosa",
    tarifas: {
      "Tarifa Online": {
        tipo: "Discriminación horaria",
        descripcion: "Gestión 100% digital con 3 períodos",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00", factor: 1.28 },
          llano: { horas: "8:00-10:00, 14:00-18:00, 22:00-24:00", factor: 1.0 },
          valle: { horas: "00:00-8:00", factor: 0.72 }
        },
        consejo: "Descuento adicional por gestión online"
      },
      "Tempo Libre": {
        tipo: "Precio indexado",
        descripcion: "Precio vinculado al mercado mayorista",
        consejo: "Sigue los precios de esta app para optimizar consumo"
      }
    }
  },
  edp: {
    name: "EDP",
    logo: "🔴",
    description: "Energías de Portugal en España",
    tarifas: {
      "Comercial": {
        tipo: "Discriminación horaria",
        descripcion: "Tarifa estándar con 3 períodos",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00", factor: 1.27 },
          llano: { horas: "8:00-10:00, 14:00-18:00, 22:00-24:00", factor: 1.0 },
          valle: { horas: "00:00-8:00", factor: 0.73 }
        },
        consejo: "Aprovecha las horas valle para electrodomésticos"
      }
    }
  },
  repsol: {
    name: "Repsol",
    logo: "🟠",
    description: "Repsol Electricidad y Gas",
    tarifas: {
      "Tarifa Eficiencia": {
        tipo: "Discriminación horaria mejorada",
        descripcion: "Mayor diferencia entre períodos",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00", factor: 1.35 },
          llano: { horas: "8:00-10:00, 14:00-18:00, 22:00-24:00", factor: 1.0 },
          valle: { horas: "00:00-8:00", factor: 0.65 }
        },
        consejo: "¡La que más ahorro da! Usa electrodomésticos en madrugada"
      }
    }
  },
  totalenergies: {
    name: "TotalEnergies",
    logo: "🟣",
    description: "Anteriormente Total Direct Energia",
    tarifas: {
      "Essential": {
        tipo: "Tarifa fija",
        descripcion: "Precio fijo garantizado 12 meses",
        precio_fijo: 0.26,
        consejo: "Sin discriminación horaria - consume cuando quieras"
      },
      "Smart": {
        tipo: "Indexada al mercado",
        descripcion: "Precio sigue el mercado eléctrico",
        consejo: "Usa esta app para saber cuándo consumir menos"
      }
    }
  },
  factorenergia: {
    name: "Factor Energía",
    logo: "⚡",
    description: "Especializada en tarifas competitivas",
    tarifas: {
      "Factor 3.0": {
        tipo: "Discriminación horaria",
        descripcion: "3 períodos optimizados",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00", factor: 1.24 },
          llano: { horas: "8:00-10:00, 14:00-18:00, 22:00-24:00", factor: 1.0 },
          valle: { horas: "00:00-8:00", factor: 0.76 }
        },
        consejo: "Buena relación calidad-precio en todos los períodos"
      }
    }
  },
  holaluz: {
    name: "Holaluz",
    logo: "☀️",
    description: "100% energía verde",
    tarifas: {
      "Tarifa Verde": {
        tipo: "Tarifa plana ecológica",
        descripcion: "Precio fijo con energía 100% renovable",
        precio_fijo: 0.29,
        consejo: "Consume con tranquilidad - energía limpia las 24h"
      },
      "Tarifa Solar": {
        tipo: "Autoconsumo solar + mercado",
        descripcion: "Para usuarios con placas solares + precio indexado",
        margen_fijo: 0.018, // 1.8 céntimos/kWh - margen autoconsumo
        consejo: "Usa electrodomésticos durante las horas de sol (10:00-16:00)"
      }
    }
  },
  somenergia: {
    name: "Som Energia",
    logo: "🌱",
    description: "Cooperativa de energías renovables",
    tarifas: {
      "Cooperativa": {
        tipo: "Tarifa indexada cooperativa",
        descripcion: "Precio de coste + margen mínimo cooperativa",
        margen_fijo: 0.012, // 1.2 céntimos/kWh - margen cooperativa
        consejo: "Sigue el mercado mayorista con margen mínimo - usa esta app para optimizar"
      },
      "Cooperativa 2.0TD": {
        tipo: "Discriminación horaria cooperativa",
        descripcion: "Tarifa cooperativa con 3 períodos horarios optimizados",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00", factor: 1.15 },
          llano: { horas: "8:00-10:00, 14:00-18:00, 22:00-24:00", factor: 1.0 },
          valle: { horas: "00:00-8:00", factor: 0.8 }
        },
        consejo: "Cooperativa con discriminación horaria - ideal para optimizar consumo"
      }
    }
  },
  lucera: {
    name: "Lucera",
    logo: "💡",
    description: "Comercializadora digital",
    tarifas: {
      "Inteligente": {
        tipo: "Precio por horas indexado",
        descripcion: "Precio diferente cada hora del día + margen competitivo",
        margen_fijo: 0.016, // 1.6 céntimos/kWh - margen comercializadora digital
        consejo: "¡PERFECTA para esta app! Comprueba precios hora a hora"
      },
      "Smart": {
        tipo: "Discriminación horaria digital",
        descripcion: "Tarifa inteligente con 3 períodos optimizados",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00", factor: 1.2 },
          llano: { horas: "8:00-10:00, 14:00-18:00, 22:00-24:00", factor: 1.0 },
          valle: { horas: "00:00-8:00", factor: 0.75 }
        },
        consejo: "Aprovecha la tecnología para optimizar tu consumo horario"
      }
    }
  },
  pvpc: {
    name: "PVPC (Tarifa Regulada)",
    logo: "🏛️",
    description: "Tarifa oficial regulada por el gobierno",
    tarifas: {
      "2.0TD": {
        tipo: "Discriminación horaria regulada",
        descripcion: "3 períodos establecidos por el gobierno",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00", factor: 1.0 },
          llano: { horas: "8:00-10:00, 14:00-18:00, 22:00-24:00", factor: 0.85 },
          valle: { horas: "00:00-8:00", factor: 0.65 }
        },
        consejo: "La base de esta app - sigue estos precios oficiales"
      }
    }
  }
};

// Función para mostrar información de la compañía
function showCompanyInfo() {
  const selector = document.getElementById('company-selector');
  const companyKey = selector.value;
  const infoDiv = document.getElementById('company-info');
  const calculatorDiv = document.getElementById('tariff-calculator');
  
  if (!companyKey) {
    infoDiv.style.display = 'none';
    calculatorDiv.style.display = 'none';
    return;
  }
  
  const company = SPANISH_ENERGY_COMPANIES[companyKey];
  
  let html = `
    <div style="background: linear-gradient(45deg, #f8f9fa, #e9ecef); border-radius: 16px; padding: 25px; border: 2px solid #dee2e6;">
      <h4 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.4rem;">
        ${company.logo} ${company.name}
      </h4>
      <p style="color: #6c757d; margin-bottom: 20px; font-size: 1rem;">
        ${company.description}
      </p>
      
      <h5 style="color: #e74c3c; margin-bottom: 15px;">📋 Tarifas Disponibles:</h5>
  `;
  
  for (const [tarifaName, tarifa] of Object.entries(company.tarifas)) {
    html += `
      <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; border-left: 4px solid #3498db; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h6 style="color: #2c3e50; margin-bottom: 10px; font-size: 1.1rem;">
          ⚡ ${tarifaName}
        </h6>
        <p style="color: #7f8c8d; margin-bottom: 12px;">
          <strong>Tipo:</strong> ${tarifa.tipo}
        </p>
        <p style="color: #34495e; margin-bottom: 12px;">
          ${tarifa.descripcion}
        </p>
    `;
    
    if (tarifa.periodos) {
      html += `
        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin: 10px 0;">
          <strong style="color: #2c3e50;">Períodos horarios:</strong>
          <ul style="margin: 8px 0; padding-left: 20px;">
            <li><strong style="color: #e74c3c;">Punta:</strong> ${tarifa.periodos.punta.horas} (${(tarifa.periodos.punta.factor * 100).toFixed(0)}% precio base)</li>
            <li><strong style="color: #f39c12;">Llano:</strong> ${tarifa.periodos.llano.horas} (${(tarifa.periodos.llano.factor * 100).toFixed(0)}% precio base)</li>
            <li><strong style="color: #27ae60;">Valle:</strong> ${tarifa.periodos.valle.horas} (${(tarifa.periodos.valle.factor * 100).toFixed(0)}% precio base)</li>
          </ul>
        </div>
      `;
    }
    
    if (tarifa.precio_fijo) {
      html += `
        <div style="background: #e8f5e8; padding: 12px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #27ae60;">
          <strong style="color: #27ae60;">💰 Precio fijo:</strong> ${tarifa.precio_fijo}€/kWh las 24 horas
        </div>
      `;
    }
    
    if (tarifa.precio_laborable !== undefined) {
      html += `
        <div style="background: #fff3e0; padding: 12px; border-radius: 8px; margin: 10px 0;">
          <strong style="color: #f39c12;">📅 Precios:</strong><br>
          • Días laborables: ${tarifa.precio_laborable}€/kWh<br>
          • Fines de semana: ${tarifa.precio_festivo}€/kWh
        </div>
      `;
    }
    
    html += `
      <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-top: 12px; border-left: 3px solid #2196f3;">
        <strong style="color: #1976d2;">💡 Consejo:</strong> ${tarifa.consejo}
      </div>
      <button onclick="calculateForTariff('${companyKey}', '${tarifaName}')" style="
        background: linear-gradient(45deg, #27ae60, #2ecc71);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 700;
        margin-top: 12px;
        transition: all 0.3s ease;
      " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
        🧮 Calcular ahorro con esta tarifa
      </button>
      </div>
    `;
  }
  
  html += `</div>`;
  
  infoDiv.innerHTML = html;
  infoDiv.style.display = 'block';
}

// Función para calcular ahorro específico por tarifa
function calculateForTariff(companyKey, tarifaName) {
  const company = SPANISH_ENERGY_COMPANIES[companyKey];
  const tarifa = company.tarifas[tarifaName];
  const calculatorDiv = document.getElementById('tariff-calculator');
  
  let html = `
    <div style="background: linear-gradient(45deg, #e8f5e8, #f0f8ff); border-radius: 16px; padding: 25px; border: 2px solid #27ae60;">
      <h4 style="color: #27ae60; margin-bottom: 15px;">
        🧮 Calculadora para ${company.name} - ${tarifaName}
      </h4>
      
      <div class="input-group" style="margin-bottom: 20px;">
        <input type="number" id="tariff-consumption" placeholder="Consumo en kWh (ej: 2.5)" step="0.1" min="0" style="
          padding: 12px 16px;
          border: 2px solid #27ae60;
          border-radius: 8px;
          font-size: 1rem;
          width: 200px;
          margin-right: 10px;
        ">
        <button onclick="calculateSpecificTariff('${companyKey}', '${tarifaName}')" style="
          background: linear-gradient(45deg, #27ae60, #2ecc71);
          color: white;
          border: none;
          padding: 12px 20px;
          border-radius: 8px;
          cursor: pointer;
          font-weight: 700;
        ">
          💰 Calcular ahorro
        </button>
      </div>
      
      <div id="tariff-results"></div>
    </div>
  `;
  
  calculatorDiv.innerHTML = html;
  calculatorDiv.style.display = 'block';
}

// Función para calcular ahorro específico
function calculateSpecificTariff(companyKey, tarifaName) {
  const consumptionElement = document.getElementById('tariff-consumption');
  if (!consumptionElement) {
    console.warn('⚠️ Elemento tariff-consumption no encontrado');
    return;
  }
  
  const consumption = parseFloat(consumptionElement.value);
  if (!consumption || consumption <= 0) {
    alert('Por favor, introduce un consumo válido');
    return;
  }
  
  const company = SPANISH_ENERGY_COMPANIES[companyKey];
  const tarifa = company.tarifas[tarifaName];
  const resultsDiv = document.getElementById('tariff-results');
  
  let html = `
    <div style="background: white; border-radius: 12px; padding: 20px; border-left: 4px solid #27ae60;">
      <h5 style="color: #27ae60; margin-bottom: 15px;">
        📊 Análisis de ahorro para ${consumption} kWh
      </h5>
  `;
  
  if (tarifa.periodos) {
    // Tarifa con discriminación horaria
    const precioBase = 0.25; // Precio base de referencia
    
    const costoPunta = consumption * precioBase * tarifa.periodos.punta.factor;
    const costoLlano = consumption * precioBase * tarifa.periodos.llano.factor;
    const costoValle = consumption * precioBase * tarifa.periodos.valle.factor;
    
    const ahorroMaximo = costoPunta - costoValle;
    const porcentajeAhorro = ((ahorroMaximo / costoPunta) * 100).toFixed(1);
    
    html += `
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div style="background: #ffebee; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #f44336;">
          <div style="font-size: 1.2rem; color: #d32f2f; font-weight: 700;">🔴 PUNTA</div>
          <div style="font-size: 1.1rem; color: #2c3e50; margin-top: 5px;">${costoPunta.toFixed(3)}€</div>
          <div style="font-size: 0.9rem; color: #666;">${tarifa.periodos.punta.horas}</div>
        </div>
        <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #ff9800;">
          <div style="font-size: 1.2rem; color: #f57c00; font-weight: 700;">🟡 LLANO</div>
          <div style="font-size: 1.1rem; color: #2c3e50; margin-top: 5px;">${costoLlano.toFixed(3)}€</div>
          <div style="font-size: 0.9rem; color: #666;">${tarifa.periodos.llano.horas}</div>
        </div>
        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #4caf50;">
          <div style="font-size: 1.2rem; color: #388e3c; font-weight: 700;">🟢 VALLE</div>
          <div style="font-size: 1.1rem; color: #2c3e50; margin-top: 5px;">${costoValle.toFixed(3)}€</div>
          <div style="font-size: 0.9rem; color: #666;">${tarifa.periodos.valle.horas}</div>
        </div>
      </div>
      
      <div style="background: #e3f2fd; padding: 20px; border-radius: 12px; border-left: 4px solid #2196f3; margin-bottom: 15px;">
        <h6 style="color: #1976d2; margin-bottom: 10px;">💰 Potencial de ahorro:</h6>
        <div style="font-size: 1.3rem; color: #2c3e50; font-weight: 700;">
          ¡Puedes ahorrar hasta ${ahorroMaximo.toFixed(3)}€ (${porcentajeAhorro}%) por cada ${consumption} kWh!
        </div>
        <div style="margin-top: 10px; color: #555; font-size: 0.95rem;">
          Usando electrodomésticos en horas valle vs. horas punta
        </div>
      </div>
      
      <div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">
        <strong style="color: #7b1fa2;">🎯 Recomendación:</strong> ${tarifa.consejo}
      </div>
    `;
    
  } else if (tarifa.precio_fijo) {
    // Tarifa plana
    const costoTotal = consumption * tarifa.precio_fijo;
    
    html += `
      <div style="background: #e8f5e8; padding: 20px; border-radius: 12px; text-align: center;">
        <h6 style="color: #27ae60; margin-bottom: 15px;">💰 Costo con tarifa plana:</h6>
        <div style="font-size: 2rem; color: #2c3e50; font-weight: 700; margin-bottom: 10px;">
          ${costoTotal.toFixed(3)}€
        </div>
        <div style="color: #666; font-size: 1rem;">
          Para ${consumption} kWh a ${tarifa.precio_fijo}€/kWh
        </div>
      </div>
      
      <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px;">
        <strong style="color: #f57c00;">✅ Ventaja:</strong> Precio fijo las 24 horas - consume cuando quieras sin preocuparte por horarios
      </div>
      
      <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-top: 10px;">
        <strong style="color: #d32f2f;">⚠️ Comparación:</strong> Con tarifa de discriminación horaria podrías ahorrar hasta un 35% usando electrodomésticos en madrugada
      </div>
    `;
    
  } else if (tarifa.precio_laborable !== undefined) {
    // Tarifa con diferencia laborable/festivo
    const costoLaborable = consumption * tarifa.precio_laborable;
    const costoFestivo = consumption * tarifa.precio_festivo;
    const ahorro = costoLaborable - costoFestivo;
    
    html += `
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div style="background: #ffebee; padding: 20px; border-radius: 12px; text-align: center;">
          <h6 style="color: #d32f2f; margin-bottom: 10px;">📅 Días laborables</h6>
          <div style="font-size: 1.5rem; color: #2c3e50; font-weight: 700;">${costoLaborable.toFixed(3)}€</div>
        </div>
        <div style="background: #e8f5e8; padding: 20px; border-radius: 12px; text-align: center;">
          <h6 style="color: #27ae60; margin-bottom: 10px;">🎉 Fines de semana</h6>
          <div style="font-size: 1.5rem; color: #2c3e50; font-weight: 700;">${costoFestivo.toFixed(3)}€</div>
        </div>
      </div>
      
      <div style="background: #e3f2fd; padding: 20px; border-radius: 12px; border-left: 4px solid #2196f3;">
        <h6 style="color: #1976d2; margin-bottom: 10px;">💰 Ahorro en fin de semana:</h6>
        <div style="font-size: 1.3rem; color: #2c3e50; font-weight: 700;">
          ${ahorro.toFixed(3)}€ por cada ${consumption} kWh
        </div>
      </div>
    `;
  }
  
  html += `
    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center;">
      <strong style="color: #2c3e50;">💡 Consejo personalizado:</strong><br>
      ${tarifa.consejo}
    </div>
  </div>`;
  
  resultsDiv.innerHTML = html;
}

// ===== FUNCIÓN PARA MOSTRAR SOLO INFORMACIÓN DE COMPAÑÍAS (SIN CALCULADORAS) =====
function showCompanyInfoOnly() {
  const selector = document.getElementById('company-selector');
  const companyKey = selector.value;
  const infoDiv = document.getElementById('company-info-display');
  
  if (!companyKey) {
    infoDiv.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #7f8c8d;">
        <span style="font-size: 3rem;">🏢</span>
        <p>Selecciona una compañía para ver información detallada sobre sus tarifas</p>
      </div>
    `;
    return;
  }
  
  const company = SPANISH_ENERGY_COMPANIES[companyKey];
  
  let html = `
    <div style="background: linear-gradient(45deg, #f8f9fa, #e9ecef); border-radius: 16px; padding: 25px; border: 2px solid #dee2e6; margin-top: 20px;">
      <div style="text-align: center; margin-bottom: 25px;">
        <div style="font-size: 4rem; margin-bottom: 10px;">${company.logo}</div>
        <h4 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.8rem;">
          ${company.name}
        </h4>
        <p style="color: #6c757d; margin-bottom: 20px; font-size: 1.1rem; max-width: 800px; margin-left: auto; margin-right: auto; line-height: 1.5;">
          ${company.description}
        </p>
  `;
  
  // Información adicional para PVPC
  if (companyKey === 'pvpc') {
    html += `
      <div style="background: linear-gradient(45deg, #e3f2fd, #f3e5f5); border-radius: 12px; padding: 20px; margin: 20px 0; border: 2px solid #2196f3;">
        <h5 style="color: #1976d2; margin-bottom: 15px; text-align: center;">🏛️ Información Oficial PVPC</h5>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
          <div style="background: white; padding: 15px; border-radius: 8px;">
            <strong style="color: #1976d2;">🏢 Tipo:</strong> ${company.tipo_compania}
          </div>
          <div style="background: white; padding: 15px; border-radius: 8px;">
            <strong style="color: #1976d2;">📋 Regulación:</strong> ${company.regulacion}
          </div>
          <div style="background: white; padding: 15px; border-radius: 8px;">
            <strong style="color: #1976d2;">⏱️ Actualización:</strong> ${company.informacion_adicional.actualizacion}
          </div>
          <div style="background: white; padding: 15px; border-radius: 8px;">
            <strong style="color: #1976d2;">👥 Quién puede:</strong> ${company.informacion_adicional.quien_puede}
          </div>
        </div>
      </div>
    `;
  }
  
  html += `
        <h5 style="color: #e74c3c; margin-bottom: 20px; text-align: center; font-size: 1.4rem;">📋 Tarifas Disponibles</h5>
      </div>
  `;
  
  // Mostrar todas las tarifas
  Object.entries(company.tarifas).forEach(([tarifaName, tarifa]) => {
    html += `
      <div style="background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; border-left: 4px solid #3498db; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <h6 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.3rem; text-align: center;">
          ⚡ ${tarifaName}
        </h6>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div>
              <strong style="color: #2c3e50;">📊 Tipo:</strong>
              <div style="color: #7f8c8d; margin-top: 5px;">${tarifa.tipo}</div>
            </div>
            <div>
              <strong style="color: #2c3e50;">📝 Descripción:</strong>
              <div style="color: #7f8c8d; margin-top: 5px;">${tarifa.descripcion}</div>
            </div>
          </div>
        </div>
    `;
    
    // Mostrar períodos horarios si existen
    if (tarifa.periodos) {
      html += `
        <div style="background: linear-gradient(45deg, #fff3e0, #f3e5f5); padding: 20px; border-radius: 12px; margin: 15px 0;">
          <h6 style="color: #f57c00; margin-bottom: 15px; text-align: center;">⏰ Períodos Horarios</h6>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
      `;
      
      Object.entries(tarifa.periodos).forEach(([periodoNombre, periodo]) => {
        let colorPeriodo = '#2196f3';
        let iconoPeriodo = '⚡';
        
        if (periodoNombre === 'punta') {
          colorPeriodo = '#f44336';
          iconoPeriodo = '🔴';
        } else if (periodoNombre === 'llano') {
          colorPeriodo = '#ff9800';
          iconoPeriodo = '🟡';
        } else if (periodoNombre === 'valle') {
          colorPeriodo = '#4caf50';
          iconoPeriodo = '🟢';
        }
        
        html += `
          <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid ${colorPeriodo};">
            <div style="text-align: center; margin-bottom: 10px;">
              <span style="font-size: 1.5rem;">${iconoPeriodo}</span>
              <strong style="color: ${colorPeriodo}; display: block; margin-top: 5px; text-transform: uppercase;">
                ${periodoNombre}
              </strong>
            </div>
            <div style="color: #2c3e50; font-size: 0.9rem; line-height: 1.4;">
              <strong>Horarios:</strong><br>
              ${periodo.horas}
            </div>
            ${periodo.factor ? `
              <div style="margin-top: 10px; color: #2c3e50; font-size: 0.9rem;">
                <strong>Factor:</strong> ${(periodo.factor * 100).toFixed(0)}% del precio base
              </div>
            ` : ''}
            ${periodo.descripcion ? `
              <div style="margin-top: 10px; color: #7f8c8d; font-size: 0.85rem; font-style: italic;">
                ${periodo.descripcion}
              </div>
            ` : ''}
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
      `;
    }
    
    // Mostrar precio fijo si existe
    if (tarifa.precio_fijo) {
      html += `
        <div style="background: linear-gradient(45deg, #e8f5e8, #f0f8ff); padding: 20px; border-radius: 12px; margin: 15px 0; text-align: center;">
          <h6 style="color: #27ae60; margin-bottom: 10px;">💰 Precio Fijo</h6>
          <div style="font-size: 1.8rem; color: #2c3e50; font-weight: bold; margin-bottom: 5px;">
            ${tarifa.precio_fijo}€/kWh
          </div>
          <div style="color: #7f8c8d; font-size: 0.9rem;">Las 24 horas del día</div>
        </div>
      `;
    }
    
    // Mostrar precios laborable/festivo si existen
    if (tarifa.precio_laborable !== undefined) {
      html += `
        <div style="background: linear-gradient(45deg, #fff3e0, #f3e5f5); padding: 20px; border-radius: 12px; margin: 15px 0;">
          <h6 style="color: #f57c00; margin-bottom: 15px; text-align: center;">📅 Precios por Tipo de Día</h6>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #ff5722;">
              <strong style="color: #ff5722;">📅 Días Laborables</strong>
              <div style="font-size: 1.4rem; color: #2c3e50; font-weight: bold; margin-top: 5px;">
                ${tarifa.precio_laborable}€/kWh
              </div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #4caf50;">
              <strong style="color: #4caf50;">🎉 Fines de Semana</strong>
              <div style="font-size: 1.4rem; color: #2c3e50; font-weight: bold; margin-top: 5px;">
                ${tarifa.precio_festivo}€/kWh
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    // Mostrar margen fijo si existe
    if (tarifa.margen_fijo) {
      html += `
        <div style="background: linear-gradient(45deg, #e3f2fd, #f3e5f5); padding: 15px; border-radius: 8px; margin: 15px 0;">
          <strong style="color: #1976d2;">📈 Margen sobre PVPC:</strong> +${tarifa.margen_fijo}€/kWh
          <div style="color: #7f8c8d; font-size: 0.9rem; margin-top: 5px;">
            Esta tarifa sigue el precio PVPC oficial + un margen fijo
          </div>
        </div>
      `;
    }
    
    // Mostrar ventajas e inconvenientes para PVPC
    if (companyKey === 'pvpc' && tarifa.ventajas) {
      html += `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
          <div style="background: linear-gradient(45deg, #e8f5e8, #f0f8ff); padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
            <h6 style="color: #4caf50; margin-bottom: 10px;">✅ Ventajas</h6>
            <ul style="margin: 0; padding-left: 20px; color: #2c3e50;">
              ${tarifa.ventajas.map(ventaja => `<li style="margin-bottom: 5px;">${ventaja}</li>`).join('')}
            </ul>
          </div>
          <div style="background: linear-gradient(45deg, #fff3e0, #ffebee); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
            <h6 style="color: #ff9800; margin-bottom: 10px;">⚠️ Consideraciones</h6>
            <ul style="margin: 0; padding-left: 20px; color: #2c3e50;">
              ${tarifa.inconvenientes.map(inconveniente => `<li style="margin-bottom: 5px;">${inconveniente}</li>`).join('')}
            </ul>
          </div>
        </div>
      `;
    }
    
    // Mostrar consejo
    html += `
      <div style="background: linear-gradient(45deg, #e3f2fd, #f3e5f5); padding: 20px; border-radius: 12px; border-left: 4px solid #2196f3; margin-top: 15px;">
        <div style="text-align: center;">
          <span style="font-size: 1.5rem; margin-bottom: 10px; display: block;">💡</span>
          <strong style="color: #1976d2; font-size: 1.1rem;">Consejo:</strong>
        </div>
        <div style="color: #2c3e50; margin-top: 10px; text-align: center; font-size: 1rem; line-height: 1.5;">
          ${tarifa.consejo}
        </div>
      </div>
    `;
    
    html += `</div>`;
  });
  
  html += `</div>`;
  
  infoDiv.innerHTML = html;
}

// ===== COMPARACIÓN DE COMPAÑÍAS =====
function generateCompanyComparison() {
  const consumptionElement = document.getElementById('comparison-consumption');
  if (!consumptionElement) {
    console.warn('⚠️ Elemento comparison-consumption no encontrado');
    return;
  }
  
  const consumption = parseFloat(consumptionElement.value);
  if (!consumption || consumption <= 0) {
    alert('Por favor, introduce un consumo válido para comparar');
    return;
  }
  
  const currentHour = new Date().getHours();
  const currentDate = new Date();
  const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
  
  // Calcular costos para cada compañía
  const comparisonData = [];
  const currentMarketPrice = globalPrices.length > 0 ? globalPrices[currentHour]?.precio || 0.25 : 0.25;
  
  for (const [key, company] of Object.entries(SPANISH_ENERGY_COMPANIES)) {
    for (const [tarifaName, tarifa] of Object.entries(company.tarifas)) {
      let cost = 0;
      let description = '';
      
      if (tarifa.periodos) {
        // Tarifa con discriminación horaria
        const factor = getCurrentPeriodFactor(currentHour, tarifa.periodos);
        cost = consumption * currentMarketPrice * factor;
        description = `${getCurrentPeriodName(currentHour, tarifa.periodos)}`;
      } else if (tarifa.precio_fijo) {
        // Tarifa fija
        cost = consumption * tarifa.precio_fijo;
        description = 'Precio fijo';
      } else if (tarifa.precio_laborable !== undefined) {
        // Tarifa con diferencia laborable/festivo
        const price = isWeekend ? tarifa.precio_festivo : tarifa.precio_laborable;
        cost = consumption * price;
        description = isWeekend ? 'Fin de semana' : 'Día laborable';
      } else if (tarifa.margen_fijo) {
        // Tarifa indexada
        cost = consumption * (currentMarketPrice + tarifa.margen_fijo);
        description = 'Indexada al mercado';
      } else {
        // Por defecto, usar precio de mercado
        cost = consumption * currentMarketPrice;
        description = 'Precio mercado';
      }
      
      comparisonData.push({
        company: company.name,
        tarifa: tarifaName,
        cost: cost,
        description: description,
        logo: company.logo,
        savings: 0 // Se calculará después
      });
    }
  }
  
  // Ordenar por precio (más barato primero)
  comparisonData.sort((a, b) => a.cost - b.cost);
  
  // Calcular ahorros relativos al más caro
  const mostExpensive = comparisonData[comparisonData.length - 1];
  comparisonData.forEach(item => {
    item.savings = mostExpensive.cost - item.cost;
  });
  
  // Crear gráfico
  createComparisonChart(comparisonData.slice(0, 8)); // Top 8 mejores
  
  // Mostrar ranking
  showCompanyRanking(comparisonData, consumption);
}

function getCurrentPeriodFactor(hour, periodos) {
  // Determinar el período actual basado en la hora
  if ((hour >= 10 && hour < 14) || (hour >= 18 && hour < 22)) {
    return periodos.punta?.factor || 1.3;
  } else if ((hour >= 8 && hour < 10) || (hour >= 14 && hour < 18) || (hour >= 22 || hour < 1)) {
    return periodos.llano?.factor || 1.0;
  } else {
    return periodos.valle?.factor || 0.7;
  }
}

function getCurrentPeriodName(hour, periodos) {
  if ((hour >= 10 && hour < 14) || (hour >= 18 && hour < 22)) {
    return 'Punta';
  } else if ((hour >= 8 && hour < 10) || (hour >= 14 && hour < 18) || (hour >= 22 || hour < 1)) {
    return 'Llano';
  } else {
    return 'Valle';
  }
}

function createComparisonChart(data) {
  const ctx = document.getElementById('comparison-chart').getContext('2d');
  
  if (comparisonChart) {
    comparisonChart.destroy();
  }
  
  const labels = data.map(item => {
    // Crear etiquetas más cortas y legibles
    const companyShort = item.company.length > 12 ? item.company.substring(0, 10) + '...' : item.company;
    const tarifaShort = item.tarifa.length > 15 ? item.tarifa.substring(0, 12) + '...' : item.tarifa;
    return [`${item.logo} ${companyShort}`, tarifaShort];
  });
  const costs = data.map(item => item.cost);
  const colors = [
    '#27ae60', '#2ecc71', '#3498db', '#9b59b6', 
    '#f39c12', '#e67e22', '#e74c3c', '#c0392b'
  ];
  
  comparisonChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Costo (€)',
        data: costs,
        backgroundColor: colors,
        borderColor: colors.map(color => color + '99'),
        borderWidth: 2,
        borderRadius: 8,
        borderSkipped: false,
        maxBarThickness: 60
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: `Comparativa de Precios - ${document.getElementById('comparison-consumption')?.value || 'N/A'} kWh`,
          font: { size: 18, weight: 'bold' },
          padding: 20
        },
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          titleColor: 'white',
          bodyColor: 'white',
          cornerRadius: 8,
          displayColors: false,
          callbacks: {
            title: function(context) {
              const item = data[context[0].dataIndex];
              return `${item.company} - ${item.tarifa}`;
            },
            label: function(context) {
              const item = data[context.dataIndex];
              return [
                `💰 Costo: ${item.cost.toFixed(3)}€`,
                `📊 Tipo: ${item.description}`,
                `💲 Ahorro vs más cara: ${item.savings.toFixed(3)}€`
              ];
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Costo (€)',
            font: { size: 14, weight: 'bold' }
          },
          ticks: {
            callback: function(value) {
              return value.toFixed(3) + '€';
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.1)'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Compañías y Tarifas',
            font: { size: 14, weight: 'bold' }
          },
          ticks: {
            maxRotation: 25,
            minRotation: 0,
            font: { size: 10 },
            padding: 5
          },
          grid: {
            display: false
          }
        }
      },
      layout: {
        padding: {
          top: 10,
          right: 10,
          bottom: 10,
          left: 10
        }
      }
    }
  });
}

function showCompanyRanking(data, consumption) {
  const rankingDiv = document.getElementById('company-ranking');
  
  let html = `
    <div style="background: linear-gradient(45deg, #f8f9fa, #e9ecef); border-radius: 16px; padding: 25px; border: 2px solid #dee2e6;">
      <h4 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">
        🏆 Ranking de Mejores Opciones para ${consumption} kWh HOY
      </h4>
      <div style="display: grid; gap: 15px;">
  `;
  
  data.slice(0, 5).forEach((item, index) => {
    const position = index + 1;
    const medal = position === 1 ? '🥇' : position === 2 ? '🥈' : position === 3 ? '🥉' : `${position}º`;
    const bgColor = position === 1 ? '#e8f5e8' : position === 2 ? '#fff3e0' : position === 3 ? '#ffebee' : '#f8f9fa';
    const borderColor = position === 1 ? '#27ae60' : position === 2 ? '#f39c12' : position === 3 ? '#e74c3c' : '#dee2e6';
    
    html += `
      <div style="background: ${bgColor}; padding: 15px; border-radius: 12px; border-left: 4px solid ${borderColor}; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 15px;">
          <span style="font-size: 1.5rem;">${medal}</span>
          <div>
            <div style="font-weight: 700; color: #2c3e50; font-size: 1.1rem;">
              ${item.logo} ${item.company} - ${item.tarifa}
            </div>
            <div style="color: #6c757d; font-size: 0.9rem;">${item.description}</div>
          </div>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 1.3rem; font-weight: 700; color: #2c3e50;">${item.cost.toFixed(3)}€</div>
          ${item.savings > 0 ? `<div style="color: #27ae60; font-size: 0.9rem;">Ahorras ${item.savings.toFixed(3)}€</div>` : ''}
        </div>
      </div>
    `;
  });
  
  html += `
      </div>
      <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center;">
        <strong style="color: #1976d2;">💡 Consejo:</strong> La diferencia entre la más barata y la más cara es de 
        <strong style="color: #e74c3c;">${(data[data.length-1].cost - data[0].cost).toFixed(3)}€</strong> 
        para este consumo. ¡Elige bien y ahorra!
      </div>
    </div>
  `;
  
  rankingDiv.innerHTML = html;
}

// ===== UTILITY FUNCTIONS =====
const formatTime = (num) => num.toString().padStart(2, "0");
const formatPrice = (price) => price.toFixed(3);

const showLoading = (elementId) => {
  const element = document.getElementById(elementId);
  if (element && !element.querySelector('.loading')) {
    element.innerHTML = '<span class="loading"></span>' + element.textContent;
  }
};

const hideLoading = (elementId) => {
  const element = document.getElementById(elementId);
  if (element) {
    const loading = element.querySelector('.loading');
    if (loading) loading.remove();
  }
};

// ===== PROMEDIO HISTÓRICO =====
function showHistoricalAverage() {
  console.log('📊 Generando promedio histórico...');
  
  const alertElement = document.getElementById("alerta");
  const originalContent = alertElement.innerHTML;
  alertElement.innerHTML = '<span class="loading"></span>Calculando promedio histórico...';
  
  try {
    const ctx = document.getElementById("grafico").getContext("2d");
    
    // Generar datos de promedio histórico basados en datos reales del mercado español
    const historicalData = generateHistoricalAverage();
    
    if (historicalData && historicalData.prices.length > 0) {
      globalPrices = historicalData.prices;
      updatePriceAlert(historicalData.prices, historicalData);
      renderPriceChart(ctx, historicalData.labels, historicalData.prices, historicalData.colors);
      
      updateApiStatus('offline', `Promedio histórico ${historicalData.context} (${historicalData.date})`);
      
      console.log('✅ Promedio histórico generado exitosamente');
    }
    
  } catch (err) {
    console.error("❌ Error generando promedio histórico:", err);
    alertElement.innerHTML = originalContent;
    updateApiStatus('error', 'Error generando promedio histórico');
  }
}

// Función para generar promedio histórico basado en datos reales
function generateHistoricalAverage() {
  const today = new Date();
  const dayOfWeek = today.getDay();
  const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
  const month = today.getMonth();
  const isSummer = month >= 5 && month <= 8;
  const isWinter = month >= 11 || month <= 2;
  
  // Promedios históricos reales del mercado español por tipo de día y estación
  // Basados en datos históricos de OMIE y REE
  
  let basePattern;
  let context;
  
  if (isWeekend && isSummer) {
    // Fin de semana verano - precios más bajos, menos variación
    basePattern = [0.074, 0.068, 0.063, 0.061, 0.066, 0.076, 0.089, 0.102, 0.094, 0.088, 0.084, 0.081, 0.079, 0.077, 0.081, 0.087, 0.095, 0.108, 0.125, 0.118, 0.106, 0.094, 0.086, 0.079];
    context = "fines de semana de verano";
  } else if (isWeekend && isWinter) {
    // Fin de semana invierno
    basePattern = [0.082, 0.076, 0.071, 0.069, 0.074, 0.084, 0.097, 0.110, 0.102, 0.096, 0.092, 0.089, 0.087, 0.085, 0.089, 0.095, 0.103, 0.116, 0.133, 0.126, 0.114, 0.102, 0.094, 0.087];
    context = "fines de semana de invierno";
  } else if (!isWeekend && isSummer) {
    // Entre semana verano - picos más altos por aire acondicionado
    basePattern = [0.089, 0.081, 0.075, 0.073, 0.079, 0.098, 0.128, 0.156, 0.142, 0.125, 0.118, 0.112, 0.108, 0.105, 0.112, 0.125, 0.145, 0.172, 0.198, 0.185, 0.165, 0.142, 0.122, 0.102];
    context = "días laborables de verano";
  } else if (!isWeekend && isWinter) {
    // Entre semana invierno - picos por calefacción
    basePattern = [0.095, 0.087, 0.081, 0.079, 0.085, 0.104, 0.134, 0.162, 0.148, 0.131, 0.124, 0.118, 0.114, 0.111, 0.118, 0.131, 0.151, 0.178, 0.204, 0.191, 0.171, 0.148, 0.128, 0.108];
    context = "días laborables de invierno";
  } else {
    // Primavera/otoño entre semana
    basePattern = [0.087, 0.079, 0.073, 0.071, 0.077, 0.096, 0.126, 0.154, 0.140, 0.123, 0.116, 0.110, 0.106, 0.103, 0.110, 0.123, 0.143, 0.170, 0.196, 0.183, 0.163, 0.140, 0.120, 0.100];
    context = "días laborables de primavera/otoño";
  }
  
  const labels = [];
  const prices = [];
  const colors = [];
  const currentHour = today.getHours();
  
  for (let i = 0; i < 24; i++) {
    labels.push(`${i.toString().padStart(2, '0')}:00`);
    
    // Pequeña variación aleatoria para simular la realidad de los promedios
    const variation = (Math.random() - 0.5) * 0.008; // ±0.8 céntimos
    const price = Math.max(0.050, basePattern[i] + variation);
    
    prices.push(parseFloat(price.toFixed(4)));
    
    // Colores según precio - destacar hora actual
    if (i === currentHour) {
      colors.push('#2196F3'); // Azul para hora actual
    } else if (price < 0.10) {
      colors.push('#27ae60'); // Verde
    } else if (price < 0.15) {
      colors.push('#f39c12'); // Naranja
    } else {
      colors.push('#e74c3c'); // Rojo
    }
  }
  
  return {
    labels: labels,
    prices: prices,
    colors: colors,
    source: 'Promedio Histórico',
    date: today.toLocaleDateString('es-ES'),
    timestamp: new Date().toISOString(),
    context: context,
    dataType: 'historical_average'
  };
}

// ===== CLOCK FUNCTIONALITY =====
function initializeClock() {
  const currentHourText = document.getElementById("current-hour-text");
  let lastHour = new Date().getHours();
  
  const updateClock = () => {
    // Usar la zona horaria de España (Europe/Madrid)
    const now = new Date();
    const spainTime = new Date(now.toLocaleString("en-US", {timeZone: "Europe/Madrid"}));
    
    const hours = formatTime(spainTime.getHours());
    
    // Actualizar indicador de hora actual en el gráfico
    if (currentHourText) {
      currentHourText.textContent = `${hours}:00`;
    }
    
    // Si cambió la hora, actualizar el gráfico
    const currentHour = spainTime.getHours();
    if (currentHour !== lastHour && priceChart && globalPrices.length > 0) {
      console.log('🕐 Cambio de hora detectado, actualizando gráfico...');
      lastHour = currentHour;
      
      // Regenerar el gráfico con la nueva hora actual destacada
      const ctx = document.getElementById("grafico").getContext("2d");
      const labels = globalPrices.map((_, i) => `${formatTime(i)}:00`);
      
      // Recalcular colores con la nueva hora actual
      const colors = globalPrices.map((price, i) => {
        if (i === currentHour) {
          return '#2196F3'; // Azul para hora actual
        } else if (price < 0.10) {
          return '#27ae60'; // Verde
        } else if (price < 0.15) {
          return '#f39c12'; // Naranja
        } else {
          return '#e74c3c'; // Rojo
        }
      });
      
      renderPriceChart(ctx, labels, globalPrices, colors);
      
      // Actualizar también la alerta de precios
      const dataInfo = {
        source: 'Actualización automática',
        date: spainTime.toLocaleDateString('es-ES')
      };
      updatePriceAlert(globalPrices, dataInfo);
    }
  };

  updateClock();
  setInterval(updateClock, 60000); // Actualizar cada minuto en lugar de cada segundo
}

// ===== PRICE FUNCTIONALITY =====
async function loadElectricityPrices() {
  const alertElement = document.getElementById("alerta");
  const ctx = document.getElementById("grafico").getContext("2d");
  
  try {
    showLoading("alerta");
    updateApiStatus('connecting');
    
    // Estrategia simple que funciona: Datos realistas por defecto, APIs como bonus
    let realData = null;
    let dataSource = '';
    
    // Paso 1: Cargar datos de respaldo realistas (siempre funciona)
    console.log('🔄 Cargando datos de respaldo realistas...');
    const backupData = await fetchBackupPriceData();
    realData = backupData;
    dataSource = 'respaldo';
    
    // Paso 2: Intentar mejorar con APIs oficiales (opcional)
    try {
      console.log('🔄 Intentando mejorar con APIs oficiales...');
      const apiData = await Promise.race([
        fetchRealPriceData(),
        new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Timeout de API')), 8000)
        )
      ]);
      
      if (apiData && apiData.prices.length > 0) {
        realData = apiData;
        dataSource = 'oficial';
        console.log('✅ Datos oficiales obtenidos exitosamente');
      }
    } catch (apiError) {
      console.log('ℹ️ APIs oficiales no disponibles, usando datos realistas:', apiError.message);
    }
    
    // Renderizar datos (siempre tenemos datos de respaldo)
    if (realData && realData.prices.length > 0) {
      globalPrices = realData.prices;
      updatePriceAlert(realData.prices, realData);
      renderPriceChart(ctx, realData.labels, realData.prices, realData.colors);
      
      // Actualizar comparación de tarifas
      const comparisonData = calculateTariffComparison(realData.prices, dataSource);
      renderTariffComparison(comparisonData);
      
      // Actualizar estado según la fuente
      if (dataSource === 'oficial') {
        updateApiStatus('connected', realData.date ? `(${realData.date})` : '');
      } else {
        const extraInfo = realData.isWeekend ? 'fin de semana' : 'entre semana';
        const seasonInfo = realData.season || '';
        updateApiStatus('offline', `Datos realistas ${extraInfo} ${seasonInfo} (${realData.date})`);
      }
    } else {
      throw new Error("Error crítico en datos de respaldo");
    }
    
    hideLoading("alerta");

  } catch (err) {
    hideLoading("alerta");
    console.error("❌ Error crítico, usando datos de ejemplo básicos:", err);
    updateApiStatus('error', 'Usando datos de ejemplo');
    
    // Último recurso: datos de ejemplo básicos
    const mockData = generateMockPriceData();
    mockData.source = 'mock';
    globalPrices = mockData.prices;
    
    updatePriceAlert(mockData.prices, mockData);
    renderPriceChart(ctx, mockData.labels, mockData.prices, mockData.colors);
    
    // Comparación también para datos de ejemplo
    const comparisonData = calculateTariffComparison(mockData.prices, 'simulación');
    renderTariffComparison(comparisonData);
  }
}

async function refreshPriceData() {
  console.log('🔄 Actualizando datos de precios...');
  updateApiStatus('connecting');
  
  // Mostrar indicador de carga
  const alertElement = document.getElementById("alerta");
  const originalContent = alertElement.innerHTML;
  alertElement.innerHTML = '<span class="loading"></span>Actualizando precios...';
  
  try {
    const ctx = document.getElementById("grafico").getContext("2d");
    
    // Estrategia simplificada: datos realistas + intento de API
    let realData = null;
    let dataSource = '';
    
    // Paso 1: Generar nuevos datos realistas (siempre funciona)
    console.log('🔄 Generando nuevos datos realistas...');
    const backupData = await fetchBackupPriceData();
    realData = backupData;
    dataSource = 'respaldo';
    
    // Paso 2: Intentar obtener datos oficiales (con timeout corto)
    try {
      console.log('🔄 Intentando datos oficiales...');
      const apiData = await Promise.race([
        fetchRealPriceData(),
        new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Timeout')), 5000)
        )
      ]);
      
      if (apiData && apiData.prices.length > 0) {
        realData = apiData;
        dataSource = 'oficial';
        console.log('✅ Actualización con datos oficiales exitosa');
      }
    } catch (apiError) {
      console.log('ℹ️ Manteniendo datos realistas:', apiError.message);
    }
    
    // Actualizar la interfaz
    if (realData && realData.prices.length > 0) {
      globalPrices = realData.prices;
      updatePriceAlert(realData.prices, realData);
      renderPriceChart(ctx, realData.labels, realData.prices, realData.colors);
      
      // Actualizar comparación de tarifas
      const comparisonData = calculateTariffComparison(realData.prices.pvpc, dataSource);
      renderTariffComparison(comparisonData);
      
      if (dataSource === 'oficial') {
        updateApiStatus('connected', realData.date ? `(${realData.date})` : '');
        console.log('✅ Actualización exitosa con datos oficiales');
      } else {
        const extraInfo = realData.isWeekend ? 'fin de semana' : 'entre semana';
        updateApiStatus('offline', `Datos realistas actualizados ${extraInfo} (${realData.date})`);
        console.log('✅ Actualización exitosa con datos realistas');
      }
    } else {
      throw new Error("Error en actualización de datos");
    }
    
  } catch (err) {
    console.warn("❌ Error al actualizar:", err);
    updateApiStatus('error', 'Error en actualización');
    
    // Restaurar contenido original
    alertElement.innerHTML = originalContent;
    
    // Si no hay datos previos, usar datos de ejemplo
    if (!globalPrices || globalPrices.length === 0) {
      const ctx = document.getElementById("grafico").getContext("2d");
      const mockData = generateMockPriceData();
      mockData.source = 'mock';
      globalPrices = mockData.prices;
      updatePriceAlert(mockData.prices, mockData);
      renderPriceChart(ctx, mockData.labels, mockData.prices, mockData.colors);
      
      // Comparación para datos de ejemplo
      const comparisonData = calculateTariffComparison(mockData.prices.pvpc, 'simulación');
      renderTariffComparison(comparisonData);
      
      updateApiStatus('error', 'Usando datos de ejemplo');
    }
  }
}

async function generateNewRealisticData() {
  console.log('📈 Generando simulación basada en datos históricos...');
  
  const alertElement = document.getElementById("alerta");
  const originalContent = alertElement.innerHTML;
  alertElement.innerHTML = '<span class="loading"></span>Generando simulación de precios...';
  
  try {
    const ctx = document.getElementById("grafico").getContext("2d");
    
    // Generar simulación basada en patrones históricos del mercado eléctrico español
    const newData = await fetchBackupPriceData();
    
    if (newData && newData.prices.length > 0) {
      globalPrices = newData.prices;
      updatePriceAlert(newData.prices, newData);
      renderPriceChart(ctx, newData.labels, newData.prices, newData.colors);
      
      // Actualizar comparación de tarifas
      const comparisonData = calculateTariffComparison(newData.prices.pvpc, dataSource);
      renderTariffComparison(comparisonData);
      
      const typeInfo = newData.isWeekend ? 'fin de semana' : 'entre semana';
      const seasonInfo = newData.season ? ` (${newData.season})` : '';
      updateApiStatus('offline', `Simulación histórica ${typeInfo}${seasonInfo} (${newData.date})`);
      
      console.log('✅ Simulación histórica generada exitosamente');
      
      // Mostrar mensaje temporal de éxito
      setTimeout(() => {
        if (alertElement.innerHTML.includes("✅") || alertElement.innerHTML.includes("⚠️") || alertElement.innerHTML.includes("❌")) {
          const currentMsg = alertElement.innerHTML;
          if (!currentMsg.includes("Simulación")) {
            alertElement.innerHTML = currentMsg + "<br><small style='color: #8e44ad; font-weight: 600; background: rgba(142, 68, 173, 0.1); padding: 3px 8px; border-radius: 10px;'>📈 Simulación basada en datos históricos</small>";
          }
        }
      }, 1000);
    }
    
  } catch (err) {
    console.error("❌ Error generando simulación histórica:", err);
    alertElement.innerHTML = originalContent;
    updateApiStatus('error', 'Error generando simulación');
  }
}

function generateMockPriceData() {
  const labels = [];
  const prices = [];
  const colors = [];
  const currentHour = new Date().getHours();

  // Generar datos de ejemplo
  const basePrices = [0.08, 0.07, 0.06, 0.06, 0.07, 0.09, 0.12, 0.15, 0.13, 0.11, 0.10, 0.09, 0.08, 0.07, 0.08, 0.10, 0.12, 0.15, 0.18, 0.16, 0.14, 0.12, 0.10, 0.09];

  for (let i = 0; i < 24; i++) {
    labels.push(`${formatTime(i)}:00`);
    prices.push(basePrices[i]);

    // Asignar colores - SIEMPRE marcar la hora actual en azul
    if (i === currentHour) {
      colors.push("#2196F3"); // Azul brillante para la hora actual
    } else if (basePrices[i] <= 0.08) {
      colors.push("#27ae60"); // Verde
    } else if (basePrices[i] <= 0.12) {
      colors.push("#f39c12"); // Naranja
    } else {
      colors.push("#e67e22"); // Rojo
    }
  }

  return { labels, prices, colors, source: 'mock' };
}

function updateApiStatus(status, message = '', isError = false) {
  const statusElement = document.getElementById("api-status");
  if (!statusElement) return;
  
  switch (status) {
    case 'connecting':
      statusElement.innerHTML = '🔄 Conectando con APIs oficiales...';
      statusElement.style.background = 'linear-gradient(45deg, #fff3cd, #ffeaa7)';
      statusElement.style.borderColor = '#f39c12';
      statusElement.style.color = '#856404';
      break;
      
    case 'connected':
      // Verificar si es ESIOS oficial
      if (message.includes('ESIOS') || message.includes('Oficial')) {
        statusElement.innerHTML = `🏆 ESIOS API Oficial activa ${message}`;
        statusElement.style.background = 'linear-gradient(45deg, #e74c3c, #c0392b)';
        statusElement.style.borderColor = '#a93226';
        statusElement.style.color = '#ffffff';
        statusElement.style.fontWeight = '800';
        statusElement.style.textTransform = 'uppercase';
        statusElement.style.letterSpacing = '0.5px';
      } else {
        statusElement.innerHTML = `✅ Datos oficiales obtenidos ${message}`;
        statusElement.style.background = 'linear-gradient(45deg, #d1ecf1, #bee5eb)';
        statusElement.style.borderColor = '#17a2b8';
        statusElement.style.color = '#0c5460';
      }
      break;
      
    case 'offline':
      statusElement.innerHTML = `🔄 ${message || 'Usando datos de respaldo'}`;
      statusElement.style.background = 'linear-gradient(45deg, #e2e3e5, #d6d8db)';
      statusElement.style.borderColor = '#6c757d';
      statusElement.style.color = '#495057';
      break;
      
    case 'error':
      statusElement.innerHTML = `❌ ${message || 'Error de conexión'}`;
      statusElement.style.background = 'linear-gradient(45deg, #f8d7da, #f1b0b7)';
      statusElement.style.borderColor = '#dc3545';
      statusElement.style.color = '#721c24';
      break;
      
    default:
      statusElement.innerHTML = '⚡ Estado desconocido';
      statusElement.style.background = 'linear-gradient(45deg, #f8f9fa, #e9ecef)';
      statusElement.style.borderColor = '#dee2e6';
      statusElement.style.color = '#6c757d';
  }
  
  // No necesitamos actualizar estado del caché
}

function updatePriceAlert(prices, dataInfo = null) {
  const alertElement = document.getElementById("alerta");
  const currentHour = new Date().getHours();
  const currentPrice = prices[currentHour];

  let message, bgColor;

  if (currentPrice <= 0.08) {
    message = `✅ Precio actual: ${formatPrice(currentPrice)} €/kWh. ¡Precio bajo!`;
    bgColor = "#d5f4e6";
  } else if (currentPrice <= 0.12) {
    message = `⚠️ Precio actual: ${formatPrice(currentPrice)} €/kWh. Precio moderado.`;
    bgColor = "#fff3cd";
  } else {
    message = `❌ Precio actual: ${formatPrice(currentPrice)} €/kWh. Precio alto.`;
    bgColor = "#f8d7da";
  }

  // Agregar información sobre la fuente de datos - MEJORADO para ESIOS
  if (dataInfo) {
    const dateStr = dataInfo.date ? ` (${dataInfo.date})` : '';
    
    if (dataInfo.source === 'ESIOS API Oficial') {
      message += `<br><small style='color: #fff; font-weight: 800; background: linear-gradient(45deg, #e74c3c, #c0392b); padding: 6px 15px; border-radius: 20px; border: 3px solid #a93226; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4); text-transform: uppercase; letter-spacing: 0.5px;'>🏆 DATOS OFICIALES REE/ESIOS${dateStr}</small>`;
    } else if (dataInfo.source === 'REE API' || dataInfo.source === 'ESIOS API') {
      message += `<br><small style='color: #fff; font-weight: 700; background: linear-gradient(45deg, #27ae60, #2ecc71); padding: 4px 12px; border-radius: 15px; border: 2px solid #27ae60; box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);'>🎯 DATOS REALES de Red Eléctrica${dateStr}</small>`;
    } else if (dataInfo.source === 'Backup Data') {
      const typeInfo = dataInfo.isWeekend ? 'fin de semana' : 'entre semana';
      const seasonInfo = dataInfo.season ? ` (${dataInfo.season})` : '';
      message += `<br><small style='color: #fff; font-weight: 600; background: linear-gradient(45deg, #8e44ad, #9b59b6); padding: 4px 12px; border-radius: 15px; border: 2px solid #8e44ad; box-shadow: 0 2px 8px rgba(142, 68, 173, 0.3);'>📈 SIMULACIÓN histórica ${typeInfo}${seasonInfo}${dateStr}</small>`;
    } else if (dataInfo.source === 'mock') {
      message += `<br><small style='color: #e74c3c; font-weight: 500;'>⚠️ Datos de ejemplo - APIs no disponibles</small>`;
    }
  }

  alertElement.innerHTML = message;
  alertElement.style.backgroundColor = bgColor;
}

function renderPriceChart(ctx, labels, prices, colors) {
  if (priceChart) {
    priceChart.destroy();
  }

  const currentHour = new Date().getHours();
  
  // Asegurar que los colores incluyan la hora actual destacada
  const updatedColors = colors.map((color, index) => 
    index === currentHour ? '#2196F3' : color
  );
  
  // Crear arrays para destacar la hora actual
  const borderColors = updatedColors.map((color, index) => 
    index === currentHour ? '#1976D2' : color
  );
  
  const borderWidths = colors.map((_, index) => 
    index === currentHour ? 4 : 1
  );

  // Plugin personalizado para mostrar el precio encima de la columna actual
  const priceDisplayPlugin = {
    id: 'priceDisplay',
    afterDatasetsDraw: function(chart, args, options) {
      const ctx = chart.ctx;
      const currentPrice = prices[currentHour];
      const meta = chart.getDatasetMeta(0);
      const currentBar = meta.data[currentHour];
      
      if (currentBar && currentPrice !== undefined) {
        ctx.save();
        
        // Configurar el texto del precio
        ctx.font = 'bold 16px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        
        const priceText = `${formatPrice(currentPrice)} €/kWh`;
        
        // Fondo blanco semi-transparente para el texto
        ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
        const textWidth = ctx.measureText(priceText).width;
        const textHeight = 22;
        const rectX = currentBar.x - (textWidth/2) - 8;
        const rectY = currentBar.y - 40;
        
        ctx.fillRect(rectX, rectY, textWidth + 16, textHeight);
        
        // Borde del fondo
        ctx.strokeStyle = '#1976D2';
        ctx.lineWidth = 2;
        ctx.strokeRect(rectX, rectY, textWidth + 16, textHeight);
        
        // Texto del precio
        ctx.fillStyle = '#1976D2';
        ctx.fillText(priceText, currentBar.x, currentBar.y - 22);
        
        // Pequeña flecha apuntando a la columna
        ctx.beginPath();
        ctx.moveTo(currentBar.x, currentBar.y - 18);
        ctx.lineTo(currentBar.x - 6, currentBar.y - 12);
        ctx.lineTo(currentBar.x + 6, currentBar.y - 12);
        ctx.closePath();
        ctx.fillStyle = '#1976D2';
        ctx.fill();
        
        ctx.restore();
      }
    }
  };
  
  priceChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: "Precio (€/kWh) - Por hora",
        data: prices,
        backgroundColor: updatedColors,
        borderColor: borderColors,
        borderWidth: borderWidths,
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          max: Math.max(...prices) * 1.2,
          title: {
            display: true,
            text: "Precio (€/kWh)"
          }
        },
        x: {
          title: {
            display: true,
            text: "Hora del día"
          }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            afterLabel: function(context) {
              if (context.dataIndex === currentHour) {
                return '⚡ HORA ACTUAL';
              }
              return '';
            }
          }
        }
      }
    },
    plugins: [priceDisplayPlugin]
  });
  
  console.log(`📊 Gráfico actualizado - Vista normal (1 hora): ${labels.length} intervalos, hora actual: ${currentHour}`);
}

// ===== WEATHER FUNCTIONALITY =====
async function loadWeatherData() {
  const weatherElement = document.getElementById("weather");
  const weatherCtx = document.getElementById("weather-chart").getContext("2d");

  try {
    showLoading("weather");
    
    // PRIORIDAD MÁXIMA: Asegurar que currentLocation esté configurado a Madrid por defecto
    if (!currentLocation || currentLocation.name !== 'Madrid') {
      console.log('🏙️ Configurando Madrid como ubicación por defecto para datos meteorológicos');
      currentLocation = {
        name: 'Madrid',
        lat: 40.4168,
        lon: -3.7038,
        country: 'España',
        detected: false
      };
    }
    
    console.log(`🌤️ Iniciando carga de datos meteorológicos para ${currentLocation.name}...`);
    
    // Probar la API de OpenWeatherMap al inicio (solo para diagnóstico)
    testOpenWeatherMapAPI().then(isWorking => {
      console.log(`🔗 Estado OpenWeatherMap API: ${isWorking ? '✅ Funcionando' : '❌ Con problemas'}`);
    }).catch(() => {
      console.log('🔗 Estado OpenWeatherMap API: ❓ No se pudo verificar');
    });
    
    // Intentar múltiples estrategias para obtener datos reales de Madrid
    let weatherData = null;
    let dataSource = '';
    
    // ESTRATEGIA 1: Datos reales de la API
    try {
      weatherData = await fetchRealWeatherData();
      dataSource = 'Datos reales obtenidos desde API';
      console.log('✅ Datos meteorológicos reales cargados exitosamente');
    } catch (apiError) {
      console.warn('⚠️ Error al obtener datos reales:', apiError.message);
      
      // ESTRATEGIA 2: Forzar nueva llamada a API con diferentes parámetros
      try {
        console.log('🔄 Intentando llamada directa a API con timeout extendido...');
        weatherData = await fetchMadridWeatherDirect();
        dataSource = 'Datos reales obtenidos (llamada directa)';
        console.log('✅ Datos meteorológicos reales obtenidos en segundo intento');
      } catch (directError) {
        console.warn('⚠️ Error en llamada directa:', directError.message);
        
        // ESTRATEGIA 3: Usar datos simulados realistas específicos para Madrid
        console.log('🎲 Generando datos simulados específicos para Madrid...');
        weatherData = generateMadridSpecificWeatherData();
        dataSource = 'Datos simulados específicos para Madrid (API no disponible)';
      }
    }
    
    // Actualizar la interfaz con los datos obtenidos
    updateWeatherDisplay(weatherElement, weatherData);
    renderWeatherChart(weatherCtx, weatherData);
    setupWeatherControls();
    
    // Mostrar el origen de los datos
    const sourceIndicator = weatherElement.querySelector('.weather-source') || 
                           document.createElement('div');
    sourceIndicator.className = 'weather-source';
    sourceIndicator.style.cssText = 'font-size: 0.8em; color: #666; margin-top: 5px; text-align: center;';
    sourceIndicator.textContent = `📊 ${dataSource}`;
    
    if (!weatherElement.querySelector('.weather-source')) {
      weatherElement.appendChild(sourceIndicator);
    }
    
    hideLoading("weather");

  } catch (err) {
    hideLoading("weather");
    console.error("Error crítico en carga meteorológica:", err);
    
    // Último recurso: datos de emergencia para Madrid
    const emergencyData = generateMadridEmergencyWeatherData();
    updateWeatherDisplay(weatherElement, emergencyData);
    renderWeatherChart(weatherCtx, emergencyData);
    setupWeatherControls();
    
    weatherElement.innerHTML += "<br><div style='color: #e74c3c; font-size: 0.8em; text-align: center; margin-top: 5px;'>⚠️ Datos meteorológicos de emergencia - Error en todas las fuentes</div>";
  }
}

// Función para refrescar datos meteorológicos manualmente
async function refreshWeatherData() {
  console.log('🔄 Refrescando datos meteorológicos...');
  
  // Limpiar todo el caché meteorológico
  const cacheKey = `weather_${currentLocation.lat}_${currentLocation.lon}`;
  cache.delete(cacheKey);
  console.log(`🧹 Caché meteorológico limpiado para ${currentLocation.name}`);
  
  // Mostrar mensaje de actualización
  const weatherElement = document.getElementById("weather");
  const originalContent = weatherElement.innerHTML;
  weatherElement.innerHTML = '<span class="loading"></span>Actualizando datos meteorológicos...';
  
  try {
    // Recargar datos meteorológicos
    await loadWeatherData();
    console.log('✅ Datos meteorológicos actualizados correctamente');
  } catch (error) {
    console.error('❌ Error al actualizar datos meteorológicos:', error);
    weatherElement.innerHTML = originalContent + "<br><small style='color: #e74c3c;'>⚠️ Error al actualizar datos</small>";
  }
}

// Función para limpiar caché de sesión manualmente
function clearSessionCache() {
  console.log('🧹 Limpiando caché de sesión...');
  
  try {
    cache.clearAll();
    
    // Mostrar confirmación
    const alertElement = document.getElementById("alerta");
    if (alertElement) {
      const originalContent = alertElement.innerHTML;
      alertElement.innerHTML = '<span style="color: #27ae60;">✅ Caché de sesión limpiado correctamente</span>';
      
      setTimeout(() => {
        alertElement.innerHTML = originalContent;
      }, 3000);
    }
    
    // Refrescar automáticamente los datos después de limpiar caché
    console.log('🔄 Refrescando datos tras limpiar caché...');
    setTimeout(() => {
      if (typeof loadElectricityPrices === 'function') {
        loadElectricityPrices();
      }
      if (typeof loadWeatherData === 'function') {
        loadWeatherData();
      }
    }, 500);
    
    console.log('✅ Caché de sesión limpiado correctamente');
  } catch (error) {
    console.error('❌ Error al limpiar caché de sesión:', error);
    
    // Mostrar error al usuario
    const alertElement = document.getElementById("alerta");
    if (alertElement) {
      const originalContent = alertElement.innerHTML;
      alertElement.innerHTML = '<span style="color: #e74c3c;">❌ Error al limpiar caché</span>';
      
      setTimeout(() => {
        alertElement.innerHTML = originalContent;
      }, 3000);
    }
  }
}

// Función para obtener datos de respaldo desde una fuente más simple
async function fetchBackupPriceData() {
  try {
    const today = new Date();
    const dayOfWeek = today.getDay(); // 0 = domingo, 6 = sábado
    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
    
    // Patrones de precios realistas basados en datos históricos españoles
    // Precios más bajos en fin de semana, más altos entre semana
    const weekdayPattern = [
      0.085, 0.078, 0.072, 0.070, 0.075, 0.095, // 00-05: madrugada
      0.125, 0.165, 0.145, 0.125, 0.115, 0.105, // 06-11: mañana
      0.095, 0.085, 0.095, 0.115, 0.135, 0.165, // 12-17: tarde  
      0.195, 0.175, 0.155, 0.135, 0.115, 0.095  // 18-23: noche
    ];
    
    const weekendPattern = [
      0.075, 0.068, 0.062, 0.060, 0.065, 0.085, // 00-05: madrugada
      0.105, 0.135, 0.125, 0.105, 0.095, 0.085, // 06-11: mañana
      0.085, 0.075, 0.085, 0.095, 0.115, 0.145, // 12-17: tarde
      0.165, 0.155, 0.135, 0.115, 0.095, 0.085  // 18-23: noche
    ];
    
    const basePattern = isWeekend ? weekendPattern : weekdayPattern;
    
    const labels = [];
    const prices = [];
    const colors = [];
    
    // Agregar variación estacional (verano vs invierno)
    const month = today.getMonth();
    const isSummer = month >= 5 && month <= 8; // junio-septiembre
    const seasonalMultiplier = isSummer ? 1.15 : 0.95; // +15% verano, -5% invierno
    
    // Agregar variación aleatoria pequeña para simular mercado real
    const variation = 0.012; // ±1.2 céntimos
    const currentHour = today.getHours(); // Obtener hora actual
    
    // GARANTIZAR 24 HORAS COMPLETAS (0-23)
    for (let i = 0; i < 24; i++) {
      labels.push(`${i.toString().padStart(2, '0')}:00`);
      
      // Precio base con variaciones realistas
      const randomVariation = (Math.random() - 0.5) * variation;
      const seasonalPrice = basePattern[i] * seasonalMultiplier;
      const finalPrice = Math.max(0.045, seasonalPrice + randomVariation);
      
      prices.push(parseFloat(finalPrice.toFixed(4)));
      
      // Colores según precio - destacar hora actual
      if (i === currentHour) {
        colors.push('#2196F3'); // Azul brillante para la hora actual
      } else if (finalPrice < 0.10) {
        colors.push('#27ae60'); // Verde
      } else if (finalPrice < 0.15) {
        colors.push('#f39c12'); // Naranja
      } else {
        colors.push('#e74c3c'); // Rojo
      }
    }
    
    console.log(`📊 Datos de respaldo generados: ${labels.length} horas (${labels[0]} - ${labels[labels.length-1]})`);
    
    return {
      labels: labels,
      prices: prices,
      colors: colors,
      source: 'Backup Data',
      date: today.toLocaleDateString('es-ES'),
      timestamp: new Date().toISOString(),
      isWeekend: isWeekend,
      season: isSummer ? 'verano' : 'invierno'
    };
    
  } catch (error) {
    console.error('Error en datos de respaldo:', error);
    throw error;
  }
}

// ===== FUNCIONES DEL SISTEMA DE SERVIDOR =====

// Función principal para obtener datos de electricidad desde el servidor
async function fetchServerElectricityData() {
  try {
    console.log('🌐 Obteniendo datos de electricidad desde servidor...');
    
    const response = await fetch('./data/electricity-prices.json', {
      method: 'GET',
      headers: { 'Accept': 'application/json' },
      cache: 'no-cache' // Evitar caché del navegador para datos frescos
    });
    
    if (!response.ok) {
      throw new Error(`Error del servidor: HTTP ${response.status}`);
    }
    
    const serverData = await response.json();
    
    // Verificar que los datos son recientes (menos de 2 horas)
    const dataAge = Date.now() - new Date(serverData.lastUpdate).getTime();
    const maxAge = 2 * 60 * 60 * 1000; // 2 horas en milisegundos
    
    if (dataAge > maxAge) {
      console.warn('⚠️ Datos del servidor antiguos, intentando APIs directas...');
      throw new Error('Datos del servidor demasiado antiguos');
    }
    
    // Actualizar colores para la hora actual
    const currentHour = new Date().getHours();
    const updatedColors = serverData.prices.map((price, index) => {
      if (index === currentHour) {
        return '#2196F3'; // Azul para hora actual
      } else if (price < 0.10) {
        return '#27ae60'; // Verde
      } else if (price < 0.15) {
        return '#f39c12'; // Naranja
      } else {
        return '#e74c3c'; // Rojo
      }
    });
    
    const result = {
      ...serverData,
      colors: updatedColors,
      fromServer: true,
      dataAge: Math.round(dataAge / 60000) // edad en minutos
    };
    
    console.log(`✅ Datos del servidor obtenidos (${result.dataAge} min de antigüedad)`);
    return result;
    
  } catch (error) {
    console.log('ℹ️ Datos del servidor no disponibles:', error.message);
    throw error;
  }
}

// Función para obtener datos meteorológicos desde el servidor
async function fetchServerWeatherData(cityName = 'Madrid') {
  try {
    console.log(`🌐 Obteniendo datos de ${cityName} desde servidor local...`);
    
    const response = await fetch('./data/weather-data.json', {
      method: 'GET',
      headers: { 'Accept': 'application/json' },
      cache: 'no-cache'
    });

    if (!response.ok) {
      throw new Error(`Error del servidor: HTTP ${response.status}`);
    }

    const serverData = await response.json();
    
    // Verificar que los datos son recientes (menos de 1 hora)
    const dataAge = Date.now() - new Date(serverData.lastUpdate).getTime();
    const maxAge = 60 * 60 * 1000; // 1 hora en milisegundos

    if (dataAge > maxAge) {
      console.warn('⚠️ Datos meteorológicos del servidor antiguos');
      throw new Error('Datos meteorológicos del servidor antiguos');
    }

    // Obtener datos de la ciudad solicitada
    const cityData = serverData.cities[cityName];

    if (!cityData) {
      throw new Error(`Ciudad ${cityName} no disponible en datos del servidor`);
    }

    const result = {
      ...cityData,
      fromServer: true,
      dataAge: Math.round(dataAge / 60000), // edad en minutos
      availableCities: Object.keys(serverData.cities)
    };    console.log(`✅ Datos meteorológicos del servidor obtenidos para ${cityName} (${result.dataAge} min de antigüedad)`);
    return result;
    
  } catch (error) {
    console.log(`ℹ️ Datos meteorológicos del servidor no disponibles para ${cityName}:`, error.message);
    throw error;
  }
}

// Función para verificar el estado del sistema del servidor
async function checkServerStatus() {
  try {
    const promises = [
      fetch('./data/electricity-prices.json', { method: 'HEAD' }),
      fetch('./data/weather-data.json', { method: 'HEAD' }),
      fetch('./data/api-calls-counter.json', { method: 'GET' })
    ];
    
    const [electricityCheck, weatherCheck, counterResponse] = await Promise.allSettled(promises);
    
    const status = {
      electricity: electricityCheck.status === 'fulfilled' && electricityCheck.value.ok,
      weather: weatherCheck.status === 'fulfilled' && weatherCheck.value.ok,
      counter: null,
      serverAvailable: false
    };
    
    // Obtener contador si está disponible
    if (counterResponse.status === 'fulfilled' && counterResponse.value.ok) {
      try {
        status.counter = await counterResponse.value.json();
      } catch (e) {
        console.log('ℹ️ Contador no disponible');
      }
    }
    
    status.serverAvailable = status.electricity || status.weather;
    
    console.log('📊 Estado del servidor:', status);
    return status;
    
  } catch (error) {
    console.log('ℹ️ Error verificando estado del servidor:', error.message);
    return { electricity: false, weather: false, counter: null, serverAvailable: false };
  }
}

// ===== FUNCIONES MODIFICADAS PARA USAR EL SERVIDOR =====

async function fetchRealPriceData() {
  // PRIORIDAD 1: Intentar datos del servidor
  try {
    const serverData = await fetchServerElectricityData();
    if (serverData) {
      updateApiStatus('online', `Servidor (${serverData.source}) - ${serverData.dataAge} min`);
      return serverData;
    }
  } catch (serverError) {
    console.log('ℹ️ Servidor no disponible, usando APIs directas...');
  }
  
  // PRIORIDAD 2-3: APIs directas como respaldo
  try {
    const today = new Date();
    
    // ESIOS API con token oficial - PRIORIDAD 1
    try {
      console.log('🎯 Intentando ESIOS API oficial con token...');
      const esiosData = await fetchESIOSWithToken(today);
      if (esiosData) {
        console.log('✅ Datos oficiales obtenidos de ESIOS');
        return esiosData;
      }
    } catch (esiosError) {
      console.log('ℹ️ ESIOS con token falló:', esiosError.message);
    }
    
    // REE API pública - RESPALDO (con caché)
    try {
      console.log('🔄 Intentando REE API pública...');
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      
      const reeCacheKey = `ree_${today.toDateString()}`;
      
      // Verificar caché REE
      const cachedREEData = cache.get(reeCacheKey);
      if (cachedREEData) {
        console.log('💾 Usando datos REE desde caché');
        return cachedREEData;
      }
      
      const apiUrl = `https://apidatos.ree.es/es/datos/mercados/precios-mercados-tiempo-real?start_date=${year}-${month}-${day}T00:00&end_date=${year}-${month}-${day}T23:59&time_trunc=hour`;
      
      const response = await fetch(apiUrl, {
        method: 'GET',
        headers: { 'Accept': 'application/json' }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      const data = await response.json();
      const reeData = parseREEData(data, today);
      
      if (reeData && reeData.prices.length >= 20) {
        // Guardar en caché REE por 1 hora
        cache.set(reeCacheKey, reeData, CACHE_CONFIG.ELECTRICITY_TTL);
        console.log('✅ Datos obtenidos de REE API pública y guardados en caché');
        return reeData;
      }
      
    } catch (reeError) {
      console.log('ℹ️ REE API falló:', reeError.message);
    }
    
    throw new Error('Todas las APIs oficiales fallaron');
    
  } catch (error) {
    console.log(`ℹ️ APIs oficiales no disponibles: ${error.message}`);
    throw error;
  }
}

// Nueva función para ESIOS con token oficial + CACHÉ
async function fetchESIOSWithToken(date) {
  const cacheKey = `esios_${date.toDateString()}`;
  
  // Intentar obtener del caché primero
  const cachedData = cache.get(cacheKey);
  if (cachedData) {
    console.log('💾 Usando datos de electricidad desde caché');
    return cachedData;
  }
  
  try {
    const ESIOS_TOKEN = 'cdc71b00d3883937477ddbf4cc1d987346b65a12de38d8addcb8765b66c9c58'; // Tu token oficial
    
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    
    // Endpoint oficial de ESIOS para PVPC
    const esiosUrl = `https://api.esios.ree.es/indicators/1001?start_date=${year}-${month}-${day}T00:00&end_date=${year}-${month}-${day}T23:59`;
    
    console.log('🌐 Consultando ESIOS oficial (caché no disponible):', esiosUrl);
    
    const response = await fetch(esiosUrl, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'Authorization': `Token token=${ESIOS_TOKEN}`,
        'Host': 'api.esios.ree.es'
      }
    });
    
    if (!response.ok) {
      throw new Error(`ESIOS HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('📊 Respuesta ESIOS recibida:', data);
    
    // Parsear datos de ESIOS
    if (data.indicator && data.indicator.values && Array.isArray(data.indicator.values)) {
      const values = data.indicator.values;
      
      if (values.length >= 10) { // Al menos algunos datos
        const currentHour = new Date().getHours();
        
        // Crear arrays para las 24 horas completas
        const labels = [];
        const prices = [];
        const colors = [];
        const hourlyData = new Array(24).fill(null);
        
        // Procesar datos de ESIOS y mapearlos por hora
        values.forEach(val => {
          if (val && val.value !== null && val.datetime) {
            const datetime = new Date(val.datetime);
            const hour = datetime.getHours();
            let price = parseFloat(val.value);
            
            // ESIOS devuelve precios en €/MWh, convertir a €/kWh
            if (price > 1) price = price / 1000;
            
            hourlyData[hour] = price;
          }
        });
        
        // Rellenar las 24 horas, interpolando valores faltantes
        for (let i = 0; i < 24; i++) {
          labels.push(`${i.toString().padStart(2, '0')}:00`);
          
          let price = hourlyData[i];
          
          // Si falta el dato, interpolar con horas cercanas
          if (price === null) {
            price = interpolatePrice(hourlyData, i);
          }
          
          prices.push(price);
          
          // Colores con hora actual destacada
          if (i === currentHour) {
            colors.push('#2196F3'); // Azul para hora actual
          } else if (price < 0.10) {
            colors.push('#27ae60'); // Verde
          } else if (price < 0.15) {
            colors.push('#f39c12'); // Naranja
          } else {
            colors.push('#e74c3c'); // Rojo
          }
        }
        
        const result = {
          labels,
          prices,
          colors,
          source: 'ESIOS API Oficial',
          date: date.toLocaleDateString('es-ES'),
          timestamp: new Date().toISOString(),
          official: true
        };
        
        // Guardar en caché por 1 hora
        cache.set(cacheKey, result, CACHE_CONFIG.ELECTRICITY_TTL);
        
        console.log(`📊 ESIOS procesado y guardado en caché: ${labels.length} horas (${labels[0]} - ${labels[labels.length-1]})`);
        
        return result;
      }
    }
    
    throw new Error('Datos insuficientes en respuesta ESIOS');
    
  } catch (error) {
    console.error('❌ Error en ESIOS:', error);
    throw error;
  }
}

// Función auxiliar para interpolar precios faltantes
function interpolatePrice(hourlyData, targetHour) {
  // Buscar valores válidos antes y después
  let beforePrice = null;
  let afterPrice = null;
  
  // Buscar hacia atrás
  for (let i = targetHour - 1; i >= 0; i--) {
    if (hourlyData[i] !== null) {
      beforePrice = hourlyData[i];
      break;
    }
  }
  
  // Buscar hacia adelante
  for (let i = targetHour + 1; i < 24; i++) {
    if (hourlyData[i] !== null) {
      afterPrice = hourlyData[i];
      break;
    }
  }
  
  // Interpolar o usar valor por defecto
  if (beforePrice !== null && afterPrice !== null) {
    return (beforePrice + afterPrice) / 2;
  } else if (beforePrice !== null) {
    return beforePrice;
  } else if (afterPrice !== null) {
    return afterPrice;
  } else {
    // Valor por defecto basado en patrones típicos españoles
    const defaultPrices = [0.08, 0.07, 0.06, 0.06, 0.07, 0.09, 0.12, 0.15, 0.13, 0.11, 0.10, 0.09, 0.08, 0.07, 0.08, 0.10, 0.12, 0.15, 0.18, 0.16, 0.14, 0.12, 0.10, 0.09];
    return defaultPrices[targetHour] || 0.10;
  }
}

// Función para parsear datos de ESIOS
function parseESIOSData(data, date) {
  try {
    if (!data || !data.PVPC) {
      throw new Error('Formato ESIOS no válido');
    }
    
    const pvpcData = data.PVPC;
    const labels = [];
    const prices = [];
    const colors = [];
    
    // ESIOS devuelve datos por horas
    for (let hour = 0; hour < 24; hour++) {
      const hourKey = `${hour.toString().padStart(2, '0')}-${(hour + 1).toString().padStart(2, '0')}`;
      const priceValue = pvpcData[hourKey];
      
      if (priceValue !== undefined) {
        labels.push(`${hour.toString().padStart(2, '0')}:00`);
        const price = parseFloat(priceValue) / 1000; // Convertir a €/kWh
        prices.push(price);
        
        // Asignar colores
        if (price < 0.10) {
          colors.push('#27ae60');
        } else if (price < 0.20) {
          colors.push('#f39c12');
        } else {
          colors.push('#e74c3c');
        }
      }
    }
    
    return {
      labels: labels,
      prices: prices,
      colors: colors,
      source: 'ESIOS API',
      date: date.toLocaleDateString('es-ES'),
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    console.error('Error parseando datos ESIOS:', error);
    return null;
  }
}

// Función para parsear datos de REE (función original mejorada)
function parseREEData(data, date) {
  try {
    if (!data.included || !Array.isArray(data.included) || data.included.length === 0) {
      throw new Error('Formato REE no válido');
    }
    
    // Buscar los datos de PVPC
    let pvpcData = null;
    for (const item of data.included) {
      if (item.type === 'PVPC' || 
          (item.attributes && item.attributes.title && 
           (item.attributes.title.toLowerCase().includes('pvpc') ||
            item.attributes.title.toLowerCase().includes('precio') ||
            item.attributes.title.toLowerCase().includes('mercado'))) ||
          (item.attributes && item.attributes.description && 
           (item.attributes.description.toLowerCase().includes('pvpc') ||
            item.attributes.description.toLowerCase().includes('precio')))) {
        pvpcData = item;
        break;
      }
    }
    
    if (!pvpcData || !pvpcData.attributes || !pvpcData.attributes.values) {
      // Intentar con el primer elemento que tenga valores
      for (const item of data.included) {
        if (item.attributes && item.attributes.values && Array.isArray(item.attributes.values) && item.attributes.values.length > 0) {
          pvpcData = item;
          break;
        }
      }
    }
    
    if (!pvpcData || !pvpcData.attributes || !pvpcData.attributes.values) {
      throw new Error('No se encontraron datos de precios válidos');
    }
    
    const priceValues = pvpcData.attributes.values;
    const currentHour = new Date().getHours();
    
    // Crear arrays para las 24 horas completas
    const labels = [];
    const prices = [];
    const colors = [];
    const hourlyData = new Array(24).fill(null);
    
    // Mapear datos por hora
    for (const item of priceValues) {
      if (!item.datetime || item.value === null || item.value === undefined) {
        continue;
      }
      
      const datetime = new Date(item.datetime);
      const hour = datetime.getHours();
      let price = parseFloat(item.value);
      
      // Detectar si está en €/MWh o €/kWh
      if (price > 1) {
        price = price / 1000;
      }
      
      hourlyData[hour] = price;
    }
    
    // Generar las 24 horas completas
    for (let i = 0; i < 24; i++) {
      labels.push(`${i.toString().padStart(2, '0')}:00`);
      
      let price = hourlyData[i];
      
      // Si falta el dato, interpolar
      if (price === null) {
        price = interpolatePrice(hourlyData, i);
      }
      
      prices.push(price);
      
      // Colores con hora actual destacada
      if (i === currentHour) {
        colors.push('#2196F3'); // Azul para hora actual
      } else if (price < 0.10) {
        colors.push('#27ae60'); // Verde
      } else if (price < 0.20) {
        colors.push('#f39c12'); // Naranja
      } else {
        colors.push('#e74c3c'); // Rojo
      }
    }
    
    console.log(`📊 REE procesado: ${labels.length} horas (${labels[0]} - ${labels[labels.length-1]})`);
    
    return {
      labels: labels,
      prices: prices,
      colors: colors,
      source: 'REE API',
      date: date.toLocaleDateString('es-ES'),
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    console.error('Error parseando datos REE:', error);
    return null;
  }
}

async function fetchRealWeatherData() {
  console.log(`🌤️ Obteniendo datos meteorológicos para ${currentLocation.name}...`);
  
  let lastError = null;
  
  // PRIORIDAD 1: Intentar datos del servidor local
  try {
    const serverData = await fetchServerWeatherData(currentLocation.name);
    if (serverData) {
      console.log(`✅ Datos del servidor obtenidos para ${currentLocation.name}`);
      return {
        ...serverData,
        fromServer: true,
        source: 'Servidor Local'
      };
    }
  } catch (serverError) {
    lastError = serverError;
    console.log('ℹ️ Servidor local no disponible, intentando otras fuentes...');
  }
  
  // PRIORIDAD 2: Usar caché existente
  const lat = currentLocation.lat;
  const lon = currentLocation.lon;
  const cacheKey = `weather_${lat}_${lon}`;
  
  const cachedData = cache.get(cacheKey);
  if (cachedData) {
    console.log('💾 Usando datos meteorológicos desde caché');
    return {
      ...cachedData,
      source: 'Caché Local',
      cached: true
    };
  }
  
  // PRIORIDAD 3: API directa con múltiples fuentes
  const apis = [
    // API 1: Open-Meteo (gratuita, sin clave API)
    {
      name: 'Open-Meteo',
      key: 'none',
      url: `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,relative_humidity_2m,precipitation_probability&forecast_days=1&timezone=Europe/Madrid`
    },
    // API 2: WeatherAPI (gratuita hasta 1M llamadas)
    {
      name: 'WeatherAPI',
      key: 'f8c8a07ca4d14d6f8f994503241708',
      url: `https://api.weatherapi.com/v1/forecast.json?key=f8c8a07ca4d14d6f8f994503241708&q=${lat},${lon}&hours=8&lang=es`
    },
    // API 3: OpenWeatherMap (API válida confirmada)
    {
      name: 'OpenWeatherMap',
      key: '8631fe126bc353af0836dbc76cfac520',
      url: `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=8631fe126bc353af0836dbc76cfac520&units=metric&lang=es`
    },
    // API 4: OpenWeatherMap Forecast (pronóstico horario)
    {
      name: 'OpenWeatherMap Forecast',
      key: '8631fe126bc353af0836dbc76cfac520',
      url: `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=8631fe126bc353af0836dbc76cfac520&units=metric&lang=es&cnt=8`
    }
  ];
  
  // Función para procesar diferentes formatos de respuesta API
  function processApiResponse(data, apiName) {
    try {
      switch (apiName) {
        case 'Open-Meteo':
          return processOpenMeteoData(data);
        case 'WeatherAPI':
          return processWeatherAPIData(data);
        case 'OpenWeatherMap':
          return processOpenWeatherMapData(data);
        case 'OpenWeatherMap Forecast':
          return processOpenWeatherMapForecastData(data);
        case 'Weatherstack':
          return processWeatherstackData(data);
        default:
          throw new Error('Formato de API no reconocido');
      }
    } catch (error) {
      console.error(`Error procesando datos de ${apiName}:`, error);
      throw error;
    }
  }
  
  // Verificar límite de llamadas diarias
  if (!cache.canMakeWeatherCall()) {
    console.warn('⚠️ Límite diario de llamadas meteorológicas alcanzado');
    throw new Error('Límite diario de llamadas meteorológicas alcanzado. Usando datos de respaldo.');
  }
  
  // Intentar con cada API
  for (const api of apis) {
    try {
      console.log(`🌤️ Intentando ${api.name}...`);
      
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000);
      
      const response = await fetch(api.url, {
        signal: controller.signal,
        headers: {
          'Accept': 'application/json',
          'User-Agent': 'PRECIO-LUZ-ESP/1.0'
        }
      });
      
      clearTimeout(timeoutId);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      // Incrementar contador de llamadas
      cache.incrementWeatherCallCounter();
      
      const data = await response.json();
      
      console.log(`✅ Datos meteorológicos obtenidos desde ${api.name}`);
      
      // Procesar los datos según el tipo de API
      const weatherData = processApiResponse(data, api.name);
      
      // Añadir metadatos
      weatherData.source = api.name;
      weatherData.cached = false;
      weatherData.timestamp = new Date().toISOString();
      
      // Guardar en caché por 30 minutos
      cache.set(cacheKey, weatherData, CACHE_CONFIG.WEATHER_TTL);
      
      return weatherData;
      
    } catch (error) {
      lastError = error;
      console.warn(`❌ Error con ${api.name}: ${error.message}`);
      continue; // Intentar siguiente API
    }
  }
  
  // Si llegamos aquí, todas las APIs fallaron
  console.error('❌ Todas las APIs meteorológicas fallaron');
  throw new Error(`Error en APIs meteorológicas: ${lastError?.message || 'APIs no disponibles'}`);
}

// ===== PROCESADORES DE DATOS POR TIPO DE API =====

// Procesador para Open-Meteo API
function processOpenMeteoData(data) {
  if (!data || !data.hourly) {
    throw new Error('Datos de Open-Meteo inválidos');
  }
  
  const hours = data.hourly;
  const maxItems = Math.min(8, hours.time.length);
  
  const labels = [];
  const temperatures = [];
  const humidity = [];
  const precipitation = [];
  
  for (let i = 0; i < maxItems; i++) {
    const date = new Date(hours.time[i]);
    labels.push(`${date.getHours().toString().padStart(2, '0')}:00`);
    temperatures.push(Math.round(hours.temperature_2m[i]));
    humidity.push(Math.round(hours.relative_humidity_2m[i]));
    precipitation.push(Math.round(hours.precipitation_probability[i] || 0));
  }
  
  return {
    labels,
    temperatures,
    humidity,
    precipitation,
    current: {
      description: 'datos actuales de Open-Meteo',
      temp: temperatures[0],
      humidity: humidity[0],
      precipitation: precipitation[0],
      city: currentLocation.name
    }
  };
}

// Procesador para WeatherAPI
function processWeatherAPIData(data) {
  if (!data || !data.forecast || !data.forecast.forecastday) {
    throw new Error('Datos de WeatherAPI inválidos');
  }
  
  const hours = data.forecast.forecastday[0].hour;
  const maxItems = Math.min(8, hours.length);
  
  const labels = [];
  const temperatures = [];
  const humidity = [];
  const precipitation = [];
  
  for (let i = 0; i < maxItems; i++) {
    const date = new Date(hours[i].time);
    labels.push(`${date.getHours().toString().padStart(2, '0')}:00`);
    temperatures.push(Math.round(hours[i].temp_c));
    humidity.push(Math.round(hours[i].humidity));
    precipitation.push(Math.round(hours[i].chance_of_rain || 0));
  }
  
  return {
    labels,
    temperatures,
    humidity,
    precipitation,
    current: {
      description: data.current?.condition?.text || 'datos actuales WeatherAPI',
      temp: temperatures[0],
      humidity: humidity[0],
      precipitation: precipitation[0],
      city: currentLocation.name
    }
  };
}

// Procesador para OpenWeatherMap
// Procesador para OpenWeatherMap - Clima Actual (endpoint weather)
function processOpenWeatherMapData(data) {
  if (!data || !data.main || !data.weather) {
    throw new Error('Datos de OpenWeatherMap (clima actual) inválidos');
  }
  
  const now = new Date();
  const labels = [];
  const temperatures = [];
  const humidity = [];
  const precipitation = [];
  
  // Para clima actual, generar proyección horaria basada en el estado actual
  for (let i = 0; i < 8; i++) {
    const hour = new Date(now.getTime() + i * 3 * 60 * 60 * 1000);
    labels.push(`${hour.getHours().toString().padStart(2, '0')}:00`);
    
    // Simular variación horaria realista basada en el clima actual
    const tempVariation = (Math.random() - 0.5) * 3;
    temperatures.push(Math.round(data.main.temp + tempVariation));
    
    const humidityVariation = (Math.random() - 0.5) * 10;
    humidity.push(Math.round(Math.max(30, Math.min(90, data.main.humidity + humidityVariation))));
    
    // Precipitación basada en las condiciones actuales
    const hasRain = data.weather[0].main.toLowerCase().includes('rain');
    precipitation.push(hasRain ? Math.round(Math.random() * 40 + 10) : Math.round(Math.random() * 10));
  }
  
  return {
    labels,
    temperatures,
    humidity,
    precipitation,
    current: {
      description: data.weather[0].description,
      temp: Math.round(data.main.temp),
      humidity: Math.round(data.main.humidity),
      precipitation: precipitation[0],
      city: currentLocation.name
    }
  };
}

// Procesador para OpenWeatherMap - Forecast (endpoint forecast)
function processOpenWeatherMapForecastData(data) {
  if (!data || !data.list || data.list.length === 0) {
    throw new Error('Datos de OpenWeatherMap (forecast) inválidos');
  }
  
  const hourlyForecast = data.list;
  const maxItems = Math.min(8, hourlyForecast.length);
  
  const labels = [];
  const temperatures = [];
  const humidity = [];
  const precipitation = [];
  
  for (let i = 0; i < maxItems; i++) {
    const item = hourlyForecast[i];
    const date = new Date(item.dt * 1000);
    labels.push(`${date.getHours().toString().padStart(2, '0')}:00`);
    temperatures.push(Math.round(item.main.temp));
    humidity.push(Math.round(item.main.humidity));
    precipitation.push(Math.round((item.pop || 0) * 100));
  }
  
  return {
    labels,
    temperatures,
    humidity,
    precipitation,
    current: {
      description: hourlyForecast[0].weather[0].description,
      temp: temperatures[0],
      humidity: humidity[0],
      precipitation: precipitation[0],
      city: currentLocation.name
    }
  };
}

// Procesador para Weatherstack
function processWeatherstackData(data) {
  if (!data || !data.forecast) {
    throw new Error('Datos de Weatherstack inválidos');
  }
  
  const current = data.current;
  const forecast = Object.values(data.forecast)[0]; // Primer día
  
  // Weatherstack tiene datos por horas en formato diferente
  const labels = ['Ahora', '3h', '6h', '9h', '12h', '15h', '18h', '21h'];
  const temperatures = [current.temperature];
  const humidity = [current.humidity];
  const precipitation = [current.precip || 0];
  
  // Simular datos horarios basados en el actual (Weatherstack free no tiene datos horarios)
  for (let i = 1; i < 8; i++) {
    temperatures.push(Math.round(current.temperature + (Math.random() - 0.5) * 4));
    humidity.push(Math.round(Math.max(30, Math.min(90, current.humidity + (Math.random() - 0.5) * 10))));
    precipitation.push(Math.round(Math.max(0, current.precip + (Math.random() - 0.5) * 5)));
  }
  
  return {
    labels,
    temperatures,
    humidity,
    precipitation,
    current: {
      description: current.weather_descriptions[0] || 'datos Weatherstack',
      temp: Math.round(current.temperature),
      humidity: Math.round(current.humidity),
      precipitation: Math.round(current.precip || 0),
      city: currentLocation.name
    }
  };
}

// Función para llamada directa a la API de Madrid con configuración optimizada
async function fetchMadridWeatherDirect() {
  console.log('🌤️ Realizando llamada directa para Madrid...');
  
  const madridLat = 40.4168;
  const madridLon = -3.7038;
  
  // Intentar primero con Open-Meteo (gratuita)
  try {
    console.log('🌍 Intentando Open-Meteo para Madrid...');
    const openMeteoUrl = `https://api.open-meteo.com/v1/forecast?latitude=${madridLat}&longitude=${madridLon}&hourly=temperature_2m,relative_humidity_2m,precipitation_probability&forecast_days=1&timezone=Europe/Madrid`;
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 8000);
    
    const response = await fetch(openMeteoUrl, {
      signal: controller.signal,
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'User-Agent': 'PRECIO-LUZ-ESP/1.0'
      }
    });
    
    clearTimeout(timeoutId);
    
    if (response.ok) {
      const data = await response.json();
      console.log('✅ Datos reales de Madrid obtenidos desde Open-Meteo');
      
      const weatherData = processOpenMeteoData(data);
      return {
        ...weatherData,
        source: 'Open-Meteo API Directa',
        cached: false,
        timestamp: new Date().toISOString()
      };
    }
  } catch (openMeteoError) {
    console.warn('⚠️ Open-Meteo falló, intentando OpenWeatherMap:', openMeteoError.message);
  }
  
  // Respaldo con OpenWeatherMap (clave API válida)
  try {
    console.log('🌤️ Intentando OpenWeatherMap para Madrid...');
    const owmUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${madridLat}&lon=${madridLon}&appid=8631fe126bc353af0836dbc76cfac520&units=metric&lang=es`;
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000);
    
    const response = await fetch(owmUrl, {
      signal: controller.signal,
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Cache-Control': 'no-cache',
        'User-Agent': 'PRECIO-LUZ-ESP/1.0'
      }
    });
    
    clearTimeout(timeoutId);
    
    if (response.ok) {
      const data = await response.json();
      console.log('✅ Datos reales de Madrid obtenidos desde OpenWeatherMap');
      
      const weatherData = processOpenWeatherMapData(data);
      return {
        ...weatherData,
        source: 'OpenWeatherMap API Directa',
        cached: false,
        timestamp: new Date().toISOString()
      };
    } else {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
  } catch (owmError) {
    console.error('❌ Error en todas las APIs directas:', owmError.message);
    throw new Error('Todas las APIs directas fallaron');
  }
}

// Función para probar la conectividad de OpenWeatherMap con la clave API
async function testOpenWeatherMapAPI() {
  console.log('🧪 Probando conectividad con OpenWeatherMap...');
  
  const apiKey = '8631fe126bc353af0836dbc76cfac520';
  const testUrl = `https://api.openweathermap.org/data/2.5/weather?q=Madrid,ES&appid=${apiKey}&units=metric&lang=es`;
  
  try {
    const response = await fetch(testUrl, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'User-Agent': 'PRECIO-LUZ-ESP/1.0'
      }
    });
    
    if (response.ok) {
      const data = await response.json();
      console.log('✅ OpenWeatherMap API funcionando correctamente');
      console.log(`📍 Datos obtenidos para ${data.name}: ${Math.round(data.main.temp)}°C, ${data.weather[0].description}`);
      return true;
    } else {
      console.error(`❌ Error HTTP ${response.status}: ${response.statusText}`);
      return false;
    }
  } catch (error) {
    console.error('❌ Error de conectividad:', error.message);
    return false;
  }
}

// Función para generar datos simulados específicos y realistas para Madrid
function generateMadridSpecificWeatherData() {
  console.log('🏙️ Generando datos meteorológicos específicos para Madrid...');
  
  const now = new Date();
  const currentHour = now.getHours();
  const month = now.getMonth(); // 0-11
  const labels = [];
  
  // Generar etiquetas para las próximas 8 horas (intervalos de 3h)
  for (let i = 0; i < 8; i++) {
    const hour = (currentHour + i * 3) % 24;
    labels.push(`${hour.toString().padStart(2, '0')}:00`);
  }
  
  // Temperaturas realistas para Madrid según la época del año
  let baseTemp;
  const isWinter = month === 11 || month === 0 || month === 1 || month === 2;
  const isSummer = month >= 5 && month <= 8;
  
  if (isWinter) {
    baseTemp = Math.random() * 10 + 5; // 5-15°C en invierno
  } else if (isSummer) {
    baseTemp = Math.random() * 15 + 25; // 25-40°C en verano
  } else {
    baseTemp = Math.random() * 10 + 15; // 15-25°C primavera/otoño
  }
  
  // Variación realista por hora del día
  const temperatures = labels.map((_, i) => {
    const hour = (currentHour + i * 3) % 24;
    let tempVariation = 0;
    
    // Ciclo diario natural
    if (hour >= 6 && hour <= 12) tempVariation = 2; // Mañana
    else if (hour >= 13 && hour <= 16) tempVariation = 4; // Tarde (más calor)
    else if (hour >= 17 && hour <= 20) tempVariation = 1; // Atardecer
    else tempVariation = -3; // Noche (más frío)
    
    return Math.round(baseTemp + tempVariation + (Math.random() - 0.5) * 3);
  });
  
  // Humedad típica de Madrid (continental)
  const baseHumidity = isWinter ? 65 : isSummer ? 35 : 50;
  const humidity = labels.map(() => {
    return Math.round(Math.max(20, Math.min(90, baseHumidity + (Math.random() - 0.5) * 20)));
  });
  
  // Precipitaciones (Madrid es bastante seco)
  const precipitation = labels.map(() => {
    if (Math.random() < 0.2) { // 20% probabilidad de lluvia
      return Math.round(Math.random() * 30); // 0-30% probabilidad
    }
    return Math.round(Math.random() * 5); // Generalmente bajo
  });
  
  return {
    labels,
    temperatures,
    humidity,
    precipitation,
    current: {
      description: 'datos estimados actuales',
      temp: temperatures[0],
      humidity: humidity[0],
      precipitation: precipitation[0],
      city: 'Madrid'
    },
    source: 'Simulación específica Madrid',
    cached: false,
    timestamp: new Date().toISOString()
  };
}

// Función de emergencia para datos mínimos de Madrid
function generateMadridEmergencyWeatherData() {
  console.log('🚨 Generando datos meteorológicos de emergencia para Madrid...');
  
  const now = new Date();
  const month = now.getMonth();
  
  // Temperaturas promedio históricas para Madrid por mes
  const madridAvgTemps = [9, 11, 15, 17, 21, 26, 29, 28, 24, 18, 12, 9];
  const baseTemp = madridAvgTemps[month];
  
  return {
    labels: ['Ahora', '3h', '6h', '9h', '12h', '15h', '18h', '21h'],
    temperatures: [baseTemp, baseTemp + 2, baseTemp + 3, baseTemp + 1, baseTemp - 1, baseTemp - 2, baseTemp - 3, baseTemp - 1],
    humidity: [50, 52, 48, 45, 47, 50, 55, 53],
    precipitation: [0, 5, 0, 0, 10, 5, 0, 0],
    current: {
      description: 'datos históricos promedio',
      temp: baseTemp,
      humidity: 50,
      precipitation: 0,
      city: 'Madrid'
    },
    source: 'Datos históricos de emergencia',
    cached: false,
    timestamp: new Date().toISOString()
  };
}

function generateMockWeatherData() {
  console.log('🎲 Generando datos meteorológicos de respaldo realistas...');
  
  const now = new Date();
  const currentHour = now.getHours();
  const labels = [];
  
  // Generar etiquetas para las próximas 8 horas
  for (let i = 0; i < 8; i++) {
    const hour = (currentHour + i * 3) % 24;
    labels.push(`${hour.toString().padStart(2, '0')}:00`);
  }
  
  // Datos realistas basados en la ubicación y estación del año
  const month = now.getMonth(); // 0-11
  const isWinter = month === 11 || month === 0 || month === 1 || month === 2;
  const isSummer = month >= 5 && month <= 8;
  
  // Temperatura base según ubicación (aproximada por latitud)
  let baseTemp = 15; // Default para centro de España
  if (currentLocation.lat > 43) baseTemp = 12; // Norte (más frío)
  else if (currentLocation.lat < 37) baseTemp = 20; // Sur (más cálido)
  
  // Ajuste estacional
  if (isWinter) baseTemp -= 8;
  else if (isSummer) baseTemp += 12;
  
  // Generar variación natural durante el día
  const temperatures = labels.map((label, i) => {
    const hour = parseInt(label.split(':')[0]);
    let tempVariation = 0;
    
    // Variación típica diaria
    if (hour >= 6 && hour <= 12) tempVariation = (hour - 6) * 0.5; // Subida matutina
    else if (hour >= 13 && hour <= 18) tempVariation = 3; // Máxima tarde
    else if (hour >= 19 && hour <= 23) tempVariation = 3 - (hour - 18) * 0.6; // Bajada nocturna
    else tempVariation = -2; // Mínima madrugada
    
    return Math.round(baseTemp + tempVariation + (Math.random() - 0.5) * 3);
  });
  
  // Humedad típica española (varía según región)
  const baseHumidity = currentLocation.lat > 43 ? 70 : // Norte (más húmedo)
                       currentLocation.lat < 37 ? 45 : // Sur (más seco)  
                       60; // Centro
  
  const humidity = labels.map(() => 
    Math.round(Math.max(30, Math.min(90, baseHumidity + (Math.random() - 0.5) * 20)))
  );
  
  // Precipitación según región y estación
  const rainChance = currentLocation.lat > 43 ? 0.3 : // Norte (más lluvia)
                     isSummer ? 0.1 : // Verano seco
                     0.2; // Default
  
  const precipitation = labels.map(() => 
    Math.random() < rainChance ? Math.round(Math.random() * 80) : Math.round(Math.random() * 15)
  );
  
  // Condiciones actuales
  const currentTemp = temperatures[0];
  const currentConditions = [
    'cielo despejado', 'algunas nubes', 'nubes dispersas', 
    'muy nuboso', 'lluvia ligera', 'soleado'
  ];
  
  let description = currentConditions[0]; // Default: despejado
  if (precipitation[0] > 50) description = 'lluvia ligera';
  else if (precipitation[0] > 20) description = 'nubes dispersas';
  else if (Math.random() > 0.7) description = currentConditions[Math.floor(Math.random() * currentConditions.length)];

  const mockData = {
    labels,
    temperatures,
    humidity,
    precipitation,
    current: {
      description,
      temp: currentTemp,
      humidity: humidity[0],
      precipitation: precipitation[0],
      city: currentLocation.name
    },
    source: 'Datos de Respaldo',
    cached: false,
    timestamp: now.toISOString(),
    location: {
      name: currentLocation.name,
      lat: currentLocation.lat,
      lon: currentLocation.lon
    }
  };
  
  console.log(`🎲 Datos de respaldo generados para ${currentLocation.name}:`, {
    temp: `${currentTemp}°C`,
    humidity: `${humidity[0]}%`,
    description
  });
  
  return mockData;
}

function updateWeatherDisplay(element, data) {
  const { current } = data;
  const cityName = current.city || currentLocation.name || 'Madrid';
  
  // Información sobre el origen de los datos
  const sourceInfo = data.fromServer ? '🖥️ Servidor' : '🌐 OpenWeatherMap';
  const locationStatus = currentLocation.detected ? '📍 Detectada' : 
                        currentLocation.name === 'Madrid' ? '⚙️ Por defecto' : 
                        '👆 Seleccionada';
  
  // Generar alertas y recomendaciones
  const { alerts, recommendations } = generateWeatherAlerts(current, data);
  const energyTips = getEnergyRecommendations(current, globalPrices);
  
  element.innerHTML = `
  <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 25px; border-radius: 16px; margin: 15px 0; color: #2c3e50; position: relative; overflow: hidden; border: 2px solid #dee2e6;">
    
    <!-- Header con ubicación y fuente -->
    <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px; flex-direction: column; gap: 8px;">
      <h4 style="margin: 0; font-size: 1.3rem; text-shadow: none; color: #2c3e50;">
        📍 ${cityName}, España
      </h4>
      <div style="display: flex; gap: 15px; font-size: 0.85rem; color: #6c757d;">
        <span style="background: rgba(52, 152, 219, 0.1); padding: 4px 8px; border-radius: 8px; border: 1px solid rgba(52, 152, 219, 0.2);">
          ${locationStatus}
        </span>
        <span style="background: rgba(40, 167, 69, 0.1); padding: 4px 8px; border-radius: 8px; border: 1px solid rgba(40, 167, 69, 0.2);">
          ${sourceInfo}
        </span>
      </div>
    </div>
    
    <!-- Grid principal con datos -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px;">
      
      <!-- Temperatura principal -->
      <div style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 12px; text-align: center; border: 2px solid rgba(52, 152, 219, 0.2);">
        <div style="font-size: 2.2rem; margin-bottom: 5px;">🌡️</div>
        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 5px; color: #e74c3c;">${current.temp}°C</div>
        <div style="font-size: 0.9rem; opacity: 0.8; color: #2c3e50;">Temperatura</div>
      </div>
      
      <!-- Condiciones -->
      <div style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 12px; text-align: center; border: 2px solid rgba(52, 152, 219, 0.2);">
        <div style="font-size: 2.2rem; margin-bottom: 5px;">${getWeatherIcon(current.description)}</div>
        <div style="font-size: 1rem; font-weight: 600; margin-bottom: 5px; text-transform: capitalize; color: #2c3e50;">${current.description}</div>
        <div style="font-size: 0.9rem; opacity: 0.8; color: #2c3e50;">Condiciones</div>
      </div>
      
      <!-- Humedad -->
      <div style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 12px; text-align: center; border: 2px solid rgba(52, 152, 219, 0.2);">
        <div style="font-size: 2.2rem; margin-bottom: 5px;">💧</div>
        <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; color: #3498db;">${Math.round(current.humidity)}%</div>
        <div style="font-size: 0.9rem; opacity: 0.8; color: #2c3e50;">Humedad</div>
      </div>
      
      <!-- Probabilidad de lluvia -->
      <div style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 12px; text-align: center; border: 2px solid rgba(52, 152, 219, 0.2);">
        <div style="font-size: 2.2rem; margin-bottom: 5px;">🌧️</div>
        <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; color: #3498db;">${Math.round(current.precipitation)}%</div>
        <div style="font-size: 0.9rem; opacity: 0.8; color: #2c3e50;">Prob. lluvia</div>
      </div>
      
    </div>
    
    <!-- Barra de sensación térmica -->
    <div style="background: rgba(108, 117, 125, 0.1); padding: 12px; border-radius: 12px; border: 2px solid rgba(108, 117, 125, 0.2);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <span style="font-size: 0.95rem; font-weight: 600; color: #2c3e50;">🌡️ Sensación térmica</span>
        <span style="font-size: 1.1rem; font-weight: bold; color: #e74c3c;">${getThermalSensation(current.temp, current.humidity)}</span>
      </div>
      <div style="background: rgba(108, 117, 125, 0.2); height: 8px; border-radius: 4px; overflow: hidden;">
        <div style="background: ${getThermalColor(current.temp)}; height: 100%; width: ${Math.min((current.temp / 50) * 100, 100)}%; border-radius: 4px; transition: width 0.3s ease;"></div>
      </div>
    </div>
    
    <!-- Alertas meteorológicas -->
    ${displayWeatherAlerts(alerts, recommendations)}
    
    <!-- Recomendaciones energéticas -->
    ${energyTips.length > 0 ? `
      <div style="margin-top: 15px;">
        <h4 style="color: #2c3e50; margin-bottom: 10px; font-size: 1.1rem;">⚡ Recomendaciones Energéticas</h4>
        <div style="background: rgba(108, 117, 125, 0.1); padding: 12px; border-radius: 8px; border: 2px solid rgba(108, 117, 125, 0.2);">
          ${energyTips.map(tip => `
            <div style="font-size: 0.85rem; margin-bottom: 6px; display: flex; align-items: flex-start; gap: 6px; color: #2c3e50;">
              <span style="margin-top: 1px;">•</span>
              <span>${tip}</span>
            </div>
          `).join('')}
        </div>
      </div>
    ` : ''}
    
    <!-- Footer con última actualización -->
    <div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(108, 117, 125, 0.2);">
      <div style="font-size: 0.85rem; opacity: 0.8; color: #6c757d;">
        🕒 Actualizado: ${new Date().toLocaleTimeString('es-ES')} | 
        🔄 Próxima actualización en 10 min
      </div>
    </div>
    
  </div>
`;
}

// Función auxiliar para obtener iconos meteorológicos
function getWeatherIcon(description) {
  const desc = description.toLowerCase();
  if (desc.includes('despejado') || desc.includes('claro')) return '☀️';
  if (desc.includes('nube')) return '☁️';
  if (desc.includes('lluvia')) return '🌧️';
  if (desc.includes('tormenta')) return '⛈️';
  if (desc.includes('nieve')) return '❄️';
  if (desc.includes('niebla')) return '🌫️';
  return '🌤️';
}

// Función para calcular sensación térmica
function getThermalSensation(temp, humidity) {
  if (temp >= 35) return '🔥 Muy caluroso';
  if (temp >= 30) return '🌡️ Caluroso';
  if (temp >= 25) return '😊 Agradable';
  if (temp >= 20) return '🙂 Templado';
  if (temp >= 15) return '😐 Fresco';
  if (temp >= 10) return '🥶 Frío';
  return '❄️ Muy frío';
}

// Función para color de la barra térmica
function getThermalColor(temp) {
  if (temp >= 35) return '#ff4757';
  if (temp >= 30) return '#ff6b35';
  if (temp >= 25) return '#ffa502';
  if (temp >= 20) return '#2ed573';
  if (temp >= 15) return '#70a1ff';
  return '#5352ed';
}

// ===== SISTEMA DE ALERTAS METEOROLÓGICAS =====
function generateWeatherAlerts(current, forecast) {
  const alerts = [];
  const recommendations = [];
  
  // Alerta por temperatura extrema
  if (current.temp >= 35) {
    alerts.push({
      type: 'danger',
      icon: '🔥',
      title: 'Alerta por Calor Extremo',
      message: `Temperatura muy alta: ${current.temp}°C`
    });
    recommendations.push('💧 Mantente hidratado - bebe agua frecuentemente');
    recommendations.push('🏠 Evita actividades al aire libre entre 12:00 y 17:00');
    recommendations.push('❄️ Usa el aire acondicionado en las horas más baratas de electricidad');
    recommendations.push('👕 Usa ropa ligera y de colores claros');
  } else if (current.temp >= 30) {
    alerts.push({
      type: 'warning',
      icon: '🌡️',
      title: 'Temperatura Alta',
      message: `Día caluroso: ${current.temp}°C`
    });
    recommendations.push('💧 Mantente hidratado');
    recommendations.push('🌂 Busca sombra si estás al aire libre');
    recommendations.push('❄️ Considera usar ventilación o aire acondicionado');
  }
  
  // Alerta por frío extremo
  if (current.temp <= 5) {
    alerts.push({
      type: 'danger',
      icon: '❄️',
      title: 'Alerta por Frío Extremo',
      message: `Temperatura muy baja: ${current.temp}°C`
    });
    recommendations.push('🧥 Abrígate bien antes de salir');
    recommendations.push('🔥 Usa calefacción - revisa las tarifas eléctricas más baratas');
    recommendations.push('🚗 Precaución al conducir - posible hielo en carreteras');
  } else if (current.temp <= 10) {
    alerts.push({
      type: 'warning',
      icon: '🥶',
      title: 'Temperatura Baja',
      message: `Día frío: ${current.temp}°C`
    });
    recommendations.push('🧥 Vístete con ropa de abrigo');
    recommendations.push('🔥 Considera usar calefacción');
  }
  
  // Alerta por lluvia
  if (current.precipitation >= 70) {
    alerts.push({
      type: 'warning',
      icon: '🌧️',
      title: 'Alta Probabilidad de Lluvia',
      message: `${current.precipitation}% de probabilidad`
    });
    recommendations.push('☂️ Lleva paraguas o impermeable');
    recommendations.push('🚗 Conduce con precaución');
    recommendations.push('👕 Evita tender ropa al aire libre');
    recommendations.push('🏠 Cierra ventanas si hay viento');
  } else if (current.precipitation >= 40) {
    alerts.push({
      type: 'info',
      icon: '🌦️',
      title: 'Posible Lluvia',
      message: `${current.precipitation}% de probabilidad`
    });
    recommendations.push('☂️ Ten un paraguas a mano');
  }
  
  // Alerta por humedad
  if (current.humidity >= 80) {
    alerts.push({
      type: 'info',
      icon: '💧',
      title: 'Alta Humedad',
      message: `Humedad: ${current.humidity}%`
    });
    recommendations.push('🌬️ Ventila tu hogar para reducir la humedad');
    recommendations.push('👕 La ropa tardará más en secarse');
    if (current.temp >= 25) {
      recommendations.push('❄️ La sensación térmica será mayor - usa aire acondicionado');
    }
  }
  
  // Recomendaciones energéticas basadas en el clima
  if (current.temp >= 30 || current.temp <= 10) {
    recommendations.push('⚡ Revisa los precios de electricidad para usar calefacción/aire acondicionado en horas baratas');
  }
  
  // Recomendaciones para actividades
  if (current.temp >= 20 && current.temp <= 28 && current.precipitation <= 20) {
    recommendations.push('🚴 Buen día para actividades al aire libre');
    recommendations.push('👕 Ideal para tender ropa');
  }
  
  return { alerts, recommendations };
}

// Función para mostrar alertas en la interfaz
function displayWeatherAlerts(alerts, recommendations) {
  if (alerts.length === 0 && recommendations.length === 0) {
    return '';
  }
  
  let alertsHTML = '';
  
  // Mostrar alertas
  if (alerts.length > 0) {
    alertsHTML += `
      <div style="margin-top: 20px;">
        <h4 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.1rem;">🚨 Alertas Meteorológicas</h4>
    `;
    
    alerts.forEach(alert => {
      const bgColor = getAlertColor(alert.type);
      const textColor = getAlertTextColor(alert.type);
      alertsHTML += `
        <div style="background: ${bgColor}; padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 2px solid ${getAlertBorderColor(alert.type)};">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 1.2rem;">${alert.icon}</span>
            <div>
              <div style="font-weight: bold; font-size: 0.9rem; color: ${textColor};">${alert.title}</div>
              <div style="font-size: 0.85rem; color: ${textColor}; opacity: 0.9;">${alert.message}</div>
            </div>
          </div>
        </div>
      `;
    });
    
    alertsHTML += '</div>';
  }
  
  // Mostrar recomendaciones
  if (recommendations.length > 0) {
    alertsHTML += `
      <div style="margin-top: 15px;">
        <h4 style="color: #2c3e50; margin-bottom: 10px; font-size: 1.1rem;">💡 Recomendaciones</h4>
        <div style="background: rgba(52, 152, 219, 0.1); padding: 12px; border-radius: 8px; border: 2px solid rgba(52, 152, 219, 0.3);">
    `;
    
    recommendations.forEach(rec => {
      alertsHTML += `
        <div style="font-size: 0.85rem; margin-bottom: 6px; display: flex; align-items: flex-start; gap: 6px; color: #2c3e50;">
          <span style="margin-top: 1px; color: #3498db; font-weight: bold;">•</span>
          <span>${rec}</span>
        </div>
      `;
    });
    
    alertsHTML += '</div></div>';
  }
  
  return alertsHTML;
}

// Función auxiliar para colores de alertas
function getAlertColor(type) {
  switch(type) {
    case 'danger': return 'rgba(231, 76, 60, 0.15)';
    case 'warning': return 'rgba(243, 156, 18, 0.15)';
    case 'info': return 'rgba(52, 152, 219, 0.15)';
    default: return 'rgba(108, 117, 125, 0.1)';
  }
}

function getAlertTextColor(type) {
  switch(type) {
    case 'danger': return '#c0392b';
    case 'warning': return '#d68910';
    case 'info': return '#2874a6';
    default: return '#2c3e50';
  }
}

function getAlertBorderColor(type) {
  switch(type) {
    case 'danger': return 'rgba(231, 76, 60, 0.3)';
    case 'warning': return 'rgba(243, 156, 18, 0.3)';
    case 'info': return 'rgba(52, 152, 219, 0.3)';
    default: return 'rgba(108, 117, 125, 0.2)';
  }
}

// Función para recomendaciones energéticas
function getEnergyRecommendations(current, prices) {
  const energyTips = [];
  const currentHour = new Date().getHours();
  
  if (!prices || prices.length === 0) return energyTips;
  
  const currentPrice = prices[currentHour] || 0.10;
  const minPrice = Math.min(...prices);
  const maxPrice = Math.max(...prices);
  const bestHour = prices.indexOf(minPrice);
  
  // Recomendaciones por temperatura
  if (current.temp >= 30) {
    if (currentPrice > minPrice * 1.5) {
      energyTips.push(`❄️ Aire acondicionado: Espera hasta las ${formatTime(bestHour)}:00 para ahorrar ${((currentPrice - minPrice) * 3).toFixed(2)}€ por cada 3 kWh`);
    } else {
      energyTips.push(`❄️ Buen momento para usar aire acondicionado - precio eléctrico favorable`);
    }
    energyTips.push(`🌡️ Configura el A/C a 24-25°C para optimizar consumo`);
  }
  
  if (current.temp <= 15) {
    if (currentPrice > minPrice * 1.5) {
      energyTips.push(`🔥 Calefacción: Mejor esperar hasta las ${formatTime(bestHour)}:00 para ahorrar`);
    } else {
      energyTips.push(`🔥 Momento ideal para usar calefacción - precio eléctrico bajo`);
    }
    energyTips.push(`🌡️ Configura calefacción a 20-21°C para eficiencia óptima`);
  }
  
  // Recomendaciones por humedad
  if (current.humidity >= 70) {
    energyTips.push(`🌬️ Usa deshumidificador en horas de precio bajo (${formatTime(bestHour)}:00)`);
  }
  
  // Recomendaciones generales
  if (currentPrice >= maxPrice * 0.8) {
    energyTips.push(`⚠️ Precio eléctrico alto - evita electrodomésticos potentes hasta las ${formatTime(bestHour)}:00`);
  }
  
  return energyTips;
}

// Función para generar datos meteorológicos de 24 horas completas
function generateFullDayWeatherData(apiData) {
  const now = new Date();
  const currentHour = now.getHours();
  
  // Generar etiquetas para 24 horas
  const labels = [];
  for (let i = 0; i < 24; i++) {
    labels.push(`${i.toString().padStart(2, '0')}:00`);
  }
  
  const temperatures = new Array(24);
  const humidity = new Array(24);
  const precipitation = new Array(24);
  
  // Obtener temperatura actual real si está disponible
  const currentTemp = apiData.current ? apiData.current.temp : apiData.temperatures[0];
  const currentHumidity = apiData.current ? apiData.current.humidity : apiData.humidity[0];
  const currentPrecip = apiData.current ? apiData.current.precipitation : apiData.precipitation[0];
  
  // Llenar datos de API disponibles (generalmente próximas horas)
  const apiHours = apiData.labels ? apiData.labels.length : 8;
  for (let i = 0; i < apiHours && i < 24; i++) {
    const apiHour = (currentHour + i * 3) % 24; // Los datos de API suelen ser cada 3 horas
    if (apiHour < 24) {
      temperatures[apiHour] = apiData.temperatures[i];
      humidity[apiHour] = apiData.humidity[i];
      precipitation[apiHour] = apiData.precipitation[i];
    }
  }
  
  // Establecer temperatura actual en la hora actual
  temperatures[currentHour] = currentTemp;
  humidity[currentHour] = currentHumidity;
  precipitation[currentHour] = currentPrecip;
  
  // Generar datos para horas pasadas (simulación basada en patrones realistas)
  for (let i = 0; i < currentHour; i++) {
    if (temperatures[i] === undefined) {
      // Simular temperaturas pasadas basadas en el patrón diario
      const hourDifference = currentHour - i;
      let tempVariation = 0;
      
      if (i >= 6 && i <= 12) tempVariation = -2; // Mañana más fresca
      else if (i >= 13 && i <= 16) tempVariation = 3; // Tarde más calurosa
      else if (i >= 17 && i <= 20) tempVariation = 1; // Atardecer
      else tempVariation = -4; // Noche más fría
      
      temperatures[i] = Math.round(currentTemp + tempVariation + (Math.random() - 0.5) * 2);
    }
    
    if (humidity[i] === undefined) {
      // Humedad típicamente más alta por la noche/madrugada
      const humidityVariation = (i >= 22 || i <= 6) ? 15 : -10;
      humidity[i] = Math.round(Math.max(30, Math.min(90, currentHumidity + humidityVariation + (Math.random() - 0.5) * 10)));
    }
    
    if (precipitation[i] === undefined) {
      // Precipitaciones generalmente más probables por la tarde/noche
      const precipVariation = (i >= 15 && i <= 21) ? 5 : -2;
      precipitation[i] = Math.round(Math.max(0, currentPrecip + precipVariation + (Math.random() - 0.5) * 5));
    }
  }
  
  // Generar datos para horas futuras si no están disponibles
  for (let i = currentHour + 1; i < 24; i++) {
    if (temperatures[i] === undefined) {
      // Proyección basada en tendencias típicas
      const hoursAhead = i - currentHour;
      let tempTrend = 0;
      
      if (currentHour < 14 && i <= 16) tempTrend = 2; // Calentamiento diurno
      else if (currentHour >= 16 && i >= 18) tempTrend = -3; // Enfriamiento nocturno
      else tempTrend = -1; // Tendencia general de enfriamiento
      
      temperatures[i] = Math.round(currentTemp + tempTrend + (Math.random() - 0.5) * 2);
    }
    
    if (humidity[i] === undefined) {
      const humidityTrend = (i >= 20 || i <= 6) ? 10 : -5; // Sube por la noche
      humidity[i] = Math.round(Math.max(30, Math.min(90, currentHumidity + humidityTrend + (Math.random() - 0.5) * 8)));
    }
    
    if (precipitation[i] === undefined) {
      precipitation[i] = Math.round(Math.max(0, currentPrecip + (Math.random() - 0.5) * 5));
    }
  }
  
  return {
    labels,
    temperatures,
    humidity,
    precipitation,
    currentHour
  };
}

function renderWeatherChart(ctx, data) {
  if (weatherChart) {
    weatherChart.destroy();
  }

  // Generar datos para 24 horas completas
  const fullDayData = generateFullDayWeatherData(data);
  const currentHour = new Date().getHours();
  
  // Separar datos en pasado y futuro
  const pastTemperatures = [];
  const futureTemperatures = [];
  const pastHumidity = [];
  const futureHumidity = [];
  const pastPrecipitation = [];
  const futurePrecipitation = [];
  
  fullDayData.labels.forEach((label, index) => {
    const hour = parseInt(label.split(':')[0]);
    
    if (hour <= currentHour) {
      pastTemperatures.push(fullDayData.temperatures[index]);
      futureTemperatures.push(null);
      pastHumidity.push(fullDayData.humidity[index]);
      futureHumidity.push(null);
      pastPrecipitation.push(fullDayData.precipitation[index]);
      futurePrecipitation.push(null);
    } else {
      pastTemperatures.push(null);
      futureTemperatures.push(fullDayData.temperatures[index]);
      pastHumidity.push(null);
      futureHumidity.push(fullDayData.humidity[index]);
      pastPrecipitation.push(null);
      futurePrecipitation.push(fullDayData.precipitation[index]);
    }
  });

  const datasets = [
    // Temperaturas pasadas (registradas)
    {
      label: "Temperatura Registrada (°C)",
      data: pastTemperatures,
      borderColor: "#2c3e50",
      backgroundColor: "rgba(44, 62, 80, 0.1)",
      fill: false,
      tension: 0.3,
      hidden: false,
      borderWidth: 3,
      pointBackgroundColor: "#2c3e50",
      pointBorderColor: "#ffffff",
      pointBorderWidth: 2,
      pointRadius: 4
    },
    // Temperaturas futuras (previstas)
    {
      label: "Temperatura Prevista (°C)",
      data: futureTemperatures,
      borderColor: "#3498db",
      backgroundColor: "rgba(52, 152, 219, 0.1)",
      fill: false,
      tension: 0.3,
      hidden: false,
      borderWidth: 2,
      borderDash: [5, 5],
      pointBackgroundColor: "#3498db",
      pointBorderColor: "#ffffff",
      pointBorderWidth: 2,
      pointRadius: 3
    },
    // Humedad pasada
    {
      label: "Humedad Registrada (%)",
      data: pastHumidity,
      borderColor: "#27ae60",
      backgroundColor: "rgba(39, 174, 96, 0.1)",
      fill: false,
      tension: 0.3,
      hidden: true,
      borderWidth: 3,
      pointBackgroundColor: "#27ae60",
      pointRadius: 3
    },
    // Humedad futura
    {
      label: "Humedad Prevista (%)",
      data: futureHumidity,
      borderColor: "#2ecc71",
      backgroundColor: "rgba(46, 204, 113, 0.1)",
      fill: false,
      tension: 0.3,
      hidden: true,
      borderWidth: 2,
      borderDash: [5, 5],
      pointBackgroundColor: "#2ecc71",
      pointRadius: 2
    },
    // Precipitaciones pasadas
    {
      label: "Precipitaciones Registradas (%)",
      data: pastPrecipitation,
      borderColor: "#e74c3c",
      backgroundColor: "rgba(231, 76, 60, 0.1)",
      fill: false,
      tension: 0.3,
      hidden: true,
      borderWidth: 3,
      pointBackgroundColor: "#e74c3c",
      pointRadius: 3
    },
    // Precipitaciones futuras
    {
      label: "Precipitaciones Previstas (%)",
      data: futurePrecipitation,
      borderColor: "#c0392b",
      backgroundColor: "rgba(192, 57, 43, 0.1)",
      fill: false,
      tension: 0.3,
      hidden: true,
      borderWidth: 2,
      borderDash: [5, 5],
      pointBackgroundColor: "#c0392b",
      pointRadius: 2
    }
  ];

  weatherChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: fullDayData.labels,
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          title: {
            display: true,
            text: "Hora del Día (24h)"
          },
          grid: {
            display: true,
            color: 'rgba(0,0,0,0.1)'
          }
        },
        y: {
          beginAtZero: true,
          max: 100,
          title: {
            display: true,
            text: "Valores"
          },
          grid: {
            display: true,
            color: 'rgba(0,0,0,0.1)'
          }
        }
      },
      plugins: {
        legend: { 
          display: true,
          position: 'top'
        },
        annotation: {
          annotations: {
            currentTime: {
              type: 'line',
              mode: 'vertical',
              scaleID: 'x',
              value: currentHour,
              borderColor: '#f39c12',
              borderWidth: 3,
              borderDash: [3, 3],
              label: {
                enabled: true,
                content: `Ahora (${currentHour}:${new Date().getMinutes().toString().padStart(2, '0')})`,
                position: 'top'
              }
            }
          }
        }
      },
      elements: {
        point: {
          hoverRadius: 6
        }
      },
      interaction: {
        intersect: false,
        mode: 'index'
      }
    }
  });
}

function setupWeatherControls() {
  const controlIds = ['temp-checkbox', 'humidity-checkbox', 'precipitation-checkbox'];
  const labelIds = ['temp-label', 'humidity-label', 'precipitation-label'];

  function updateVisibility(activeMetric) {
    if (!weatherChart) return;
    
    // Tenemos 6 datasets: [0,1] temperatura, [2,3] humedad, [4,5] precipitaciones
    // Cada par representa: [registrado, previsto]
    
    for (let i = 0; i < 6; i++) {
      const datasetMeta = weatherChart.getDatasetMeta(i);
      if (datasetMeta) {
        switch (activeMetric) {
          case 0: // Temperatura
            datasetMeta.hidden = !(i === 0 || i === 1); // Mostrar solo temperatura registrada y prevista
            break;
          case 1: // Humedad
            datasetMeta.hidden = !(i === 2 || i === 3); // Mostrar solo humedad registrada y prevista
            break;
          case 2: // Precipitaciones
            datasetMeta.hidden = !(i === 4 || i === 5); // Mostrar solo precipitaciones registradas y previstas
            break;
          default:
            datasetMeta.hidden = true;
        }
      }
    }
    
    // Actualizar etiquetas de los controles
    labelIds.forEach((labelId, index) => {
      const label = document.getElementById(labelId);
      if (label) {
        if (index === activeMetric) {
          label.classList.add('active');
        } else {
          label.classList.remove('active');
        }
      }
    });
    
    weatherChart.update();
  }

  // Configurar event listeners para los checkboxes
  controlIds.forEach((id, index) => {
    const checkbox = document.getElementById(id);
    if (checkbox) {
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          // Desmarcar otros checkboxes
          controlIds.forEach((otherId, otherIndex) => {
            if (otherIndex !== index) {
              const otherCheckbox = document.getElementById(otherId);
              if (otherCheckbox) otherCheckbox.checked = false;
            }
          });
          updateVisibility(index);
        } else {
          // Si se desmarca, mostrar temperatura por defecto
          updateVisibility(0);
          const tempCheckbox = document.getElementById('temp-checkbox');
          if (tempCheckbox) tempCheckbox.checked = true;
        }
      });
    }
  });

  // Inicializar con temperatura visible por defecto
  setTimeout(() => {
    const tempCheckbox = document.getElementById('temp-checkbox');
    if (tempCheckbox) {
      tempCheckbox.checked = true;
      updateVisibility(0);
    }
  }, 100);
}

// ===== MAP FUNCTIONALITY RESTRINGIDO A ESPAÑA =====
let currentLocation = {
  name: 'Madrid',
  lat: 40.4168,
  lon: -3.7038,
  country: 'España',
  detected: false // Indica si la ubicación fue detectada automáticamente
};

// Límites geográficos de España (incluyendo islas)
const SPAIN_BOUNDS = {
  north: 43.8,    // Galicia/País Vasco
  south: 27.6,    // Islas Canarias  
  east: 4.3,      // Cataluña/Baleares
  west: -18.2     // Islas Canarias (El Hierro)
};

// ===== GEOLOCATION FUNCTIONALITY =====
async function detectUserLocation() {
  console.log('🌍 Intentando detectar ubicación del usuario...');
  
  return new Promise((resolve) => {
    // Verificar si el navegador soporta geolocalización
    if (!navigator.geolocation) {
      console.log('❌ Geolocalización no soportada por el navegador');
      resolve(null);
      return;
    }

    // Configuración de geolocalización
    const options = {
      enableHighAccuracy: true,
      timeout: 10000, // 10 segundos máximo
      maximumAge: 300000 // 5 minutos de caché
    };

    navigator.geolocation.getCurrentPosition(
      async (position) => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        
        console.log(`📍 Ubicación detectada: ${lat}, ${lon}`);
        
        // Verificar si está en España
        if (isWithinSpain(lat, lon)) {
          try {
            // Obtener información de la ubicación
            const locationInfo = await getLocationInfo(lat, lon);
            if (locationInfo && locationInfo.name) {
              console.log(`✅ Ubicación española detectada: ${locationInfo.name}`);
              resolve({
                name: locationInfo.name,
                lat: lat,
                lon: lon,
                country: 'España',
                detected: true
              });
              return;
            }
          } catch (error) {
            console.log('❌ Error obteniendo información de ubicación:', error);
          }
        } else {
          console.log('⚠️ Ubicación detectada fuera de España, usando Madrid por defecto');
        }
        
        // Si no está en España o hay error, usar Madrid
        resolve(null);
      },
      (error) => {
        console.log('❌ Error de geolocalización:', error.message);
        resolve(null);
      },
      options
    );
  });
}

// Función para observar cuando el mapa es visible y mostrar popup
function setupMapVisibilityObserver(marker) {
  const mapElement = document.getElementById('map');
  if (!mapElement) return;

  // Crear Intersection Observer
  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        // El mapa es visible, abrir popup del marcador
        setTimeout(() => {
          if (marker && marker.openPopup) {
            marker.openPopup();
            console.log('📍 Popup del mapa mostrado al llegar a la sección');
          }
        }, 500); // Pequeño delay para que la animación de scroll termine
        
        // Desconectar el observer después de mostrar el popup una vez
        observer.disconnect();
      }
    });
  }, {
    threshold: 0.3, // Activar cuando el 30% del mapa sea visible
    rootMargin: '-50px' // Margen para activar un poco antes
  });

  // Comenzar a observar el elemento del mapa
  observer.observe(mapElement);
}

// Función para mostrar popup solo si el mapa es visible o es acción de usuario
function showPopupIfMapVisible(marker, isUserAction = false) {
  if (!marker || !marker.openPopup) return;
  
  const mapElement = document.getElementById('map');
  if (!mapElement) return;

  // Si es acción del usuario (doble click, búsqueda), mostrar inmediatamente
  if (isUserAction) {
    marker.openPopup();
    console.log('📍 Popup mostrado por acción del usuario');
    return;
  }

  // Verificar si el mapa está visible en el viewport
  const rect = mapElement.getBoundingClientRect();
  const isVisible = rect.top < window.innerHeight && rect.bottom > 0;
  
  if (isVisible) {
    setTimeout(() => {
      marker.openPopup();
      console.log('📍 Popup mostrado - mapa visible');
    }, 500);
  } else {
    // Configurar observer para mostrar cuando sea visible
    setupMapVisibilityObserver(marker);
  }
}

async function initializeMap() {
  if (map) {
    map.remove();
  }

  // Intentar detectar ubicación del usuario primero
  const detectedLocation = await detectUserLocation();
  if (detectedLocation) {
    currentLocation = detectedLocation;
    console.log(`🎯 Usando ubicación detectada: ${currentLocation.name}`);
    updateLocationInfo(); // Actualizar la información en el banner
  } else {
    console.log(`🏠 Usando ubicación por defecto: Madrid`);
    currentLocation.detected = false;
    updateLocationInfo(); // Actualizar la información en el banner
  }

  // Centrar mapa en España
  map = L.map('map').setView([39.5, -4.0], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors',
    maxZoom: 18
  }).addTo(map);

  // Marcador en la ubicación actual (detectada o por defecto)
  let currentMarker = L.marker([currentLocation.lat, currentLocation.lon])
    .addTo(map)
    .bindPopup(`📍 ${currentLocation.name}, ${currentLocation.country}`);

  // Si se detectó ubicación, centrar el mapa en ella
  if (currentLocation.detected) {
    map.setView([currentLocation.lat, currentLocation.lon], 10);
  }

  // Mostrar popup solo cuando el mapa sea visible
  showPopupIfMapVisible(currentMarker, false);

  // Dibujar los límites de España como referencia visual
  drawSpainBounds();

  // Variables para manejar clicks simples vs dobles
  let clickTimer = null;
  let clickDelay = 300; // ms para distinguir entre click simple y doble

  // Event listener para clicks simples en el mapa (SOLO MOSTRAR INFORMACIÓN)
  map.on('click', function(e) {
    // Cancelar si hay un timer de doble click activo
    if (clickTimer) {
      return;
    }
    
    clickTimer = setTimeout(async () => {
      try {
        console.log('🖱️ Click simple en mapa:', e.latlng);
        
        // Verificar si está dentro de España
        if (!isWithinSpain(e.latlng.lat, e.latlng.lng)) {
          showLocationPreview(e.latlng, null, false);
          return;
        }
        
        // Mostrar preview de la ubicación sin cambiar datos
        const locationInfo = await getLocationInfo(e.latlng.lat, e.latlng.lng);
        showLocationPreview(e.latlng, locationInfo, true);
        
      } catch (error) {
        console.error('❌ Error en preview de ubicación:', error);
        showLocationPreview(e.latlng, null, false);
      } finally {
        clickTimer = null;
      }
    }, clickDelay);
  });

  // Event listener para DOBLE CLICK (SELECCIONAR UBICACIÓN)
  map.on('dblclick', async function(e) {
    // Cancelar el timer de click simple
    if (clickTimer) {
      clearTimeout(clickTimer);
      clickTimer = null;
    }

    try {
      console.log('🖱️🖱️ Doble click en mapa - Seleccionando ubicación:', e.latlng);
      
      // Mostrar loading inmediatamente
      const weatherElement = document.getElementById("weather");
      showLoading("weather");
      
      // Verificar si está dentro de España
      if (!isWithinSpain(e.latlng.lat, e.latlng.lng)) {
        hideLoading("weather");
        showSpainOnlyAlert();
        return;
      }
      
      // Obtener información de la ubicación
      const locationInfo = await getLocationInfo(e.latlng.lat, e.latlng.lng);
      
      // Verificar que la ubicación esté en España
      if (locationInfo && isLocationInSpain(locationInfo)) {
        // Actualizar ubicación actual
        currentLocation = {
          name: locationInfo.name,
          lat: e.latlng.lat,
          lon: e.latlng.lng,
          country: 'España',
          detected: false // Marcada como seleccionada manualmente
        };
        
        // Actualizar información de ubicación en el banner
        updateLocationInfo();
        
        // Remover marcador anterior
        if (currentMarker) {
          map.removeLayer(currentMarker);
        }
        
        // Añadir nuevo marcador
        currentMarker = L.marker([e.latlng.lat, e.latlng.lng])
          .addTo(map)
          .bindPopup(`📍 ${locationInfo.name}, España`);
        
        // Mostrar popup inmediatamente porque es acción del usuario
        showPopupIfMapVisible(currentMarker, true);
        
        // Actualizar toda la información de la página
        await updateAllDataForLocation();
        
        // Mostrar confirmación de selección
        showLocationSelectedNotification(locationInfo.name);
        
        console.log('✅ Ubicación española seleccionada:', currentLocation);
      } else {
        hideLoading("weather");
        showSpainOnlyAlert();
      }
      
    } catch (error) {
      console.error('❌ Error al seleccionar ubicación:', error);
      hideLoading("weather");
      alert('Error al obtener información de la ubicación. Intenta con otra ubicación dentro de España.');
    }
  });

  // Mostrar instrucciones al usuario
  setTimeout(() => {
    showMapInstructions();
  }, 2000);
}

// Función para verificar si está dentro de España
function isWithinSpain(lat, lon) {
  return (
    lat >= SPAIN_BOUNDS.south && 
    lat <= SPAIN_BOUNDS.north && 
    lon >= SPAIN_BOUNDS.west && 
    lon <= SPAIN_BOUNDS.east
  );
}

// Función para verificar si una ubicación es española
function isLocationInSpain(locationInfo) {
  const country = locationInfo.country?.toLowerCase() || '';
  const fullData = locationInfo.fullData || {};
  const address = fullData.address || {};
  
  const spanishIdentifiers = [
    'españa', 'spain', 'espagne', 'spagna', 
    'es', 'esp', 'spanish', 'español'
  ];
  
  return spanishIdentifiers.some(identifier => 
    country.includes(identifier) || 
    address.country?.toLowerCase().includes(identifier)
  );
}

// Función para dibujar límites de España
function drawSpainBounds() {
  const spainRectangle = L.rectangle([
    [SPAIN_BOUNDS.south, SPAIN_BOUNDS.west],
    [SPAIN_BOUNDS.north, SPAIN_BOUNDS.east]
  ], {
    color: '#3498db',
    weight: 2,
    opacity: 0.3,
    fillOpacity: 0.05,
    fillColor: '#3498db'
  }).addTo(map);
  
  spainRectangle.bindPopup('🇪🇸 Área de cobertura: España (incluyendo Baleares y Canarias)');
}

// Funciones de preview y notificaciones
function showLocationPreview(latlng, locationInfo, isInSpain) {
  const existingPreview = document.querySelector('.location-preview');
  if (existingPreview) {
    existingPreview.remove();
  }

  const preview = document.createElement('div');
  preview.className = 'location-preview';
  preview.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: ${isInSpain ? 'linear-gradient(45deg, #27ae60, #2ecc71)' : 'linear-gradient(45deg, #e74c3c, #c0392b)'};
    color: white;
    padding: 15px 25px;
    border-radius: 25px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    z-index: 10000;
    font-weight: 600;
    font-size: 0.9rem;
    animation: slideUp 0.3s ease-out;
    max-width: 90%;
    text-align: center;
  `;

  const lat = latlng.lat.toFixed(4);
  const lon = latlng.lng.toFixed(4);

  if (isInSpain && locationInfo) {
    preview.innerHTML = `
      <div>
        <span>📍 ${locationInfo.name}</span>
        <span style="opacity: 0.8; font-size: 0.8rem;">(${lat}, ${lon})</span>
        <br>
        <span style="font-size: 0.8rem;">🖱️🖱️ Doble click para seleccionar</span>
      </div>
    `;
  } else if (isInSpain) {
    preview.innerHTML = `
      <div>
        <span>📍 Ubicación española</span>
        <span style="opacity: 0.8; font-size: 0.8rem;">(${lat}, ${lon})</span>
        <br>
        <span style="font-size: 0.8rem;">🖱️🖱️ Doble click para seleccionar</span>
      </div>
    `;
  } else {
    preview.innerHTML = `
      <div>
        <span>🚫 Fuera de España</span>
        <span style="opacity: 0.8; font-size: 0.8rem;">(${lat}, ${lon})</span>
        <br>
        <span style="font-size: 0.8rem;">Solo ubicaciones españolas</span>
      </div>
    `;
  }

  document.body.appendChild(preview);

  setTimeout(() => {
    if (preview.parentNode) {
      preview.style.animation = 'slideDown 0.3s ease-in';
      setTimeout(() => {
        if (preview.parentNode) {
          preview.remove();
        }
      }, 300);
    }
  }, 4000);
}

function showLocationSelectedNotification(cityName) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(45deg, #27ae60, #2ecc71);
    color: white;
    padding: 18px 25px;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    z-index: 10000;
    font-weight: 600;
    animation: slideInRight 0.4s ease-out;
    max-width: 300px;
  `;
  
  notification.innerHTML = `
    <div style="display: flex; align-items: center; gap: 12px;">
      <span style="font-size: 1.5rem;">✅</span>
      <div>
        <div style="font-size: 1rem; margin-bottom: 3px;">Ubicación seleccionada</div>
        <div style="font-size: 0.85rem; opacity: 0.9;">${cityName}, España</div>
        <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 3px;">Actualizando datos...</div>
      </div>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentNode) {
      notification.style.animation = 'slideOutRight 0.3s ease-in';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 300);
    }
  }, 4000);
}

function showMapInstructions() {
  const instructions = document.createElement('div');
  instructions.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(52, 73, 94, 0.95);
    color: white;
    padding: 25px 30px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    z-index: 10000;
    text-align: center;
    max-width: 400px;
    animation: fadeInScale 0.5s ease-out;
    backdrop-filter: blur(10px);
  `;
  
  instructions.innerHTML = `
    <div style="font-size: 2rem; margin-bottom: 15px;">📍</div>
    <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 15px;">¿Cómo usar el mapa?</div>
    <div style="font-size: 0.95rem; line-height: 1.6; margin-bottom: 20px;">
      <p style="margin-bottom: 10px;"><strong>🖱️ Click simple:</strong> Ver información</p>
      <p style="margin-bottom: 10px;"><strong>🖱️🖱️ Doble click:</strong> Seleccionar ubicación</p>
      <p style="margin-bottom: 10px;"><strong>🔍 Búsqueda:</strong> Ciudad española</p>
    </div>
    <button onclick="this.parentNode.remove()" style="
      padding: 10px 25px; 
      background: linear-gradient(45deg, #3498db, #2980b9); 
      border: none; 
      border-radius: 8px; 
      color: white; 
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
    ">¡Entendido!</button>
  `;
  
  document.body.appendChild(instructions);
  
  setTimeout(() => {
    if (instructions.parentNode) {
      instructions.style.animation = 'fadeOutScale 0.3s ease-in';
      setTimeout(() => {
        if (instructions.parentNode) {
          instructions.remove();
        }
      }, 300);
    }
  }, 8000);
}

function showSpainOnlyAlert() {
  const alert = document.createElement('div');
  alert.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(45deg, #e74c3c, #c0392b);
    color: white;
    padding: 20px 30px;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    z-index: 10000;
    font-weight: 600;
    text-align: center;
    max-width: 400px;
    animation: alertBounce 0.5s ease-out;
  `;
  
  alert.innerHTML = `
    <div style="font-size: 2rem; margin-bottom:  10px;">🇪🇸</div>
    <div style="font-size: 1.2rem; margin-bottom: 15px;">Solo España</div>
    <div style="font-size: 0.95rem; line-height: 1.4;">
      Esta aplicación solo funciona en territorio español porque los precios 
      eléctricos son específicos del mercado PVPC español.
    </div>
    <button onclick="this.parentNode.remove()" style="
      margin-top: 15px; 
      padding: 8px 20px; 
      background: rgba(255,255,255,0.2); 
      border: 1px solid white; 
      border-radius: 6px; 
      color: white; 
      cursor: pointer;
      font-weight: 600;
    ">Entendido</button>
  `;
  
  document.body.appendChild(alert);
  
  setTimeout(() => {
    if (alert.parentNode) {
      alert.remove();
    }
  }, 5000);
}

// Funciones de búsqueda y ubicación
async function buscarCiudad() {
  const cityInput = document.getElementById("ciudad");
  const city = cityInput.value.trim();

  if (!city) {
    alert("Por favor, ingresa el nombre de una ciudad española.");
    return;
  }

  try {
    console.log('🔍 Buscando ciudad española:', city);
    
    showLoading("weather");
    
    const response = await fetch(
      `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(city)},España&format=json&addressdetails=1&limit=10&accept-language=es&countrycodes=es`
    );
    
    if (!response.ok) {
      throw new Error('Error en búsqueda de ciudad');
    }
    
    const results = await response.json();
    
    if (results.length === 0) {
      alert('No se encontró la ciudad en España. Intenta con:\n• Madrid\n• Barcelona\n• Valencia\n• Sevilla\n• Bilbao');
      hideLoading("weather");
      return;
    }
    
    let bestResult = null;
    for (const result of results) {
      if (result.address && result.address.country) {
        const country = result.address.country.toLowerCase();
        if (country.includes('españa') || country.includes('spain')) {
          bestResult = result;
          break;
        }
      }
    }
    
    if (!bestResult) {
      alert('La ciudad no se encontró en territorio español.');
      hideLoading("weather");
      return;
    }
    
    const lat = parseFloat(bestResult.lat);
    const lon = parseFloat(bestResult.lon);
    
    if (!isWithinSpain(lat, lon)) {
      alert('La ubicación está fuera del territorio español.');
      hideLoading("weather");
      return;
    }
    
    const address = bestResult.address || {};
    const cityName = address.city || address.town || address.village || 
                     address.municipality || bestResult.display_name.split(',')[0];
    
    currentLocation = {
      name: cityName,
      lat: lat,
      lon: lon,
      country: 'España',
      detected: false // Marcada como seleccionada manualmente
    };
    
    // Actualizar información de ubicación en el banner
    updateLocationInfo();
    
    if (map) {
      map.setView([lat, lon], 12);
      
      map.eachLayer(function (layer) {
        if (layer instanceof L.Marker) {
          map.removeLayer(layer);
        }
      });
      
      const marker = L.marker([lat, lon])
        .addTo(map)
        .bindPopup(`📍 ${cityName}, España`);
      
      // Mostrar popup inmediatamente porque es acción del usuario
      showPopupIfMapVisible(marker, true);
    }
    
    await updateAllDataForLocation();
    
    cityInput.value = "";
    
    console.log('✅ Ciudad encontrada:', currentLocation);
    
  } catch (error) {
    console.error('❌ Error en búsqueda:', error);
    hideLoading("weather");
    alert('Error al buscar la ciudad. Verifica que sea una ciudad española.');
  }
}

async function getLocationInfo(lat, lon) {
  try {
    const response = await fetch(
      `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1&accept-language=es`
    );
    
    if (!response.ok) {
      throw new Error('Error en geocoding');
    }
    
    const data = await response.json();
    
    const address = data.address || {};
    const name = address.city || address.town || address.village || address.municipality || 
                 address.county || address.state || 'Ubicación';
    const country = address.country || '';
    
    return { name, country, fullData: data };
    
  } catch (error) {
    console.error('Error en geocoding:', error);
    return null;
  }
}

async function updateAllDataForLocation() {
  try {
    console.log('🔄 Actualizando datos para:', currentLocation);
    await updateWeatherForLocation();
  } catch (error) {
    console.error('❌ Error actualizando datos:', error);
    hideLoading("weather");
  }
}

async function updateWeatherForLocation() {
  const weatherElement = document.getElementById("weather");
  const weatherCtx = document.getElementById("weather-chart").getContext("2d");

  try {
    const realWeatherData = await fetchWeatherDataForLocation(currentLocation.lat, currentLocation.lon);
    
    updateWeatherDisplay(weatherElement, realWeatherData);
    renderWeatherChart(weatherCtx, realWeatherData);
    setupWeatherControls();
    
    hideLoading("weather");
    
    console.log('✅ Datos actualizados para:', currentLocation.name);
    
  } catch (error) {
    console.error('❌ Error obteniendo datos:', error);
    
    const mockWeatherData = generateMockWeatherDataForLocation();
    updateWeatherDisplay(weatherElement, mockWeatherData);
    renderWeatherChart(weatherCtx, mockWeatherData);
    setupWeatherControls();
    
    hideLoading("weather");
    weatherElement.innerHTML += `<br><small style='color: #e74c3c;'>⚠️ Usando datos de ejemplo para ${currentLocation.name}</small>`;
  }
}

async function fetchWeatherDataForLocation(lat, lon) {
  const apiKey = '8631fe126bc353af0836dbc76cfac520';
  const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=es&cnt=8`;
  
  console.log(`🌤️ Obteniendo datos para ${currentLocation.name}...`);
  
  const response = await fetch(url);
  
  if (!response.ok) {
    throw new Error(`Error en API: ${response.status}`);
  }
  
  const data = await response.json();
  console.log('✅ Datos obtenidos para:', currentLocation.name);
  
  const hourlyForecast = data.list;
  
  return {
    labels: hourlyForecast.map(item => {
      const date = new Date(item.dt * 1000);
      return `${date.getHours().toString().padStart(2, '0')}:00`;
    }),
    temperatures: hourlyForecast.map(item => Math.round(item.main.temp)),
    humidity: hourlyForecast.map(item => Math.round(item.main.humidity)),
    precipitation: hourlyForecast.map(item => {
      return Math.round((item.pop || 0) * 100);
    }),
    current: {
      description: hourlyForecast[0].weather[0].description,
      temp: Math.round(hourlyForecast[0].main.temp),
      humidity: Math.round(hourlyForecast[0].main.humidity),
      temp: Math.round(hourlyForecast[0].main.temp),
      humidity: hourlyForecast[0].main.humidity,
      precipitation: Math.round((hourlyForecast[0].pop || 0) * 100),
      city: currentLocation.name
    }
  };
}

function generateMockWeatherDataForLocation() {
  const labels = ['00:00', '03:00', '06:00', '09:00', '12:00', '15:00', '18:00', '21:00'];
  
  const baseTemp = currentLocation.lat > 40 ? 18 : (currentLocation.lat > 35 ? 25 : 30);
  const temperatures = labels.map((_, i) => baseTemp + Math.sin(i * Math.PI / 4) * 8);
  const humidity = [65, 70, 75, 60, 45, 40, 50, 60];
  const precipitation = [10, 15, 20, 5, 0, 0, 5, 10];

  return {
    labels,
    temperatures: temperatures.map(t => Math.round(t)),
    humidity,
    precipitation,
    current: {
      description: 'datos estimados regionales',
      temp: Math.round(baseTemp + 5),
      humidity: 50,
      precipitation: 5,
      city: currentLocation.name
    }
  };
}

// ===== SAVINGS CALCULATOR =====

// Función para actualizar el contexto de la calculadora según la tarifa seleccionada
function updateCalculatorContext() {
  const tariffElement = document.getElementById('calculator-tariff-type');
  const contextDiv = document.getElementById('calculator-context');
  
  if (!tariffElement || !contextDiv) {
    console.warn('⚠️ Elementos de calculadora no encontrados');
    return;
  }
  
  const tariffType = tariffElement.value;
  
  const contexts = {
    'pvpc-discrimination': {
      text: '• Períodos: Valle (00:00-08:00) ~25% más barato, Llano intermedio, Punta (10:00-14:00, 18:00-22:00) ~25% más caro',
      tip: 'Máximo ahorro programando electrodomésticos en madrugada'
    },
    'pvpc-flat': {
      text: '• Precio único todo el día según mercado oficial • Sin variación horaria',
      tip: 'No hay optimización horaria posible, pero precio oficial sin márgenes'
    },
    'fixed': {
      text: '• Precio fijo establecido por la comercializadora • No varía con el mercado ni horario',
      tip: 'Previsibilidad total, pero sin aprovechar bajadas del mercado'
    },
    'indexed': {
      text: '• Precio PVPC oficial + margen fijo de la comercializadora • Sigue las variaciones del mercado',
      tip: 'Aprovecha horarios valle como PVPC pero con coste adicional'
    },
    'weekend': {
      text: '• Precio especial (a menudo gratuito) fines de semana • Precio normal laborables',
      tip: 'Concentra máximo consumo en sábados y domingos'
    }
  };
  
  const context = contexts[tariffType];
  contextDiv.innerHTML = `
    ${context.text}<br>
    <strong style="color: #1565c0;">💡 ${context.tip}</strong>
  `;
}

function calcularAhorro() {
  const consumoInput = document.getElementById("consumo");
  const resultadoDiv = document.getElementById("resultado-ahorro");
  const tariffType = document.getElementById("calculator-tariff-type")?.value || 'pvpc-discrimination';
  
  const consumo = parseFloat(consumoInput.value);
  
  if (isNaN(consumo) || consumo <= 0) {
    alert("Por favor, introduce un consumo válido en kWh.");
    return;
  }

  // Inicializar datos si no están disponibles
  if (globalPrices.length === 0) {
    if (!currentPricesData) {
      initializeDefaultPricesData();
    }
    if (currentPricesData && currentPricesData.hourlyPrices) {
      globalPrices = currentPricesData.hourlyPrices;
    } else {
      resultadoDiv.innerHTML = `
        <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; text-align: center;">
          <p><strong>❌ No hay datos de precios disponibles</strong></p>
          <p>Presiona "OBTENER PRECIOS REALES" para cargar datos actuales de REE.</p>
        </div>
      `;
      return;
    }
  }

  const currentHour = new Date().getHours();
  let hourlyPrices = [...globalPrices];
  
  // Aplicar modificaciones según tipo de tarifa
  if (tariffType === 'pvpc-discrimination') {
    // Aplicar factores de discriminación horaria sobre PVPC
    hourlyPrices = hourlyPrices.map((price, hour) => {
      if (hour >= 0 && hour < 8) return price * 0.75; // Valle
      if ((hour >= 10 && hour < 14) || (hour >= 18 && hour < 22)) return price * 1.25; // Punta
      return price; // Llano
    });
  } else if (tariffType === 'fixed') {
    // Tarifa fija - usar promedio
    const avgPrice = globalPrices.reduce((a, b) => a + b, 0) / globalPrices.length;
    hourlyPrices = Array(24).fill(avgPrice * 1.1); // +10% típico de tarifas fijas
  } else if (tariffType === 'indexed') {
    // PVPC + margen
    hourlyPrices = hourlyPrices.map(price => price + 0.015); // +1.5 céntimos típico
  } else if (tariffType === 'weekend') {
    const isWeekend = [0, 6].includes(new Date().getDay());
    if (isWeekend) {
      hourlyPrices = Array(24).fill(0.01); // Casi gratis el fin de semana
    } else {
      hourlyPrices = hourlyPrices.map(price => price * 1.15); // +15% laborables
    }
  }
  // pvpc-flat no necesita modificación

  const currentPrice = hourlyPrices[currentHour];
  const minPrice = Math.min(...hourlyPrices);
  const maxPrice = Math.max(...hourlyPrices);
  const bestHour = hourlyPrices.indexOf(minPrice);
  const worstHour = hourlyPrices.indexOf(maxPrice);

  const currentCost = consumo * currentPrice;
  const bestCost = consumo * minPrice;
  const worstCost = consumo * maxPrice;
  const savings = currentCost - bestCost;
  const maxSavings = worstCost - bestCost;
  const savingsPercentage = ((maxSavings / worstCost) * 100);

  // Obtener nombre de la tarifa para mostrar
  const tariffNames = {
    'pvpc-discrimination': 'PVPC con discriminación horaria',
    'pvpc-flat': 'PVPC sin discriminación',
    'fixed': 'Tarifa fija comercial',
    'indexed': 'Tarifa indexada (PVPC + margen)',
    'weekend': 'Tarifa plana fin de semana'
  };

  resultadoDiv.innerHTML = `
    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 12px; margin-top: 15px;">
      <h4 style="margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 1.5rem;">📊</span>
        <span>Análisis de Ahorro - ${tariffNames[tariffType]}</span>
      </h4>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">Tu consumo</div>
          <div style="font-size: 1.4rem; font-weight: bold;">${consumo} kWh</div>
        </div>
        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">Coste actual (${currentHour.toString().padStart(2,'0')}:00)</div>
          <div style="font-size: 1.4rem; font-weight: bold;">${currentCost.toFixed(3)}€</div>
        </div>
        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">Mejor momento (${bestHour.toString().padStart(2,'0')}:00)</div>
          <div style="font-size: 1.4rem; font-weight: bold; color: #00ff88;">${bestCost.toFixed(3)}€</div>
        </div>
        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">Ahorro máximo posible</div>
          <div style="font-size: 1.4rem; font-weight: bold; color: #00ff88;">${maxSavings.toFixed(3)}€ (${savingsPercentage.toFixed(1)}%)</div>
        </div>
      </div>
      
      <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;">
        <h5 style="margin: 0 0 10px 0;">💡 Recomendaciones específicas:</h5>
        <ul style="margin: 0; padding-left: 20px; line-height: 1.6;">
          <li><strong>Mejor hora:</strong> ${bestHour.toString().padStart(2,'0')}:00 - ${(bestHour+1).toString().padStart(2,'0')}:00 (${formatPrice(minPrice)} €/kWh)</li>
          <li><strong>Evitar:</strong> ${worstHour.toString().padStart(2,'0')}:00 - ${(worstHour+1).toString().padStart(2,'0')}:00 (${formatPrice(maxPrice)} €/kWh)</li>
          <li><strong>Ahorro mensual estimado:</strong> ${(maxSavings * 30).toFixed(2)}€ (si optimizas siempre)</li>
          <li><strong>Ahorro anual estimado:</strong> ${(maxSavings * 365).toFixed(2)}€ (potencial máximo)</li>
        </ul>
      </div>
    </div>
  `;
}

// ===== NUEVAS FUNCIONES PARA COMPARACIÓN HORARIA DE TARIFAS =====

// ===== NUEVAS FUNCIONES PARA COMPARACIÓN HORARIA PRECISA =====

function updateTimeDisplay() {
  // Solo actualiza los campos de visualización de tiempo, sin ejecutar comparaciones
  const requiredElements = ['start-hour', 'start-minute', 'duration-hours', 'duration-minutes'];
  const missingElements = requiredElements.filter(id => !document.getElementById(id));
  
  if (missingElements.length > 0) {
    console.warn(`⚠️ Elementos faltantes para calculadora de tiempo: ${missingElements.join(', ')}`);
    return;
  }
  
  updateEndTimeDisplay();
  updateDurationDisplay();
}

function calculateTimingAndComparison() {
  // Función completa que incluye la comparación de tarifas
  const requiredElements = ['start-hour', 'start-minute', 'duration-hours', 'duration-minutes'];
  const missingElements = requiredElements.filter(id => !document.getElementById(id));
  
  if (missingElements.length > 0) {
    console.warn(`⚠️ Elementos faltantes para calculadora de tiempo: ${missingElements.join(', ')}`);
    return;
  }
  
  updateEndTimeDisplay();
  updateDurationDisplay();
  calculatePreciseHourlyComparison();
}

function updateEndTimeDisplay() {
  const startHourElement = document.getElementById('start-hour');
  const startMinuteElement = document.getElementById('start-minute');
  const durationHoursElement = document.getElementById('duration-hours');
  const durationMinutesElement = document.getElementById('duration-minutes');
  const endTimeDisplay = document.getElementById('end-time-display');
  
  // Verificar que todos los elementos existan
  if (!startHourElement || !startMinuteElement || !durationHoursElement || !durationMinutesElement || !endTimeDisplay) {
    console.warn('⚠️ Elementos de calculadora de tiempo no encontrados');
    return;
  }
  
  const startHour = parseInt(startHourElement.value);
  const startMinute = parseInt(startMinuteElement.value);
  const durationHours = parseInt(durationHoursElement.value);
  const durationMinutes = parseInt(durationMinutesElement.value);
  
  // Calcular hora de finalización
  let totalMinutes = (startHour * 60) + startMinute + (durationHours * 60) + durationMinutes;
  
  // Manejar días que cruzan medianoche
  const endDay = Math.floor(totalMinutes / (24 * 60));
  totalMinutes = totalMinutes % (24 * 60);
  
  const endHour = Math.floor(totalMinutes / 60);
  const endMinute = totalMinutes % 60;
  
  const endTimeStr = `${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`;
  const dayIndicator = endDay > 0 ? ` (+${endDay} día${endDay > 1 ? 's' : ''})` : '';
  
  endTimeDisplay.value = endTimeStr + dayIndicator;
  
  return {
    startHour,
    startMinute,
    endHour,
    endMinute,
    durationHours,
    durationMinutes,
    totalDurationHours: (durationHours * 60 + durationMinutes) / 60,
    crossesDay: endDay > 0
  };
}

function updateDurationDisplay() {
  const durationHoursElement = document.getElementById('duration-hours');
  const durationMinutesElement = document.getElementById('duration-minutes');
  const durationDisplay = document.getElementById('duration-display');
  
  // Verificar que todos los elementos existan
  if (!durationHoursElement || !durationMinutesElement || !durationDisplay) {
    console.warn('⚠️ Elementos de duración no encontrados');
    return;
  }
  
  const durationHours = parseInt(durationHoursElement.value);
  const durationMinutes = parseInt(durationMinutesElement.value);
  
  // Formatear duración
  let durationText = '';
  if (durationHours > 0 && durationMinutes > 0) {
    durationText = `${durationHours} hora${durationHours > 1 ? 's' : ''} y ${durationMinutes} minuto${durationMinutes > 1 ? 's' : ''}`;
  } else if (durationHours > 0) {
    durationText = `${durationHours} hora${durationHours > 1 ? 's' : ''}`;
  } else if (durationMinutes > 0) {
    durationText = `${durationMinutes} minuto${durationMinutes > 1 ? 's' : ''}`;
  } else {
    durationText = 'Sin duración';
  }
  
  durationDisplay.value = durationText;
}

function calculatePreciseHourlyComparison() {
  const applianceSelector = document.getElementById('appliance-selector');
  const consumptionInput = document.getElementById('appliance-consumption');
  const resultDiv = document.getElementById('hourly-comparison-result');
  
  const appliance = applianceSelector.value;
  const consumption = parseFloat(consumptionInput.value);
  
  // Obtener tiempos precisos
  const timing = updateEndTimeDisplay();
  
  // Validaciones
  if (!appliance) {
    resultDiv.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <span style="font-size: 3rem;">⚠️</span>
        <p>Selecciona un electrodoméstico primero</p>
      </div>
    `;
    return;
  }
  
  if (isNaN(consumption) || consumption <= 0) {
    resultDiv.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <span style="font-size: 3rem;">⚠️</span>
        <p>Introduce un consumo válido</p>
      </div>
    `;
    return;
  }
  
  if (timing.totalDurationHours <= 0) {
    resultDiv.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <span style="font-size: 3rem;">⚠️</span>
        <p>La duración debe ser mayor a 0</p>
      </div>
    `;
    return;
  }
  
  // Obtener precios PVPC (usar datos globales o generar si no existen)
  let pvpcPrices = [];
  if (globalPrices && globalPrices.length > 0) {
    pvpcPrices = globalPrices;
  } else {
    // Generar precios de respaldo realistas
    for (let hour = 0; hour < 24; hour++) {
      let price = 0.12; // Precio base
      if (hour >= 0 && hour < 8) price *= 0.8;        // Valle
      else if ((hour >= 10 && hour < 14) || (hour >= 18 && hour < 22)) price *= 1.4; // Punta
      else price *= 1.1; // Llano
      pvpcPrices.push(price);
    }
  }
  
  // Calcular consumo total del electrodoméstico
  const totalConsumption = consumption * timing.totalDurationHours;
  
  // Obtener tarifa actual del usuario (de la sección del calculador de horarios)
  const companySelector = document.getElementById('hourly-company-selector');
  const tariffSelector = document.getElementById('hourly-tariff-selector');
  const selectedCompany = companySelector ? companySelector.value : 'pvpc';
  const selectedTariff = tariffSelector ? tariffSelector.value : '2.0A';
  
  // Calcular costo real con la tarifa del usuario
  let realCost = calculatePreciseCost(timing, pvpcPrices, consumption, selectedCompany, selectedTariff);
  let userTariffName = 'PVPC 2.0A';
  let userTariffCompany = 'Estado Español (PVPC)';
  
  // Obtener información de la tarifa seleccionada
  if (selectedCompany && companySelector && tariffSelector) {
    const selectedCompanyOption = companySelector.options[companySelector.selectedIndex];
    const selectedTariffOption = tariffSelector.options[tariffSelector.selectedIndex];
    if (selectedCompanyOption && selectedTariffOption) {
      userTariffCompany = selectedCompanyOption.textContent;
      userTariffName = selectedTariffOption.textContent;
    }
  }
  
  // Encontrar mejores horarios del día
  const hourlyData = pvpcPrices.map((price, hour) => ({ hour, price }));
  hourlyData.sort((a, b) => a.price - b.price);
  const bestHours = hourlyData.slice(0, 3);
  const worstHours = hourlyData.slice(-3);
  
  // Crear objeto con información completa
  const costAnalysis = {
    realCost: realCost,
    tariffName: userTariffName,
    tariffCompany: userTariffCompany,
    appliance: appliance,
    consumption: consumption,
    timing: timing,
    bestHours: bestHours,
    worstHours: worstHours,
    currentHourPrice: pvpcPrices[timing.startHour] || 0
  };
  
  // Generar resultado visual enfocado en costo real
  displayRealCostAnalysis(costAnalysis);
}

function calculatePreciseCost(timing, pvpcPrices, consumption, companyType, tariffType) {
  let totalCost = 0;
  
  // Calcular el costo minuto a minuto
  const startTotalMinutes = timing.startHour * 60 + timing.startMinute;
  const durationMinutes = timing.durationHours * 60 + timing.durationMinutes;
  
  for (let minute = 0; minute < durationMinutes; minute++) {
    const currentMinute = (startTotalMinutes + minute) % (24 * 60);
    const currentHour = Math.floor(currentMinute / 60);
    
    let hourlyPrice = pvpcPrices[currentHour] || 0;
    let factor = 1.0;
    let margin = 0;
    
    // Aplicar factores y márgenes según tipo de compañía y tarifa
    if (companyType === 'pvpc') {
      // Tarifas PVPC oficiales
      switch (tariffType) {
        case '2.0A':
          factor = 1.0; // Sin discriminación horaria
          break;
        case '2.0DHA':
          if (currentHour >= 0 && currentHour < 8) factor = 0.75;  // Valle
          else if ((currentHour >= 10 && currentHour < 14) || (currentHour >= 18 && currentHour < 22)) factor = 1.25; // Punta
          else factor = 1.0; // Llano
          break;
        case '2.0DHS':
          if (currentHour >= 0 && currentHour < 8) factor = 0.65;  // Supervalle
          else if ((currentHour >= 10 && currentHour < 14) || (currentHour >= 18 && currentHour < 22)) factor = 1.35; // Punta
          else factor = 1.0; // Llano
          break;
      }
    } else if (companyType.includes('-cor')) {
      // Tarifas COR (con pequeño margen sobre PVPC)
      margin = 0.005; // +0.5 céntimos sobre PVPC
      switch (tariffType) {
        case '2.0A':
          factor = 1.0;
          break;
        case '2.0DHA':
          if (currentHour >= 0 && currentHour < 8) factor = 0.75;
          else if ((currentHour >= 10 && currentHour < 14) || (currentHour >= 18 && currentHour < 22)) factor = 1.25;
          else factor = 1.0;
          break;
        case '2.0DHS':
          if (currentHour >= 0 && currentHour < 8) factor = 0.65;
          else if ((currentHour >= 10 && currentHour < 14) || (currentHour >= 18 && currentHour < 22)) factor = 1.35;
          else factor = 1.0;
          break;
      }
    } else {
      // Tarifas de mercado libre
      switch (companyType) {
        case 'iberdrola':
          margin = 0.025; // +2.5 céntimos
          break;
        case 'endesa':
          margin = 0.022; // +2.2 céntimos
          break;
        case 'naturgy':
          margin = 0.020; // +2.0 céntimos
          break;
        case 'repsol':
          margin = 0.018; // +1.8 céntimos
          break;
        case 'totalenergies':
          margin = 0.024; // +2.4 céntimos
          break;
        case 'holaluz':
          margin = 0.028; // +2.8 céntimos (100% renovable)
          break;
        case 'edp':
          margin = 0.021; // +2.1 céntimos
          break;
        case 'asenergy':
          margin = 0.019; // +1.9 céntimos
          break;
        case 'factorenergia':
          margin = 0.017; // +1.7 céntimos
          break;
        case 'lucera':
          margin = 0.016; // +1.6 céntimos
          break;
        case 'somenergia':
          margin = 0.015; // +1.5 céntimos (cooperativa)
          break;
        case 'octopus':
          margin = 0.014; // +1.4 céntimos (competitivo)
          break;
        case 'nexus':
          margin = 0.023; // +2.3 céntimos
          break;
        case 'gana':
          margin = 0.016; // +1.6 céntimos
          break;
        case 'pepeenergy':
          margin = 0.013; // +1.3 céntimos (muy competitivo)
          break;
        case 'curenergia-cor':
          margin = 0.005; // +0.5 céntimos (es COR pero se maneja aquí)
          break;
        default:
          margin = 0.020; // +2.0 céntimos promedio
          break;
      }
      
      // Aplicar discriminación horaria si corresponde
      switch (tariffType) {
        case 'fija':
          factor = 1.0;
          hourlyPrice = 0.12; // Precio fijo promedio
          margin = 0; // Ya incluido en precio fijo
          break;
        case 'indexada':
          factor = 1.0; // Sigue precios del mercado
          break;
        case '2.0DHA':
          if (currentHour >= 0 && currentHour < 8) factor = 0.75;
          else if ((currentHour >= 10 && currentHour < 14) || (currentHour >= 18 && currentHour < 22)) factor = 1.25;
          else factor = 1.0;
          break;
        case '2.0DHS':
          if (currentHour >= 0 && currentHour < 8) factor = 0.65;
          else if ((currentHour >= 10 && currentHour < 14) || (currentHour >= 18 && currentHour < 22)) factor = 1.35;
          else factor = 1.0;
          break;
      }
    }
    
    // Calcular precio final para este minuto
    const finalPrice = (hourlyPrice * factor) + margin;
    const minuteConsumption = consumption / 60; // kWh por minuto
    totalCost += finalPrice * minuteConsumption;
  }
  
  return totalCost;
}

function displayRealCostAnalysis(analysis) {
  const resultDiv = document.getElementById('hourly-comparison-result');
  
  const cost = analysis.realCost;
  const costInCents = Math.round(cost * 100);
  const costPerKwh = cost / analysis.consumption;
  
  // Determinar si es hora cara o barata
  const currentHourRank = analysis.bestHours.findIndex(h => h.hour === analysis.timing.startHour);
  let hourQuality = '';
  let hourIcon = '';
  let hourColor = '';
  
  if (currentHourRank >= 0 && currentHourRank < 3) {
    hourQuality = 'Hora BARATA';
    hourIcon = '🟢';
    hourColor = '#27ae60';
  } else if (analysis.worstHours.some(h => h.hour === analysis.timing.startHour)) {
    hourQuality = 'Hora CARA';
    hourIcon = '🔴';
    hourColor = '#e74c3c';
  } else {
    hourQuality = 'Hora INTERMEDIA';
    hourIcon = '🟡';
    hourColor = '#f39c12';
  }
  
  const html = `
    <div style="background: linear-gradient(135deg, ${hourColor}, ${hourColor}dd); color: white; padding: 25px; border-radius: 12px; text-align: center; margin-bottom: 20px;">
      <h3 style="margin: 0 0 15px 0; font-size: 1.6rem;">💰 Costo Real de tu Consumo</h3>
      <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; margin-bottom: 15px;">
        <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 5px;">${cost.toFixed(4)}€</div>
        <div style="font-size: 1.1rem; opacity: 0.9;">Por usar ${analysis.appliance || 'el electrodoméstico'}</div>
        <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 5px;">${costInCents} céntimos</div>
      </div>
      <div style="font-size: 1.2rem;">
        ${hourIcon} <strong>${hourQuality}</strong> para consumir
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
      <!-- Detalles del uso -->
      <div style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; border-radius: 10px;">
        <h4 style="margin: 0 0 15px 0;">📋 Detalles del Uso</h4>
        <div style="line-height: 1.8;">
          <div style="margin-bottom: 8px;"><strong>⚡ Electrodoméstico:</strong><br>${analysis.appliance || 'No especificado'}</div>
          <div style="margin-bottom: 8px;"><strong>🔋 Consumo:</strong><br>${analysis.consumption} kWh</div>
          <div style="margin-bottom: 8px;"><strong>⏱️ Duración:</strong><br>${analysis.timing.totalDurationHours.toFixed(2)} horas</div>
          <div><strong>🕐 Horario:</strong><br>${analysis.timing.startHour.toString().padStart(2, '0')}:${analysis.timing.startMinute.toString().padStart(2, '0')} - ${analysis.timing.endHour.toString().padStart(2, '0')}:${(analysis.timing.endMinute || 0).toString().padStart(2, '0')}</div>
        </div>
      </div>
      
      <!-- Tu tarifa -->
      <div style="background: linear-gradient(135deg, #8e44ad, #9b59b6); color: white; padding: 20px; border-radius: 10px;">
        <h4 style="margin: 0 0 15px 0;">💼 Tu Tarifa</h4>
        <div style="text-align: center;">
          <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 8px;">${analysis.tariffName}</div>
          <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 15px;">${analysis.tariffCompany}</div>
          <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
            <div style="font-size: 1.1rem; font-weight: bold;">${costPerKwh.toFixed(4)}€/kWh</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">Precio promedio en este horario</div>
          </div>
        </div>
      </div>
    </div>
    
    <div style="background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 25px; border-radius: 12px;">
      <h4 style="margin: 0 0 20px 0; text-align: center;">💡 Recomendaciones para HOY</h4>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <!-- Mejores horas -->
        <div style="background: linear-gradient(135deg, #27ae60, #2ecc71); padding: 18px; border-radius: 10px;">
          <h5 style="margin: 0 0 12px 0; color: white; font-weight: 700;">🟢 Mejores Horas HOY</h5>
          ${analysis.bestHours.map(h => `
            <div style="margin-bottom: 8px; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px;">
              <strong>${h.hour.toString().padStart(2, '0')}:00 - ${(h.hour + 1).toString().padStart(2, '0')}:00</strong>
              <br><span style="font-size: 0.9rem; opacity: 0.9;">${h.price.toFixed(3)}€/kWh</span>
            </div>
          `).join('')}
          <div style="margin-top: 12px; font-size: 0.9rem; opacity: 0.9; text-align: center;">
            💰 <strong>Ahorro estimado:</strong> ${((analysis.currentHourPrice - analysis.bestHours[0].price) * analysis.consumption * analysis.timing.totalDurationHours).toFixed(4)}€
          </div>
        </div>
        
        <!-- Peores horas -->
        <div style="background: linear-gradient(135deg, #e74c3c, #c0392b); padding: 18px; border-radius: 10px;">
          <h5 style="margin: 0 0 12px 0; color: white; font-weight: 700;">🔴 Evita Estas Horas</h5>
          ${analysis.worstHours.map(h => `
            <div style="margin-bottom: 8px; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px;">
              <strong>${h.hour.toString().padStart(2, '0')}:00 - ${(h.hour + 1).toString().padStart(2, '0')}:00</strong>
              <br><span style="font-size: 0.9rem; opacity: 0.9;">${h.price.toFixed(3)}€/kWh</span>
            </div>
          `).join('')}
          <div style="margin-top: 12px; font-size: 0.9rem; opacity: 0.9; text-align: center;">
            💸 <strong>Costo extra:</strong> +${((analysis.worstHours[0].price - analysis.currentHourPrice) * analysis.consumption * analysis.timing.totalDurationHours).toFixed(4)}€
          </div>
        </div>
      </div>
      
      <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
        <div style="font-size: 0.95rem; margin-bottom: 8px;">
          💡 <strong>Consejo del día:</strong> 
          ${analysis.bestHours[0].hour < 12 ? 
            `Programa tus electrodomésticos antes de las ${analysis.bestHours[2].hour + 1}:00 para máximo ahorro.` :
            `Las horas de la madrugada (${analysis.bestHours[0].hour}:00-${analysis.bestHours[2].hour + 1}:00) son las más baratas.`
          }
        </div>
        <div style="font-size: 0.85rem; opacity: 0.8;">
          ⚡ Los precios cambian cada hora según la demanda nacional de electricidad
        </div>
      </div>
    </div>
  `;
  
  resultDiv.innerHTML = html;
}

function displaySimpleComparison(comparison, timing, appliance, consumption) {
  const resultDiv = document.getElementById('hourly-comparison-result');
  
  const userCost = comparison.userTariff.cost;
  const pvpcCost = comparison.pvpcTariff.cost;
  const difference = comparison.difference;
  const isUserCheaper = difference < 0;
  const absPercentage = Math.abs(comparison.percentageDiff);
  
  const resultColor = isUserCheaper ? '#27ae60' : '#e74c3c';
  const resultIcon = isUserCheaper ? '💚' : '💸';
  const resultText = isUserCheaper ? 'PAGAS MENOS' : 'PAGAS MÁS';
  
  const html = `
    <div style="background: linear-gradient(135deg, ${resultColor}, ${isUserCheaper ? '#2ecc71' : '#c0392b'}); color: white; padding: 25px; border-radius: 12px; text-align: center; margin-bottom: 20px;">
      <h3 style="margin: 0 0 15px 0; font-size: 1.5rem;">${resultIcon} ${resultText} que el PVPC Oficial</h3>
      <div style="font-size: 1.2rem; margin-bottom: 10px;">
        <strong>${Math.abs(difference).toFixed(4)}€ ${isUserCheaper ? 'menos' : 'más'}</strong> por este uso específico
      </div>
      <div style="font-size: 1rem; opacity: 0.9;">
        (${absPercentage.toFixed(1)}% ${isUserCheaper ? 'de ahorro' : 'más caro'} vs PVPC)
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
      <!-- Tu Tarifa -->
      <div style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; border-radius: 10px; text-align: center;">
        <h4 style="margin: 0 0 10px 0;">💼 Tu Tarifa Actual</h4>
        <div style="font-size: 1.1rem; margin-bottom: 8px;"><strong>${comparison.userTariff.name}</strong></div>
        <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 15px;">${comparison.userTariff.company}</div>
        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
          <div style="font-size: 1.4rem; font-weight: bold;">${userCost.toFixed(4)}€</div>
          <div style="font-size: 0.9rem; opacity: 0.9;">Por este uso</div>
        </div>
      </div>
      
      <!-- PVPC Oficial -->
      <div style="background: linear-gradient(135deg, #8e44ad, #9b59b6); color: white; padding: 20px; border-radius: 10px; text-align: center;">
        <h4 style="margin: 0 0 10px 0;">🏛️ PVPC Oficial</h4>
        <div style="font-size: 1.1rem; margin-bottom: 8px;"><strong>PVPC 2.0TD</strong></div>
        <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 15px;">Estado Español (Mayorista)</div>
        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
          <div style="font-size: 1.4rem; font-weight: bold;">${pvpcCost.toFixed(4)}€</div>
          <div style="font-size: 0.9rem; opacity: 0.9;">Por este uso</div>
        </div>
      </div>
    </div>
    
    <div style="background: linear-gradient(135deg, #34495e, #2c3e50); color: white; padding: 20px; border-radius: 10px;">
      <h4 style="margin: 0 0 15px 0;">📊 Detalles del Cálculo</h4>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div>
          <div style="font-size: 0.9rem; opacity: 0.8;">Electrodoméstico:</div>
          <div style="font-weight: bold;">${appliance || 'No especificado'}</div>
        </div>
        <div>
          <div style="font-size: 0.9rem; opacity: 0.8;">Consumo:</div>
          <div style="font-weight: bold;">${consumption} kWh</div>
        </div>
        <div>
          <div style="font-size: 0.9rem; opacity: 0.8;">Duración:</div>
          <div style="font-weight: bold;">${timing.totalDurationHours.toFixed(2)} horas</div>
        </div>
        <div>
          <div style="font-size: 0.9rem; opacity: 0.8;">Horario:</div>
          <div style="font-weight: bold;">${timing.startHour.toString().padStart(2, '0')}:${timing.startMinute.toString().padStart(2, '0')} - ${timing.endHour.toString().padStart(2, '0')}:${(timing.endMinute || 0).toString().padStart(2, '0')}</div>
        </div>
      </div>
    </div>
  `;
  
  resultDiv.innerHTML = html;
}

function displayPreciseComparison(tariffComparisons, timing, appliance, consumption) {
  const resultDiv = document.getElementById('hourly-comparison-result');
  
  // Obtener ganadora y calcular ahorros
  const winner = tariffComparisons[0];
  const mostExpensive = tariffComparisons[tariffComparisons.length - 1];
  const maxSavings = mostExpensive.cost - winner.cost;
  const savingsPercentage = (maxSavings / mostExpensive.cost) * 100;
  
  // Generar resultado visual
  const applianceName = document.getElementById('appliance-selector').options[document.getElementById('appliance-selector').selectedIndex].text;
  const startTime = `${timing.startHour.toString().padStart(2, '0')}:${timing.startMinute.toString().padStart(2, '0')}`;
  const endTimeElement = document.getElementById('end-time-display');
  const endTime = endTimeElement ? endTimeElement.value : '00:00';
  const durationText = timing.durationHours > 0 && timing.durationMinutes > 0 
    ? `${timing.durationHours}h ${timing.durationMinutes}m`
    : timing.durationHours > 0 
      ? `${timing.durationHours}h`
      : `${timing.durationMinutes}m`;
  
  let html = `
    <div style="background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px;">
      <div style="text-align: center; margin-bottom: 20px;">
        <h4 style="margin: 0 0 10px 0; font-size: 1.5rem;">🏆 TARIFA GANADORA</h4>
        <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px;">
          <div style="font-size: 2rem; margin-bottom: 10px;">${winner.logo}</div>
          <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 5px;">${winner.name}</div>
          <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 15px;">${winner.company}</div>
          <div style="font-size: 2.2rem; font-weight: bold; color: #00ff88;">
            ${winner.cost.toFixed(4)}€
          </div>
          <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 10px;">
            ${applianceName}<br>
            ${startTime} → ${endTime} (${durationText})<br>
            ${consumption}kWh total en ${timing.totalDurationHours.toFixed(2)}h
          </div>
        </div>
      </div>
      
      <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
        <strong>💰 Ahorro máximo: ${maxSavings.toFixed(4)}€ (${savingsPercentage.toFixed(1)}%)</strong><br>
        <span style="opacity: 0.9;">vs la tarifa más cara (${mostExpensive.name}: ${mostExpensive.cost.toFixed(4)}€)</span>
      </div>
    </div>
    
    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
      <h4 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">📊 Comparación Precisa de Tarifas</h4>
      
      <div style="display: grid; gap: 15px;">
  `;
  
  // Mostrar todas las tarifas
  tariffComparisons.forEach((tariff, index) => {
    const isWinner = index === 0;
    const extraCost = tariff.cost - winner.cost;
    const extraPercentage = winner.cost > 0 ? (extraCost / winner.cost) * 100 : 0;
    
    html += `
      <div style="
        background: ${isWinner ? 'linear-gradient(45deg, #e8f5e8, #f0f8ff)' : '#f8f9fa'};
        border: ${isWinner ? '3px solid #27ae60' : '2px solid #dee2e6'};
        border-radius: 12px;
        padding: 20px;
        position: relative;
      ">
        ${isWinner ? '<div style="position: absolute; top: -10px; right: 20px; background: #27ae60; color: white; padding: 5px 15px; border-radius: 15px; font-size: 0.8rem; font-weight: bold;">🏆 MEJOR</div>' : ''}
        
        <div style="display: grid; grid-template-columns: auto 1fr auto auto; gap: 15px; align-items: center;">
          <div style="font-size: 2rem;">${tariff.logo}</div>
          
          <div>
            <div style="font-weight: bold; color: #2c3e50; margin-bottom: 5px;">${tariff.name}</div>
            <div style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 3px;">${tariff.company}</div>
            <div style="color: #6c757d; font-size: 0.85rem;">${tariff.description}</div>
          </div>
          
          <div style="text-align: right;">
            <div style="font-size: 1.4rem; font-weight: bold; color: ${isWinner ? '#27ae60' : '#2c3e50'};">
              ${tariff.cost.toFixed(4)}€
            </div>
            ${!isWinner && extraCost > 0 ? `
              <div style="color: #e74c3c; font-size: 0.9rem; font-weight: 600;">
                +${extraCost.toFixed(4)}€
              </div>
            ` : ''}
          </div>
          
          <div style="text-align: center; min-width: 60px;">
            ${!isWinner && extraCost > 0 ? `
              <div style="color: #e74c3c; font-size: 0.9rem; font-weight: 600;">
                +${extraPercentage.toFixed(1)}%
              </div>
            ` : isWinner ? `
              <div style="color: #27ae60; font-size: 0.9rem; font-weight: 600;">
                MEJOR
              </div>
            ` : ''}
          </div>
        </div>
      </div>
    `;
  });
  
  html += `
      </div>
    </div>
  `;
  
  resultDiv.innerHTML = html;
}

function updateApplianceConsumption() {
  const selector = document.getElementById('appliance-selector');
  const consumptionInput = document.getElementById('appliance-consumption');
  
  if (!selector || !consumptionInput) {
    console.warn('⚠️ Elementos de electrodomésticos no encontrados');
    return;
  }
  
  if (selector.value && selector.value !== 'personalizado') {
    const selectedOption = selector.options[selector.selectedIndex];
    const consumption = selectedOption.getAttribute('data-consumption');
    if (consumption) {
      consumptionInput.value = consumption;
      // Solo actualizar los campos de tiempo, no ejecutar la comparación completa
      updateTimeDisplay();
    }
  }
}

function updateHourlyTariff() {
  const companySelector = document.getElementById('hourly-company-selector');
  const tariffSelector = document.getElementById('hourly-tariff-selector');
  
  if (!companySelector || !tariffSelector) {
    console.warn('⚠️ Selectores de compañía/tarifa no encontrados');
    return;
  }
  
  const selectedCompany = companySelector.value;
  
  // Actualizar las opciones de tarifa según la compañía seleccionada
  tariffSelector.innerHTML = '';
  
  if (selectedCompany === 'pvpc') {
    // Tarifas PVPC
    tariffSelector.innerHTML = `
      <option value="2.0A">PVPC 2.0A (Sin discriminación)</option>
      <option value="2.0DHA">PVPC 2.0DHA (Discriminación horaria)</option>
      <option value="2.0DHS">PVPC 2.0DHS (Supervalle)</option>
    `;
  } else if (selectedCompany.includes('-cor')) {
    // Tarifas COR
    tariffSelector.innerHTML = `
      <option value="2.0A">COR 2.0A (Sin discriminación)</option>
      <option value="2.0DHA">COR 2.0DHA (Discriminación horaria)</option>
      <option value="2.0DHS">COR 2.0DHS (Supervalle)</option>
    `;
  } else {
    // Tarifas mercado libre
    tariffSelector.innerHTML = `
      <option value="fija">Tarifa Fija</option>
      <option value="indexada">Tarifa Indexada</option>
      <option value="2.0DHA">Discriminación Horaria (2 períodos)</option>
      <option value="2.0DHS">Discriminación Horaria + Supervalle</option>
    `;
  }
}

// ===== FUNCIONES OBSOLETAS (mantenidas para compatibilidad) =====

function updateDurationDisplay() {
  // Función obsoleta - redirigir a la nueva función
  updateEndTimeDisplay();
}

function calculateHourlyComparison() {
  // Esta función está obsoleta y no debe ejecutar comparaciones automáticamente
  // Solo actualizar campos de tiempo si es necesario
  console.log('🔧 Función calculateHourlyComparison() llamada - no ejecutando comparación automática');
}

// ===== SCROLL FUNCTIONALITY =====
function scrollToSection(sectionId) {
  const element = document.getElementById(sectionId);
  if (element) {
    element.scrollIntoView({ 
      behavior: 'smooth',
      block: 'start'
    });
    
    // Efecto visual de highlight
    element.classList.add('scroll-highlight');
    setTimeout(() => {
      element.classList.remove('scroll-highlight');
    }, 2000);
  }
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
  console.log('🚀 DOM cargado');
  console.log('📋 IDs encontrados:', 
    Array.from(document.querySelectorAll('[id]')).map(el => el.id)
  );
  
  // Inicializar estado del caché
  updateCacheStatus();
  
  initializeClock();
  loadElectricityPrices();
  
  // Inicializar selectores del calculador de horarios
  setTimeout(() => {
    updateHourlyTariff();
  }, 500);
  
  // Fallback: Inicializar comparación después de un delay
  setTimeout(() => {
    console.log('🔄 Ejecutando updateDailyComparison como fallback...');
    updateDailyComparison();
  }, 3000);
  
  // Debug: Verificar que los selectores estén disponibles
  setTimeout(() => {
    const companySelector = document.getElementById('user-company-selector');
    const tariffSelector = document.getElementById('user-tariff-selector');
    console.log('🔍 Debug selectores:', {
      companySelector: !!companySelector,
      tariffSelector: !!tariffSelector,
      companies: !!SPANISH_ENERGY_COMPANIES
    });
    
    if (companySelector) {
      console.log('✅ Selector de compañías encontrado');
    } else {
      console.error('❌ Selector de compañías NO encontrado');
    }
  }, 1000);
  
  // Configurar event listeners para elementos que siguen en index.html
  // (Ya no hay elementos de meteorología aquí)

  const consumoInput = document.getElementById('consumo');
  if (consumoInput) {
    consumoInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        calcularAhorro();
      }
    });
  }
});

// Añadir estilos para animaciones
const style = document.createElement('style');
style.textContent = `
  @keyframes alertBounce {
    0% { 
      transform: translate(-50%, -50%) scale(0.5); 
      opacity: 0; 
    }
    50% { 
      transform: translate(-50%, -50%) scale(1.05); 
    }
    100% { 
      transform: translate(-50%, -50%) scale(1); 
      opacity: 1; 
    }
  }
`;
document.head.appendChild(style);
  </script> <!-- Cierre del script existente -->
</body>
</html>