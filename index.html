<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MERCADO ELÃ‰CTRICO ESPAÃ‘OL - Precios y Comparativas</title>
  
  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* ===== RESET AND BASE STYLES ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ===== TYPOGRAPHY ===== */
    h1, h2, h3 {
      text-transform: uppercase;
      font-weight: 700;
    }

    h1 {
      text-align: center;
      margin: 30px 0;
      font-size: clamp(1.8rem, 4vw, 2.5rem);
      color: #2c3e50;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
      margin: 20px 0;
      font-size: clamp(1.5rem, 3.5vw, 2rem);
      color: #2980b9;
    }

    h3 {
      margin: 0 0 20px 0;
      font-size: 1.4rem;
      color: #34495e;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
    }

    /* ===== LAYOUT ===== */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .full-width {
      grid-column: 1 / -1;
    }

    /* ===== CARDS ===== */
    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      padding: 25px;
      text-align: center;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      scroll-margin-top: 80px;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    }

    /* ===== ALERT STYLES ===== */
    #alerta {
      font-size: 1.2rem;
      font-weight: 600;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    #weather {
      font-size: 1.1rem;
      margin: 15px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #3498db;
    }

    /* ===== CHART AND MAP STYLES ===== */
    .chart-container {
      position: relative;
      height: 400px;
      width: 100%;
      margin: 20px 0;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }

    #map {
      height: 450px;
      width: 100%;
      border: 2px solid #ddd;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }

    /* ===== CHART CONTROLS ===== */
    .chart-controls {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      margin: 20px 0;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .chart-controls label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: 600;
      padding: 8px 16px;
      margin: 0;
      border-radius: 20px;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      background: #ffffff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      white-space: nowrap;
      font-size: 0.9rem;
      color: #666;
      min-width: auto;
    }
    
    .chart-controls label:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      border-color: #3498db;
    }
    
    .chart-controls label.active {
      background: linear-gradient(45deg, #3498db, #5dade2);
      color: white;
      border-color: #3498db;
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
    }
    
    .chart-controls input[type="checkbox"] {
      margin-right: 8px;
      transform: scale(1.1);
      accent-color: currentColor;
    }

    /* ===== FORM CONTROLS ===== */
    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .input-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    input[type="text"], input[type="number"] {
      padding: 12px 16px;
      font-size: 1rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      width: 220px;
      max-width: 100%;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      background: rgba(255, 255, 255, 0.9);
    }

    input[type="text"]:focus, input[type="number"]:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    button {
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 600;
      color: white;
      background: linear-gradient(45deg, #3498db, #2980b9);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
      background: linear-gradient(45deg, #2980b9, #3498db);
    }

    button:active {
      transform: translateY(0);
    }

    /* ===== RESULTS ===== */
    #resultado-ahorro {
      margin-top: 20px;
      padding: 20px;
      background: linear-gradient(45deg, #e8f5e8, #f0f8ff);
      border-radius: 12px;
      border-left: 5px solid #27ae60;
      font-size: 1.1rem;
      line-height: 1.8;
    }

    /* ===== FOOTER ===== */
    .footer {
      text-align: center;
      margin-top: 40px;
      padding: 30px 20px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      font-size: 0.9rem;
      color: #7f8c8d;
      box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
    }

    .footer a {
      color: #3498db;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s ease;
    }

    .footer a:hover {
      color: #2980b9;
    }

    /* ===== DISCLAIMER ===== */
    .disclaimer {
      background: linear-gradient(135deg, #fff9e6, #ffeaa7);
      border: 2px solid #fdcb6e;
      border-radius: 10px;
      margin: 30px auto;
      padding: 20px;
      max-width: 1200px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(253, 203, 110, 0.3);
    }

    .disclaimer h3 {
      color: #d63031;
      margin-bottom: 15px;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .disclaimer p {
      color: #2d3436;
      line-height: 1.6;
      font-size: 1rem;
      margin-bottom: 10px;
    }

    .disclaimer .highlight {
      font-weight: bold;
      color: #d63031;
    }

    /* ===== LOADING ANIMATION ===== */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ===== INFO BANNER STYLES ===== */
    .info-banner {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      color: white;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    .info-banner::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><radialGradient id="a" cx="50" cy="50" r="50"><stop offset="0" stop-color="rgba(255,255,255,.1)"/><stop offset="1" stop-color="rgba(255,255,255,0)"/></radialGradient></defs><rect width="100" height="20" fill="url(%23a)"/></svg>');
      pointer-events: none;
    }

    .banner-content {
      position: relative;
      z-index: 1;
    }

    .banner-content h2 {
      margin-bottom: 20px;
      font-size: 1.8rem;
      text-align: center;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      color: #ffffff;
      font-weight: 800;
    }

    .banner-content p {
      text-align: center;
      font-size: 1.15rem;
      margin-bottom: 25px;
      line-height: 1.7;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      color: #ecf0f1;
      font-weight: 500;
    }

    .banner-content strong {
      color: #f39c12;
      font-weight: 700;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    /* ===== HEADER WITH CLOCK STYLES ===== */
    .header-with-clock {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }

    .info-panel {
      width: 100%;
      max-width: 600px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.25);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .time-location-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      align-items: stretch;
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 2px solid transparent;
      min-height: 80px;
    }

    .clock-info {
      border-color: rgba(52, 152, 219, 0.3);
    }

    .location-info {
      border-color: rgba(243, 156, 18, 0.3);
    }

    .info-icon {
      font-size: 1.8rem;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: linear-gradient(45deg, #f8f9fa, #e9ecef);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .clock-info .info-icon {
      background: linear-gradient(45deg, #3498db, #2980b9);
      color: white;
    }

    .location-info .info-icon {
      background: linear-gradient(45deg, #f39c12, #e67e22);
      color: white;
    }

    .info-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
    }

    .info-label {
      font-size: 1rem;
      color: #6c757d;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .info-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: #2c3e50;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .header-with-clock {
        gap: 15px;
      }
      
      .info-panel {
        max-width: 100%;
        padding: 16px;
      }
      
      .time-location-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .info-item {
        padding: 12px;
        gap: 10px;
        min-height: 70px;
      }
      
      .info-icon {
        width: 40px;
        height: 40px;
        font-size: 1.5rem;
      }
      
      .info-value {
        font-size: 1.2rem;
      }
    }

    @media (max-width: 480px) {
      .info-panel {
        padding: 12px;
      }
      
      .info-item {
        padding: 10px;
        gap: 8px;
        min-height: 60px;
      }
      
      .info-icon {
        width: 35px;
        height: 35px;
        font-size: 1.3rem;
      }
    }

    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
      margin-top: 25px;
    }

    .feature-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255, 255, 255, 0.15);
      padding: 15px 20px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: white;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: left;
      min-height: 60px;
    }

    .feature-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.4);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .feature-btn:active {
      transform: translateY(-1px);
      transition: transform 0.1s;
    }

    .feature-icon {
      font-size: 1.8rem;
      flex-shrink: 0;
      filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.3));
    }

    .feature-btn span:last-child {
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      line-height: 1.3;
    }

    /* ===== SCROLL ANIMATION ===== */
    .scroll-highlight {
      animation: highlightPulse 2s ease-in-out;
    }

    @keyframes highlightPulse {
      0% { 
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }
      50% { 
        box-shadow: 0 0 30px rgba(52, 152, 219, 0.6), 0 0 60px rgba(52, 152, 219, 0.3);
        transform: scale(1.02);
      }
      100% { 
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transform: scale(1);
      }
    }

    /* ===== INFO BOXES ===== */
    .info-box {
      background: linear-gradient(45deg, #e8f4fd, #f0f8ff);
      border: 2px solid #3498db;
      border-radius: 12px;
      padding: 15px;
      margin: 15px 0;
      text-align: left;
      font-size: 0.95rem;
    }

    .info-box strong {
      color: #2c3e50;
    }

    .info-box ol, .info-box ul {
      margin: 10px 0;
      padding-left: 20px;
    }

    .info-box li {
      margin: 5px 0;
      line-height: 1.4;
    }

    .tips-box {
      background: linear-gradient(45deg, #fff3e0, #ffeaa7);
      border: 2px solid #f39c12;
      border-radius: 12px;
      padding: 15px;
      margin-top: 20px;
      text-align: left;
    }

    .tips-box h4 {
      color: #e67e22;
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .tips-box ul {
      margin: 0;
      padding-left: 20px;
    }

    .tips-box li {
      margin: 5px 0;
      color: #d35400;
      font-weight: 500;
    }

    /* ===== SMOOTH SCROLL ===== */
    html {
      scroll-behavior: smooth;
    }


    /* ===== RESPONSIVE DESIGN ===== */
    @media (max-width: 900px) {
      .container {
        padding: 10px;
      }
      .grid {
        grid-template-columns: 1fr;
        gap: 18px;
      }
      .card {
        padding: 16px;
      }
      .chart-container {
        height: 250px;
      }
      .controls {
        flex-direction: column;
        gap: 12px;
      }
      input[type="text"], input[type="number"] {
        width: 100%;
        max-width: 260px;
      }
      #map {
        height: 250px;
      }
      /* Calculadora de electrodomÃ©sticos */
      #calculadora-ahorro > div[style*="display: grid"] {
        grid-template-columns: 1fr;
        gap: 15px !important;
      }
      #calculadora-ahorro .card, #calculadora-ahorro {
        padding: 10px !important;
      }
      #calculadora-ahorro .info-box {
        text-align: center;
      }
      #calculadora-ahorro > div[style*="display: grid"] > div {
        min-width: 0 !important;
        width: 100% !important;
        margin: 0 auto !important;
      }
      #calculadora-ahorro select, #calculadora-ahorro input[type="number"], #calculadora-ahorro input[type="text"] {
        font-size: 1rem;
        width: 100% !important;
        min-width: 0 !important;
        max-width: 100% !important;
      }
      #calculadora-ahorro button {
        width: 100%;
        font-size: 1rem;
      }
      /* Centrado de cuadros informativos */
      .info-box, .tips-box {
        margin-left: auto;
        margin-right: auto;
        text-align: center;
      }
      .info-banner, .disclaimer, .footer {
        margin-left: auto;
        margin-right: auto;
      }
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 1.3rem;
        margin: 14px 0;
      }
      .card {
        padding: 8px;
      }
      .chart-container {
        height: 160px;
      }
      #calculadora-ahorro .info-box {
        font-size: 0.92rem;
        padding: 8px;
      }
      .info-box, .tips-box {
        font-size: 0.92rem;
        padding: 8px;
      }
      .features-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
    }

    /* Animaciones personalizadas */
    @keyframes slideUp {
      from { 
        transform: translateX(-50%) translateY(100%); 
        opacity: 0; 
      }
      to { 
        transform: translateX(-50%) translateY(0); 
        opacity: 1; 
      }
    }
    
    @keyframes slideDown {
      from { 
        transform: translateX(-50%) translateY(0); 
        opacity: 1; 
      }
      to { 
        transform: translateX(-50%) translateY(100%); 
        opacity: 0; 
      }
    }
    
    @keyframes slideInRight {
      from { 
        transform: translateX(100%); 
        opacity: 0; 
      }
      to { 
        transform: translateX(0); 
        opacity: 1; 
      }
    }
    
    @keyframes slideOutRight {
      from { 
        transform: translateX(0); 
        opacity: 1; 
      }
      to { 
        transform: translateX(100%); 
        opacity: 0; 
      }
    }
    
    @keyframes fadeInScale {
      from { 
        transform: translate(-50%, -50%) scale(0.7); 
        opacity: 0; 
      }
      to { 
        transform: translate(-50%, -50%) scale(1); 
        opacity: 1; 
      }
    }
    
    @keyframes fadeOutScale {
      from { 
        transform: translate(-50%, -50%) scale(1); 
        opacity: 1; 
      }
      to { 
        transform: translate(-50%, -50%) scale(0.7); 
        opacity: 0; 
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header principal mejorado -->
    <div style="
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 25px 20px;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      text-align: center;
      position: relative;
      overflow: hidden;
    ">
      <!-- Efecto de brillo sutil -->
      <div style="
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        pointer-events: none;
      "></div>
      
      <!-- TÃ­tulo principal -->
      <h1 style="
        color: white;
        margin: 0 0 15px 0;
        font-size: clamp(1.8rem, 4vw, 2.8rem);
        font-weight: 700;
        text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
        position: relative;
        z-index: 1;
      ">
        ğŸ‡ªğŸ‡¸ âš¡ MERCADO ELÃ‰CTRICO ESPAÃ‘OL âš¡ ğŸ‡ªğŸ‡¸
      </h1>
      
      <!-- SubtÃ­tulo -->
      <p style="
        color: rgba(255,255,255,0.9);
        margin: 0 0 20px 0;
        font-size: 1.1rem;
        font-weight: 500;
        position: relative;
        z-index: 1;
      ">
        Precios y Comparativas en Tiempo Real
      </p>
      
      <!-- Indicador de estado mejorado -->
      <div id="api-status" style="
        display: inline-block;
        background: linear-gradient(45deg, #27ae60, #2ecc71);
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 0.95rem;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        border: 2px solid rgba(255,255,255,0.2);
        position: relative;
        z-index: 1;
        transition: all 0.3s ease;
      ">
        âœ… Datos oficiales obtenidos (8/8/2025)
      </div>
    </div>
    
    <!-- Banner informativo -->
    <div class="info-banner">
      <div class="banner-content">
        <div class="header-with-clock">
          <h2>ğŸ“Š Dashboard del Mercado ElÃ©ctrico</h2>
        </div>
        <p>Analiza <strong>precios oficiales PVPC</strong> y compara todas las <strong>comercializadoras espaÃ±olas</strong> para encontrar la mejor tarifa y optimizar tu factura elÃ©ctrica.</p>
        
        <!-- ExplicaciÃ³n del sistema elÃ©ctrico espaÃ±ol -->
        <div style="background: linear-gradient(135deg, #2c3e50, #34495e); padding: 25px; border-radius: 15px; margin: 20px 0; color: white; box-shadow: 0 8px 25px rgba(44, 62, 80, 0.4);">
          <h3 style="margin: 0 0 20px 0; text-align: center; font-size: 1.6rem; font-weight: 700; color: #ffffff;">âš¡ Â¿CÃ³mo funciona el mercado elÃ©ctrico espaÃ±ol?</h3>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <div style="background: rgba(255,255,255,0.12); padding: 22px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
              <h4 style="margin: 0 0 12px 0; color: #ffffff; font-size: 1.1rem; font-weight: 600;">ğŸ“ˆ PVPC - Precio de Referencia</h4>
              <p style="margin: 0; font-size: 1rem; line-height: 1.6; color: #f8f9fa;">
                Es el <strong style="color: #ffd700;">precio oficial regulado</strong> que marca el gobierno, cambia cada hora segÃºn el mercado elÃ©ctrico.
                <br><br>
                <span style="color: #ff6b6b; font-weight: 700; background: rgba(255,107,107,0.2); padding: 2px 6px; border-radius: 4px;">âš ï¸ IMPORTANTE:</span> <strong style="color: #ffffff;">NO es una tarifa que puedas contratar.</strong> Es la referencia oficial del estado para medir si las comercializadoras son caras o baratas.
              </p>
            </div>
            
            <div style="background: rgba(255,255,255,0.12); padding: 22px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
              <h4 style="margin: 0 0 12px 0; color: #ffffff; font-size: 1.1rem; font-weight: 600;">ğŸ¢ Comercializadoras de Referencia (COR)</h4>
              <p style="margin: 0; font-size: 1rem; line-height: 1.6; color: #f8f9fa;">
                Son las <strong style="color: #74b9ff;">Ãºnicas que pueden aplicar PVPC</strong>:
                <br>â€¢ Iberdrola (CurenergÃ­a)
                <br>â€¢ Endesa (EnergÃ­a XXI)
                <br>â€¢ Naturgy (Com. Regulada)
                <br>â€¢ EDP, Viesgo
                <br><br>
                <strong style="color: #55efc4;">Precio final = PVPC + margen regulado pequeÃ±o</strong>
              </p>
            </div>
            
            <div style="background: rgba(255,255,255,0.15); padding: 18px; border-radius: 10px;">
              <h4 style="margin: 0 0 10px 0; color: #ecf0f1;">ï¿½ Comercializadoras Libres</h4>
              <p style="margin: 0; font-size: 1rem; line-height: 1.6; color: #f8f9fa;">
                Tienen <strong>precios propios independientes</strong> del PVPC:
                <br>â€¢ Precios fijos
                <br>â€¢ Indexados al mercado
                <br>â€¢ Promociones especiales
                <br><br>
                <strong>Pueden ser mejores o peores que PVPC</strong> segÃºn tu consumo y horarios.
              </p>
            </div>
          </div>
          
          <div style="background: rgba(255,255,255,0.15); padding: 22px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.25);">
            <h4 style="margin: 0 0 15px 0; color: #ffffff; font-size: 1.2rem; font-weight: 600;">ğŸ¯ MetodologÃ­a de ComparaciÃ³n</h4>
            <p style="margin: 0; font-size: 1.1rem; font-weight: 600; line-height: 1.5; color: #f8f9fa;">
              Comparamos las tarifas reales de las comercializadoras <strong style="color: #ffd700;">CONTRA el precio PVPC oficial de referencia</strong>.
              <br>
              Te mostramos cuÃ¡nto ahorras (o pagas de mÃ¡s) respecto al precio oficial que marca el gobierno.
            </p>
          </div>
        </div>
        
        <div class="features-grid">
          <button class="feature-btn" onclick="scrollToSection('grafico-precios')">
            <span class="feature-icon">âš¡</span>
            <span>Precios PVPC hora a hora</span>
          </button>
          <button class="feature-btn" onclick="scrollToSection('comparativa-companias')">
            <span class="feature-icon">ğŸ“Š</span>
            <span>Â¿QuÃ© comercializadora elegir HOY?</span>
          </button>
          <button class="feature-btn" onclick="scrollToSection('companias-electricas')">
            <span class="feature-icon">ğŸ¢</span>
            <span>Todas las comercializadoras</span>
          </button>
          <button class="feature-btn" onclick="scrollToSection('calculadora-ahorro')">
            <span class="feature-icon">ğŸ’°</span>
            <span>Calcula tu ahorro personalizado</span>
          </button>
          <a href="meteorologia.html" class="feature-btn" style="
            display: flex;
            align-items: center;
            text-decoration: none;
            color: inherit;
          ">
            <span class="feature-icon">ğŸŒ¤ï¸ğŸ’°</span>
            <span>METEOROLOGÃA Y AHORRO</span>
          </a>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Price Alert Card -->
      <div class="card">
        <h3>ğŸ’° Estado del Precio</h3>
        <div id="alerta">
          <span class="loading"></span>Cargando precios...
        </div>
      </div>
    </div>

    <!-- Price Chart Card -->
    <div class="card full-width" id="grafico-precios">
      <h3>ğŸ“Š Precios PVPC EspaÃ±a - Precio Oficial por Horas</h3>
      <div style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #3498db;">
        <p style="margin: 0 0 8px 0; font-size: 0.9rem; color: #2c3e50;"><strong>ğŸ’¡ Precio oficial del gobierno</strong> - PVPC es el precio regulado que marca el estado espaÃ±ol cada hora como referencia del mercado.</p>
        <p style="margin: 0; font-size: 0.9rem; color: #2c3e50;"><strong>ğŸ“Š Uso como referencia:</strong> Usamos estos precios oficiales como base para comparar y mostrar si las comercializadoras te ofrecen mejor o peor precio que la referencia gubernamental.</p>
      </div>
      <div style="text-align: center; margin-bottom: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
        <button onclick="refreshPriceData()" style="
          background: linear-gradient(45deg, #27ae60, #2ecc71);
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 8px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 700;
          transition: all 0.3s ease;
          box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(39, 174, 96, 0.5)'" 
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(39, 174, 96, 0.4)'">
          ğŸ¯ OBTENER PRECIOS REALES
        </button>
        <button onclick="generateNewRealisticData()" style="
          background: linear-gradient(45deg, #8e44ad, #9b59b6);
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 8px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 700;
          transition: all 0.3s ease;
          box-shadow: 0 4px 15px rgba(142, 68, 173, 0.4);
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(142, 68, 173, 0.5)'" 
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(142, 68, 173, 0.4)'">
          ğŸ“ˆ VER SIMULACIÃ“N
        </button>
        <button onclick="showHistoricalAverage()" style="
          background: linear-gradient(45deg, #f39c12, #e67e22);
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 8px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 700;
          transition: all 0.3s ease;
          box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(243, 156, 18, 0.5)'" 
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(243, 156, 18, 0.4)'">
          ğŸ“Š PROMEDIO HISTÃ“RICO
        </button>
      </div>
      <div style="text-align: center; margin-bottom: 15px;">
        <div style="font-size: 0.95rem; color: #2c3e50; max-width: 750px; margin: 0 auto; line-height: 1.5; background: linear-gradient(45deg, #f8f9fa, #e9ecef); padding: 15px 25px; border-radius: 12px; border: 2px solid #dee2e6; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <strong style="color: #27ae60; font-size: 1.05rem;">ğŸ¯ PRECIOS REALES (TARIFA PVPC):</strong> Datos oficiales hora por hora de Red ElÃ©ctrica de EspaÃ±a para la tarifa regulada PVPC<br>
          <strong style="color: #8e44ad; font-size: 1.05rem;">ğŸ“ˆ SIMULACIÃ“N:</strong> PredicciÃ³n realista basada en patrones actuales del mercado<br>
          <strong style="color: #f39c12; font-size: 1.05rem;">ğŸ“Š PROMEDIO HISTÃ“RICO:</strong> Media de precios de dÃ­as similares (mismo tipo de dÃ­a y estaciÃ³n)<br>
        </div>
      </div>
      <div id="current-hour-indicator" style="text-align: center; margin-bottom: 10px;">
        <div style="display: inline-block; background: linear-gradient(45deg, #2196F3, #1976D2); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; box-shadow: 0 3px 10px rgba(33, 150, 243, 0.4); border: 2px solid #1565C0;">
          âš¡ HORA ACTUAL: <span id="current-hour-text">--:--</span> | La columna azul muestra el precio ahora
        </div>
      </div>
      <div class="chart-container">
        <canvas id="grafico"></canvas>
      </div>
    </div>

    <!-- Company Comparison Chart -->
    <div class="card full-width" id="comparativa-companias">
      <h3>ï¿½ Â¿CuÃ¡nto mÃ¡s o menos pagas HOY con tu tarifa?</h3>
      <div class="info-box">
        <p><strong>ğŸ¯ ComparaciÃ³n contra precio oficial:</strong> Introduce tu patrÃ³n de consumo y ve cuÃ¡nto pagarÃ­as con cada comercializadora comparado contra el precio PVPC oficial del gobierno (usado como referencia de mercado).</p>
        <p><strong>ğŸ¢ COR vs Libres:</strong> Las Comercializadoras de Referencia aplican PVPC + margen pequeÃ±o. Las libres tienen precios propios que pueden ser mejores o peores segÃºn tu consumo.</p>
        <p><strong>ğŸ’° Resultado prÃ¡ctico:</strong> Conoce los mÃ¡rgenes de ahorro o sobrecosto de cada comercializadora respecto al precio oficial PVPC para tomar decisiones informadas.</p>
      </div>
      
      <!-- Control de consumo diario -->
      <div style="background: linear-gradient(135deg, #e67e22, #d35400); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
        <h4 style="margin: 0 0 15px 0;">âš¡ Configura tu consumo de HOY</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Consumo total del dÃ­a:</label>
            <input type="number" id="daily-consumption" value="10" min="1" max="100" step="0.5" style="
              width: 100%;
              padding: 10px;
              border: none;
              border-radius: 8px;
              font-size: 1rem;
              background: white;
              color: #2c3e50;
            " onchange="updateUserComparison()">
            <small style="opacity: 0.9;">kWh por dÃ­a</small>
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Â¿CuÃ¡ndo consumes mÃ¡s?</label>
            <select id="consumption-pattern" style="
              width: 100%;
              padding: 10px;
              border: none;
              border-radius: 8px;
              font-size: 1rem;
              background: white;
              color: #2c3e50;
            " onchange="updateUserComparison()">
              <option value="flat">ğŸ  Plano (uniforme)</option>
              <option value="residential" selected>â° Residencial (maÃ±ana/tarde/noche)</option>
              <option value="business">ï¿½ Comercial (horario laboral)</option>
              <option value="work-day">ğŸ’¼ DÃ­a laboral (maÃ±ana y noche)</option>
            </select>
          </div>
        </div>
        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; font-size: 0.9rem;">
          ğŸ’¡ <strong>Consejo:</strong> Un hogar medio consume entre 8-15 kWh/dÃ­a. Ajusta estos valores segÃºn tu factura elÃ©ctrica.
        </div>
      </div>
      
      <!-- Selector de tu tarifa actual -->
      <div style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
        <h4 style="margin: 0 0 15px 0;">ğŸ  Â¿CuÃ¡l es tu tarifa actual?</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Tu compaÃ±Ã­a:</label>
            <select id="user-company-selector" style="
              width: 100%;
              padding: 10px;
              border: none;
              border-radius: 8px;
              font-size: 1rem;
              background: white;
              color: #2c3e50;
            " onchange="updateUserTariffSelector()">
              <option value="">-- Selecciona tu compaÃ±Ã­a --</option>
              <option value="iberdrola-cor">ğŸ›ï¸ Iberdrola COR (Tarifa regulada)</option>
              <option value="endesa-cor">ğŸ›ï¸ Endesa EnergÃ­a XXI (Tarifa regulada)</option>
              <option value="naturgy-cor">ğŸ›ï¸ Naturgy Iberia (Tarifa regulada)</option>
              <option value="edp-cor">ğŸ›ï¸ EDP Comercial. Ãšlt. Recurso</option>
              <option value="repsol-cor">ğŸ›ï¸ Repsol Comercial. Ãšlt. Recurso</option>
              <option value="iberdrola">ğŸŸ¦ Iberdrola (Mercado libre)</option>
              <option value="endesa">ğŸ”µ Endesa (Mercado libre)</option>
              <option value="naturgy">ğŸŸ¢ Naturgy (Mercado libre)</option>
              <option value="repsol">ğŸŸ¡ Repsol (Mercado libre)</option>
              <option value="totalenergies">ğŸŸ£ TotalEnergies</option>
              <option value="holaluz">â˜€ï¸ Holaluz</option>
              <option value="asenergy">âš¡ Asenergy</option>
              <option value="edp">ğŸ”· EDP (Mercado libre)</option>
              <option value="factorenergia">ğŸ“Š Factor EnergÃ­a</option>
              <option value="lucera">ğŸ’¡ Lucera</option>
              <option value="somenergia">ğŸŒ± Som Energia</option>
            </select>
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Tu tarifa:</label>
            <select id="user-tariff-selector" style="
              width: 100%;
              padding: 10px;
              border: none;
              border-radius: 8px;
              font-size: 1rem;
              background: white;
              color: #2c3e50;
              display: none;
            " onchange="updateUserComparison()">
              <option value="">-- Selecciona tu tarifa --</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Resultado de la comparaciÃ³n -->
      <div id="user-comparison-result">
        <div style="text-align: center; padding: 40px; color: #7f8c8d;">
          <span style="font-size: 3rem;">â¬†ï¸</span>
          <p>Selecciona tu tarifa actual para ver la comparaciÃ³n</p>
        </div>
      </div>
    </div>

    <!-- Spanish Energy Companies Card -->
    <div class="card full-width" id="companias-electricas">
      <h3>âš¡ Comercializadoras en EspaÃ±a - Toda la informaciÃ³n</h3>
      <div class="info-box">
        <p><strong>ğŸ¢ Tipos de comercializadoras:</strong> Aprende las diferencias entre Comercializadoras de Referencia (COR) que aplican PVPC y las del mercado libre con precios propios.</p>
        <p><strong>ğŸ“Š InformaciÃ³n completa:</strong> Consulta caracterÃ­sticas, precios orientativos y contacto de todas las comercializadoras disponibles en EspaÃ±a.</p>
        <p><strong>ğŸ’¡ Toma la mejor decisiÃ³n:</strong> Datos actualizados para ayudarte a elegir la comercializadora que mejor se adapte a tu consumo.</p>
      </div>
      
      <!-- ExplicaciÃ³n tipos de comercializadoras -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div style="background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 18px; border-radius: 12px;">
          <h4 style="margin: 0 0 10px 0;">ğŸ›ï¸ Comercializadoras de Referencia (COR)</h4>
          <p style="margin: 0 0 8px 0; font-size: 0.9rem; line-height: 1.4;"><strong>Las Ãºnicas que pueden aplicar PVPC:</strong></p>
          <ul style="margin: 0; padding-left: 0; list-style: none; font-size: 0.9rem;">
            <li style="margin-bottom: 4px;">ğŸ¢ Iberdrola (CurenergÃ­a)</li>
            <li style="margin-bottom: 4px;">ğŸ¢ Endesa (EnergÃ­a XXI)</li>
            <li style="margin-bottom: 4px;">ğŸ¢ Naturgy (Comercializadora Regulada)</li>
            <li style="margin-bottom: 4px;">ğŸ¢ EDP, Viesgo</li>
          </ul>
          <p style="margin: 8px 0 0 0; font-size: 0.85rem; opacity: 0.9;"><strong>Precio:</strong> PVPC + margen regulado pequeÃ±o</p>
        </div>
        
        <div style="background: linear-gradient(135deg, #e67e22, #f39c12); color: white; padding: 18px; border-radius: 12px;">
          <h4 style="margin: 0 0 10px 0;">ğŸ†“ Comercializadoras Libres</h4>
          <p style="margin: 0 0 8px 0; font-size: 0.9rem; line-height: 1.4;"><strong>Precios propios independientes del PVPC:</strong></p>
          <ul style="margin: 0; padding-left: 0; list-style: none; font-size: 0.9rem;">
            <li style="margin-bottom: 4px;">ğŸ’° Precios fijos todo el aÃ±o</li>
            <li style="margin-bottom: 4px;">ğŸ“ˆ Indexados con descuentos</li>
            <li style="margin-bottom: 4px;">ğŸ Promociones especiales</li>
            <li style="margin-bottom: 4px;">â° Tarifas por horas</li>
          </ul>
          <p style="margin: 8px 0 0 0; font-size: 0.85rem; opacity: 0.9;"><strong>Pueden ser mejores o peores que PVPC</strong></p>
        </div>
      </div>
      
      <!-- Selector de compaÃ±Ã­a -->
      <div class="controls" style="margin-bottom: 20px;">
        <div class="input-group">
          <select id="company-selector" style="
            padding: 12px 16px;
            border: 2px solid #3498db;
            border-radius: 8px;
            background: white;
            font-size: 1rem;
            color: #2c3e50;
            cursor: pointer;
            width: 100%;
            max-width: 400px;
          " onchange="showCompanyInfoOnly()">
            <option value="">Selecciona tu comercializadora como aparece en tu factura...</option>
            <option value="iberdrola-cor">ğŸ›ï¸ Iberdrola ComercializaciÃ³n de Ãšltimo Recurso</option>
            <option value="endesa-cor">ğŸ›ï¸ Endesa EnergÃ­a XXI</option>
            <option value="naturgy-cor">ğŸ›ï¸ Naturgy Iberia</option>
            <option value="edp-cor">ğŸ›ï¸ EDP Comercial Ãšltimo Recurso</option>
            <option value="repsol-cor">ğŸ›ï¸ Repsol Comercial Ãšltimo Recurso</option>
            <option value="curenergia-cor">ğŸ›ï¸ Curenergia (COR)</option>
            <option value="iberdrola">ğŸŸ¦ Iberdrola Clientes</option>
            <option value="endesa">ğŸ”µ Endesa EnergÃ­a</option>
            <option value="naturgy">ğŸŸ¢ Naturgy</option>
            <option value="repsol">ğŸŸ¡ Repsol</option>
            <option value="totalenergies">ğŸŸ£ TotalEnergies</option>
            <option value="holaluz">â˜€ï¸ Holaluz</option>
            <option value="edp">âš¡ EDP EnergÃ­a</option>
            <option value="asenergy">ğŸ”‹ Asenergy</option>
            <option value="factorenergia">ğŸ“Š Factor EnergÃ­a</option>
            <option value="lucera">ğŸ’¡ Lucera EnergÃ­a</option>
            <option value="somenergia">ğŸŒ± Som Energia</option>
            <option value="octopus">ğŸ™ Octopus Energy</option>
            <option value="nexus">ğŸ”Œ Nexus EnergÃ­a</option>
            <option value="gana">ğŸ’° Gana EnergÃ­a</option>
            <option value="pepeenergy">ğŸŒŸ Pepe Energy</option>
          </select>
        </div>
      </div>
      
      <!-- InformaciÃ³n de la compaÃ±Ã­a seleccionada (solo informativa) -->
      <div id="company-info-display">
        <div style="text-align: center; padding: 40px; color: #7f8c8d;">
          <span style="font-size: 3rem;">ğŸ¢</span>
          <p>Selecciona una compaÃ±Ã­a para ver informaciÃ³n detallada sobre sus tarifas</p>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Hourly Tariff Comparison Calculator -->
      <div class="card" id="calculadora-ahorro">
        <h3>ğŸ’° Calculadora de Costo Real por ElectrodomÃ©stico - Â¿CuÃ¡nto Pagas HOY?</h3>
        <div class="info-box">
          <p><strong>ğŸ¯ FunciÃ³n:</strong> Calcula el costo exacto en euros y cÃ©ntimos por usar un electrodomÃ©stico especÃ­fico en un horario concreto de HOY.</p>
          <p><strong>ï¿½ Resultado:</strong> Costo real de tu consumo con recomendaciones de mejores horarios para ahorrar dinero.</p>
          <p><strong>ğŸ’¡ Utilidad:</strong> Descubre cuÃ¡nto pagas realmente y optimiza tus horarios de consumo para reducir tu factura.</p>
        </div>
        
        <!-- ConfiguraciÃ³n del electrodomÃ©stico y horario -->
        <div style="display: grid; grid-template-columns: 1fr 350px; gap: 20px; margin-bottom: 20px;">
          <!-- Columna izquierda: ConfiguraciÃ³n -->
          <div style="background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; padding: 25px; border-radius: 12px;">
            <h4 style="margin: 0 0 20px 0;">âš¡ Configura tu ElectrodomÃ©stico y Horario</h4>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
              <!-- ElectrodomÃ©stico -->
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">ElectrodomÃ©stico:</label>
                <select id="appliance-selector" style="
                  width: 100%;
                  padding: 12px;
                  border: none;
                  border-radius: 8px;
                  font-size: 1rem;
                  background: white;
                  color: #2c3e50;
                " onchange="updateApplianceConsumption()">
                  <option value="">-- Selecciona electrodomÃ©stico --</option>
                  <option value="lavadora" data-consumption="2.0">ğŸ§º Lavadora (2.0 kWh/ciclo)</option>
                  <option value="lavavajillas" data-consumption="1.5">ğŸ½ï¸ Lavavajillas (1.5 kWh/ciclo)</option>
                  <option value="secadora" data-consumption="4.0">ğŸ‘• Secadora (4.0 kWh/ciclo)</option>
                  <option value="horno" data-consumption="2.5">ğŸ Horno (2.5 kWh/hora)</option>
                  <option value="aire-acondicionado" data-consumption="2.0">â„ï¸ Aire acondicionado (2.0 kWh/hora)</option>
                  <option value="calefaccion" data-consumption="3.0">ğŸ”¥ CalefacciÃ³n elÃ©ctrica (3.0 kWh/hora)</option>
                  <option value="coche-electrico" data-consumption="25.0">ğŸš— Carga coche elÃ©ctrico (25.0 kWh)</option>
                  <option value="bomba-calor" data-consumption="3.5">â™¨ï¸ Bomba de calor (3.5 kWh/hora)</option>
                  <option value="personalizado" data-consumption="0">ğŸ”§ Personalizado</option>
                </select>
              </div>
              
              <!-- Consumo -->
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Consumo (kWh):</label>
                <input type="number" id="appliance-consumption" value="2.0" min="0.1" max="100" step="0.1" style="
                  width: 100%;
                  padding: 12px;
                  border: none;
                  border-radius: 8px;
                  font-size: 1rem;
                  background: white;
                  color: #2c3e50;
                " onchange="updateApplianceConsumption()">
                <small style="opacity: 0.9;">kWh del electrodomÃ©stico</small>
              </div>
            </div>
            
            <!-- Selector de CompaÃ±Ã­a y Tarifa -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
              <!-- CompaÃ±Ã­a -->
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">ğŸ¢ Tu CompaÃ±Ã­a:</label>
                <select id="hourly-company-selector" style="
                  width: 100%;
                  padding: 12px;
                  border: none;
                  border-radius: 8px;
                  font-size: 1rem;
                  background: white;
                  color: #2c3e50;
                " onchange="updateHourlyTariff()">
                  <option value="pvpc">PVPC (Tarifa regulada)</option>
                  <option value="iberdrola-cor">ğŸ›ï¸ Iberdrola ComercializaciÃ³n de Ãšltimo Recurso</option>
                  <option value="endesa-cor">ğŸ›ï¸ Endesa EnergÃ­a XXI</option>
                  <option value="naturgy-cor">ğŸ›ï¸ Naturgy Iberia</option>
                  <option value="edp-cor">ğŸ›ï¸ EDP Comercial Ãšltimo Recurso</option>
                  <option value="repsol-cor">ğŸ›ï¸ Repsol Comercial Ãšltimo Recurso</option>
                  <option value="curenergia-cor">ğŸ›ï¸ Curenergia (COR)</option>
                  <option value="iberdrola">ğŸŸ¦ Iberdrola Clientes</option>
                  <option value="endesa">ğŸ”µ Endesa EnergÃ­a</option>
                  <option value="naturgy">ğŸŸ¢ Naturgy</option>
                  <option value="repsol">ğŸŸ¡ Repsol</option>
                  <option value="totalenergies">ğŸŸ£ TotalEnergies</option>
                  <option value="holaluz">â˜€ï¸ Holaluz</option>
                  <option value="edp">âš¡ EDP EnergÃ­a</option>
                  <option value="asenergy">ğŸ”‹ Asenergy</option>
                  <option value="factorenergia">ğŸ“Š Factor EnergÃ­a</option>
                  <option value="lucera">ğŸ’¡ Lucera EnergÃ­a</option>
                  <option value="somenergia">ğŸŒ± Som Energia</option>
                  <option value="octopus">ğŸ™ Octopus Energy</option>
                  <option value="nexus">ğŸ”Œ Nexus EnergÃ­a</option>
                  <option value="gana">ğŸ’° Gana EnergÃ­a</option>
                  <option value="pepeenergy">ğŸŒŸ Pepe Energy</option>
                </select>
              </div>
              
              <!-- Tarifa -->
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">ğŸ“Š Tu Tarifa:</label>
                <select id="hourly-tariff-selector" style="
                  width: 100%;
                  padding: 12px;
                  border: none;
                  border-radius: 8px;
                  font-size: 1rem;
                  background: white;
                  color: #2c3e50;
                " onchange="updateHourlyTariff()">
                  <option value="2.0A">PVPC 2.0A (Sin discriminaciÃ³n)</option>
                  <option value="2.0DHA">PVPC 2.0DHA (DiscriminaciÃ³n horaria)</option>
                  <option value="2.0DHS">PVPC 2.0DHS (Supervalle)</option>
                </select>
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
              <!-- Hora y minutos de inicio -->
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">â° Hora de inicio:</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                  <select id="start-hour" style="
                    width: 100%;
                    padding: 10px;
                    border: none;
                    border-radius: 6px;
                    font-size: 0.95rem;
                    background: white;
                    color: #2c3e50;
                  " onchange="updateTimeDisplay()">
                    <option value="0">00</option>
                    <option value="1">01</option>
                    <option value="2">02</option>
                    <option value="3">03</option>
                    <option value="4">04</option>
                    <option value="5">05</option>
                    <option value="6">06</option>
                    <option value="7">07</option>
                    <option value="8">08</option>
                    <option value="9">09</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12" selected>12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                  </select>
                  <select id="start-minute" style="
                    width: 100%;
                    padding: 10px;
                    border: none;
                    border-radius: 6px;
                    font-size: 0.95rem;
                    background: white;
                    color: #2c3e50;
                  " onchange="updateTimeDisplay()">
                    <option value="0" selected>00</option>
                    <option value="15">15</option>
                    <option value="30">30</option>
                    <option value="45">45</option>
                  </select>
                </div>
                <small style="opacity: 0.8; font-size: 0.8rem;">Hora : Minutos</small>
              </div>
              
              <!-- DuraciÃ³n del funcionamiento -->
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">â±ï¸ DuraciÃ³n funcionamiento:</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                  <select id="duration-hours" style="
                    width: 100%;
                    padding: 10px;
                    border: none;
                    border-radius: 6px;
                    font-size: 0.95rem;
                    background: white;
                    color: #2c3e50;
                  " onchange="updateTimeDisplay()">
                    <option value="0">0h</option>
                    <option value="1" selected>1h</option>
                    <option value="2">2h</option>
                    <option value="3">3h</option>
                    <option value="4">4h</option>
                    <option value="5">5h</option>
                    <option value="6">6h</option>
                    <option value="7">7h</option>
                    <option value="8">8h</option>
                    <option value="9">9h</option>
                    <option value="10">10h</option>
                    <option value="11">11h</option>
                    <option value="12">12h</option>
                  </select>
                  <select id="duration-minutes" style="
                    width: 100%;
                    padding: 10px;
                    border: none;
                    border-radius: 6px;
                    font-size: 0.95rem;
                    background: white;
                    color: #2c3e50;
                  " onchange="updateTimeDisplay()">
                    <option value="0" selected>0m</option>
                    <option value="15">15m</option>
                    <option value="30">30m</option>
                    <option value="45">45m</option>
                  </select>
                </div>
                <small style="opacity: 0.8; font-size: 0.8rem;">Horas : Minutos</small>
              </div>
            </div>
          </div>
          
          <!-- Columna derecha: Resumen y acciÃ³n -->
          <div style="display: flex; flex-direction: column; gap: 15px;">
            <!-- Panel de resumen -->
            <div style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; border-radius: 12px; flex: 1;">
              <h4 style="margin: 0 0 15px 0;">ğŸ“‹ Resumen</h4>
              
              <!-- Hora de finalizaciÃ³n -->
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem;">ğŸ Finaliza a las:</label>
                <input type="text" id="end-time-display" readonly style="
                  width: 100%;
                  padding: 10px;
                  border: none;
                  border-radius: 6px;
                  font-size: 1.1rem;
                  background: rgba(255,255,255,0.9);
                  color: #2c3e50;
                  text-align: center;
                  font-weight: bold;
                " value="13:00">
              </div>
              
              <!-- DuraciÃ³n -->
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem;">â±ï¸ DuraciÃ³n:</label>
                <input type="text" id="duration-display" readonly style="
                  width: 100%;
                  padding: 10px;
                  border: none;
                  border-radius: 6px;
                  font-size: 1rem;
                  background: rgba(255,255,255,0.8);
                  color: #2c3e50;
                  text-align: center;
                  font-weight: bold;
                " value="1 hora">
              </div>
              
              <!-- InformaciÃ³n adicional -->
              <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 6px; font-size: 0.85rem;">
                ğŸ’¡ <strong>Tip:</strong> Selecciona tu compaÃ±Ã­a y tarifa actual para conocer el costo exacto de usar electrodomÃ©sticos en horarios especÃ­ficos.
              </div>
            </div>
            
            <!-- BotÃ³n de acciÃ³n -->
            <div style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 20px; border-radius: 12px; text-align: center;">
              <button onclick="calculateTimingAndComparison()" style="
                background: rgba(255,255,255,0.2);
                color: white;
                border: 2px solid white;
                padding: 15px 25px;
                border-radius: 25px;
                cursor: pointer;
                font-size: 1.1rem;
                font-weight: 700;
                width: 100%;
                transition: all 0.3s ease;
              " onmouseover="this.style.background='white'; this.style.color='#e74c3c'" 
                 onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.color='white'">
                ğŸ’° CALCULAR COSTO REAL
              </button>
              <div style="margin-top: 10px; font-size: 0.8rem; opacity: 0.9;">
                Descubre cuÃ¡nto pagas con tu tarifa actual
              </div>
            </div>
          </div>
        </div>
        
        <!-- Resultado de la comparaciÃ³n -->
        <div id="hourly-comparison-result">
          <div style="text-align: center; padding: 40px; color: #7f8c8d;">
            <span style="font-size: 3rem;">âš¡</span>
            <p>Configura tu electrodomÃ©stico y horario para ver la comparaciÃ³n de tarifas</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Disclaimer -->
  <div class="disclaimer">
    <h3>âš ï¸ DISCLAIMER - AVISO IMPORTANTE</h3>
    <p>
      La informaciÃ³n presentada en esta plataforma ha sido desarrollada con el <span class="highlight">mÃ¡ximo cuidado y atenciÃ³n al detalle</span>. 
      Sin embargo, reconocemos que <span class="highlight">pueden existir errores</span> en los datos, cÃ¡lculos o interpretaciones.
    </p>
    <p>
      <span class="highlight">Esta informaciÃ³n debe considerarse Ãºnicamente como referencia orientativa</span> y no constituye asesoramiento financiero, energÃ©tico o comercial profesional. 
      Los precios de la electricidad, condiciones meteorolÃ³gicas y tarifas pueden variar y cambiar sin previo aviso.
    </p>
    <p>
      <strong>Recomendamos verificar siempre los datos con fuentes oficiales</strong> como OMIE, REE, AEMET y las comercializadoras elÃ©ctricas antes de tomar decisiones importantes. 
      El uso de esta informaciÃ³n es bajo su propia responsabilidad.
    </p>
  </div>

  <div class="footer">
    <p>Â© 2025 PRECIO DE LA ELECTRICIDAD Y METEOROLOGÃA. TODOS LOS DERECHOS RESERVADOS.</p>
    <p>Desarrollado con â¤ï¸ por <a href="https://github.com/adriancubasalvarez" target="_blank">AdriÃ¡n Cubas</a></p>
  </div>

  <script>
// ===== GLOBAL VARIABLES =====
let globalPrices = [];
let weatherChart = null;
let priceChart = null;
let comparisonChart = null;
let map = null;

// ===== SISTEMA DE CACHÃ‰ SIMPLIFICADO PARA GITHUB PAGES =====
const CACHE_CONFIG = {
  ELECTRICITY_TTL: 30 * 60 * 1000,     // 30 minutos (mÃ¡s frecuente para GitHub Pages)
  WEATHER_TTL: 15 * 60 * 1000,         // 15 minutos (mÃ¡s frecuente)
  MAX_WEATHER_CALLS_PER_DAY: 800       // LÃ­mite de seguridad
};

class SimpleCache {
  constructor() {
    this.prefix = 'precio_luz_';
    this.sessionCounters = new Map(); // Usar Map en memoria en lugar de localStorage
  }

  // Verificar si podemos hacer mÃ¡s llamadas meteorolÃ³gicas (solo en sesiÃ³n actual)
  canMakeWeatherCall() {
    const today = new Date().toDateString();
    const sessionKey = `weather_calls_${today}`;
    const current = this.sessionCounters.get(sessionKey) || 0;
    
    if (current >= CACHE_CONFIG.MAX_WEATHER_CALLS_PER_DAY) {
      console.warn(`âš ï¸ LÃ­mite de llamadas meteorolÃ³gicas alcanzado en esta sesiÃ³n: ${current}/${CACHE_CONFIG.MAX_WEATHER_CALLS_PER_DAY}`);
      return false;
    }
    
    return true;
  }

  // Incrementar contador de llamadas meteorolÃ³gicas (solo en sesiÃ³n)
  incrementWeatherCallCounter() {
    const today = new Date().toDateString();
    const sessionKey = `weather_calls_${today}`;
    const current = this.sessionCounters.get(sessionKey) || 0;
    this.sessionCounters.set(sessionKey, current + 1);
    console.log(`ğŸŒ¤ï¸ Llamadas meteorolÃ³gicas en esta sesiÃ³n: ${current + 1}/${CACHE_CONFIG.MAX_WEATHER_CALLS_PER_DAY}`);
  }

  // CachÃ© temporal en sessionStorage (se pierde al recargar - perfecto para GitHub Pages)
  set(key, data, ttl = CACHE_CONFIG.ELECTRICITY_TTL) {
    const expirationTime = Date.now() + ttl;
    const cacheData = {
      data: data,
      expiration: expirationTime,
      timestamp: Date.now()
    };
    
    try {
      // Solo usar sessionStorage para datos crÃ­ticos, no localStorage
      sessionStorage.setItem(this.prefix + key, JSON.stringify(cacheData));
      console.log(`ğŸ’¾ Datos guardados en cachÃ© temporal: ${key} (expira en ${Math.round(ttl/60000)} min)`);
      return true;
    } catch (error) {
      console.warn('âš ï¸ Error guardando en cachÃ© temporal:', error);
      return false;
    }
  }

  // Obtener datos del cachÃ© temporal
  get(key) {
    try {
      const stored = sessionStorage.getItem(this.prefix + key);
      if (!stored) return null;

      const cacheData = JSON.parse(stored);
      
      if (Date.now() > cacheData.expiration) {
        sessionStorage.removeItem(this.prefix + key);
        console.log(`âŒ› CachÃ© temporal expirado eliminado: ${key}`);
        return null;
      }

      const ageMinutes = Math.round((Date.now() - cacheData.timestamp) / 60000);
      console.log(`âœ… Datos obtenidos del cachÃ© temporal: ${key} (${ageMinutes} min de antigÃ¼edad)`);
      return cacheData.data;
    } catch (error) {
      console.warn('âš ï¸ Error leyendo cachÃ© temporal:', error);
      return null;
    }
  }

  // Eliminar entrada del cachÃ©
  delete(key) {
    try {
      sessionStorage.removeItem(this.prefix + key);
    } catch (error) {
      console.warn('âš ï¸ Error eliminando cachÃ©:', error);
    }
  }

  // Limpiar todo el cachÃ© de la sesiÃ³n
  clearAll() {
    try {
      const keys = Object.keys(sessionStorage);
      keys.forEach(key => {
        if (key.startsWith(this.prefix)) {
          sessionStorage.removeItem(key);
        }
      });
      this.sessionCounters.clear();
      console.log('ğŸ§¹ CachÃ© de sesiÃ³n limpiado');
    } catch (error) {
      console.warn('âš ï¸ Error limpiando cachÃ©:', error);
    }
  }

  // Obtener estadÃ­sticas simples
  getStats() {
    const today = new Date().toDateString();
    const sessionKey = `weather_calls_${today}`;
    const weatherCalls = this.sessionCounters.get(sessionKey) || 0;
    
    return {
      weatherCallsToday: weatherCalls,
      remainingWeatherCalls: CACHE_CONFIG.MAX_WEATHER_CALLS_PER_DAY - weatherCalls,
      cacheType: 'Session (GitHub Pages optimized)'
    };
  }
}

// Instancia global del cachÃ© simplificado
const cache = new SimpleCache();

// === FUNCIONES DE RESPALDO GARANTIZADO ===
function forceLoadBackupPrices() {
  console.log('ğŸ”§ Forzando carga de precios de respaldo...');
  
  try {
    const alertElement = document.getElementById("alerta");
    const canvasElement = document.getElementById("grafico");
    
    if (!canvasElement) {
      console.error('âŒ Canvas del grÃ¡fico no encontrado');
      return;
    }
    
    const ctx = canvasElement.getContext("2d");
    
    // Generar datos de respaldo inmediatamente
    const backupData = generateImmediateBackupPrices();
    
    if (backupData && backupData.prices && backupData.prices.length > 0) {
      globalPrices = backupData.prices;
      updatePriceAlert(backupData.prices, backupData);
      renderPriceChart(ctx, backupData.labels, backupData.prices, backupData.colors);
      
      // Actualizar comparaciÃ³n de tarifas
      const comparisonData = calculateTariffComparison(backupData.prices, 'respaldo');
      renderTariffComparison(comparisonData);
      
      updateApiStatus('offline', 'Datos de respaldo cargados correctamente');
      console.log('âœ… Precios de respaldo cargados exitosamente');
    }
  } catch (error) {
    console.error('âŒ Error en forceLoadBackupPrices:', error);
  }
}

function forceLoadBackupWeather() {
  console.log('ğŸ”§ Forzando carga de datos meteorolÃ³gicos de respaldo...');
  
  try {
    const weatherElement = document.getElementById("weather");
    const weatherCanvasElement = document.getElementById("weather-chart");
    
    if (!weatherElement || !weatherCanvasElement) {
      console.error('âŒ Elementos meteorolÃ³gicos no encontrados');
      return;
    }
    
    const weatherCtx = weatherCanvasElement.getContext("2d");
    
    // Generar datos meteorolÃ³gicos de respaldo inmediatamente
    const mockWeatherData = generateMockWeatherData();
    updateWeatherDisplay(weatherElement, mockWeatherData);
    renderWeatherChart(weatherCtx, mockWeatherData);
    setupWeatherControls();
    
    console.log('âœ… Datos meteorolÃ³gicos de respaldo cargados exitosamente');
  } catch (error) {
    console.error('âŒ Error en forceLoadBackupWeather:', error);
  }
}

function generateImmediateBackupPrices() {
  console.log('ğŸ“Š Generando precios de respaldo inmediatos...');
  
  const today = new Date();
  const isWeekend = [0, 6].includes(today.getDay());
  const currentHour = today.getHours();
  
  // Patrones realistas de precios PVPC
  const basePattern = isWeekend ? 
    [0.075, 0.068, 0.062, 0.060, 0.065, 0.085, 0.105, 0.135, 0.125, 0.105, 0.095, 0.085, 
     0.085, 0.075, 0.085, 0.095, 0.115, 0.145, 0.165, 0.155, 0.135, 0.115, 0.095, 0.085] :
    [0.085, 0.078, 0.072, 0.070, 0.075, 0.095, 0.125, 0.165, 0.145, 0.125, 0.115, 0.105,
     0.095, 0.085, 0.095, 0.115, 0.135, 0.165, 0.195, 0.175, 0.155, 0.135, 0.115, 0.095];
  
  const labels = [];
  const prices = [];
  const colors = [];
  
  for (let i = 0; i < 24; i++) {
    labels.push(`${i.toString().padStart(2, '0')}:00`);
    
    // Agregar pequeÃ±a variaciÃ³n aleatoria
    const variation = (Math.random() - 0.5) * 0.01;
    const finalPrice = Math.max(0.045, basePattern[i] + variation);
    prices.push(parseFloat(finalPrice.toFixed(4)));
    
    // Colores segÃºn precio y hora actual
    if (i === currentHour) {
      colors.push("#2196F3"); // Azul para hora actual
    } else if (finalPrice <= 0.08) {
      colors.push("#27ae60"); // Verde
    } else if (finalPrice <= 0.12) {
      colors.push("#f39c12"); // Naranja
    } else {
      colors.push("#e67e22"); // Rojo
    }
  }
  
  return {
    labels,
    prices,
    colors,
    date: today.toLocaleDateString('es-ES'),
    isWeekend,
    source: 'Datos de respaldo'
  };
}

function updateCacheStatus() {
  const cacheElement = document.getElementById("cache-status");
  if (!cacheElement) return;
  
  const stats = cache.getStats();
  const weatherCalls = stats.weatherCallsToday;
  const usagePercentage = Math.round((weatherCalls / CACHE_CONFIG.MAX_WEATHER_CALLS_PER_DAY) * 100);
  
  // Color y estado segÃºn el uso
  let statusColor = '#27ae60'; // Verde
  let statusText = 'Ã“ptimo';
  
  if (usagePercentage > 80) {
    statusColor = '#e74c3c'; // Rojo
    statusText = 'Alto uso';
  } else if (usagePercentage > 60) {
    statusColor = '#f39c12'; // Naranja
    statusText = 'Uso medio';
  }
  
  cacheElement.innerHTML = `ğŸ’¾ API Calls: ${weatherCalls}/800 (${statusText})`;
  cacheElement.style.background = `linear-gradient(45deg, ${statusColor}, ${statusColor}dd)`;
  cacheElement.style.borderColor = statusColor;
}

// ===== COMPARACIÃ“N DIARIA CON CONSUMO REAL =====

function calculateTariffComparison(pvpcPrices, dataSource = null) {
  console.log('ğŸ”§ Iniciando calculateTariffComparison con:', {
    pvpcPricesLength: pvpcPrices?.length,
    dataSource,
    firstPrice: pvpcPrices?.[0],
    lastPrice: pvpcPrices?.[pvpcPrices?.length - 1]
  });

  if (!pvpcPrices || pvpcPrices.length === 0) {
    console.error('âŒ No hay precios PVPC disponibles');
    return null;
  }

  const currentHour = new Date().getHours();
  const currentPVPCPrice = pvpcPrices[currentHour];
  const isWeekend = [0, 6].includes(new Date().getDay());
  const dailyAveragePVPC = pvpcPrices.reduce((a, b) => a + b, 0) / 24;
  
  // Obtener configuraciÃ³n de consumo del usuario
  const dailyConsumption = parseFloat(document.getElementById('daily-consumption')?.value || 10);
  const consumptionPattern = document.getElementById('consumption-pattern')?.value || 'residential';
  
  console.log('ğŸ“Š ConfiguraciÃ³n inicial:', {
    currentHour,
    currentPVPCPrice,
    dailyAveragePVPC,
    dailyConsumption,
    consumptionPattern
  });
  
  // Generar distribuciÃ³n horaria del consumo
  const hourlyConsumption = generateHourlyConsumption(dailyConsumption, consumptionPattern);
  
  if (!hourlyConsumption || hourlyConsumption.length !== 24) {
    console.error('âŒ Error generando distribuciÃ³n horaria del consumo');
    return null;
  }
  
  console.log('âœ… DistribuciÃ³n horaria generada:', hourlyConsumption.slice(0, 3), '...');
  
  // Verificar si estamos usando datos oficiales de REE
  const isOfficialData = dataSource && (dataSource.includes('ESIOS') || dataSource.includes('REE') || dataSource.includes('oficial'));
  
  console.log(`ğŸ” Calculando costes del dÃ­a completo con ${dailyConsumption} kWh (patrÃ³n: ${consumptionPattern})`);
  console.log(`ğŸ“Š PVPC actual: ${formatPrice(currentPVPCPrice)} â‚¬/kWh | Promedio dÃ­a: ${formatPrice(dailyAveragePVPC)} â‚¬/kWh`);
  console.log(`ğŸ›ï¸ Datos oficiales REE: ${isOfficialData ? 'SÃ' : 'NO'}`);
  
  const comparisons = [];
  
  // Calcular coste PVPC del dÃ­a completo
  const pvpcDailyCost = calculateDailyCost(hourlyConsumption, pvpcPrices);
  console.log('ğŸ’° Coste PVPC del dÃ­a:', pvpcDailyCost);
  
  if (!SPANISH_ENERGY_COMPANIES) {
    console.error('âŒ SPANISH_ENERGY_COMPANIES no estÃ¡ definido');
    return null;
  }
  
  console.log('ğŸ¢ Procesando', Object.keys(SPANISH_ENERGY_COMPANIES).length, 'compaÃ±Ã­as...');
  
  Object.entries(SPANISH_ENERGY_COMPANIES).forEach(([companyKey, company]) => {
    Object.entries(company.tarifas).forEach(([tariffName, tariff]) => {
      console.log(`ğŸ”§ Calculando: ${company.name} - ${tariffName}`);
      
      // Calcular precios por hora para esta tarifa
      const tariffHourlyPrices = calculateTariffHourlyPrices(tariff, pvpcPrices);
      
      // Calcular coste total del dÃ­a con esta tarifa
      const tariffDailyCost = calculateDailyCost(tariffHourlyPrices, hourlyConsumption);
      
      // Calcular ahorros vs PVPC
      const dailySavings = pvpcDailyCost - tariffDailyCost;
      const dailySavingsPercent = (dailySavings / pvpcDailyCost) * 100;
      
      // Precio medio de la tarifa en el dÃ­a
      const tariffAveragePrice = tariffHourlyPrices.reduce((a, b) => a + b, 0) / 24;
      
      // Generar recomendaciÃ³n
      let recommendation = '';
      if (dailySavingsPercent > 10) {
        recommendation = 'ğŸŸ¢ EXCELENTE AHORRO HOY';
      } else if (dailySavingsPercent > 2) {
        recommendation = 'ğŸŸ¡ LIGERO AHORRO HOY';
      } else if (dailySavingsPercent > -2) {
        recommendation = 'ğŸŸ  SIMILAR AL PVPC HOY';
      } else {
        recommendation = 'ğŸ”´ MÃS CARO HOY';
      }
      
      // MÃ©todo de cÃ¡lculo
      let calculationMethod = '';
      if (tariff.tipo === "Tarifa fija" && tariff.precio_fijo) {
        calculationMethod = `Precio fijo: ${formatPrice(tariff.precio_fijo)} â‚¬/kWh`;
      } else if (tariff.periodos) {
        calculationMethod = `DiscriminaciÃ³n horaria aplicada a ${dailyConsumption} kWh`;
      } else if (tariff.margen_fijo) {
        calculationMethod = `PVPC + ${formatPrice(tariff.margen_fijo)} â‚¬/kWh de margen`;
      } else {
        calculationMethod = 'Sigue exactamente el PVPC oficial';
      }
      
      console.log(`ğŸ“Š ${company.name} - ${tariffName}: ${tariffDailyCost.toFixed(2)} â‚¬ hoy (${dailySavingsPercent.toFixed(1)}% vs PVPC)`);
      
      comparisons.push({
        company: company.name,
        companyKey,
        tariffName,
        tariff,
        dailyCost: tariffDailyCost,
        dailySavings: dailySavings,
        dailySavingsPercent: dailySavingsPercent,
        averagePrice: tariffAveragePrice,
        currentPrice: tariffHourlyPrices[currentHour],
        recommendation,
        calculationMethod,
        hourlyPrices: tariffHourlyPrices,
        isOfficialComparison: isOfficialData
      });
    });
  });
  
  // Ordenar por ahorro diario (mejor primero)
  comparisons.sort((a, b) => b.dailySavings - a.dailySavings);
  
  console.log(`âœ… ComparaciÃ³n completa: ${comparisons.length} tarifas analizadas`);
  console.log(`ğŸ¥‡ Mejor opciÃ³n: ${comparisons[0]?.company} - ${comparisons[0]?.tariffName} (ahorra ${comparisons[0]?.dailySavings.toFixed(2)} â‚¬ hoy)`);
  console.log(`ğŸ¥‰ Peor opciÃ³n: ${comparisons[comparisons.length - 1]?.company} - ${comparisons[comparisons.length - 1]?.tariffName} (cuesta ${Math.abs(comparisons[comparisons.length - 1]?.dailySavings).toFixed(2)} â‚¬ mÃ¡s)`);
  
  return {
    pvpcDailyCost: pvpcDailyCost,
    pvpcAveragePrice: dailyAveragePVPC,
    pvpcCurrentPrice: currentPVPCPrice,
    dailyConsumption: dailyConsumption,
    consumptionPattern: consumptionPattern,
    comparisons,
    bestOption: comparisons[0],
    worstOption: comparisons[comparisons.length - 1],
    isOfficialData,
    dataSource,
    timestamp: new Date().toISOString(),
    currentHour
  };
}

function renderTariffComparison(comparisonData) {
  const container = document.getElementById('company-comparison-chart');
  if (!container) {
    console.error('âŒ No se encontrÃ³ el contenedor company-comparison-chart');
    return;
  }
  
  if (!comparisonData) {
    console.error('âŒ No hay datos de comparaciÃ³n para renderizar');
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <span style="font-size: 3rem;">âŒ</span>
        <p>Error: No se pudieron generar las comparaciones de tarifas</p>
        <button onclick="forceUpdateComparison()" style="
          background: #3498db; color: white; border: none; padding: 10px 20px; 
          border-radius: 5px; cursor: pointer; margin-top: 10px;
        ">ğŸ”„ Reintentar</button>
      </div>
    `;
    return;
  }
  
  console.log('ğŸ“Š Renderizando comparaciÃ³n con datos:', comparisonData);
  
  // Almacenar datos para anÃ¡lisis personalizado
  currentPricesData = {
    pvpcPrice: comparisonData.pvpcCurrentPrice,
    pvpcDailyAverage: comparisonData.pvpcAveragePrice,
    comparisons: comparisonData.comparisons,
    isOfficialData: comparisonData.isOfficialData,
    hourlyPrices: globalPrices // Usar los precios globales
  };
  
  const { pvpcAveragePrice, pvpcCurrentPrice, comparisons, bestOption, worstOption, isOfficialData, dataSource } = comparisonData;
  
  console.log('ğŸ’° Datos de renderizado:', {
    pvpcCurrentPrice,
    pvpcAveragePrice,
    comparisonsCount: comparisons.length,
    bestOption: bestOption ? `${bestOption.company} - ${bestOption.tariffName}` : 'No definido',
    worstOption: worstOption ? `${worstOption.company} - ${worstOption.tariffName}` : 'No definido'
  });
  
  container.innerHTML = `
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
      <h3 style="margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 2rem;">âš¡</span>
        <span>ComparaciÃ³n Oficial vs PVPC ${isOfficialData ? '(Datos REE)' : '(SimulaciÃ³n)'}</span>
      </h3>
      
      ${isOfficialData ? `
        <div style="background: rgba(39, 174, 96, 0.3); padding: 10px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #27ae60;">
          <strong>ğŸ›ï¸ DATOS OFICIALES REE</strong> - ComparaciÃ³n basada en precios reales de Red ElÃ©ctrica de EspaÃ±a
        </div>
      ` : `
        <div style="background: rgba(243, 156, 18, 0.3); padding: 10px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f39c12;">
          <strong>ğŸ“Š SIMULACIÃ“N</strong> - ComparaciÃ³n basada en datos de respaldo realistas
        </div>
      `}
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">PVPC Ahora</div>
          <div style="font-size: 1.4rem; font-weight: bold;">${formatPrice(pvpcCurrentPrice)} â‚¬/kWh</div>
        </div>
        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">PVPC Promedio Hoy</div>
          <div style="font-size: 1.4rem; font-weight: bold;">${formatPrice(pvpcAveragePrice)} â‚¬/kWh</div>
        </div>
        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">Mejor OpciÃ³n</div>
          <div style="font-size: 1.1rem; font-weight: bold;">${bestOption.company}</div>
          <div style="font-size: 0.9rem; opacity: 0.8;">${bestOption.tariffName}</div>
          <div style="font-size: 1rem; color: #00ff88;">Ahorra ${bestOption.dailySavingsPercent.toFixed(1)}%</div>
        </div>
        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">Tarifas Analizadas</div>
          <div style="font-size: 1.4rem; font-weight: bold;">${comparisons.length}</div>
          <div style="font-size: 0.9rem; opacity: 0.8;">de ${Object.keys(SPANISH_ENERGY_COMPANIES).length} compaÃ±Ã­as</div>
        </div>
      </div>
      
      <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
        <h4 style="margin: 0 0 10px 0; font-size: 1.1rem;">ğŸ“Š Resumen de ComparaciÃ³n</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; font-size: 0.9rem;">
          <div>ğŸŸ¢ Tarifas que ahorran vs PVPC: <strong>${comparisons.filter(c => c.dailySavingsPercent > 0).length}</strong></div>
          <div>ğŸ”´ Tarifas mÃ¡s caras que PVPC: <strong>${comparisons.filter(c => c.dailySavingsPercent <= 0).length}</strong></div>
          <div>ğŸ’° Mejor ahorro posible: <strong>${bestOption.dailySavingsPercent.toFixed(1)}%</strong></div>
          <div>ğŸ“ˆ Peor opciÃ³n: <strong>${worstOption.dailySavingsPercent.toFixed(1)}%</strong> (${worstOption.company})</div>
        </div>
      </div>
    </div>
    
    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #3498db;">
      <p style="margin: 0; font-size: 0.9rem; color: #2c3e50;">
        <strong>â„¹ï¸ InformaciÃ³n importante:</strong> Esta comparaciÃ³n se basa en el precio PVPC oficial ${isOfficialData ? 'obtenido de Red ElÃ©ctrica de EspaÃ±a (REE)' : 'usando datos de simulaciÃ³n realista'}. 
        Los precios mostrados son orientativos y pueden variar segÃºn condiciones especÃ­ficas de cada comercializadora. 
        ${isOfficialData ? 'Los datos son oficiales y se actualizan en tiempo real.' : 'Para obtener datos oficiales, use el botÃ³n "OBTENER PRECIOS REALES".'}
      </p>
    </div>
  `;
  
  // Si hay un usuario seleccionado, actualizar su anÃ¡lisis
  const userCompanySelector = document.getElementById('user-company-selector');
  const userTariffSelector = document.getElementById('user-tariff-selector');
  
  if (userCompanySelector && userCompanySelector.value && userTariffSelector && userTariffSelector.value) {
    setTimeout(() => {
      generateUserAnalysis(userCompanySelector.value, userTariffSelector.value);
    }, 100);
  }
}

// Funciones helper para el cÃ¡lculo de costos diarios
function generateHourlyConsumption(dailyConsumption, pattern) {
  // ValidaciÃ³n de entrada
  const consumption = parseFloat(dailyConsumption) || 10;
  if (consumption <= 0) {
    console.warn('âš ï¸ Consumo diario invÃ¡lido, usando valor por defecto:', consumption);
    return new Array(24).fill(10/24); // 10 kWh distribuidos uniformemente
  }
  
  const patterns = {
    'flat': new Array(24).fill(1/24), // Consumo plano
    'residential': [
      0.02, 0.01, 0.01, 0.01, 0.01, 0.02, // 00-05: muy bajo
      0.03, 0.05, 0.06, 0.04, 0.03, 0.03, // 06-11: maÃ±ana
      0.04, 0.04, 0.05, 0.05, 0.06, 0.07, // 12-17: tarde
      0.08, 0.09, 0.08, 0.06, 0.04, 0.03  // 18-23: noche/pico
    ],
    'business': [
      0.01, 0.01, 0.01, 0.01, 0.01, 0.02, // 00-05: cerrado
      0.04, 0.06, 0.08, 0.09, 0.08, 0.07, // 06-11: apertura
      0.06, 0.07, 0.08, 0.09, 0.08, 0.07, // 12-17: horario comercial
      0.06, 0.04, 0.03, 0.02, 0.01, 0.01  // 18-23: cierre
    ],
    'work-day': [
      0.01, 0.01, 0.01, 0.01, 0.01, 0.02, // 00-05: dormido
      0.04, 0.06, 0.03, 0.02, 0.02, 0.02, // 06-11: preparaciÃ³n y trabajo
      0.02, 0.02, 0.02, 0.02, 0.02, 0.03, // 12-17: trabajo fuera
      0.05, 0.08, 0.09, 0.08, 0.06, 0.04  // 18-23: regreso a casa
    ]
  };
  
  const selectedPattern = patterns[pattern] || patterns['residential'];
  const hourlyConsumption = selectedPattern.map(ratio => consumption * ratio);
  
  // Validar que todos los valores son nÃºmeros vÃ¡lidos
  const validConsumption = hourlyConsumption.map(value => {
    const num = parseFloat(value);
    return isNaN(num) || num < 0 ? 0 : num;
  });
  
  // Verificar que la suma total sea correcta
  const total = validConsumption.reduce((sum, val) => sum + val, 0);
  if (Math.abs(total - consumption) > 0.01) {
    console.warn('âš ï¸ Ajustando distribuciÃ³n horaria para que sume el total exacto');
    const factor = consumption / total;
    return validConsumption.map(val => val * factor);
  }
  
  return validConsumption;
}

function calculateTariffHourlyPrices(tariff, pvpcHourlyPrices) {
  return pvpcHourlyPrices.map((pvpcPrice, hour) => {
    return calculateTariffPriceForHour(tariff, pvpcPrice, hour);
  });
}

function calculateDailyCost(hourlyConsumption, hourlyPrices) {
  // ValidaciÃ³n de entrada
  if (!Array.isArray(hourlyConsumption) || !Array.isArray(hourlyPrices)) {
    console.warn('âš ï¸ Datos invÃ¡lidos en calculateDailyCost:', { hourlyConsumption, hourlyPrices });
    return 0;
  }
  
  if (hourlyConsumption.length !== hourlyPrices.length) {
    console.warn('âš ï¸ Arrays de diferente longitud en calculateDailyCost');
    return 0;
  }
  
  const totalCost = hourlyConsumption.reduce((total, consumption, hour) => {
    const price = parseFloat(hourlyPrices[hour]) || 0;
    const cons = parseFloat(consumption) || 0;
    const hourCost = cons * price;
    
    if (isNaN(hourCost)) {
      console.warn('âš ï¸ Costo invÃ¡lido en hora', hour, { consumption: cons, price, hourCost });
      return total;
    }
    
    return total + hourCost;
  }, 0);
  
  // ValidaciÃ³n del resultado final
  if (isNaN(totalCost) || totalCost < 0) {
    console.warn('âš ï¸ Costo total invÃ¡lido:', totalCost);
    return 0;
  }
  
  return totalCost;
}

function updateDailyComparison() {
  console.log('ğŸ”„ Actualizando comparaciÃ³n diaria...');
  console.log('ğŸ“Š Estado de globalPrices:', {
    exists: !!globalPrices,
    type: typeof globalPrices,
    hasArray: Array.isArray(globalPrices),
    hasPvpc: !!(globalPrices && globalPrices.pvpc),
    pvpcLength: globalPrices?.pvpc?.length || 0,
    firstThreePrices: globalPrices?.pvpc?.slice(0, 3) || globalPrices?.slice(0, 3)
  });
  
  let pvpcPrices = null;
  
  // Verificar estructura de datos y extraer precios PVPC
  if (globalPrices && globalPrices.pvpc && globalPrices.pvpc.length > 0) {
    pvpcPrices = globalPrices.pvpc;
    console.log('âœ… Usando globalPrices.pvpc');
  } else if (Array.isArray(globalPrices) && globalPrices.length > 0) {
    pvpcPrices = globalPrices;
    console.log('âœ… Usando globalPrices como array directo');
  } else {
    console.log('âš ï¸ No hay datos de precios disponibles, generando datos por defecto');
    
    // Generar datos de respaldo
    const hourlyPrices = [];
    for (let hour = 0; hour < 24; hour++) {
      // PatrÃ³n realista de precios espaÃ±oles
      let price = 0.12; // precio base
      if (hour >= 0 && hour < 8) price *= 0.8; // valle
      else if ((hour >= 10 && hour < 14) || (hour >= 18 && hour < 22)) price *= 1.4; // punta
      else price *= 1.0; // llano
      hourlyPrices.push(price);
    }
    pvpcPrices = hourlyPrices;
    globalPrices = { pvpc: hourlyPrices };
    console.log('âœ… Datos de respaldo generados');
  }
  
  // Recalcular y actualizar la comparaciÃ³n
  const comparisonData = calculateTariffComparison(pvpcPrices);
  renderTariffComparison(comparisonData);
}

function getSavingsColor(savings) {
  if (savings > 5) return '#27ae60';
  if (savings > 0) return '#f39c12';
  if (savings > -5) return '#e67e22';
  return '#e74c3c';
}

// FunciÃ³n para forzar actualizaciÃ³n de la comparaciÃ³n
function forceUpdateComparison() {
  console.log('ğŸ”„ Forzando actualizaciÃ³n de comparaciÃ³n...');
  
  // Verificar que el botÃ³n existe
  if (!event || !event.target) {
    console.error('âŒ Error: No se puede acceder al botÃ³n');
    return;
  }
  
  // Actualizar botÃ³n para mostrar que estÃ¡ cargando
  const button = event.target;
  const originalText = button.innerHTML;
  button.innerHTML = 'â³ Actualizando...';
  button.disabled = true;
  
  // Verificar que los elementos necesarios existan
  const canvasElement = document.getElementById("grafico");
  const alertElement = document.getElementById("alerta");
  
  if (!canvasElement) {
    console.error('âŒ Error: Canvas del grÃ¡fico no encontrado');
    button.innerHTML = 'âŒ Canvas no encontrado';
    button.disabled = false;
    return;
  }
  
  if (!alertElement) {
    console.error('âŒ Error: Elemento de alerta no encontrado');
    button.innerHTML = 'âŒ Elementos no encontrados';
    button.disabled = false;
    return;
  }
  
  // Limpiar datos existentes para forzar recarga
  cache.delete('electricity_prices');
  globalPrices = [];
  currentPricesData = null;
  
  // Recargar datos
  loadElectricityPrices().then(() => {
    console.log('âœ… ComparaciÃ³n actualizada');
    button.innerHTML = originalText;
    button.disabled = false;
  }).catch((error) => {
    console.error('âŒ Error actualizando comparaciÃ³n:', error);
    button.innerHTML = 'âŒ Error - Reintentar';
    button.disabled = false;
    
    // Mostrar error mÃ¡s especÃ­fico en consola
    console.error('ğŸ“ Detalles del error:', {
      message: error.message,
      stack: error.stack,
      globalPricesLength: globalPrices ? globalPrices.length : 'undefined',
      canvasExists: !!canvasElement,
      alertExists: !!alertElement
    });
  });
}

// ===== NUEVA COMPARACIÃ“N USUARIO VS PVPC =====

function updateUserTariffSelector() {
  const companySelector = document.getElementById('user-company-selector');
  const tariffSelector = document.getElementById('user-tariff-selector');
  
  if (!companySelector || !tariffSelector) return;
  
  const selectedCompany = companySelector.value;
  
  if (!selectedCompany) {
    tariffSelector.style.display = 'none';
    tariffSelector.innerHTML = '<option value="">-- Selecciona tu tarifa --</option>';
    updateUserComparison();
    return;
  }
  
  tariffSelector.style.display = 'block';
  tariffSelector.innerHTML = '<option value="">-- Selecciona tu tarifa --</option>';
  
  if (selectedCompany === 'pvpc') {
    tariffSelector.innerHTML += `
      <option value="2.0TD">2.0TD (DiscriminaciÃ³n horaria)</option>
      <option value="2.0A">2.0A (Sin discriminaciÃ³n)</option>
    `;
  } else if (SPANISH_ENERGY_COMPANIES && SPANISH_ENERGY_COMPANIES[selectedCompany]) {
    const company = SPANISH_ENERGY_COMPANIES[selectedCompany];
    Object.keys(company.tarifas).forEach(tariffName => {
      tariffSelector.innerHTML += `<option value="${tariffName}">${tariffName}</option>`;
    });
  }
  
  updateUserComparison();
}

function updateUserComparison() {
  const companySelector = document.getElementById('user-company-selector');
  const tariffSelector = document.getElementById('user-tariff-selector');
  const consumptionInput = document.getElementById('daily-consumption');
  const patternSelector = document.getElementById('consumption-pattern');
  const resultContainer = document.getElementById('user-comparison-result');
  
  if (!companySelector || !tariffSelector || !consumptionInput || !patternSelector || !resultContainer) {
    console.error('âŒ No se encontraron todos los elementos necesarios');
    return;
  }
  
  const selectedCompany = companySelector.value;
  const selectedTariff = tariffSelector.value;
  const dailyConsumption = parseFloat(consumptionInput.value) || 10;
  const pattern = patternSelector.value || 'residential';
  
  if (!selectedCompany || !selectedTariff) {
    resultContainer.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #7f8c8d;">
        <span style="font-size: 3rem;">â¬†ï¸</span>
        <p>Selecciona tu tarifa actual para ver la comparaciÃ³n</p>
      </div>
    `;
    return;
  }
  
  // Obtener precios PVPC
  let pvpcPrices = null;
  if (globalPrices && globalPrices.pvpc && globalPrices.pvpc.length > 0) {
    pvpcPrices = globalPrices.pvpc;
  } else if (Array.isArray(globalPrices) && globalPrices.length > 0) {
    pvpcPrices = globalPrices;
  } else {
    // Generar datos de respaldo
    pvpcPrices = [];
    for (let hour = 0; hour < 24; hour++) {
      let price = 0.12;
      if (hour >= 0 && hour < 8) price *= 0.8;
      else if ((hour >= 10 && hour < 14) || (hour >= 18 && hour < 22)) price *= 1.4;
      pvpcPrices.push(price);
    }
  }
  
  // Generar distribuciÃ³n horaria del consumo
  const hourlyConsumption = generateHourlyConsumption(dailyConsumption, pattern);
  
  // Calcular costo PVPC
  const pvpcDailyCost = calculateDailyCost(hourlyConsumption, pvpcPrices);
  
  // Calcular costo de la tarifa del usuario
  let userTariffCost = 0;
  let userTariffName = '';
  let companyName = '';
  
  if (selectedCompany === 'pvpc') {
    userTariffCost = pvpcDailyCost; // Es la misma tarifa
    userTariffName = selectedTariff;
    companyName = 'PVPC';
  } else {
    const company = SPANISH_ENERGY_COMPANIES[selectedCompany];
    if (company && company.tarifas[selectedTariff]) {
      const tariff = company.tarifas[selectedTariff];
      const userHourlyPrices = calculateTariffHourlyPrices(tariff, pvpcPrices);
      userTariffCost = calculateDailyCost(hourlyConsumption, userHourlyPrices);
      userTariffName = selectedTariff;
      companyName = company.name;
    }
  }
  
  // Calcular diferencia
  const difference = userTariffCost - pvpcDailyCost;
  const percentageDiff = pvpcDailyCost > 0 ? (difference / pvpcDailyCost) * 100 : 0;
  
  // ValidaciÃ³n de valores calculados
  if (isNaN(userTariffCost) || isNaN(pvpcDailyCost) || isNaN(difference)) {
    console.error('âŒ Error en cÃ¡lculos:', { userTariffCost, pvpcDailyCost, difference });
    resultContainer.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c; background: #ffeaa7; border-radius: 12px;">
        <span style="font-size: 3rem;">âš ï¸</span>
        <p><strong>Error en el cÃ¡lculo</strong></p>
        <p>Por favor, actualiza los datos o selecciona otra tarifa</p>
      </div>
    `;
    return;
  }
  
  // Generar resultado visual
  let resultIcon = '';
  let resultColor = '';
  let resultText = '';
  
  if (Math.abs(difference) < 0.01) {
    resultIcon = 'ğŸŸ°';
    resultColor = '#95a5a6';
    resultText = 'IDÃ‰NTICO AL PVPC';
  } else if (difference > 0) {
    resultIcon = 'ğŸ“ˆ';
    resultColor = '#e74c3c';
    resultText = `PAGAS ${Math.abs(difference).toFixed(2)}â‚¬ MÃS vs PVPC HOY`;
  } else {
    resultIcon = 'ğŸ“‰';
    resultColor = '#27ae60';
    resultText = `AHORRAS ${Math.abs(difference).toFixed(2)}â‚¬ vs PVPC HOY`;
  }
  
  resultContainer.innerHTML = `
    <div style="background: linear-gradient(135deg, ${resultColor}, ${adjustColor(resultColor, -20)}); color: white; padding: 30px; border-radius: 12px; text-align: center;">
      <div style="font-size: 4rem; margin-bottom: 15px;">${resultIcon}</div>
      <h3 style="margin: 0 0 20px 0; font-size: 1.8rem;">${resultText}</h3>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 20px;">
        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">Tu Tarifa HOY</div>
          <div style="font-size: 1.6rem; font-weight: bold;">${userTariffCost.toFixed(2)} â‚¬</div>
          <div style="font-size: 0.8rem; opacity: 0.8;">${companyName} - ${userTariffName}</div>
        </div>
        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">PVPC HOY</div>
          <div style="font-size: 1.6rem; font-weight: bold;">${pvpcDailyCost.toFixed(2)} â‚¬</div>
          <div style="font-size: 0.8rem; opacity: 0.8;">Tarifa regulada</div>
        </div>
        <div style="background: rgba(255,255,255,0.3); padding: 15px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">Diferencia</div>
          <div style="font-size: 1.6rem; font-weight: bold;">${difference > 0 ? '+' : ''}${difference.toFixed(2)} â‚¬</div>
          <div style="font-size: 0.8rem; opacity: 0.8;">${percentageDiff > 0 ? '+' : ''}${percentageDiff.toFixed(1)}%</div>
        </div>
      </div>
      
      <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; font-size: 0.9rem;">
        ğŸ’¡ <strong>Con ${dailyConsumption} kWh hoy:</strong> 
        ${Math.abs(difference) < 0.01 
          ? 'Tu tarifa tiene el mismo costo que PVPC' 
          : difference > 0 
            ? `Pagas ${difference.toFixed(2)} â‚¬ mÃ¡s que con PVPC (${(difference * 365).toFixed(0)} â‚¬/aÃ±o)` 
            : `Ahorras ${Math.abs(difference).toFixed(2)} â‚¬ vs PVPC (${(Math.abs(difference) * 365).toFixed(0)} â‚¬/aÃ±o)`}
      </div>
    </div>
    
    <!-- GrÃ¡fico de comparaciÃ³n por horas -->
    <div style="background: white; padding: 20px; border-radius: 12px; margin-top: 20px;">
      <h4 style="margin: 0 0 15px 0; color: #2c3e50;">ğŸ“Š ComparaciÃ³n por Horas del DÃ­a</h4>
      <canvas id="user-comparison-chart" width="400" height="200"></canvas>
    </div>
  `;
  
  // Generar grÃ¡fico
  setTimeout(() => generateUserComparisonChart(pvpcPrices, hourlyConsumption, selectedCompany, selectedTariff), 100);
}

function generateUserComparisonChart(pvpcPrices, hourlyConsumption, companyKey, tariffName) {
  const canvas = document.getElementById('user-comparison-chart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  // Preparar datos
  const hours = Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`);
  
  // FunciÃ³n helper para detectar si es una comercializadora que aplica PVPC
  function isCORCompany(companyKey) {
    return companyKey === 'pvpc' || companyKey.endsWith('-cor');
  }
  
  let userHourlyPrices = pvpcPrices; // Por defecto PVPC puro
  
  // Si es una COR o compaÃ±Ã­a del mercado libre, aplicar sus mÃ¡rgenes
  if (SPANISH_ENERGY_COMPANIES[companyKey] && companyKey !== 'pvpc') {
    const company = SPANISH_ENERGY_COMPANIES[companyKey];
    if (company.tarifas[tariffName]) {
      userHourlyPrices = calculateTariffHourlyPrices(company.tarifas[tariffName], pvpcPrices);
    }
  }
  
  // Calcular costos por hora
  const pvpcHourlyCosts = pvpcPrices.map((price, hour) => price * hourlyConsumption[hour]);
  const userHourlyCosts = userHourlyPrices.map((price, hour) => price * hourlyConsumption[hour]);
  
  // Configurar grÃ¡fico
  if (window.userComparisonChart) {
    window.userComparisonChart.destroy();
  }
  
  window.userComparisonChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: hours,
      datasets: [
        {
          label: 'PVPC',
          data: pvpcHourlyCosts,
          borderColor: '#3498db',
          backgroundColor: 'rgba(52, 152, 219, 0.1)',
          borderWidth: 2,
          fill: true
        },
        {
          label: `Tu Tarifa (${tariffName})`,
          data: userHourlyCosts,
          borderColor: '#e74c3c',
          backgroundColor: 'rgba(231, 76, 60, 0.1)',
          borderWidth: 2,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Costo por Hora (â‚¬)'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Hora del DÃ­a'
          }
        }
      },
      plugins: {
        legend: {
          display: true,
          position: 'top'
        }
      }
    }
  });
}

function adjustColor(color, percent) {
  const num = parseInt(color.replace("#",""), 16);
  const amt = Math.round(2.55 * percent);
  const R = (num >> 16) + amt;
  const G = (num >> 8 & 0x00FF) + amt;
  const B = (num & 0x0000FF) + amt;
  return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 + (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255)).toString(16).slice(1);
}

// ===== ANÃLISIS PERSONALIZADO DEL USUARIO =====

// Variable global para almacenar datos actuales
let currentPricesData = null;

// FunciÃ³n para inicializar datos por defecto si no hay datos reales
function initializeDefaultPricesData() {
  if (!currentPricesData) {
    console.log('ğŸ”§ Inicializando datos por defecto...');
    
    // Si tenemos datos globales, usarlos
    if (globalPrices && globalPrices.length > 0) {
      const dailyAverage = globalPrices.reduce((a, b) => a + b, 0) / globalPrices.length;
      currentPricesData = {
        pvpcPrice: globalPrices[new Date().getHours()] || 0.12,
        pvpcDailyAverage: dailyAverage || 0.12,
        hourlyPrices: globalPrices,
        isOfficialData: false
      };
      console.log('âœ… Usando datos de globalPrices para anÃ¡lisis');
    } else {
      // Generar datos realistas por defecto si no hay nada
      const hourlyPrices = generateRealisticPriceData();
      const dailyAverage = hourlyPrices.reduce((a, b) => a + b, 0) / hourlyPrices.length;
      
      currentPricesData = {
        pvpcPrice: hourlyPrices[new Date().getHours()] || 0.12,
        pvpcDailyAverage: dailyAverage,
        hourlyPrices: hourlyPrices,
        isOfficialData: false
      };
      
      // TambiÃ©n actualizar globalPrices para coherencia
      globalPrices = hourlyPrices;
      
      console.log('âœ… Datos realistas generados para anÃ¡lisis');
    }
    
    console.log('ï¿½ Datos por defecto:', {
      pvpcPrice: currentPricesData.pvpcPrice,
      dailyAverage: currentPricesData.pvpcDailyAverage,
      hourlyPricesCount: currentPricesData.hourlyPrices.length
    });
  }
}

// FunciÃ³n auxiliar para generar datos de precio realistas
function generateRealisticPriceData() {
  const basePrice = 0.12; // â‚¬/kWh base
  const hourlyPrices = [];
  
  for (let hour = 0; hour < 24; hour++) {
    let multiplier = 1.0;
    
    // Horas valle (mÃ¡s barato)
    if (hour >= 0 && hour < 8) {
      multiplier = 0.7 + Math.random() * 0.2; // 0.7-0.9
    }
    // Horas punta (mÃ¡s caro)
    else if ((hour >= 10 && hour < 14) || (hour >= 18 && hour < 22)) {
      multiplier = 1.3 + Math.random() * 0.4; // 1.3-1.7
    }
    // Horas llano
    else {
      multiplier = 0.9 + Math.random() * 0.3; // 0.9-1.2
    }
    
    hourlyPrices.push(basePrice * multiplier);
  }
  
  return hourlyPrices;
}

function updateUserCompanyComparison() {
  const companySelector = document.getElementById('user-company-selector');
  const tariffSelector = document.getElementById('user-tariff-selector');
  const analysisContainer = document.getElementById('user-analysis');
  
  if (!companySelector || !tariffSelector || !analysisContainer) {
    console.error('âŒ Error: No se encontraron los elementos del selector');
    return;
  }
  
  const selectedCompany = companySelector.value;
  console.log('ğŸ” CompaÃ±Ã­a seleccionada:', selectedCompany);
  
  if (!selectedCompany) {
    tariffSelector.style.display = 'none';
    analysisContainer.style.display = 'none';
    tariffSelector.innerHTML = '<option value="">-- Selecciona tu tarifa --</option>';
    return;
  }
  
  // Actualizar selector de tarifas
  updateTariffSelector(selectedCompany);
}

function handleTariffSelection() {
  const companySelector = document.getElementById('user-company-selector');
  const tariffSelector = document.getElementById('user-tariff-selector');
  
  if (!companySelector || !tariffSelector) {
    console.error('âŒ Error: No se encontraron los selectores');
    return;
  }
  
  const selectedCompany = companySelector.value;
  const selectedTariff = tariffSelector.value;
  
  console.log('ğŸ¯ Tarifa seleccionada:', selectedCompany, selectedTariff);
  
  if (selectedCompany && selectedTariff) {
    // Intentar inicializar datos por defecto si no hay datos reales
    if (!currentPricesData) {
      initializeDefaultPricesData();
    }
    
    if (currentPricesData) {
      console.log('âœ… Generando anÃ¡lisis...');
      generateUserAnalysis(selectedCompany, selectedTariff);
    } else {
      console.log('âš ï¸ No hay datos de precios disponibles');
      const analysisContainer = document.getElementById('user-analysis');
      if (analysisContainer) {
        analysisContainer.innerHTML = `
          <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; text-align: center;">
            <p><strong>âŒ Sin datos de precios</strong></p>
            <p>Por favor, presiona <strong>"OBTENER PRECIOS REALES"</strong> primero para cargar los datos PVPC.</p>
            <button onclick="refreshPriceData()" style="
              background: #27ae60; 
              color: white; 
              border: none; 
              padding: 10px 20px; 
              border-radius: 6px; 
              cursor: pointer; 
              margin-top: 10px;
              font-weight: bold;
            ">
              ğŸ”„ Cargar Datos Ahora
            </button>
          </div>
        `;
        analysisContainer.style.display = 'block';
      }
    }
  } else {
    console.log('âš ï¸ Faltan selecciones:', {
      company: !!selectedCompany,
      tariff: !!selectedTariff
    });
  }
}

function updateTariffSelector(companyKey) {
  const tariffSelector = document.getElementById('user-tariff-selector');
  
  if (!tariffSelector) {
    console.error('âŒ Error: No se encontrÃ³ el selector de tarifas');
    return;
  }
  
  console.log('ğŸ”§ Actualizando selector para:', companyKey);
  
  // Limpiar opciones y mostrar loading
  tariffSelector.innerHTML = '<option value="">â³ Cargando tarifas...</option>';
  tariffSelector.style.display = 'block';
  
  // PequeÃ±o delay para efecto visual
  setTimeout(() => {
    tariffSelector.innerHTML = '<option value="">-- Selecciona tu tarifa --</option>';
    
    // FunciÃ³n helper para detectar si es una comercializadora que aplica PVPC
    function isCORCompany(companyKey) {
      return companyKey === 'pvpc' || companyKey.endsWith('-cor');
    }
    
    if (isCORCompany(companyKey)) {
      tariffSelector.innerHTML += `
        <option value="2.0TD">2.0TD (DiscriminaciÃ³n horaria)</option>
        <option value="2.0A">2.0A (Sin discriminaciÃ³n)</option>
      `;
      console.log('âœ… Tarifas PVPC/COR aÃ±adidas para:', companyKey);
    } else if (SPANISH_ENERGY_COMPANIES && SPANISH_ENERGY_COMPANIES[companyKey]) {
      const company = SPANISH_ENERGY_COMPANIES[companyKey];
      console.log('ğŸ¢ CompaÃ±Ã­a encontrada:', company.name);
      
      const tariffs = Object.keys(company.tarifas);
      if (tariffs.length === 0) {
        tariffSelector.innerHTML += '<option value="">No hay tarifas disponibles</option>';
      } else {
        tariffs.forEach(tariffName => {
          tariffSelector.innerHTML += `<option value="${tariffName}">${tariffName}</option>`;
        });
        console.log('âœ… Tarifas de', company.name, 'aÃ±adidas:', tariffs);
      }
    } else {
      console.error('âŒ Error: CompaÃ±Ã­a no encontrada en SPANISH_ENERGY_COMPANIES:', companyKey);
      tariffSelector.innerHTML += '<option value="">âŒ Error: CompaÃ±Ã­a no encontrada</option>';
    }
    
    console.log('ğŸ‘ï¸ Selector de tarifas actualizado y mostrado');
  }, 200);
}

function generateUserAnalysis(companyKey, tariffName) {
  console.log('ğŸ“Š Generando anÃ¡lisis para:', companyKey, tariffName);
  
  let usingFallbackData = false;
  if (!currentPricesData) {
    console.log('âš ï¸ No hay datos reales, usando datos por defecto para anÃ¡lisis');
    initializeDefaultPricesData();
    usingFallbackData = true;
    
    if (!currentPricesData) {
      console.log('âŒ Error: No se pudieron inicializar datos por defecto');
      const analysisContainer = document.getElementById('user-analysis');
      if (analysisContainer) {
        analysisContainer.innerHTML = `
          <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; text-align: center;">
            <p><strong>âŒ Error en anÃ¡lisis</strong></p>
            <p>No se pudieron cargar los datos necesarios. Presiona "OBTENER PRECIOS REALES" para intentar de nuevo.</p>
            <button onclick="refreshPriceData()" style="
              background: #27ae60; 
              color: white; 
              border: none; 
              padding: 10px 20px; 
              border-radius: 6px; 
              cursor: pointer; 
              margin-top: 10px;
              font-weight: bold;
            ">
              ğŸ”„ Cargar Datos Reales
            </button>
          </div>
        `;
        analysisContainer.style.display = 'block';
      }
      return;
    }
  }
  
  const analysisContainer = document.getElementById('user-analysis');
  const currentHour = new Date().getHours();
  const pvpcPrice = currentPricesData.pvpcPrice;
  const pvpcDailyAverage = currentPricesData.pvpcDailyAverage;
  
  let userCurrentPrice = 0;
  let userDailyAverage = 0;
  let companyName = '';
  let tariffInfo = null;
  let recommendations = [];
  
  if (companyKey === 'pvpc') {
    console.log('ğŸ›ï¸ Analizando tarifa PVPC:', tariffName);
    
    if (tariffName === '2.0TD') {
      // PVPC con discriminaciÃ³n horaria
      const period = getCurrentPVPCPeriod(currentHour);
      userCurrentPrice = pvpcPrice; // El precio PVPC ya incluye la discriminaciÃ³n
      userDailyAverage = pvpcDailyAverage;
      companyName = 'PVPC 2.0TD (Regulada)';
      
      recommendations.push({
        icon: 'ğŸ›ï¸',
        title: 'Tarifa regulada con discriminaciÃ³n horaria',
        text: `EstÃ¡s en perÃ­odo ${period.name} (${period.hours}). Precio oficial del Estado.`
      });
      
      recommendations.push({
        icon: 'â°',
        title: 'Optimiza tus horarios',
        text: 'Usa electrodomÃ©sticos de 00:00-08:00 (valle) para mÃ¡ximo ahorro.'
      });
      
      recommendations.push({
        icon: 'ğŸ’¡',
        title: 'Evita horas punta',
        text: 'Reduce consumo de 10:00-14:00 y 18:00-22:00 (perÃ­odo mÃ¡s caro).'
      });
      
    } else if (tariffName === '2.0A') {
      // PVPC sin discriminaciÃ³n horaria
      userCurrentPrice = pvpcPrice;
      userDailyAverage = pvpcDailyAverage;
      companyName = 'PVPC 2.0A (Regulada)';
      
      recommendations.push({
        icon: 'ğŸ›ï¸',
        title: 'Tarifa regulada sin discriminaciÃ³n',
        text: 'Precio Ãºnico durante todo el dÃ­a. Oficial del Estado.'
      });
      
      recommendations.push({
        icon: 'ğŸ’­',
        title: 'Considera 2.0TD',
        text: 'PodrÃ­as ahorrar con discriminaciÃ³n horaria si puedes cambiar horarios de consumo.'
      });
    }
    
  } else {
    console.log('ğŸ¢ Analizando compaÃ±Ã­a comercial:', companyKey);
    
    const company = SPANISH_ENERGY_COMPANIES[companyKey];
    if (!company) {
      console.error('âŒ CompaÃ±Ã­a no encontrada:', companyKey);
      return;
    }
    
    companyName = company.name;
    tariffInfo = company.tarifas[tariffName];
    
    if (!tariffInfo) {
      console.error('âŒ Tarifa no encontrada:', tariffName);
      return;
    }
    
    // Calcular precio actual de la tarifa del usuario
    const calculation = calculateTariffPrice(tariffInfo, pvpcPrice, pvpcDailyAverage);
    userCurrentPrice = calculation.currentPrice;
    userDailyAverage = calculation.dailyAverage;
    
    // Generar recomendaciones especÃ­ficas
    recommendations = generateUserRecommendations(tariffInfo, pvpcPrice, pvpcDailyAverage, calculation);
  }
  
  // Calcular ahorros/costes vs PVPC
  const currentSavings = ((pvpcPrice - userCurrentPrice) / pvpcPrice) * 100;
  const dailySavings = ((pvpcDailyAverage - userDailyAverage) / pvpcDailyAverage) * 100;
  
  // Calcular ahorro mensual estimado (30 kWh promedio)
  const monthlyUsage = 30; // kWh
  const monthlyCostUser = userDailyAverage * monthlyUsage;
  const monthlyCostPVPC = pvpcDailyAverage * monthlyUsage;
  const monthlyDifference = monthlyCostPVPC - monthlyCostUser;
  
  console.log('ğŸ’° AnÃ¡lisis completado:', {
    userCurrentPrice,
    pvpcPrice,
    currentSavings,
    monthlyDifference
  });
  
  // Renderizar anÃ¡lisis
  analysisContainer.innerHTML = `
    <div style="background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; padding: 20px; border-radius: 12px;">
      <h4 style="margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 1.5rem;">ğŸ”</span>
        <span>Tu AnÃ¡lisis Personal - ${companyName}</span>
      </h4>
      
      ${usingFallbackData ? `
        <div style="background: rgba(255, 193, 7, 0.2); border: 2px solid rgba(255, 193, 7, 0.6); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 1.2rem;">âš ï¸</span>
            <div>
              <strong>AnÃ¡lisis con datos de ejemplo</strong><br>
              <span style="font-size: 0.9rem; opacity: 0.9;">Presiona "OBTENER PRECIOS REALES" para un anÃ¡lisis preciso con datos actuales de REE.</span>
            </div>
          </div>
        </div>
      ` : ''}
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">Tu precio ahora</div>
          <div style="font-size: 1.4rem; font-weight: bold;">${formatPrice(userCurrentPrice)} â‚¬/kWh</div>
          <div style="font-size: 0.85rem; margin-top: 5px;">
            ${currentSavings > 0 ? 'ğŸ’š' : 'âŒ'} ${currentSavings > 0 ? '+' : ''}${currentSavings.toFixed(1)}% vs PVPC
          </div>
        </div>
        
        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">PVPC ahora</div>
          <div style="font-size: 1.4rem; font-weight: bold;">${formatPrice(pvpcPrice)} â‚¬/kWh</div>
          <div style="font-size: 0.85rem; margin-top: 5px; opacity: 0.8;">Precio oficial</div>
        </div>
        
        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">Ahorro/Coste mensual</div>
          <div style="font-size: 1.4rem; font-weight: bold; color: ${monthlyDifference > 0 ? '#00ff88' : '#ff6b6b'};">
            ${monthlyDifference > 0 ? '+' : ''}${monthlyDifference.toFixed(2)}â‚¬
          </div>
          <div style="font-size: 0.85rem; margin-top: 5px;">vs PVPC (${monthlyUsage} kWh)</div>
        </div>
      </div>
      
      <div style="display: grid; gap: 15px;">
        ${recommendations.map(rec => `
          <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; border-left: 4px solid #fff;">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
              <span style="font-size: 1.5rem;">${rec.icon}</span>
              <div>
                <div style="font-weight: bold; margin-bottom: 5px;">${rec.title}</div>
                <div style="opacity: 0.95; line-height: 1.4;">${rec.text}</div>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
      
      <!-- GrÃ¡fico comparativo de horarios -->
      <div style="margin-top: 20px; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
        <h5 style="margin: 0 0 15px 0;">ğŸ“Š ComparaciÃ³n por horas hoy</h5>
        <div id="hourly-comparison-chart" style="height: 200px;">
          <canvas id="hourly-comparison-canvas"></canvas>
        </div>
      </div>
    </div>
  `;
  
  analysisContainer.style.display = 'block';
  
  // Generar grÃ¡fico comparativo por horas (con pequeÃ±o delay para asegurar DOM)
  setTimeout(() => {
    generateHourlyComparisonChart(companyKey, tariffName);
  }, 100);
}

function calculateTariffPrice(tariff, pvpcPrice, pvpcDailyAverage) {
  const currentHour = new Date().getHours();
  const isWeekend = [0, 6].includes(new Date().getDay());
  
  let currentPrice = 0;
  let dailyAverage = 0;
  
  if (tariff.tipo === "Tarifa fija" && tariff.precio_fijo) {
    currentPrice = tariff.precio_fijo;
    dailyAverage = tariff.precio_fijo;
    
  } else if (tariff.tipo === "Tarifa plana fin de semana" && tariff.precio_laborable && tariff.precio_festivo !== undefined) {
    currentPrice = isWeekend ? tariff.precio_festivo : tariff.precio_laborable;
    dailyAverage = (tariff.precio_laborable * 5 + tariff.precio_festivo * 2) / 7;
    
  } else if (tariff.periodos) {
    let factor = 1.0;
    if (currentHour >= 10 && currentHour < 14 || currentHour >= 18 && currentHour < 22) {
      factor = tariff.periodos.punta?.factor || 1.25;
    } else if (currentHour >= 0 && currentHour < 8) {
      factor = tariff.periodos.valle?.factor || 0.75;
    } else {
      factor = tariff.periodos.llano?.factor || 1.0;
    }
    
    currentPrice = pvpcPrice * factor;
    
    const puntaHours = 8;
    const valleHours = 8;
    const llanoHours = 8;
    
    dailyAverage = (pvpcDailyAverage * tariff.periodos.punta.factor * puntaHours + 
                   pvpcDailyAverage * tariff.periodos.valle.factor * valleHours + 
                   pvpcDailyAverage * tariff.periodos.llano.factor * llanoHours) / 24;
    
  } else if (tariff.margen_fijo) {
    currentPrice = pvpcPrice + tariff.margen_fijo;
    dailyAverage = pvpcDailyAverage + tariff.margen_fijo;
    
  } else {
    currentPrice = pvpcPrice;
    dailyAverage = pvpcDailyAverage;
  }
  
  return { currentPrice, dailyAverage };
}

function generateUserRecommendations(tariff, pvpcPrice, pvpcDailyAverage, calculation) {
  const recommendations = [];
  const currentHour = new Date().getHours();
  
  // ComparaciÃ³n con PVPC
  const savings = ((pvpcPrice - calculation.currentPrice) / pvpcPrice) * 100;
  
  if (savings > 10) {
    recommendations.push({
      icon: 'ğŸ’š',
      title: 'Excelente elecciÃ³n',
      text: `Tu tarifa te ahorra un ${savings.toFixed(1)}% comparado con PVPC en este momento.`
    });
  } else if (savings > 0) {
    recommendations.push({
      icon: 'ğŸ‘',
      title: 'Buena tarifa',
      text: `Ahorras un ${savings.toFixed(1)}% vs PVPC ahora, pero podrÃ­as optimizar mÃ¡s.`
    });
  } else {
    recommendations.push({
      icon: 'âš ï¸',
      title: 'Pagando mÃ¡s que PVPC',
      text: `EstÃ¡s pagando un ${Math.abs(savings).toFixed(1)}% mÃ¡s que la tarifa regulada en este momento.`
    });
  }
  
  // Recomendaciones especÃ­ficas por tipo de tarifa
  if (tariff.periodos) {
    const bestPeriod = getBestPeriodForTariff(tariff, currentHour);
    recommendations.push({
      icon: 'â°',
      title: 'Optimiza tus horarios',
      text: `Con discriminaciÃ³n horaria, ${bestPeriod.advice}`
    });
  }
  
  if (tariff.tipo === "Tarifa fija") {
    recommendations.push({
      icon: 'ğŸ“Š',
      title: 'Precio fijo',
      text: 'No necesitas preocuparte por horarios, pero vigila si el mercado baja mucho.'
    });
  }
  
  // RecomendaciÃ³n de cambio si es conveniente
  if (savings < -15) {
    recommendations.push({
      icon: 'ğŸ”„',
      title: 'Considera cambiar a PVPC',
      text: 'El precio regulado te podrÃ­a ahorrar significativamente este mes.'
    });
  }
  
  return recommendations;
}

function getBestPeriodForTariff(tariff, currentHour) {
  const periods = tariff.periodos;
  const factors = [
    { name: 'valle', factor: periods.valle.factor, hours: periods.valle.horas },
    { name: 'llano', factor: periods.llano.factor, hours: periods.llano.horas },
    { name: 'punta', factor: periods.punta.factor, hours: periods.punta.horas }
  ];
  
  const bestPeriod = factors.sort((a, b) => a.factor - b.factor)[0];
  
  return {
    name: bestPeriod.name,
    factor: bestPeriod.factor,
    advice: `aprovecha el perÃ­odo ${bestPeriod.name} (${bestPeriod.hours}) para mayor ahorro.`
  };
}

function getCurrentPVPCPeriod(hour) {
  if (hour >= 10 && hour < 14 || hour >= 18 && hour < 22) {
    return {
      name: 'Punta (P1)',
      hours: '10:00-14:00 y 18:00-22:00',
      description: 'PerÃ­odo mÃ¡s caro'
    };
  } else if (hour >= 0 && hour < 8) {
    return {
      name: 'Valle (P3)', 
      hours: '00:00-08:00',
      description: 'PerÃ­odo mÃ¡s barato'
    };
  } else {
    return {
      name: 'Llano (P2)',
      hours: '08:00-10:00, 14:00-18:00, 22:00-24:00', 
      description: 'PerÃ­odo intermedio'
    };
  }
}

function findBestHours(hourlyPrices) {
  if (!hourlyPrices || hourlyPrices.length === 0) {
    return ['02:00-06:00']; // Default
  }
  
  const sorted = hourlyPrices.map((price, hour) => ({ hour, price }))
                            .sort((a, b) => a.price - b.price);
  
  return sorted.slice(0, 3).map(item => `${item.hour.toString().padStart(2, '0')}:00`);
}

function generateHourlyComparisonChart(companyKey, tariffName) {
  console.log('ğŸ“Š Generando grÃ¡fico comparativo para:', companyKey, tariffName);
  
  const canvas = document.getElementById('hourly-comparison-canvas');
  if (!canvas) {
    console.error('âŒ Canvas no encontrado para grÃ¡fico comparativo');
    return;
  }
  
  if (!currentPricesData) {
    console.log('âš ï¸ No hay datos de precios, inicializando datos por defecto...');
    initializeDefaultPricesData();
  }
  
  if (!currentPricesData) {
    console.log('âŒ Error: No se pudieron obtener datos para el grÃ¡fico');
    
    // Mostrar mensaje de error
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth;
    canvas.height = 200;
    
    ctx.fillStyle = 'rgba(255,255,255,0.9)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#e74c3c';
    ctx.font = 'bold 16px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('âŒ Error al cargar datos para grÃ¡fico', canvas.width / 2, canvas.height / 2 - 15);
    ctx.font = '14px Arial';
    ctx.fillStyle = '#7f8c8d';
    ctx.fillText('Presiona "OBTENER PRECIOS REALES" para cargar datos', canvas.width / 2, canvas.height / 2 + 15);
    return;
  }
  
  // Preparar datos para el grÃ¡fico
  const hours = Array.from({ length: 24 }, (_, i) => `${i.toString().padStart(2, '0')}:00`);
  const pvpcPrices = [];
  const userPrices = [];
  
  // Usar los precios por hora si estÃ¡n disponibles, sino usar el precio base para todas las horas
  const baseHourlyPrices = currentPricesData.hourlyPrices && currentPricesData.hourlyPrices.length === 24 
    ? currentPricesData.hourlyPrices 
    : Array.from({ length: 24 }, () => currentPricesData.pvpcPrice);
  
  for (let hour = 0; hour < 24; hour++) {
    const pvpcPrice = baseHourlyPrices[hour] || currentPricesData.pvpcPrice;
    pvpcPrices.push(pvpcPrice);
    
    // Calcular precio del usuario para esta hora
    let userPrice = pvpcPrice;
    
    if (companyKey === 'pvpc') {
      userPrice = pvpcPrice; // PVPC es igual
    } else {
      const company = SPANISH_ENERGY_COMPANIES[companyKey];
      if (company && company.tarifas[tariffName]) {
        const tariff = company.tarifas[tariffName];
        const calculation = calculateTariffPriceForHour(tariff, pvpcPrice, hour);
        userPrice = calculation.hourlyPrice;
      }
    }
    
    userPrices.push(userPrice);
  }
  
  // Destruir grÃ¡fico anterior si existe
  if (window.hourlyComparisonChart) {
    window.hourlyComparisonChart.destroy();
  }
  
  // FunciÃ³n helper para detectar si es una comercializadora que aplica PVPC
  function isCORCompany(companyKey) {
    return companyKey === 'pvpc' || companyKey.endsWith('-cor');
  }
  
  // Obtener informaciÃ³n de la compaÃ±Ã­a
  const companyName = isCORCompany(companyKey) ? 
    (SPANISH_ENERGY_COMPANIES[companyKey]?.name || 'PVPC') : 
    (SPANISH_ENERGY_COMPANIES[companyKey]?.name || companyKey);
  const companyColor = isCORCompany(companyKey) ? '#3498db' : '#e74c3c';
  
  // Crear nuevo grÃ¡fico
  const ctx = canvas.getContext('2d');
  window.hourlyComparisonChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: hours,
      datasets: [
        {
          label: 'ğŸ›ï¸ PVPC (Oficial REE)',
          data: pvpcPrices,
          borderColor: '#3498db',
          backgroundColor: 'rgba(52, 152, 219, 0.1)',
          borderWidth: 3,
          fill: false,
          tension: 0.2,
          pointBackgroundColor: '#3498db',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2,
          pointRadius: 4
        },
        {
          label: `${companyName} - ${tariffName}`,
          data: userPrices,
          borderColor: companyColor,
          backgroundColor: companyColor.replace('rgb', 'rgba').replace(')', ', 0.1)'),
          borderWidth: 3,
          fill: false,
          tension: 0.2,
          pointBackgroundColor: companyColor,
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2,
          pointRadius: 4
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: `ComparaciÃ³n ${companyName} vs PVPC por horas`,
          font: { size: 14, weight: 'bold' },
          color: '#2c3e50'
        },
        legend: {
          display: true,
          position: 'top',
          labels: {
            font: { size: 12 },
            usePointStyle: true
          }
        },
        tooltip: {
          mode: 'index',
          intersect: false,
          backgroundColor: 'rgba(0,0,0,0.8)',
          titleColor: '#ffffff',
          bodyColor: '#ffffff',
          borderColor: '#3498db',
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              const price = context.parsed.y;
              const isPVPC = context.datasetIndex === 0;
              
              if (isPVPC) {
                return `${context.dataset.label}: ${formatPrice(price)} â‚¬/kWh`;
              } else {
                const pvpcPrice = pvpcPrices[context.dataIndex];
                const savings = ((pvpcPrice - price) / pvpcPrice * 100);
                const savingsText = savings > 5 ? ` (ğŸ’š ${savings.toFixed(1)}% ahorro)` : 
                                   savings < -5 ? ` (âŒ ${Math.abs(savings).toFixed(1)}% mÃ¡s caro)` : 
                                   ` (â‰ˆ similar al PVPC)`;
                return `${context.dataset.label}: ${formatPrice(price)} â‚¬/kWh${savingsText}`;
              }
            },
            title: function(context) {
              const hour = context[0].dataIndex;
              const currentHour = new Date().getHours();
              const isCurrentHour = hour === currentHour;
              return `${context[0].label}${isCurrentHour ? ' âš¡ AHORA' : ''}`;
            }
          }
        }
      },
      scales: {
        x: {
          title: { 
            display: true, 
            text: 'Hora del dÃ­a',
            font: { size: 12, weight: 'bold' }
          },
          grid: { 
            display: true, 
            color: 'rgba(0,0,0,0.1)',
            lineWidth: 1
          },
          ticks: {
            font: { size: 11 }
          }
        },
        y: {
          title: { 
            display: true, 
            text: 'Precio (â‚¬/kWh)',
            font: { size: 12, weight: 'bold' }
          },
          grid: { 
            display: true, 
            color: 'rgba(0,0,0,0.1)',
            lineWidth: 1
          },
          ticks: {
            font: { size: 11 },
            callback: function(value) {
              return formatPrice(value) + ' â‚¬';
            }
          }
        }
      },
      interaction: {
        mode: 'nearest',
        axis: 'x',
        intersect: false
      },
      elements: {
        point: {
          hoverRadius: 8
        }
      }
    }
  });
  
  console.log('âœ… GrÃ¡fico comparativo generado exitosamente');
}

// FunciÃ³n auxiliar para calcular precio por hora especÃ­fica
function calculateTariffPriceForHour(tariff, pvpcPrice, hour) {
  const isWeekend = [0, 6].includes(new Date().getDay());
  
  let hourlyPrice = 0;
  
  // ValidaciÃ³n de entrada
  if (!tariff || isNaN(pvpcPrice) || pvpcPrice < 0) {
    console.warn('âš ï¸ Datos invÃ¡lidos en calculateTariffPriceForHour:', { tariff, pvpcPrice, hour });
    return pvpcPrice || 0.12; // Precio de respaldo
  }
  
  if (tariff.tipo === "Tarifa fija" && tariff.precio_fijo) {
    hourlyPrice = parseFloat(tariff.precio_fijo) || 0.12;
    
  } else if (tariff.tipo === "Tarifa plana fin de semana" && tariff.precio_laborable && tariff.precio_festivo !== undefined) {
    hourlyPrice = isWeekend ? (parseFloat(tariff.precio_festivo) || 0.10) : (parseFloat(tariff.precio_laborable) || 0.12);
    
  } else if (tariff.periodos) {
    let factor = 1.0;
    if (hour >= 10 && hour < 14 || hour >= 18 && hour < 22) {
      factor = tariff.periodos.punta?.factor || 1.25;
    } else if (hour >= 0 && hour < 8) {
      factor = tariff.periodos.valle?.factor || 0.75;
    } else {
      factor = tariff.periodos.llano?.factor || 1.0;
    }
    
    hourlyPrice = pvpcPrice * factor;
    
  } else if (tariff.margen_fijo) {
    hourlyPrice = pvpcPrice + (parseFloat(tariff.margen_fijo) || 0.015);
    
  } else {
    hourlyPrice = pvpcPrice;
  }
  
  // Asegurar que el resultado es un nÃºmero vÃ¡lido
  if (isNaN(hourlyPrice) || hourlyPrice < 0) {
    console.warn('âš ï¸ Precio calculado invÃ¡lido, usando respaldo:', hourlyPrice);
    hourlyPrice = pvpcPrice || 0.12;
  }
  
  return hourlyPrice; // Devolver solo el nÃºmero, no un objeto
}

// ===== INFORMACIÃ“N DE COMPAÃ‘ÃAS ELÃ‰CTRICAS ESPAÃ‘OLAS (Orden alfabÃ©tico) =====
const SPANISH_ENERGY_COMPANIES = {
  pvpc: {
    name: "PVPC (Precio Voluntario para el PequeÃ±o Consumidor)",
    logo: "ğŸ›ï¸",
    description: "Tarifa regulada por el Estado espaÃ±ol. Es la referencia oficial del mercado elÃ©ctrico espaÃ±ol y se actualiza cada hora segÃºn la oferta y demanda.",
    tipo_compania: "Regulada por el Estado",
    regulacion: "Real Decreto 216/2014",
    tarifas: {
      "2.0TD - Con discriminaciÃ³n horaria": {
        tipo: "DiscriminaciÃ³n horaria (3 perÃ­odos)",
        descripcion: "Tarifa con 3 tramos horarios: Valle (mÃ¡s barato), Llano (precio medio) y Punta (mÃ¡s caro). Ideal para adaptar tu consumo.",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00 (dÃ­as laborables)", factor: 1.0, descripcion: "Horas mÃ¡s caras del dÃ­a" },
          llano: { horas: "08:00-10:00, 14:00-18:00, 22:00-24:00", factor: 1.0, descripcion: "Precio intermedio" },
          valle: { horas: "00:00-08:00 (todos los dÃ­as) + fines de semana completos", factor: 1.0, descripcion: "Horas mÃ¡s baratas" }
        },
        consejo: "Usa electrodomÃ©sticos de alto consumo durante las horas valle (madrugada y fines de semana) para ahorrar hasta un 50%",
        ventajas: ["Precio transparente y oficial", "Sin permanencia", "Ahorro programando consumo", "Acceso directo al mercado mayorista"],
        inconvenientes: ["Precio variable por horas", "Requiere planificaciÃ³n", "Facturas menos predecibles"]
      },
      "2.0A - Sin discriminaciÃ³n horaria": {
        tipo: "Precio Ãºnico las 24 horas",
        descripcion: "Mismo precio durante todo el dÃ­a. Simplicidad mÃ¡xima sin necesidad de planificar el consumo por horarios.",
        precio_base: "Precio medio del mercado mayorista",
        consejo: "Ideal si no puedes o no quieres adaptar tus hÃ¡bitos de consumo a diferentes horarios",
        ventajas: ["Simplicidad total", "Precio transparente", "Sin permanencia", "Facturas mÃ¡s predecibles"],
        inconvenientes: ["No aprovechas horas baratas", "Menor potencial de ahorro"]
      }
    },
    informacion_adicional: {
      como_contratar: "A travÃ©s de comercializadoras de referencia o directamente con distribuidoras",
      quien_puede: "Consumidores con potencia contratada â‰¤ 10 kW",
      actualizacion: "Precios actualizados cada hora segÃºn el mercado mayorista OMIE",
      regulacion_completa: "Establecida por la CNMC (ComisiÃ³n Nacional de los Mercados y la Competencia)"
    }
  },
  
  // === COMERCIALIZADORAS DE REFERENCIA (COR) - Aplican PVPC ===
  "iberdrola-cor": {
    name: "Iberdrola COR",
    logo: "ğŸ›ï¸",
    description: "Comercializadora de Referencia del grupo Iberdrola. Aplica estrictamente las tarifas PVPC reguladas por el Estado.",
    tipo_compania: "Comercializadora de Referencia (COR)",
    tarifas: {
      "2.0TD - Con discriminaciÃ³n horaria": {
        tipo: "PVPC con discriminaciÃ³n horaria + margen COR",
        descripcion: "Tarifa PVPC oficial con 3 perÃ­odos horarios + margen regulado",
        precio_base: "PVPC + margen regulado",
        margen_fijo: 0.003, // 0.3 cÃ©ntimos/kWh - margen tÃ­pico COR
        es_cor: true,
        consejo: "Tarifa regulada oficial con mÃ­nimo sobrecosto - aprovecha horas valle para ahorrar"
      },
      "2.0A - Sin discriminaciÃ³n horaria": {
        tipo: "PVPC sin discriminaciÃ³n + margen COR",
        descripcion: "Tarifa PVPC oficial con precio Ãºnico + margen regulado",
        precio_base: "PVPC + margen regulado",
        margen_fijo: 0.003, // 0.3 cÃ©ntimos/kWh - margen tÃ­pico COR
        es_cor: true,
        consejo: "Precio oficial fijo las 24h + margen mÃ­nimo regulado - mÃ¡xima tranquilidad"
      }
    }
  },
  
  "endesa-cor": {
    name: "Endesa EnergÃ­a XXI",
    logo: "ğŸ›ï¸", 
    description: "Comercializadora de Referencia del grupo Endesa. Aplica tarifas PVPC con los mÃ¡rgenes mÃ­nimos permitidos.",
    tipo_compania: "Comercializadora de Referencia (COR)",
    tarifas: {
      "2.0TD - Con discriminaciÃ³n horaria": {
        tipo: "PVPC con discriminaciÃ³n horaria + margen COR",
        descripcion: "Tarifa PVPC oficial con 3 perÃ­odos horarios + margen regulado",
        precio_base: "PVPC + margen regulado",
        margen_fijo: 0.004, // 0.4 cÃ©ntimos/kWh - margen tÃ­pico COR
        es_cor: true,
        consejo: "COR de Endesa con PVPC oficial - usa horas valle (00:00-08:00) para mayor ahorro"
      },
      "2.0A - Sin discriminaciÃ³n horaria": {
        tipo: "PVPC sin discriminaciÃ³n + margen COR", 
        descripcion: "Tarifa PVPC oficial con precio Ãºnico + margen regulado",
        precio_base: "PVPC + margen regulado",
        margen_fijo: 0.004, // 0.4 cÃ©ntimos/kWh - margen tÃ­pico COR
        es_cor: true,
        consejo: "Tarifa regulada sin horarios - consume cuando quieras con margen mÃ­nimo"
      }
    }
  },
  
  "naturgy-cor": {
    name: "Naturgy Iberia",
    logo: "ğŸ›ï¸",
    description: "Comercializadora de Referencia del grupo Naturgy. Ofrece las tarifas PVPC reguladas oficiales.",
    tipo_compania: "Comercializadora de Referencia (COR)", 
    tarifas: {
      "2.0TD - Con discriminaciÃ³n horaria": {
        tipo: "PVPC con discriminaciÃ³n horaria + margen COR",
        descripcion: "Tarifa PVPC oficial con 3 perÃ­odos horarios + margen regulado",
        precio_base: "PVPC + margen regulado",
        margen_fijo: 0.0035, // 0.35 cÃ©ntimos/kWh - margen tÃ­pico COR
        es_cor: true,
        consejo: "COR de Naturgy con precios oficiales - optimiza consumo en horario valle"
      },
      "2.0A - Sin discriminaciÃ³n horaria": {
        tipo: "PVPC sin discriminaciÃ³n + margen COR",
        descripcion: "Tarifa PVPC oficial con precio Ãºnico + margen regulado", 
        precio_base: "PVPC + margen regulado",
        margen_fijo: 0.0035, // 0.35 cÃ©ntimos/kWh - margen tÃ­pico COR
        es_cor: true,
        consejo: "Simplicidad total con precio regulado Ãºnico - sin horarios que recordar"
      }
    }
  },
  
  "edp-cor": {
    name: "EDP Comercializadora de Ãšltimo Recurso",
    logo: "ğŸ›ï¸",
    description: "Comercializadora de Referencia de EDP. Aplica exclusivamente tarifas PVPC reguladas por el Estado.",
    tipo_compania: "Comercializadora de Referencia (COR)",
    tarifas: {
      "2.0TD - Con discriminaciÃ³n horaria": {
        tipo: "PVPC con discriminaciÃ³n horaria + margen COR",
        descripcion: "Tarifa PVPC oficial con 3 perÃ­odos horarios + margen regulado",
        precio_base: "PVPC + margen regulado",
        margen_fijo: 0.0025, // 0.25 cÃ©ntimos/kWh - margen tÃ­pico COR
        es_cor: true,
        consejo: "EDP COR con menor margen regulado - mÃ¡ximo ahorro en tarifa oficial"
      },
      "2.0A - Sin discriminaciÃ³n horaria": {
        tipo: "PVPC sin discriminaciÃ³n + margen COR",
        descripcion: "Tarifa PVPC oficial con precio Ãºnico + margen regulado",
        precio_base: "PVPC + margen regulado",
        margen_fijo: 0.0025, // 0.25 cÃ©ntimos/kWh - margen tÃ­pico COR
        es_cor: true,
        consejo: "El margen COR mÃ¡s bajo - tarifa regulada con mÃ­nimo sobrecosto"
      }
    }
  },
  
  "repsol-cor": {
    name: "Repsol Comercializadora de Ãšltimo Recurso", 
    logo: "ğŸ›ï¸",
    description: "Comercializadora de Referencia de Repsol. Ofrece Ãºnicamente tarifas PVPC con mÃ¡rgenes regulados mÃ­nimos.",
    tipo_compania: "Comercializadora de Referencia (COR)",
    tarifas: {
      "2.0TD - Con discriminaciÃ³n horaria": {
        tipo: "PVPC con discriminaciÃ³n horaria + margen COR",
        descripcion: "Tarifa PVPC oficial con 3 perÃ­odos horarios + margen regulado", 
        precio_base: "PVPC + margen regulado",
        margen_fijo: 0.003, // 0.3 cÃ©ntimos/kWh - margen tÃ­pico COR
        es_cor: true,
        consejo: "Repsol COR con precios oficiales - planifica consumo en valle para ahorrar"
      },
      "2.0A - Sin discriminaciÃ³n horaria": {
        tipo: "PVPC sin discriminaciÃ³n + margen COR",
        descripcion: "Tarifa PVPC oficial con precio Ãºnico + margen regulado",
        precio_base: "PVPC + margen regulado",
        margen_fijo: 0.003, // 0.3 cÃ©ntimos/kWh - margen tÃ­pico COR
        es_cor: true,
        consejo: "Tarifa regulada Ãºnica - predictibilidad con margen oficial mÃ­nimo"
      }
    }
  },
  
  // === COMPAÃ‘ÃAS DE MERCADO LIBRE ===
  asenergy: {
    name: "Asenergy",
    logo: "âš¡",
    description: "Comercializadora independiente especializada en tarifas competitivas",
    tarifas: {
      "Tarifa Indexada": {
        tipo: "Precio indexado al mercado",
        descripcion: "Precio que sigue el mercado mayorista + margen competitivo",
        margen_fijo: 0.015,
        consejo: "Sigue los precios PVPC oficiales con margen mÃ­nimo"
      },
      "Tarifa con DiscriminaciÃ³n Horaria": {
        tipo: "DiscriminaciÃ³n horaria",
        descripcion: "3 perÃ­odos con precios diferenciados",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00", factor: 1.25 },
          llano: { horas: "8:00-10:00, 14:00-18:00, 22:00-24:00", factor: 1.0 },
          valle: { horas: "00:00-8:00", factor: 0.75 }
        },
        consejo: "Aprovecha las horas valle para electrodomÃ©sticos de alto consumo"
      },
      "Tarifa Verde Plus": {
        tipo: "EnergÃ­a renovable indexada",
        descripcion: "Electricidad de origen renovable + precio de mercado",
        margen_fijo: 0.02,
        consejo: "Consume limpio siguiendo los precios mÃ¡s bajos del mercado"
      }
    }
  },
  iberdrola: {
    name: "Iberdrola",
    logo: "ğŸŸ¦",
    description: "Una de las principales elÃ©ctricas de EspaÃ±a",
    tarifas: {
      "One Luz": {
        tipo: "DiscriminaciÃ³n horaria",
        descripcion: "Tarifa con 3 perÃ­odos horarios diferentes",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00", factor: 1.3 },
          llano: { horas: "8:00-10:00, 14:00-18:00, 22:00-24:00", factor: 1.0 },
          valle: { horas: "00:00-8:00", factor: 0.7 }
        },
        consejo: "Usa electrodomÃ©sticos entre 00:00-08:00 para mÃ¡ximo ahorro"
      },
      "Tempo Happy": {
        tipo: "Tarifa plana fin de semana",
        descripcion: "Gratis los fines de semana de 00:00 a 24:00",
        precio_laborable: 0.25,
        precio_festivo: 0.0,
        consejo: "Concentra el consumo mÃ¡ximo en sÃ¡bados y domingos"
      }
    }
  },
  endesa: {
    name: "Endesa",
    logo: "ğŸ”µ",
    description: "Mayor distribuidora elÃ©ctrica de EspaÃ±a",
    tarifas: {
      "One Luz": {
        tipo: "DiscriminaciÃ³n horaria",
        descripcion: "3 perÃ­odos con precios diferenciados",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00", factor: 1.25 },
          llano: { horas: "8:00-10:00, 14:00-18:00, 22:00-24:00", factor: 1.0 },
          valle: { horas: "00:00-8:00", factor: 0.75 }
        },
        consejo: "Programa electrodomÃ©sticos para madrugada (00:00-08:00)"
      },
      "Tempo Fijo": {
        tipo: "Tarifa fija",
        descripcion: "Precio fijo durante 12 meses",
        precio_fijo: 0.28,
        consejo: "Ideal si quieres previsibilidad total en tu factura"
      }
    }
  },
  naturgy: {
    name: "Naturgy (Gas Natural Fenosa)",
    logo: "ğŸŸ¢",
    description: "Anteriormente Gas Natural Fenosa",
    tarifas: {
      "Tarifa Online": {
        tipo: "DiscriminaciÃ³n horaria",
        descripcion: "GestiÃ³n 100% digital con 3 perÃ­odos",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00", factor: 1.28 },
          llano: { horas: "8:00-10:00, 14:00-18:00, 22:00-24:00", factor: 1.0 },
          valle: { horas: "00:00-8:00", factor: 0.72 }
        },
        consejo: "Descuento adicional por gestiÃ³n online"
      },
      "Tempo Libre": {
        tipo: "Precio indexado",
        descripcion: "Precio vinculado al mercado mayorista",
        consejo: "Sigue los precios de esta app para optimizar consumo"
      }
    }
  },
  edp: {
    name: "EDP",
    logo: "ğŸ”´",
    description: "EnergÃ­as de Portugal en EspaÃ±a",
    tarifas: {
      "Comercial": {
        tipo: "DiscriminaciÃ³n horaria",
        descripcion: "Tarifa estÃ¡ndar con 3 perÃ­odos",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00", factor: 1.27 },
          llano: { horas: "8:00-10:00, 14:00-18:00, 22:00-24:00", factor: 1.0 },
          valle: { horas: "00:00-8:00", factor: 0.73 }
        },
        consejo: "Aprovecha las horas valle para electrodomÃ©sticos"
      }
    }
  },
  repsol: {
    name: "Repsol",
    logo: "ğŸŸ ",
    description: "Repsol Electricidad y Gas",
    tarifas: {
      "Tarifa Eficiencia": {
        tipo: "DiscriminaciÃ³n horaria mejorada",
        descripcion: "Mayor diferencia entre perÃ­odos",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00", factor: 1.35 },
          llano: { horas: "8:00-10:00, 14:00-18:00, 22:00-24:00", factor: 1.0 },
          valle: { horas: "00:00-8:00", factor: 0.65 }
        },
        consejo: "Â¡La que mÃ¡s ahorro da! Usa electrodomÃ©sticos en madrugada"
      }
    }
  },
  totalenergies: {
    name: "TotalEnergies",
    logo: "ğŸŸ£",
    description: "Anteriormente Total Direct Energia",
    tarifas: {
      "Essential": {
        tipo: "Tarifa fija",
        descripcion: "Precio fijo garantizado 12 meses",
        precio_fijo: 0.26,
        consejo: "Sin discriminaciÃ³n horaria - consume cuando quieras"
      },
      "Smart": {
        tipo: "Indexada al mercado",
        descripcion: "Precio sigue el mercado elÃ©ctrico",
        consejo: "Usa esta app para saber cuÃ¡ndo consumir menos"
      }
    }
  },
  factorenergia: {
    name: "Factor EnergÃ­a",
    logo: "âš¡",
    description: "Especializada en tarifas competitivas",
    tarifas: {
      "Factor 3.0": {
        tipo: "DiscriminaciÃ³n horaria",
        descripcion: "3 perÃ­odos optimizados",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00", factor: 1.24 },
          llano: { horas: "8:00-10:00, 14:00-18:00, 22:00-24:00", factor: 1.0 },
          valle: { horas: "00:00-8:00", factor: 0.76 }
        },
        consejo: "Buena relaciÃ³n calidad-precio en todos los perÃ­odos"
      }
    }
  },
  holaluz: {
    name: "Holaluz",
    logo: "â˜€ï¸",
    description: "100% energÃ­a verde",
    tarifas: {
      "Tarifa Verde": {
        tipo: "Tarifa plana ecolÃ³gica",
        descripcion: "Precio fijo con energÃ­a 100% renovable",
        precio_fijo: 0.29,
        consejo: "Consume con tranquilidad - energÃ­a limpia las 24h"
      },
      "Tarifa Solar": {
        tipo: "Autoconsumo solar + mercado",
        descripcion: "Para usuarios con placas solares + precio indexado",
        margen_fijo: 0.018, // 1.8 cÃ©ntimos/kWh - margen autoconsumo
        consejo: "Usa electrodomÃ©sticos durante las horas de sol (10:00-16:00)"
      }
    }
  },
  somenergia: {
    name: "Som Energia",
    logo: "ğŸŒ±",
    description: "Cooperativa de energÃ­as renovables",
    tarifas: {
      "Cooperativa": {
        tipo: "Tarifa indexada cooperativa",
        descripcion: "Precio de coste + margen mÃ­nimo cooperativa",
        margen_fijo: 0.012, // 1.2 cÃ©ntimos/kWh - margen cooperativa
        consejo: "Sigue el mercado mayorista con margen mÃ­nimo - usa esta app para optimizar"
      },
      "Cooperativa 2.0TD": {
        tipo: "DiscriminaciÃ³n horaria cooperativa",
        descripcion: "Tarifa cooperativa con 3 perÃ­odos horarios optimizados",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00", factor: 1.15 },
          llano: { horas: "8:00-10:00, 14:00-18:00, 22:00-24:00", factor: 1.0 },
          valle: { horas: "00:00-8:00", factor: 0.8 }
        },
        consejo: "Cooperativa con discriminaciÃ³n horaria - ideal para optimizar consumo"
      }
    }
  },
  lucera: {
    name: "Lucera",
    logo: "ğŸ’¡",
    description: "Comercializadora digital",
    tarifas: {
      "Inteligente": {
        tipo: "Precio por horas indexado",
        descripcion: "Precio diferente cada hora del dÃ­a + margen competitivo",
        margen_fijo: 0.016, // 1.6 cÃ©ntimos/kWh - margen comercializadora digital
        consejo: "Â¡PERFECTA para esta app! Comprueba precios hora a hora"
      },
      "Smart": {
        tipo: "DiscriminaciÃ³n horaria digital",
        descripcion: "Tarifa inteligente con 3 perÃ­odos optimizados",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00", factor: 1.2 },
          llano: { horas: "8:00-10:00, 14:00-18:00, 22:00-24:00", factor: 1.0 },
          valle: { horas: "00:00-8:00", factor: 0.75 }
        },
        consejo: "Aprovecha la tecnologÃ­a para optimizar tu consumo horario"
      }
    }
  },
  pvpc: {
    name: "PVPC (Tarifa Regulada)",
    logo: "ğŸ›ï¸",
    description: "Tarifa oficial regulada por el gobierno",
    tarifas: {
      "2.0TD": {
        tipo: "DiscriminaciÃ³n horaria regulada",
        descripcion: "3 perÃ­odos establecidos por el gobierno",
        periodos: {
          punta: { horas: "10:00-14:00 y 18:00-22:00", factor: 1.0 },
          llano: { horas: "8:00-10:00, 14:00-18:00, 22:00-24:00", factor: 0.85 },
          valle: { horas: "00:00-8:00", factor: 0.65 }
        },
        consejo: "La base de esta app - sigue estos precios oficiales"
      }
    }
  }
};

// FunciÃ³n para mostrar informaciÃ³n de la compaÃ±Ã­a
function showCompanyInfo() {
  const selector = document.getElementById('company-selector');
  const companyKey = selector.value;
  const infoDiv = document.getElementById('company-info');
  const calculatorDiv = document.getElementById('tariff-calculator');
  
  if (!companyKey) {
    infoDiv.style.display = 'none';
    calculatorDiv.style.display = 'none';
    return;
  }
  
  const company = SPANISH_ENERGY_COMPANIES[companyKey];
  
  let html = `
    <div style="background: linear-gradient(45deg, #f8f9fa, #e9ecef); border-radius: 16px; padding: 25px; border: 2px solid #dee2e6;">
      <h4 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.4rem;">
        ${company.logo} ${company.name}
      </h4>
      <p style="color: #6c757d; margin-bottom: 20px; font-size: 1rem;">
        ${company.description}
      </p>
      
      <h5 style="color: #e74c3c; margin-bottom: 15px;">ğŸ“‹ Tarifas Disponibles:</h5>
  `;
  
  for (const [tarifaName, tarifa] of Object.entries(company.tarifas)) {
    html += `
      <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; border-left: 4px solid #3498db; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h6 style="color: #2c3e50; margin-bottom: 10px; font-size: 1.1rem;">
          âš¡ ${tarifaName}
        </h6>
        <p style="color: #7f8c8d; margin-bottom: 12px;">
          <strong>Tipo:</strong> ${tarifa.tipo}
        </p>
        <p style="color: #34495e; margin-bottom: 12px;">
          ${tarifa.descripcion}
        </p>
    `;
    
    if (tarifa.periodos) {
      html += `
        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin: 10px 0;">
          <strong style="color: #2c3e50;">PerÃ­odos horarios:</strong>
          <ul style="margin: 8px 0; padding-left: 20px;">
            <li><strong style="color: #e74c3c;">Punta:</strong> ${tarifa.periodos.punta.horas} (${(tarifa.periodos.punta.factor * 100).toFixed(0)}% precio base)</li>
            <li><strong style="color: #f39c12;">Llano:</strong> ${tarifa.periodos.llano.horas} (${(tarifa.periodos.llano.factor * 100).toFixed(0)}% precio base)</li>
            <li><strong style="color: #27ae60;">Valle:</strong> ${tarifa.periodos.valle.horas} (${(tarifa.periodos.valle.factor * 100).toFixed(0)}% precio base)</li>
          </ul>
        </div>
      `;
    }
    
    if (tarifa.precio_fijo) {
      html += `
        <div style="background: #e8f5e8; padding: 12px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #27ae60;">
          <strong style="color: #27ae60;">ğŸ’° Precio fijo:</strong> ${tarifa.precio_fijo}â‚¬/kWh las 24 horas
        </div>
      `;
    }
    
    if (tarifa.precio_laborable !== undefined) {
      html += `
        <div style="background: #fff3e0; padding: 12px; border-radius: 8px; margin: 10px 0;">
          <strong style="color: #f39c12;">ğŸ“… Precios:</strong><br>
          â€¢ DÃ­as laborables: ${tarifa.precio_laborable}â‚¬/kWh<br>
          â€¢ Fines de semana: ${tarifa.precio_festivo}â‚¬/kWh
        </div>
      `;
    }
    
    html += `
      <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-top: 12px; border-left: 3px solid #2196f3;">
        <strong style="color: #1976d2;">ğŸ’¡ Consejo:</strong> ${tarifa.consejo}
      </div>
      <button onclick="calculateForTariff('${companyKey}', '${tarifaName}')" style="
        background: linear-gradient(45deg, #27ae60, #2ecc71);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 700;
        margin-top: 12px;
        transition: all 0.3s ease;
      " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
        ğŸ§® Calcular ahorro con esta tarifa
      </button>
      </div>
    `;
  }
  
  html += `</div>`;
  
  infoDiv.innerHTML = html;
  infoDiv.style.display = 'block';
}

// FunciÃ³n para calcular ahorro especÃ­fico por tarifa
function calculateForTariff(companyKey, tarifaName) {
  const company = SPANISH_ENERGY_COMPANIES[companyKey];
  const tarifa = company.tarifas[tarifaName];
  const calculatorDiv = document.getElementById('tariff-calculator');
  
  let html = `
    <div style="background: linear-gradient(45deg, #e8f5e8, #f0f8ff); border-radius: 16px; padding: 25px; border: 2px solid #27ae60;">
      <h4 style="color: #27ae60; margin-bottom: 15px;">
        ğŸ§® Calculadora para ${company.name} - ${tarifaName}
      </h4>
      
      <div class="input-group" style="margin-bottom: 20px;">
        <input type="number" id="tariff-consumption" placeholder="Consumo en kWh (ej: 2.5)" step="0.1" min="0" style="
          padding: 12px 16px;
          border: 2px solid #27ae60;
          border-radius: 8px;
          font-size: 1rem;
          width: 200px;
          margin-right: 10px;
        ">
        <button onclick="calculateSpecificTariff('${companyKey}', '${tarifaName}')" style="
          background: linear-gradient(45deg, #27ae60, #2ecc71);
          color: white;
          border: none;
          padding: 12px 20px;
          border-radius: 8px;
          cursor: pointer;
          font-weight: 700;
        ">
          ğŸ’° Calcular ahorro
        </button>
      </div>
      
      <div id="tariff-results"></div>
    </div>
  `;
  
  calculatorDiv.innerHTML = html;
  calculatorDiv.style.display = 'block';
}

// FunciÃ³n para calcular ahorro especÃ­fico
function calculateSpecificTariff(companyKey, tarifaName) {
  const consumptionElement = document.getElementById('tariff-consumption');
  if (!consumptionElement) {
    console.warn('âš ï¸ Elemento tariff-consumption no encontrado');
    return;
  }
  
  const consumption = parseFloat(consumptionElement.value);
  if (!consumption || consumption <= 0) {
    alert('Por favor, introduce un consumo vÃ¡lido');
    return;
  }
  
  const company = SPANISH_ENERGY_COMPANIES[companyKey];
  const tarifa = company.tarifas[tarifaName];
  const resultsDiv = document.getElementById('tariff-results');
  
  let html = `
    <div style="background: white; border-radius: 12px; padding: 20px; border-left: 4px solid #27ae60;">
      <h5 style="color: #27ae60; margin-bottom: 15px;">
        ğŸ“Š AnÃ¡lisis de ahorro para ${consumption} kWh
      </h5>
  `;
  
  if (tarifa.periodos) {
    // Tarifa con discriminaciÃ³n horaria
    const precioBase = 0.25; // Precio base de referencia
    
    const costoPunta = consumption * precioBase * tarifa.periodos.punta.factor;
    const costoLlano = consumption * precioBase * tarifa.periodos.llano.factor;
    const costoValle = consumption * precioBase * tarifa.periodos.valle.factor;
    
    const ahorroMaximo = costoPunta - costoValle;
    const porcentajeAhorro = ((ahorroMaximo / costoPunta) * 100).toFixed(1);
    
    html += `
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div style="background: #ffebee; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #f44336;">
          <div style="font-size: 1.2rem; color: #d32f2f; font-weight: 700;">ğŸ”´ PUNTA</div>
          <div style="font-size: 1.1rem; color: #2c3e50; margin-top: 5px;">${costoPunta.toFixed(3)}â‚¬</div>
          <div style="font-size: 0.9rem; color: #666;">${tarifa.periodos.punta.horas}</div>
        </div>
        <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #ff9800;">
          <div style="font-size: 1.2rem; color: #f57c00; font-weight: 700;">ğŸŸ¡ LLANO</div>
          <div style="font-size: 1.1rem; color: #2c3e50; margin-top: 5px;">${costoLlano.toFixed(3)}â‚¬</div>
          <div style="font-size: 0.9rem; color: #666;">${tarifa.periodos.llano.horas}</div>
        </div>
        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #4caf50;">
          <div style="font-size: 1.2rem; color: #388e3c; font-weight: 700;">ğŸŸ¢ VALLE</div>
          <div style="font-size: 1.1rem; color: #2c3e50; margin-top: 5px;">${costoValle.toFixed(3)}â‚¬</div>
          <div style="font-size: 0.9rem; color: #666;">${tarifa.periodos.valle.horas}</div>
        </div>
      </div>
      
      <div style="background: #e3f2fd; padding: 20px; border-radius: 12px; border-left: 4px solid #2196f3; margin-bottom: 15px;">
        <h6 style="color: #1976d2; margin-bottom: 10px;">ğŸ’° Potencial de ahorro:</h6>
        <div style="font-size: 1.3rem; color: #2c3e50; font-weight: 700;">
          Â¡Puedes ahorrar hasta ${ahorroMaximo.toFixed(3)}â‚¬ (${porcentajeAhorro}%) por cada ${consumption} kWh!
        </div>
        <div style="margin-top: 10px; color: #555; font-size: 0.95rem;">
          Usando electrodomÃ©sticos en horas valle vs. horas punta
        </div>
      </div>
      
      <div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">
        <strong style="color: #7b1fa2;">ğŸ¯ RecomendaciÃ³n:</strong> ${tarifa.consejo}
      </div>
    `;
    
  } else if (tarifa.precio_fijo) {
    // Tarifa plana
    const costoTotal = consumption * tarifa.precio_fijo;
    
    html += `
      <div style="background: #e8f5e8; padding: 20px; border-radius: 12px; text-align: center;">
        <h6 style="color: #27ae60; margin-bottom: 15px;">ğŸ’° Costo con tarifa plana:</h6>
        <div style="font-size: 2rem; color: #2c3e50; font-weight: 700; margin-bottom: 10px;">
          ${costoTotal.toFixed(3)}â‚¬
        </div>
        <div style="color: #666; font-size: 1rem;">
          Para ${consumption} kWh a ${tarifa.precio_fijo}â‚¬/kWh
        </div>
      </div>
      
      <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px;">
        <strong style="color: #f57c00;">âœ… Ventaja:</strong> Precio fijo las 24 horas - consume cuando quieras sin preocuparte por horarios
      </div>
      
      <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-top: 10px;">
        <strong style="color: #d32f2f;">âš ï¸ ComparaciÃ³n:</strong> Con tarifa de discriminaciÃ³n horaria podrÃ­as ahorrar hasta un 35% usando electrodomÃ©sticos en madrugada
      </div>
    `;
    
  } else if (tarifa.precio_laborable !== undefined) {
    // Tarifa con diferencia laborable/festivo
    const costoLaborable = consumption * tarifa.precio_laborable;
    const costoFestivo = consumption * tarifa.precio_festivo;
    const ahorro = costoLaborable - costoFestivo;
    
    html += `
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div style="background: #ffebee; padding: 20px; border-radius: 12px; text-align: center;">
          <h6 style="color: #d32f2f; margin-bottom: 10px;">ğŸ“… DÃ­as laborables</h6>
          <div style="font-size: 1.5rem; color: #2c3e50; font-weight: 700;">${costoLaborable.toFixed(3)}â‚¬</div>
        </div>
        <div style="background: #e8f5e8; padding: 20px; border-radius: 12px; text-align: center;">
          <h6 style="color: #27ae60; margin-bottom: 10px;">ğŸ‰ Fines de semana</h6>
          <div style="font-size: 1.5rem; color: #2c3e50; font-weight: 700;">${costoFestivo.toFixed(3)}â‚¬</div>
        </div>
      </div>
      
      <div style="background: #e3f2fd; padding: 20px; border-radius: 12px; border-left: 4px solid #2196f3;">
        <h6 style="color: #1976d2; margin-bottom: 10px;">ğŸ’° Ahorro en fin de semana:</h6>
        <div style="font-size: 1.3rem; color: #2c3e50; font-weight: 700;">
          ${ahorro.toFixed(3)}â‚¬ por cada ${consumption} kWh
        </div>
      </div>
    `;
  }
  
  html += `
    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center;">
      <strong style="color: #2c3e50;">ğŸ’¡ Consejo personalizado:</strong><br>
      ${tarifa.consejo}
    </div>
  </div>`;
  
  resultsDiv.innerHTML = html;
}

// ===== FUNCIÃ“N PARA MOSTRAR SOLO INFORMACIÃ“N DE COMPAÃ‘ÃAS (SIN CALCULADORAS) =====
function showCompanyInfoOnly() {
  const selector = document.getElementById('company-selector');
  const companyKey = selector.value;
  const infoDiv = document.getElementById('company-info-display');
  
  if (!companyKey) {
    infoDiv.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #7f8c8d;">
        <span style="font-size: 3rem;">ğŸ¢</span>
        <p>Selecciona una compaÃ±Ã­a para ver informaciÃ³n detallada sobre sus tarifas</p>
      </div>
    `;
    return;
  }
  
  const company = SPANISH_ENERGY_COMPANIES[companyKey];
  
  let html = `
    <div style="background: linear-gradient(45deg, #f8f9fa, #e9ecef); border-radius: 16px; padding: 25px; border: 2px solid #dee2e6; margin-top: 20px;">
      <div style="text-align: center; margin-bottom: 25px;">
        <div style="font-size: 4rem; margin-bottom: 10px;">${company.logo}</div>
        <h4 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.8rem;">
          ${company.name}
        </h4>
        <p style="color: #6c757d; margin-bottom: 20px; font-size: 1.1rem; max-width: 800px; margin-left: auto; margin-right: auto; line-height: 1.5;">
          ${company.description}
        </p>
  `;
  
  // InformaciÃ³n adicional para PVPC
  if (companyKey === 'pvpc') {
    html += `
      <div style="background: linear-gradient(45deg, #e3f2fd, #f3e5f5); border-radius: 12px; padding: 20px; margin: 20px 0; border: 2px solid #2196f3;">
        <h5 style="color: #1976d2; margin-bottom: 15px; text-align: center;">ğŸ›ï¸ InformaciÃ³n Oficial PVPC</h5>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
          <div style="background: white; padding: 15px; border-radius: 8px;">
            <strong style="color: #1976d2;">ğŸ¢ Tipo:</strong> ${company.tipo_compania}
          </div>
          <div style="background: white; padding: 15px; border-radius: 8px;">
            <strong style="color: #1976d2;">ğŸ“‹ RegulaciÃ³n:</strong> ${company.regulacion}
          </div>
          <div style="background: white; padding: 15px; border-radius: 8px;">
            <strong style="color: #1976d2;">â±ï¸ ActualizaciÃ³n:</strong> ${company.informacion_adicional.actualizacion}
          </div>
          <div style="background: white; padding: 15px; border-radius: 8px;">
            <strong style="color: #1976d2;">ğŸ‘¥ QuiÃ©n puede:</strong> ${company.informacion_adicional.quien_puede}
          </div>
        </div>
      </div>
    `;
  }
  
  html += `
        <h5 style="color: #e74c3c; margin-bottom: 20px; text-align: center; font-size: 1.4rem;">ğŸ“‹ Tarifas Disponibles</h5>
      </div>
  `;
  
  // Mostrar todas las tarifas
  Object.entries(company.tarifas).forEach(([tarifaName, tarifa]) => {
    html += `
      <div style="background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; border-left: 4px solid #3498db; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <h6 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.3rem; text-align: center;">
          âš¡ ${tarifaName}
        </h6>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div>
              <strong style="color: #2c3e50;">ğŸ“Š Tipo:</strong>
              <div style="color: #7f8c8d; margin-top: 5px;">${tarifa.tipo}</div>
            </div>
            <div>
              <strong style="color: #2c3e50;">ğŸ“ DescripciÃ³n:</strong>
              <div style="color: #7f8c8d; margin-top: 5px;">${tarifa.descripcion}</div>
            </div>
          </div>
        </div>
    `;
    
    // Mostrar perÃ­odos horarios si existen
    if (tarifa.periodos) {
      html += `
        <div style="background: linear-gradient(45deg, #fff3e0, #f3e5f5); padding: 20px; border-radius: 12px; margin: 15px 0;">
          <h6 style="color: #f57c00; margin-bottom: 15px; text-align: center;">â° PerÃ­odos Horarios</h6>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
      `;
      
      Object.entries(tarifa.periodos).forEach(([periodoNombre, periodo]) => {
        let colorPeriodo = '#2196f3';
        let iconoPeriodo = 'âš¡';
        
        if (periodoNombre === 'punta') {
          colorPeriodo = '#f44336';
          iconoPeriodo = 'ğŸ”´';
        } else if (periodoNombre === 'llano') {
          colorPeriodo = '#ff9800';
          iconoPeriodo = 'ğŸŸ¡';
        } else if (periodoNombre === 'valle') {
          colorPeriodo = '#4caf50';
          iconoPeriodo = 'ğŸŸ¢';
        }
        
        html += `
          <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid ${colorPeriodo};">
            <div style="text-align: center; margin-bottom: 10px;">
              <span style="font-size: 1.5rem;">${iconoPeriodo}</span>
              <strong style="color: ${colorPeriodo}; display: block; margin-top: 5px; text-transform: uppercase;">
                ${periodoNombre}
              </strong>
            </div>
            <div style="color: #2c3e50; font-size: 0.9rem; line-height: 1.4;">
              <strong>Horarios:</strong><br>
              ${periodo.horas}
            </div>
            ${periodo.factor ? `
              <div style="margin-top: 10px; color: #2c3e50; font-size: 0.9rem;">
                <strong>Factor:</strong> ${(periodo.factor * 100).toFixed(0)}% del precio base
              </div>
            ` : ''}
            ${periodo.descripcion ? `
              <div style="margin-top: 10px; color: #7f8c8d; font-size: 0.85rem; font-style: italic;">
                ${periodo.descripcion}
              </div>
            ` : ''}
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
      `;
    }
    
    // Mostrar precio fijo si existe
    if (tarifa.precio_fijo) {
      html += `
        <div style="background: linear-gradient(45deg, #e8f5e8, #f0f8ff); padding: 20px; border-radius: 12px; margin: 15px 0; text-align: center;">
          <h6 style="color: #27ae60; margin-bottom: 10px;">ğŸ’° Precio Fijo</h6>
          <div style="font-size: 1.8rem; color: #2c3e50; font-weight: bold; margin-bottom: 5px;">
            ${tarifa.precio_fijo}â‚¬/kWh
          </div>
          <div style="color: #7f8c8d; font-size: 0.9rem;">Las 24 horas del dÃ­a</div>
        </div>
      `;
    }
    
    // Mostrar precios laborable/festivo si existen
    if (tarifa.precio_laborable !== undefined) {
      html += `
        <div style="background: linear-gradient(45deg, #fff3e0, #f3e5f5); padding: 20px; border-radius: 12px; margin: 15px 0;">
          <h6 style="color: #f57c00; margin-bottom: 15px; text-align: center;">ğŸ“… Precios por Tipo de DÃ­a</h6>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #ff5722;">
              <strong style="color: #ff5722;">ğŸ“… DÃ­as Laborables</strong>
              <div style="font-size: 1.4rem; color: #2c3e50; font-weight: bold; margin-top: 5px;">
                ${tarifa.precio_laborable}â‚¬/kWh
              </div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #4caf50;">
              <strong style="color: #4caf50;">ğŸ‰ Fines de Semana</strong>
              <div style="font-size: 1.4rem; color: #2c3e50; font-weight: bold; margin-top: 5px;">
                ${tarifa.precio_festivo}â‚¬/kWh
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    // Mostrar margen fijo si existe
    if (tarifa.margen_fijo) {
      html += `
        <div style="background: linear-gradient(45deg, #e3f2fd, #f3e5f5); padding: 15px; border-radius: 8px; margin: 15px 0;">
          <strong style="color: #1976d2;">ğŸ“ˆ Margen sobre PVPC:</strong> +${tarifa.margen_fijo}â‚¬/kWh
          <div style="color: #7f8c8d; font-size: 0.9rem; margin-top: 5px;">
            Esta tarifa sigue el precio PVPC oficial + un margen fijo
          </div>
        </div>
      `;
    }
    
    // Mostrar ventajas e inconvenientes para PVPC
    if (companyKey === 'pvpc' && tarifa.ventajas) {
      html += `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
          <div style="background: linear-gradient(45deg, #e8f5e8, #f0f8ff); padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
            <h6 style="color: #4caf50; margin-bottom: 10px;">âœ… Ventajas</h6>
            <ul style="margin: 0; padding-left: 20px; color: #2c3e50;">
              ${tarifa.ventajas.map(ventaja => `<li style="margin-bottom: 5px;">${ventaja}</li>`).join('')}
            </ul>
          </div>
          <div style="background: linear-gradient(45deg, #fff3e0, #ffebee); padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
            <h6 style="color: #ff9800; margin-bottom: 10px;">âš ï¸ Consideraciones</h6>
            <ul style="margin: 0; padding-left: 20px; color: #2c3e50;">
              ${tarifa.inconvenientes.map(inconveniente => `<li style="margin-bottom: 5px;">${inconveniente}</li>`).join('')}
            </ul>
          </div>
        </div>
      `;
    }
    
    // Mostrar consejo
    html += `
      <div style="background: linear-gradient(45deg, #e3f2fd, #f3e5f5); padding: 20px; border-radius: 12px; border-left: 4px solid #2196f3; margin-top: 15px;">
        <div style="text-align: center;">
          <span style="font-size: 1.5rem; margin-bottom: 10px; display: block;">ğŸ’¡</span>
          <strong style="color: #1976d2; font-size: 1.1rem;">Consejo:</strong>
        </div>
        <div style="color: #2c3e50; margin-top: 10px; text-align: center; font-size: 1rem; line-height: 1.5;">
          ${tarifa.consejo}
        </div>
      </div>
    `;
    
    html += `</div>`;
  });
  
  html += `</div>`;
  
  infoDiv.innerHTML = html;
}

// ===== COMPARACIÃ“N DE COMPAÃ‘ÃAS =====
function generateCompanyComparison() {
  const consumptionElement = document.getElementById('comparison-consumption');
  if (!consumptionElement) {
    console.warn('âš ï¸ Elemento comparison-consumption no encontrado');
    return;
  }
  
  const consumption = parseFloat(consumptionElement.value);
  if (!consumption || consumption <= 0) {
    alert('Por favor, introduce un consumo vÃ¡lido para comparar');
    return;
  }
  
  const currentHour = new Date().getHours();
  const currentDate = new Date();
  const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
  
  // Calcular costos para cada compaÃ±Ã­a
  const comparisonData = [];
  const currentMarketPrice = globalPrices.length > 0 ? globalPrices[currentHour]?.precio || 0.25 : 0.25;
  
  for (const [key, company] of Object.entries(SPANISH_ENERGY_COMPANIES)) {
    for (const [tarifaName, tarifa] of Object.entries(company.tarifas)) {
      let cost = 0;
      let description = '';
      
      if (tarifa.periodos) {
        // Tarifa con discriminaciÃ³n horaria
        const factor = getCurrentPeriodFactor(currentHour, tarifa.periodos);
        cost = consumption * currentMarketPrice * factor;
        description = `${getCurrentPeriodName(currentHour, tarifa.periodos)}`;
      } else if (tarifa.precio_fijo) {
        // Tarifa fija
        cost = consumption * tarifa.precio_fijo;
        description = 'Precio fijo';
      } else if (tarifa.precio_laborable !== undefined) {
        // Tarifa con diferencia laborable/festivo
        const price = isWeekend ? tarifa.precio_festivo : tarifa.precio_laborable;
        cost = consumption * price;
        description = isWeekend ? 'Fin de semana' : 'DÃ­a laborable';
      } else if (tarifa.margen_fijo) {
        // Tarifa indexada
        cost = consumption * (currentMarketPrice + tarifa.margen_fijo);
        description = 'Indexada al mercado';
      } else {
        // Por defecto, usar precio de mercado
        cost = consumption * currentMarketPrice;
        description = 'Precio mercado';
      }
      
      comparisonData.push({
        company: company.name,
        tarifa: tarifaName,
        cost: cost,
        description: description,
        logo: company.logo,
        savings: 0 // Se calcularÃ¡ despuÃ©s
      });
    }
  }
  
  // Ordenar por precio (mÃ¡s barato primero)
  comparisonData.sort((a, b) => a.cost - b.cost);
  
  // Calcular ahorros relativos al mÃ¡s caro
  const mostExpensive = comparisonData[comparisonData.length - 1];
  comparisonData.forEach(item => {
    item.savings = mostExpensive.cost - item.cost;
  });
  
  // Crear grÃ¡fico
  createComparisonChart(comparisonData.slice(0, 8)); // Top 8 mejores
  
  // Mostrar ranking
  showCompanyRanking(comparisonData, consumption);
}

function getCurrentPeriodFactor(hour, periodos) {
  // Determinar el perÃ­odo actual basado en la hora
  if ((hour >= 10 && hour < 14) || (hour >= 18 && hour < 22)) {
    return periodos.punta?.factor || 1.3;
  } else if ((hour >= 8 && hour < 10) || (hour >= 14 && hour < 18) || (hour >= 22 || hour < 1)) {
    return periodos.llano?.factor || 1.0;
  } else {
    return periodos.valle?.factor || 0.7;
  }
}

function getCurrentPeriodName(hour, periodos) {
  if ((hour >= 10 && hour < 14) || (hour >= 18 && hour < 22)) {
    return 'Punta';
  } else if ((hour >= 8 && hour < 10) || (hour >= 14 && hour < 18) || (hour >= 22 || hour < 1)) {
    return 'Llano';
  } else {
    return 'Valle';
  }
}

function createComparisonChart(data) {
  const ctx = document.getElementById('comparison-chart').getContext('2d');
  
  if (comparisonChart) {
    comparisonChart.destroy();
  }
  
  const labels = data.map(item => {
    // Crear etiquetas mÃ¡s cortas y legibles
    const companyShort = item.company.length > 12 ? item.company.substring(0, 10) + '...' : item.company;
    const tarifaShort = item.tarifa.length > 15 ? item.tarifa.substring(0, 12) + '...' : item.tarifa;
    return [`${item.logo} ${companyShort}`, tarifaShort];
  });
  const costs = data.map(item => item.cost);
  const colors = [
    '#27ae60', '#2ecc71', '#3498db', '#9b59b6', 
    '#f39c12', '#e67e22', '#e74c3c', '#c0392b'
  ];
  
  comparisonChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Costo (â‚¬)',
        data: costs,
        backgroundColor: colors,
        borderColor: colors.map(color => color + '99'),
        borderWidth: 2,
        borderRadius: 8,
        borderSkipped: false,
        maxBarThickness: 60
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: `Comparativa de Precios - ${document.getElementById('comparison-consumption')?.value || 'N/A'} kWh`,
          font: { size: 18, weight: 'bold' },
          padding: 20
        },
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          titleColor: 'white',
          bodyColor: 'white',
          cornerRadius: 8,
          displayColors: false,
          callbacks: {
            title: function(context) {
              const item = data[context[0].dataIndex];
              return `${item.company} - ${item.tarifa}`;
            },
            label: function(context) {
              const item = data[context.dataIndex];
              return [
                `ğŸ’° Costo: ${item.cost.toFixed(3)}â‚¬`,
                `ğŸ“Š Tipo: ${item.description}`,
                `ğŸ’² Ahorro vs mÃ¡s cara: ${item.savings.toFixed(3)}â‚¬`
              ];
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Costo (â‚¬)',
            font: { size: 14, weight: 'bold' }
          },
          ticks: {
            callback: function(value) {
              return value.toFixed(3) + 'â‚¬';
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.1)'
          }
        },
        x: {
          title: {
            display: true,
            text: 'CompaÃ±Ã­as y Tarifas',
            font: { size: 14, weight: 'bold' }
          },
          ticks: {
            maxRotation: 25,
            minRotation: 0,
            font: { size: 10 },
            padding: 5
          },
          grid: {
            display: false
          }
        }
      },
      layout: {
        padding: {
          top: 10,
          right: 10,
          bottom: 10,
          left: 10
        }
      }
    }
  });
}

function showCompanyRanking(data, consumption) {
  const rankingDiv = document.getElementById('company-ranking');
  
  let html = `
    <div style="background: linear-gradient(45deg, #f8f9fa, #e9ecef); border-radius: 16px; padding: 25px; border: 2px solid #dee2e6;">
      <h4 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">
        ğŸ† Ranking de Mejores Opciones para ${consumption} kWh HOY
      </h4>
      <div style="display: grid; gap: 15px;">
  `;
  
  data.slice(0, 5).forEach((item, index) => {
    const position = index + 1;
    const medal = position === 1 ? 'ğŸ¥‡' : position === 2 ? 'ğŸ¥ˆ' : position === 3 ? 'ğŸ¥‰' : `${position}Âº`;
    const bgColor = position === 1 ? '#e8f5e8' : position === 2 ? '#fff3e0' : position === 3 ? '#ffebee' : '#f8f9fa';
    const borderColor = position === 1 ? '#27ae60' : position === 2 ? '#f39c12' : position === 3 ? '#e74c3c' : '#dee2e6';
    
    html += `
      <div style="background: ${bgColor}; padding: 15px; border-radius: 12px; border-left: 4px solid ${borderColor}; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 15px;">
          <span style="font-size: 1.5rem;">${medal}</span>
          <div>
            <div style="font-weight: 700; color: #2c3e50; font-size: 1.1rem;">
              ${item.logo} ${item.company} - ${item.tarifa}
            </div>
            <div style="color: #6c757d; font-size: 0.9rem;">${item.description}</div>
          </div>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 1.3rem; font-weight: 700; color: #2c3e50;">${item.cost.toFixed(3)}â‚¬</div>
          ${item.savings > 0 ? `<div style="color: #27ae60; font-size: 0.9rem;">Ahorras ${item.savings.toFixed(3)}â‚¬</div>` : ''}
        </div>
      </div>
    `;
  });
  
  html += `
      </div>
      <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center;">
        <strong style="color: #1976d2;">ğŸ’¡ Consejo:</strong> La diferencia entre la mÃ¡s barata y la mÃ¡s cara es de 
        <strong style="color: #e74c3c;">${(data[data.length-1].cost - data[0].cost).toFixed(3)}â‚¬</strong> 
        para este consumo. Â¡Elige bien y ahorra!
      </div>
    </div>
  `;
  
  rankingDiv.innerHTML = html;
}

// ===== UTILITY FUNCTIONS =====
const formatTime = (num) => num.toString().padStart(2, "0");
const formatPrice = (price) => price.toFixed(3);

const showLoading = (elementId) => {
  const element = document.getElementById(elementId);
  if (element && !element.querySelector('.loading')) {
    element.innerHTML = '<span class="loading"></span>' + element.textContent;
  }
};

const hideLoading = (elementId) => {
  const element = document.getElementById(elementId);
  if (element) {
    const loading = element.querySelector('.loading');
    if (loading) loading.remove();
  }
};

// ===== PROMEDIO HISTÃ“RICO =====
function showHistoricalAverage() {
  console.log('ğŸ“Š Generando promedio histÃ³rico...');
  
  const alertElement = document.getElementById("alerta");
  const originalContent = alertElement.innerHTML;
  alertElement.innerHTML = '<span class="loading"></span>Calculando promedio histÃ³rico...';
  
  try {
    const ctx = document.getElementById("grafico").getContext("2d");
    
    // Generar datos de promedio histÃ³rico basados en datos reales del mercado espaÃ±ol
    const historicalData = generateHistoricalAverage();
    
    if (historicalData && historicalData.prices.length > 0) {
      globalPrices = historicalData.prices;
      updatePriceAlert(historicalData.prices, historicalData);
      renderPriceChart(ctx, historicalData.labels, historicalData.prices, historicalData.colors);
      
      updateApiStatus('offline', `Promedio histÃ³rico ${historicalData.context} (${historicalData.date})`);
      
      console.log('âœ… Promedio histÃ³rico generado exitosamente');
    }
    
  } catch (err) {
    console.error("âŒ Error generando promedio histÃ³rico:", err);
    alertElement.innerHTML = originalContent;
    updateApiStatus('error', 'Error generando promedio histÃ³rico');
  }
}

// FunciÃ³n para generar promedio histÃ³rico basado en datos reales
function generateHistoricalAverage() {
  const today = new Date();
  const dayOfWeek = today.getDay();
  const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
  const month = today.getMonth();
  const isSummer = month >= 5 && month <= 8;
  const isWinter = month >= 11 || month <= 2;
  
  // Promedios histÃ³ricos reales del mercado espaÃ±ol por tipo de dÃ­a y estaciÃ³n
  // Basados en datos histÃ³ricos de OMIE y REE
  
  let basePattern;
  let context;
  
  if (isWeekend && isSummer) {
    // Fin de semana verano - precios mÃ¡s bajos, menos variaciÃ³n
    basePattern = [0.074, 0.068, 0.063, 0.061, 0.066, 0.076, 0.089, 0.102, 0.094, 0.088, 0.084, 0.081, 0.079, 0.077, 0.081, 0.087, 0.095, 0.108, 0.125, 0.118, 0.106, 0.094, 0.086, 0.079];
    context = "fines de semana de verano";
  } else if (isWeekend && isWinter) {
    // Fin de semana invierno
    basePattern = [0.082, 0.076, 0.071, 0.069, 0.074, 0.084, 0.097, 0.110, 0.102, 0.096, 0.092, 0.089, 0.087, 0.085, 0.089, 0.095, 0.103, 0.116, 0.133, 0.126, 0.114, 0.102, 0.094, 0.087];
    context = "fines de semana de invierno";
  } else if (!isWeekend && isSummer) {
    // Entre semana verano - picos mÃ¡s altos por aire acondicionado
    basePattern = [0.089, 0.081, 0.075, 0.073, 0.079, 0.098, 0.128, 0.156, 0.142, 0.125, 0.118, 0.112, 0.108, 0.105, 0.112, 0.125, 0.145, 0.172, 0.198, 0.185, 0.165, 0.142, 0.122, 0.102];
    context = "dÃ­as laborables de verano";
  } else if (!isWeekend && isWinter) {
    // Entre semana invierno - picos por calefacciÃ³n
    basePattern = [0.095, 0.087, 0.081, 0.079, 0.085, 0.104, 0.134, 0.162, 0.148, 0.131, 0.124, 0.118, 0.114, 0.111, 0.118, 0.131, 0.151, 0.178, 0.204, 0.191, 0.171, 0.148, 0.128, 0.108];
    context = "dÃ­as laborables de invierno";
  } else {
    // Primavera/otoÃ±o entre semana
    basePattern = [0.087, 0.079, 0.073, 0.071, 0.077, 0.096, 0.126, 0.154, 0.140, 0.123, 0.116, 0.110, 0.106, 0.103, 0.110, 0.123, 0.143, 0.170, 0.196, 0.183, 0.163, 0.140, 0.120, 0.100];
    context = "dÃ­as laborables de primavera/otoÃ±o";
  }
  
  const labels = [];
  const prices = [];
  const colors = [];
  const currentHour = today.getHours();
  
  for (let i = 0; i < 24; i++) {
    labels.push(`${i.toString().padStart(2, '0')}:00`);
    
    // PequeÃ±a variaciÃ³n aleatoria para simular la realidad de los promedios
    const variation = (Math.random() - 0.5) * 0.008; // Â±0.8 cÃ©ntimos
    const price = Math.max(0.050, basePattern[i] + variation);
    
    prices.push(parseFloat(price.toFixed(4)));
    
    // Colores segÃºn precio - destacar hora actual
    if (i === currentHour) {
      colors.push('#2196F3'); // Azul para hora actual
    } else if (price < 0.10) {
      colors.push('#27ae60'); // Verde
    } else if (price < 0.15) {
      colors.push('#f39c12'); // Naranja
    } else {
      colors.push('#e74c3c'); // Rojo
    }
  }
  
  return {
    labels: labels,
    prices: prices,
    colors: colors,
    source: 'Promedio HistÃ³rico',
    date: today.toLocaleDateString('es-ES'),
    timestamp: new Date().toISOString(),
    context: context,
    dataType: 'historical_average'
  };
}

// ===== CLOCK FUNCTIONALITY =====
function initializeClock() {
  const currentHourText = document.getElementById("current-hour-text");
  let lastHour = new Date().getHours();
  
  const updateClock = () => {
    // Usar la zona horaria de EspaÃ±a (Europe/Madrid)
    const now = new Date();
    const spainTime = new Date(now.toLocaleString("en-US", {timeZone: "Europe/Madrid"}));
    
    const hours = formatTime(spainTime.getHours());
    
    // Actualizar indicador de hora actual en el grÃ¡fico
    if (currentHourText) {
      currentHourText.textContent = `${hours}:00`;
    }
    
    // Si cambiÃ³ la hora, actualizar el grÃ¡fico
    const currentHour = spainTime.getHours();
    if (currentHour !== lastHour && priceChart && globalPrices.length > 0) {
      console.log('ğŸ• Cambio de hora detectado, actualizando grÃ¡fico...');
      lastHour = currentHour;
      
      // Regenerar el grÃ¡fico con la nueva hora actual destacada
      const ctx = document.getElementById("grafico").getContext("2d");
      const labels = globalPrices.map((_, i) => `${formatTime(i)}:00`);
      
      // Recalcular colores con la nueva hora actual
      const colors = globalPrices.map((price, i) => {
        if (i === currentHour) {
          return '#2196F3'; // Azul para hora actual
        } else if (price < 0.10) {
          return '#27ae60'; // Verde
        } else if (price < 0.15) {
          return '#f39c12'; // Naranja
        } else {
          return '#e74c3c'; // Rojo
        }
      });
      
      renderPriceChart(ctx, labels, globalPrices, colors);
      
      // Actualizar tambiÃ©n la alerta de precios
      const dataInfo = {
        source: 'ActualizaciÃ³n automÃ¡tica',
        date: spainTime.toLocaleDateString('es-ES')
      };
      updatePriceAlert(globalPrices, dataInfo);
    }
  };

  updateClock();
  setInterval(updateClock, 60000); // Actualizar cada minuto en lugar de cada segundo
}

// ===== PRICE FUNCTIONALITY =====
async function loadElectricityPrices() {
  const alertElement = document.getElementById("alerta");
  const ctx = document.getElementById("grafico").getContext("2d");
  
  try {
    showLoading("alerta");
    updateApiStatus('connecting');
    
    // Estrategia simple que funciona: Datos realistas por defecto, APIs como bonus
    let realData = null;
    let dataSource = '';
    
    // Paso 1: Cargar datos de respaldo realistas (siempre funciona)
    console.log('ğŸ”„ Cargando datos de respaldo realistas...');
    const backupData = await fetchBackupPriceData();
    realData = backupData;
    dataSource = 'respaldo';
    
    // Paso 2: Intentar mejorar con APIs oficiales (opcional)
    try {
      console.log('ğŸ”„ Intentando mejorar con APIs oficiales...');
      const apiData = await Promise.race([
        fetchRealPriceData(),
        new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Timeout de API')), 8000)
        )
      ]);
      
      if (apiData && apiData.prices.length > 0) {
        realData = apiData;
        dataSource = 'oficial';
        console.log('âœ… Datos oficiales obtenidos exitosamente');
      }
    } catch (apiError) {
      console.log('â„¹ï¸ APIs oficiales no disponibles, usando datos realistas:', apiError.message);
    }
    
    // Renderizar datos (siempre tenemos datos de respaldo)
    if (realData && realData.prices.length > 0) {
      globalPrices = realData.prices;
      updatePriceAlert(realData.prices, realData);
      renderPriceChart(ctx, realData.labels, realData.prices, realData.colors);
      
      // Actualizar comparaciÃ³n de tarifas
      const comparisonData = calculateTariffComparison(realData.prices, dataSource);
      renderTariffComparison(comparisonData);
      
      // Actualizar estado segÃºn la fuente
      if (dataSource === 'oficial') {
        updateApiStatus('connected', realData.date ? `(${realData.date})` : '');
      } else {
        const extraInfo = realData.isWeekend ? 'fin de semana' : 'entre semana';
        const seasonInfo = realData.season || '';
        updateApiStatus('offline', `Datos realistas ${extraInfo} ${seasonInfo} (${realData.date})`);
      }
    } else {
      throw new Error("Error crÃ­tico en datos de respaldo");
    }
    
    hideLoading("alerta");

  } catch (err) {
    hideLoading("alerta");
    console.error("âŒ Error crÃ­tico, usando datos de ejemplo bÃ¡sicos:", err);
    updateApiStatus('error', 'Usando datos de ejemplo');
    
    // Ãšltimo recurso: datos de ejemplo bÃ¡sicos
    const mockData = generateMockPriceData();
    mockData.source = 'mock';
    globalPrices = mockData.prices;
    
    updatePriceAlert(mockData.prices, mockData);
    renderPriceChart(ctx, mockData.labels, mockData.prices, mockData.colors);
    
    // ComparaciÃ³n tambiÃ©n para datos de ejemplo
    const comparisonData = calculateTariffComparison(mockData.prices, 'simulaciÃ³n');
    renderTariffComparison(comparisonData);
  }
}

async function refreshPriceData() {
  console.log('ğŸ”„ Actualizando datos de precios...');
  updateApiStatus('connecting');
  
  // Mostrar indicador de carga
  const alertElement = document.getElementById("alerta");
  const originalContent = alertElement.innerHTML;
  alertElement.innerHTML = '<span class="loading"></span>Actualizando precios...';
  
  try {
    const ctx = document.getElementById("grafico").getContext("2d");
    
    // Estrategia simplificada: datos realistas + intento de API
    let realData = null;
    let dataSource = '';
    
    // Paso 1: Generar nuevos datos realistas (siempre funciona)
    console.log('ğŸ”„ Generando nuevos datos realistas...');
    const backupData = await fetchBackupPriceData();
    realData = backupData;
    dataSource = 'respaldo';
    
    // Paso 2: Intentar obtener datos oficiales (con timeout corto)
    try {
      console.log('ğŸ”„ Intentando datos oficiales...');
      const apiData = await Promise.race([
        fetchRealPriceData(),
        new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Timeout')), 5000)
        )
      ]);
      
      if (apiData && apiData.prices.length > 0) {
        realData = apiData;
        dataSource = 'oficial';
        console.log('âœ… ActualizaciÃ³n con datos oficiales exitosa');
      }
    } catch (apiError) {
      console.log('â„¹ï¸ Manteniendo datos realistas:', apiError.message);
    }
    
    // Actualizar la interfaz
    if (realData && realData.prices.length > 0) {
      globalPrices = realData.prices;
      updatePriceAlert(realData.prices, realData);
      renderPriceChart(ctx, realData.labels, realData.prices, realData.colors);
      
      // Actualizar comparaciÃ³n de tarifas
      const comparisonData = calculateTariffComparison(realData.prices.pvpc, dataSource);
      renderTariffComparison(comparisonData);
      
      if (dataSource === 'oficial') {
        updateApiStatus('connected', realData.date ? `(${realData.date})` : '');
        console.log('âœ… ActualizaciÃ³n exitosa con datos oficiales');
      } else {
        const extraInfo = realData.isWeekend ? 'fin de semana' : 'entre semana';
        updateApiStatus('offline', `Datos realistas actualizados ${extraInfo} (${realData.date})`);
        console.log('âœ… ActualizaciÃ³n exitosa con datos realistas');
      }
    } else {
      throw new Error("Error en actualizaciÃ³n de datos");
    }
    
  } catch (err) {
    console.warn("âŒ Error al actualizar:", err);
    updateApiStatus('error', 'Error en actualizaciÃ³n');
    
    // Restaurar contenido original
    alertElement.innerHTML = originalContent;
    
    // Si no hay datos previos, usar datos de ejemplo
    if (!globalPrices || globalPrices.length === 0) {
      const ctx = document.getElementById("grafico").getContext("2d");
      const mockData = generateMockPriceData();
      mockData.source = 'mock';
      globalPrices = mockData.prices;
      updatePriceAlert(mockData.prices, mockData);
      renderPriceChart(ctx, mockData.labels, mockData.prices, mockData.colors);
      
      // ComparaciÃ³n para datos de ejemplo
      const comparisonData = calculateTariffComparison(mockData.prices.pvpc, 'simulaciÃ³n');
      renderTariffComparison(comparisonData);
      
      updateApiStatus('error', 'Usando datos de ejemplo');
    }
  }
}

async function generateNewRealisticData() {
  console.log('ğŸ“ˆ Generando simulaciÃ³n basada en datos histÃ³ricos...');
  
  const alertElement = document.getElementById("alerta");
  const originalContent = alertElement.innerHTML;
  alertElement.innerHTML = '<span class="loading"></span>Generando simulaciÃ³n de precios...';
  
  try {
    const ctx = document.getElementById("grafico").getContext("2d");
    
    // Generar simulaciÃ³n basada en patrones histÃ³ricos del mercado elÃ©ctrico espaÃ±ol
    const newData = await fetchBackupPriceData();
    
    if (newData && newData.prices.length > 0) {
      globalPrices = newData.prices;
      updatePriceAlert(newData.prices, newData);
      renderPriceChart(ctx, newData.labels, newData.prices, newData.colors);
      
      // Actualizar comparaciÃ³n de tarifas
      const comparisonData = calculateTariffComparison(newData.prices.pvpc, dataSource);
      renderTariffComparison(comparisonData);
      
      const typeInfo = newData.isWeekend ? 'fin de semana' : 'entre semana';
      const seasonInfo = newData.season ? ` (${newData.season})` : '';
      updateApiStatus('offline', `SimulaciÃ³n histÃ³rica ${typeInfo}${seasonInfo} (${newData.date})`);
      
      console.log('âœ… SimulaciÃ³n histÃ³rica generada exitosamente');
      
      // Mostrar mensaje temporal de Ã©xito
      setTimeout(() => {
        if (alertElement.innerHTML.includes("âœ…") || alertElement.innerHTML.includes("âš ï¸") || alertElement.innerHTML.includes("âŒ")) {
          const currentMsg = alertElement.innerHTML;
          if (!currentMsg.includes("SimulaciÃ³n")) {
            alertElement.innerHTML = currentMsg + "<br><small style='color: #8e44ad; font-weight: 600; background: rgba(142, 68, 173, 0.1); padding: 3px 8px; border-radius: 10px;'>ğŸ“ˆ SimulaciÃ³n basada en datos histÃ³ricos</small>";
          }
        }
      }, 1000);
    }
    
  } catch (err) {
    console.error("âŒ Error generando simulaciÃ³n histÃ³rica:", err);
    alertElement.innerHTML = originalContent;
    updateApiStatus('error', 'Error generando simulaciÃ³n');
  }
}

function generateMockPriceData() {
  const labels = [];
  const prices = [];
  const colors = [];
  const currentHour = new Date().getHours();

  // Generar datos de ejemplo
  const basePrices = [0.08, 0.07, 0.06, 0.06, 0.07, 0.09, 0.12, 0.15, 0.13, 0.11, 0.10, 0.09, 0.08, 0.07, 0.08, 0.10, 0.12, 0.15, 0.18, 0.16, 0.14, 0.12, 0.10, 0.09];

  for (let i = 0; i < 24; i++) {
    labels.push(`${formatTime(i)}:00`);
    prices.push(basePrices[i]);

    // Asignar colores - SIEMPRE marcar la hora actual en azul
    if (i === currentHour) {
      colors.push("#2196F3"); // Azul brillante para la hora actual
    } else if (basePrices[i] <= 0.08) {
      colors.push("#27ae60"); // Verde
    } else if (basePrices[i] <= 0.12) {
      colors.push("#f39c12"); // Naranja
    } else {
      colors.push("#e67e22"); // Rojo
    }
  }

  return { labels, prices, colors, source: 'mock' };
}

function updateApiStatus(status, message = '', isError = false) {
  const statusElement = document.getElementById("api-status");
  if (!statusElement) return;
  
  switch (status) {
    case 'connecting':
      statusElement.innerHTML = 'ğŸ”„ Conectando con APIs oficiales...';
      statusElement.style.background = 'linear-gradient(45deg, #fff3cd, #ffeaa7)';
      statusElement.style.borderColor = '#f39c12';
      statusElement.style.color = '#856404';
      break;
      
    case 'connected':
      // Verificar si es ESIOS oficial
      if (message.includes('ESIOS') || message.includes('Oficial')) {
        statusElement.innerHTML = `ğŸ† ESIOS API Oficial activa ${message}`;
        statusElement.style.background = 'linear-gradient(45deg, #e74c3c, #c0392b)';
        statusElement.style.borderColor = '#a93226';
        statusElement.style.color = '#ffffff';
        statusElement.style.fontWeight = '800';
        statusElement.style.textTransform = 'uppercase';
        statusElement.style.letterSpacing = '0.5px';
      } else {
        statusElement.innerHTML = `âœ… Datos oficiales obtenidos ${message}`;
        statusElement.style.background = 'linear-gradient(45deg, #d1ecf1, #bee5eb)';
        statusElement.style.borderColor = '#17a2b8';
        statusElement.style.color = '#0c5460';
      }
      break;
      
    case 'offline':
      statusElement.innerHTML = `ğŸ”„ ${message || 'Usando datos de respaldo'}`;
      statusElement.style.background = 'linear-gradient(45deg, #e2e3e5, #d6d8db)';
      statusElement.style.borderColor = '#6c757d';
      statusElement.style.color = '#495057';
      break;
      
    case 'error':
      statusElement.innerHTML = `âŒ ${message || 'Error de conexiÃ³n'}`;
      statusElement.style.background = 'linear-gradient(45deg, #f8d7da, #f1b0b7)';
      statusElement.style.borderColor = '#dc3545';
      statusElement.style.color = '#721c24';
      break;
      
    default:
      statusElement.innerHTML = 'âš¡ Estado desconocido';
      statusElement.style.background = 'linear-gradient(45deg, #f8f9fa, #e9ecef)';
      statusElement.style.borderColor = '#dee2e6';
      statusElement.style.color = '#6c757d';
  }
  
  // No necesitamos actualizar estado del cachÃ©
}

function updatePriceAlert(prices, dataInfo = null) {
  const alertElement = document.getElementById("alerta");
  const currentHour = new Date().getHours();
  const currentPrice = prices[currentHour];

  let message, bgColor;

  if (currentPrice <= 0.08) {
    message = `âœ… Precio actual: ${formatPrice(currentPrice)} â‚¬/kWh. Â¡Precio bajo!`;
    bgColor = "#d5f4e6";
  } else if (currentPrice <= 0.12) {
    message = `âš ï¸ Precio actual: ${formatPrice(currentPrice)} â‚¬/kWh. Precio moderado.`;
    bgColor = "#fff3cd";
  } else {
    message = `âŒ Precio actual: ${formatPrice(currentPrice)} â‚¬/kWh. Precio alto.`;
    bgColor = "#f8d7da";
  }

  // Agregar informaciÃ³n sobre la fuente de datos - MEJORADO para ESIOS
  if (dataInfo) {
    const dateStr = dataInfo.date ? ` (${dataInfo.date})` : '';
    
    if (dataInfo.source === 'ESIOS API Oficial') {
      message += `<br><small style='color: #fff; font-weight: 800; background: linear-gradient(45deg, #e74c3c, #c0392b); padding: 6px 15px; border-radius: 20px; border: 3px solid #a93226; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4); text-transform: uppercase; letter-spacing: 0.5px;'>ğŸ† DATOS OFICIALES REE/ESIOS${dateStr}</small>`;
    } else if (dataInfo.source === 'REE API' || dataInfo.source === 'ESIOS API') {
      message += `<br><small style='color: #fff; font-weight: 700; background: linear-gradient(45deg, #27ae60, #2ecc71); padding: 4px 12px; border-radius: 15px; border: 2px solid #27ae60; box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);'>ğŸ¯ DATOS REALES de Red ElÃ©ctrica${dateStr}</small>`;
    } else if (dataInfo.source === 'Backup Data') {
      const typeInfo = dataInfo.isWeekend ? 'fin de semana' : 'entre semana';
      const seasonInfo = dataInfo.season ? ` (${dataInfo.season})` : '';
      message += `<br><small style='color: #fff; font-weight: 600; background: linear-gradient(45deg, #8e44ad, #9b59b6); padding: 4px 12px; border-radius: 15px; border: 2px solid #8e44ad; box-shadow: 0 2px 8px rgba(142, 68, 173, 0.3);'>ğŸ“ˆ SIMULACIÃ“N histÃ³rica ${typeInfo}${seasonInfo}${dateStr}</small>`;
    } else if (dataInfo.source === 'mock') {
      message += `<br><small style='color: #e74c3c; font-weight: 500;'>âš ï¸ Datos de ejemplo - APIs no disponibles</small>`;
    }
  }

  alertElement.innerHTML = message;
  alertElement.style.backgroundColor = bgColor;
}

function renderPriceChart(ctx, labels, prices, colors) {
  if (priceChart) {
    priceChart.destroy();
  }

  const currentHour = new Date().getHours();
  
  // Asegurar que los colores incluyan la hora actual destacada
  const updatedColors = colors.map((color, index) => 
    index === currentHour ? '#2196F3' : color
  );
  
  // Crear arrays para destacar la hora actual
  const borderColors = updatedColors.map((color, index) => 
    index === currentHour ? '#1976D2' : color
  );
  
  const borderWidths = colors.map((_, index) => 
    index === currentHour ? 4 : 1
  );

  // Plugin personalizado para mostrar el precio encima de la columna actual
  const priceDisplayPlugin = {
    id: 'priceDisplay',
    afterDatasetsDraw: function(chart, args, options) {
      const ctx = chart.ctx;
      const currentPrice = prices[currentHour];
      const meta = chart.getDatasetMeta(0);
      const currentBar = meta.data[currentHour];
      
      if (currentBar && currentPrice !== undefined) {
        ctx.save();
        
        // Configurar el texto del precio
        ctx.font = 'bold 16px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        
        const priceText = `${formatPrice(currentPrice)} â‚¬/kWh`;
        
        // Fondo blanco semi-transparente para el texto
        ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
        const textWidth = ctx.measureText(priceText).width;
        const textHeight = 22;
        const rectX = currentBar.x - (textWidth/2) - 8;
        const rectY = currentBar.y - 40;
        
        ctx.fillRect(rectX, rectY, textWidth + 16, textHeight);
        
        // Borde del fondo
        ctx.strokeStyle = '#1976D2';
        ctx.lineWidth = 2;
        ctx.strokeRect(rectX, rectY, textWidth + 16, textHeight);
        
        // Texto del precio
        ctx.fillStyle = '#1976D2';
        ctx.fillText(priceText, currentBar.x, currentBar.y - 22);
        
        // PequeÃ±a flecha apuntando a la columna
        ctx.beginPath();
        ctx.moveTo(currentBar.x, currentBar.y - 18);
        ctx.lineTo(currentBar.x - 6, currentBar.y - 12);
        ctx.lineTo(currentBar.x + 6, currentBar.y - 12);
        ctx.closePath();
        ctx.fillStyle = '#1976D2';
        ctx.fill();
        
        ctx.restore();
      }
    }
  };
  
  priceChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: "Precio (â‚¬/kWh) - Por hora",
        data: prices,
        backgroundColor: updatedColors,
        borderColor: borderColors,
        borderWidth: borderWidths,
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          max: Math.max(...prices) * 1.2,
          title: {
            display: true,
            text: "Precio (â‚¬/kWh)"
          }
        },
        x: {
          title: {
            display: true,
            text: "Hora del dÃ­a"
          }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            afterLabel: function(context) {
              if (context.dataIndex === currentHour) {
                return 'âš¡ HORA ACTUAL';
              }
              return '';
            }
          }
        }
      }
    },
    plugins: [priceDisplayPlugin]
  });
  
  console.log(`ğŸ“Š GrÃ¡fico actualizado - Vista normal (1 hora): ${labels.length} intervalos, hora actual: ${currentHour}`);
}

// ===== WEATHER FUNCTIONALITY =====
async function loadWeatherData() {
  const weatherElement = document.getElementById("weather");
  const weatherCtx = document.getElementById("weather-chart").getContext("2d");

  try {
    showLoading("weather");
    
    // PRIORIDAD MÃXIMA: Asegurar que currentLocation estÃ© configurado a Madrid por defecto
    if (!currentLocation || currentLocation.name !== 'Madrid') {
      console.log('ğŸ™ï¸ Configurando Madrid como ubicaciÃ³n por defecto para datos meteorolÃ³gicos');
      currentLocation = {
        name: 'Madrid',
        lat: 40.4168,
        lon: -3.7038,
        country: 'EspaÃ±a',
        detected: false
      };
    }
    
    console.log(`ğŸŒ¤ï¸ Iniciando carga de datos meteorolÃ³gicos para ${currentLocation.name}...`);
    
    // Probar la API de OpenWeatherMap al inicio (solo para diagnÃ³stico)
    testOpenWeatherMapAPI().then(isWorking => {
      console.log(`ğŸ”— Estado OpenWeatherMap API: ${isWorking ? 'âœ… Funcionando' : 'âŒ Con problemas'}`);
    }).catch(() => {
      console.log('ğŸ”— Estado OpenWeatherMap API: â“ No se pudo verificar');
    });
    
    // Intentar mÃºltiples estrategias para obtener datos reales de Madrid
    let weatherData = null;
    let dataSource = '';
    
    // ESTRATEGIA 1: Datos reales de la API
    try {
      weatherData = await fetchRealWeatherData();
      dataSource = 'Datos reales obtenidos desde API';
      console.log('âœ… Datos meteorolÃ³gicos reales cargados exitosamente');
    } catch (apiError) {
      console.warn('âš ï¸ Error al obtener datos reales:', apiError.message);
      
      // ESTRATEGIA 2: Forzar nueva llamada a API con diferentes parÃ¡metros
      try {
        console.log('ğŸ”„ Intentando llamada directa a API con timeout extendido...');
        weatherData = await fetchMadridWeatherDirect();
        dataSource = 'Datos reales obtenidos (llamada directa)';
        console.log('âœ… Datos meteorolÃ³gicos reales obtenidos en segundo intento');
      } catch (directError) {
        console.warn('âš ï¸ Error en llamada directa:', directError.message);
        
        // ESTRATEGIA 3: Usar datos simulados realistas especÃ­ficos para Madrid
        console.log('ğŸ² Generando datos simulados especÃ­ficos para Madrid...');
        weatherData = generateMadridSpecificWeatherData();
        dataSource = 'Datos simulados especÃ­ficos para Madrid (API no disponible)';
      }
    }
    
    // Actualizar la interfaz con los datos obtenidos
    updateWeatherDisplay(weatherElement, weatherData);
    renderWeatherChart(weatherCtx, weatherData);
    setupWeatherControls();
    
    // Mostrar el origen de los datos
    const sourceIndicator = weatherElement.querySelector('.weather-source') || 
                           document.createElement('div');
    sourceIndicator.className = 'weather-source';
    sourceIndicator.style.cssText = 'font-size: 0.8em; color: #666; margin-top: 5px; text-align: center;';
    sourceIndicator.textContent = `ğŸ“Š ${dataSource}`;
    
    if (!weatherElement.querySelector('.weather-source')) {
      weatherElement.appendChild(sourceIndicator);
    }
    
    hideLoading("weather");

  } catch (err) {
    hideLoading("weather");
    console.error("Error crÃ­tico en carga meteorolÃ³gica:", err);
    
    // Ãšltimo recurso: datos de emergencia para Madrid
    const emergencyData = generateMadridEmergencyWeatherData();
    updateWeatherDisplay(weatherElement, emergencyData);
    renderWeatherChart(weatherCtx, emergencyData);
    setupWeatherControls();
    
    weatherElement.innerHTML += "<br><div style='color: #e74c3c; font-size: 0.8em; text-align: center; margin-top: 5px;'>âš ï¸ Datos meteorolÃ³gicos de emergencia - Error en todas las fuentes</div>";
  }
}

// FunciÃ³n para refrescar datos meteorolÃ³gicos manualmente
async function refreshWeatherData() {
  console.log('ğŸ”„ Refrescando datos meteorolÃ³gicos...');
  
  // Limpiar todo el cachÃ© meteorolÃ³gico
  const cacheKey = `weather_${currentLocation.lat}_${currentLocation.lon}`;
  cache.delete(cacheKey);
  console.log(`ğŸ§¹ CachÃ© meteorolÃ³gico limpiado para ${currentLocation.name}`);
  
  // Mostrar mensaje de actualizaciÃ³n
  const weatherElement = document.getElementById("weather");
  const originalContent = weatherElement.innerHTML;
  weatherElement.innerHTML = '<span class="loading"></span>Actualizando datos meteorolÃ³gicos...';
  
  try {
    // Recargar datos meteorolÃ³gicos
    await loadWeatherData();
    console.log('âœ… Datos meteorolÃ³gicos actualizados correctamente');
  } catch (error) {
    console.error('âŒ Error al actualizar datos meteorolÃ³gicos:', error);
    weatherElement.innerHTML = originalContent + "<br><small style='color: #e74c3c;'>âš ï¸ Error al actualizar datos</small>";
  }
}

// FunciÃ³n para limpiar cachÃ© de sesiÃ³n manualmente
function clearSessionCache() {
  console.log('ğŸ§¹ Limpiando cachÃ© de sesiÃ³n...');
  
  try {
    cache.clearAll();
    
    // Mostrar confirmaciÃ³n
    const alertElement = document.getElementById("alerta");
    if (alertElement) {
      const originalContent = alertElement.innerHTML;
      alertElement.innerHTML = '<span style="color: #27ae60;">âœ… CachÃ© de sesiÃ³n limpiado correctamente</span>';
      
      setTimeout(() => {
        alertElement.innerHTML = originalContent;
      }, 3000);
    }
    
    // Refrescar automÃ¡ticamente los datos despuÃ©s de limpiar cachÃ©
    console.log('ğŸ”„ Refrescando datos tras limpiar cachÃ©...');
    setTimeout(() => {
      if (typeof loadElectricityPrices === 'function') {
        loadElectricityPrices();
      }
      if (typeof loadWeatherData === 'function') {
        loadWeatherData();
      }
    }, 500);
    
    console.log('âœ… CachÃ© de sesiÃ³n limpiado correctamente');
  } catch (error) {
    console.error('âŒ Error al limpiar cachÃ© de sesiÃ³n:', error);
    
    // Mostrar error al usuario
    const alertElement = document.getElementById("alerta");
    if (alertElement) {
      const originalContent = alertElement.innerHTML;
      alertElement.innerHTML = '<span style="color: #e74c3c;">âŒ Error al limpiar cachÃ©</span>';
      
      setTimeout(() => {
        alertElement.innerHTML = originalContent;
      }, 3000);
    }
  }
}

// FunciÃ³n para obtener datos de respaldo desde una fuente mÃ¡s simple
async function fetchBackupPriceData() {
  try {
    const today = new Date();
    const dayOfWeek = today.getDay(); // 0 = domingo, 6 = sÃ¡bado
    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
    
    // Patrones de precios realistas basados en datos histÃ³ricos espaÃ±oles
    // Precios mÃ¡s bajos en fin de semana, mÃ¡s altos entre semana
    const weekdayPattern = [
      0.085, 0.078, 0.072, 0.070, 0.075, 0.095, // 00-05: madrugada
      0.125, 0.165, 0.145, 0.125, 0.115, 0.105, // 06-11: maÃ±ana
      0.095, 0.085, 0.095, 0.115, 0.135, 0.165, // 12-17: tarde  
      0.195, 0.175, 0.155, 0.135, 0.115, 0.095  // 18-23: noche
    ];
    
    const weekendPattern = [
      0.075, 0.068, 0.062, 0.060, 0.065, 0.085, // 00-05: madrugada
      0.105, 0.135, 0.125, 0.105, 0.095, 0.085, // 06-11: maÃ±ana
      0.085, 0.075, 0.085, 0.095, 0.115, 0.145, // 12-17: tarde
      0.165, 0.155, 0.135, 0.115, 0.095, 0.085  // 18-23: noche
    ];
    
    const basePattern = isWeekend ? weekendPattern : weekdayPattern;
    
    const labels = [];
    const prices = [];
    const colors = [];
    
    // Agregar variaciÃ³n estacional (verano vs invierno)
    const month = today.getMonth();
    const isSummer = month >= 5 && month <= 8; // junio-septiembre
    const seasonalMultiplier = isSummer ? 1.15 : 0.95; // +15% verano, -5% invierno
    
    // Agregar variaciÃ³n aleatoria pequeÃ±a para simular mercado real
    const variation = 0.012; // Â±1.2 cÃ©ntimos
    const currentHour = today.getHours(); // Obtener hora actual
    
    // GARANTIZAR 24 HORAS COMPLETAS (0-23)
    for (let i = 0; i < 24; i++) {
      labels.push(`${i.toString().padStart(2, '0')}:00`);
      
      // Precio base con variaciones realistas
      const randomVariation = (Math.random() - 0.5) * variation;
      const seasonalPrice = basePattern[i] * seasonalMultiplier;
      const finalPrice = Math.max(0.045, seasonalPrice + randomVariation);
      
      prices.push(parseFloat(finalPrice.toFixed(4)));
      
      // Colores segÃºn precio - destacar hora actual
      if (i === currentHour) {
        colors.push('#2196F3'); // Azul brillante para la hora actual
      } else if (finalPrice < 0.10) {
        colors.push('#27ae60'); // Verde
      } else if (finalPrice < 0.15) {
        colors.push('#f39c12'); // Naranja
      } else {
        colors.push('#e74c3c'); // Rojo
      }
    }
    
    console.log(`ğŸ“Š Datos de respaldo generados: ${labels.length} horas (${labels[0]} - ${labels[labels.length-1]})`);
    
    return {
      labels: labels,
      prices: prices,
      colors: colors,
      source: 'Backup Data',
      date: today.toLocaleDateString('es-ES'),
      timestamp: new Date().toISOString(),
      isWeekend: isWeekend,
      season: isSummer ? 'verano' : 'invierno'
    };
    
  } catch (error) {
    console.error('Error en datos de respaldo:', error);
    throw error;
  }
}

// ===== FUNCIONES DEL SISTEMA DE SERVIDOR =====

// FunciÃ³n principal para obtener datos de electricidad desde el servidor
async function fetchServerElectricityData() {
  try {
    console.log('ğŸŒ Obteniendo datos de electricidad desde servidor...');
    
    const response = await fetch('./data/electricity-prices.json', {
      method: 'GET',
      headers: { 'Accept': 'application/json' },
      cache: 'no-cache' // Evitar cachÃ© del navegador para datos frescos
    });
    
    if (!response.ok) {
      throw new Error(`Error del servidor: HTTP ${response.status}`);
    }
    
    const serverData = await response.json();
    
    // Verificar que los datos son recientes (menos de 2 horas)
    const dataAge = Date.now() - new Date(serverData.lastUpdate).getTime();
    const maxAge = 2 * 60 * 60 * 1000; // 2 horas en milisegundos
    
    if (dataAge > maxAge) {
      console.warn('âš ï¸ Datos del servidor antiguos, intentando APIs directas...');
      throw new Error('Datos del servidor demasiado antiguos');
    }
    
    // Actualizar colores para la hora actual
    const currentHour = new Date().getHours();
    const updatedColors = serverData.prices.map((price, index) => {
      if (index === currentHour) {
        return '#2196F3'; // Azul para hora actual
      } else if (price < 0.10) {
        return '#27ae60'; // Verde
      } else if (price < 0.15) {
        return '#f39c12'; // Naranja
      } else {
        return '#e74c3c'; // Rojo
      }
    });
    
    const result = {
      ...serverData,
      colors: updatedColors,
      fromServer: true,
      dataAge: Math.round(dataAge / 60000) // edad en minutos
    };
    
    console.log(`âœ… Datos del servidor obtenidos (${result.dataAge} min de antigÃ¼edad)`);
    return result;
    
  } catch (error) {
    console.log('â„¹ï¸ Datos del servidor no disponibles:', error.message);
    throw error;
  }
}

// FunciÃ³n para obtener datos meteorolÃ³gicos desde el servidor
async function fetchServerWeatherData(cityName = 'Madrid') {
  try {
    console.log(`ğŸŒ Obteniendo datos de ${cityName} desde servidor local...`);
    
    const response = await fetch('./data/weather-data.json', {
      method: 'GET',
      headers: { 'Accept': 'application/json' },
      cache: 'no-cache'
    });

    if (!response.ok) {
      throw new Error(`Error del servidor: HTTP ${response.status}`);
    }

    const serverData = await response.json();
    
    // Verificar que los datos son recientes (menos de 1 hora)
    const dataAge = Date.now() - new Date(serverData.lastUpdate).getTime();
    const maxAge = 60 * 60 * 1000; // 1 hora en milisegundos

    if (dataAge > maxAge) {
      console.warn('âš ï¸ Datos meteorolÃ³gicos del servidor antiguos');
      throw new Error('Datos meteorolÃ³gicos del servidor antiguos');
    }

    // Obtener datos de la ciudad solicitada
    const cityData = serverData.cities[cityName];

    if (!cityData) {
      throw new Error(`Ciudad ${cityName} no disponible en datos del servidor`);
    }

    const result = {
      ...cityData,
      fromServer: true,
      dataAge: Math.round(dataAge / 60000), // edad en minutos
      availableCities: Object.keys(serverData.cities)
    };    console.log(`âœ… Datos meteorolÃ³gicos del servidor obtenidos para ${cityName} (${result.dataAge} min de antigÃ¼edad)`);
    return result;
    
  } catch (error) {
    console.log(`â„¹ï¸ Datos meteorolÃ³gicos del servidor no disponibles para ${cityName}:`, error.message);
    throw error;
  }
}

// FunciÃ³n para verificar el estado del sistema del servidor
async function checkServerStatus() {
  try {
    const promises = [
      fetch('./data/electricity-prices.json', { method: 'HEAD' }),
      fetch('./data/weather-data.json', { method: 'HEAD' }),
      fetch('./data/api-calls-counter.json', { method: 'GET' })
    ];
    
    const [electricityCheck, weatherCheck, counterResponse] = await Promise.allSettled(promises);
    
    const status = {
      electricity: electricityCheck.status === 'fulfilled' && electricityCheck.value.ok,
      weather: weatherCheck.status === 'fulfilled' && weatherCheck.value.ok,
      counter: null,
      serverAvailable: false
    };
    
    // Obtener contador si estÃ¡ disponible
    if (counterResponse.status === 'fulfilled' && counterResponse.value.ok) {
      try {
        status.counter = await counterResponse.value.json();
      } catch (e) {
        console.log('â„¹ï¸ Contador no disponible');
      }
    }
    
    status.serverAvailable = status.electricity || status.weather;
    
    console.log('ğŸ“Š Estado del servidor:', status);
    return status;
    
  } catch (error) {
    console.log('â„¹ï¸ Error verificando estado del servidor:', error.message);
    return { electricity: false, weather: false, counter: null, serverAvailable: false };
  }
}

// ===== FUNCIONES MODIFICADAS PARA USAR EL SERVIDOR =====

async function fetchRealPriceData() {
  // PRIORIDAD 1: Intentar datos del servidor
  try {
    const serverData = await fetchServerElectricityData();
    if (serverData) {
      updateApiStatus('online', `Servidor (${serverData.source}) - ${serverData.dataAge} min`);
      return serverData;
    }
  } catch (serverError) {
    console.log('â„¹ï¸ Servidor no disponible, usando APIs directas...');
  }
  
  // PRIORIDAD 2-3: APIs directas como respaldo
  try {
    const today = new Date();
    
    // ESIOS API con token oficial - PRIORIDAD 1
    try {
      console.log('ğŸ¯ Intentando ESIOS API oficial con token...');
      const esiosData = await fetchESIOSWithToken(today);
      if (esiosData) {
        console.log('âœ… Datos oficiales obtenidos de ESIOS');
        return esiosData;
      }
    } catch (esiosError) {
      console.log('â„¹ï¸ ESIOS con token fallÃ³:', esiosError.message);
    }
    
    // REE API pÃºblica - RESPALDO (con cachÃ©)
    try {
      console.log('ğŸ”„ Intentando REE API pÃºblica...');
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      
      const reeCacheKey = `ree_${today.toDateString()}`;
      
      // Verificar cachÃ© REE
      const cachedREEData = cache.get(reeCacheKey);
      if (cachedREEData) {
        console.log('ğŸ’¾ Usando datos REE desde cachÃ©');
        return cachedREEData;
      }
      
      const apiUrl = `https://apidatos.ree.es/es/datos/mercados/precios-mercados-tiempo-real?start_date=${year}-${month}-${day}T00:00&end_date=${year}-${month}-${day}T23:59&time_trunc=hour`;
      
      const response = await fetch(apiUrl, {
        method: 'GET',
        headers: { 'Accept': 'application/json' }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      const data = await response.json();
      const reeData = parseREEData(data, today);
      
      if (reeData && reeData.prices.length >= 20) {
        // Guardar en cachÃ© REE por 1 hora
        cache.set(reeCacheKey, reeData, CACHE_CONFIG.ELECTRICITY_TTL);
        console.log('âœ… Datos obtenidos de REE API pÃºblica y guardados en cachÃ©');
        return reeData;
      }
      
    } catch (reeError) {
      console.log('â„¹ï¸ REE API fallÃ³:', reeError.message);
    }
    
    throw new Error('Todas las APIs oficiales fallaron');
    
  } catch (error) {
    console.log(`â„¹ï¸ APIs oficiales no disponibles: ${error.message}`);
    throw error;
  }
}

// Nueva funciÃ³n para ESIOS con token oficial + CACHÃ‰
async function fetchESIOSWithToken(date) {
  const cacheKey = `esios_${date.toDateString()}`;
  
  // Intentar obtener del cachÃ© primero
  const cachedData = cache.get(cacheKey);
  if (cachedData) {
    console.log('ğŸ’¾ Usando datos de electricidad desde cachÃ©');
    return cachedData;
  }
  
  try {
    const ESIOS_TOKEN = 'cdc71b00d3883937477ddbf4cc1d987346b65a12de38d8addcb8765b66c9c58'; // Tu token oficial
    
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    
    // Endpoint oficial de ESIOS para PVPC
    const esiosUrl = `https://api.esios.ree.es/indicators/1001?start_date=${year}-${month}-${day}T00:00&end_date=${year}-${month}-${day}T23:59`;
    
    console.log('ğŸŒ Consultando ESIOS oficial (cachÃ© no disponible):', esiosUrl);
    
    const response = await fetch(esiosUrl, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'Authorization': `Token token=${ESIOS_TOKEN}`,
        'Host': 'api.esios.ree.es'
      }
    });
    
    if (!response.ok) {
      throw new Error(`ESIOS HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('ğŸ“Š Respuesta ESIOS recibida:', data);
    
    // Parsear datos de ESIOS
    if (data.indicator && data.indicator.values && Array.isArray(data.indicator.values)) {
      const values = data.indicator.values;
      
      if (values.length >= 10) { // Al menos algunos datos
        const currentHour = new Date().getHours();
        
        // Crear arrays para las 24 horas completas
        const labels = [];
        const prices = [];
        const colors = [];
        const hourlyData = new Array(24).fill(null);
        
        // Procesar datos de ESIOS y mapearlos por hora
        values.forEach(val => {
          if (val && val.value !== null && val.datetime) {
            const datetime = new Date(val.datetime);
            const hour = datetime.getHours();
            let price = parseFloat(val.value);
            
            // ESIOS devuelve precios en â‚¬/MWh, convertir a â‚¬/kWh
            if (price > 1) price = price / 1000;
            
            hourlyData[hour] = price;
          }
        });
        
        // Rellenar las 24 horas, interpolando valores faltantes
        for (let i = 0; i < 24; i++) {
          labels.push(`${i.toString().padStart(2, '0')}:00`);
          
          let price = hourlyData[i];
          
          // Si falta el dato, interpolar con horas cercanas
          if (price === null) {
            price = interpolatePrice(hourlyData, i);
          }
          
          prices.push(price);
          
          // Colores con hora actual destacada
          if (i === currentHour) {
            colors.push('#2196F3'); // Azul para hora actual
          } else if (price < 0.10) {
            colors.push('#27ae60'); // Verde
          } else if (price < 0.15) {
            colors.push('#f39c12'); // Naranja
          } else {
            colors.push('#e74c3c'); // Rojo
          }
        }
        
        const result = {
          labels,
          prices,
          colors,
          source: 'ESIOS API Oficial',
          date: date.toLocaleDateString('es-ES'),
          timestamp: new Date().toISOString(),
          official: true
        };
        
        // Guardar en cachÃ© por 1 hora
        cache.set(cacheKey, result, CACHE_CONFIG.ELECTRICITY_TTL);
        
        console.log(`ğŸ“Š ESIOS procesado y guardado en cachÃ©: ${labels.length} horas (${labels[0]} - ${labels[labels.length-1]})`);
        
        return result;
      }
    }
    
    throw new Error('Datos insuficientes en respuesta ESIOS');
    
  } catch (error) {
    console.error('âŒ Error en ESIOS:', error);
    throw error;
  }
}

// FunciÃ³n auxiliar para interpolar precios faltantes
function interpolatePrice(hourlyData, targetHour) {
  // Buscar valores vÃ¡lidos antes y despuÃ©s
  let beforePrice = null;
  let afterPrice = null;
  
  // Buscar hacia atrÃ¡s
  for (let i = targetHour - 1; i >= 0; i--) {
    if (hourlyData[i] !== null) {
      beforePrice = hourlyData[i];
      break;
    }
  }
  
  // Buscar hacia adelante
  for (let i = targetHour + 1; i < 24; i++) {
    if (hourlyData[i] !== null) {
      afterPrice = hourlyData[i];
      break;
    }
  }
  
  // Interpolar o usar valor por defecto
  if (beforePrice !== null && afterPrice !== null) {
    return (beforePrice + afterPrice) / 2;
  } else if (beforePrice !== null) {
    return beforePrice;
  } else if (afterPrice !== null) {
    return afterPrice;
  } else {
    // Valor por defecto basado en patrones tÃ­picos espaÃ±oles
    const defaultPrices = [0.08, 0.07, 0.06, 0.06, 0.07, 0.09, 0.12, 0.15, 0.13, 0.11, 0.10, 0.09, 0.08, 0.07, 0.08, 0.10, 0.12, 0.15, 0.18, 0.16, 0.14, 0.12, 0.10, 0.09];
    return defaultPrices[targetHour] || 0.10;
  }
}

// FunciÃ³n para parsear datos de ESIOS
function parseESIOSData(data, date) {
  try {
    if (!data || !data.PVPC) {
      throw new Error('Formato ESIOS no vÃ¡lido');
    }
    
    const pvpcData = data.PVPC;
    const labels = [];
    const prices = [];
    const colors = [];
    
    // ESIOS devuelve datos por horas
    for (let hour = 0; hour < 24; hour++) {
      const hourKey = `${hour.toString().padStart(2, '0')}-${(hour + 1).toString().padStart(2, '0')}`;
      const priceValue = pvpcData[hourKey];
      
      if (priceValue !== undefined) {
        labels.push(`${hour.toString().padStart(2, '0')}:00`);
        const price = parseFloat(priceValue) / 1000; // Convertir a â‚¬/kWh
        prices.push(price);
        
        // Asignar colores
        if (price < 0.10) {
          colors.push('#27ae60');
        } else if (price < 0.20) {
          colors.push('#f39c12');
        } else {
          colors.push('#e74c3c');
        }
      }
    }
    
    return {
      labels: labels,
      prices: prices,
      colors: colors,
      source: 'ESIOS API',
      date: date.toLocaleDateString('es-ES'),
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    console.error('Error parseando datos ESIOS:', error);
    return null;
  }
}

// FunciÃ³n para parsear datos de REE (funciÃ³n original mejorada)
function parseREEData(data, date) {
  try {
    if (!data.included || !Array.isArray(data.included) || data.included.length === 0) {
      throw new Error('Formato REE no vÃ¡lido');
    }
    
    // Buscar los datos de PVPC
    let pvpcData = null;
    for (const item of data.included) {
      if (item.type === 'PVPC' || 
          (item.attributes && item.attributes.title && 
           (item.attributes.title.toLowerCase().includes('pvpc') ||
            item.attributes.title.toLowerCase().includes('precio') ||
            item.attributes.title.toLowerCase().includes('mercado'))) ||
          (item.attributes && item.attributes.description && 
           (item.attributes.description.toLowerCase().includes('pvpc') ||
            item.attributes.description.toLowerCase().includes('precio')))) {
        pvpcData = item;
        break;
      }
    }
    
    if (!pvpcData || !pvpcData.attributes || !pvpcData.attributes.values) {
      // Intentar con el primer elemento que tenga valores
      for (const item of data.included) {
        if (item.attributes && item.attributes.values && Array.isArray(item.attributes.values) && item.attributes.values.length > 0) {
          pvpcData = item;
          break;
        }
      }
    }
    
    if (!pvpcData || !pvpcData.attributes || !pvpcData.attributes.values) {
      throw new Error('No se encontraron datos de precios vÃ¡lidos');
    }
    
    const priceValues = pvpcData.attributes.values;
    const currentHour = new Date().getHours();
    
    // Crear arrays para las 24 horas completas
    const labels = [];
    const prices = [];
    const colors = [];
    const hourlyData = new Array(24).fill(null);
    
    // Mapear datos por hora
    for (const item of priceValues) {
      if (!item.datetime || item.value === null || item.value === undefined) {
        continue;
      }
      
      const datetime = new Date(item.datetime);
      const hour = datetime.getHours();
      let price = parseFloat(item.value);
      
      // Detectar si estÃ¡ en â‚¬/MWh o â‚¬/kWh
      if (price > 1) {
        price = price / 1000;
      }
      
      hourlyData[hour] = price;
    }
    
    // Generar las 24 horas completas
    for (let i = 0; i < 24; i++) {
      labels.push(`${i.toString().padStart(2, '0')}:00`);
      
      let price = hourlyData[i];
      
      // Si falta el dato, interpolar
      if (price === null) {
        price = interpolatePrice(hourlyData, i);
      }
      
      prices.push(price);
      
      // Colores con hora actual destacada
      if (i === currentHour) {
        colors.push('#2196F3'); // Azul para hora actual
      } else if (price < 0.10) {
        colors.push('#27ae60'); // Verde
      } else if (price < 0.20) {
        colors.push('#f39c12'); // Naranja
      } else {
        colors.push('#e74c3c'); // Rojo
      }
    }
    
    console.log(`ğŸ“Š REE procesado: ${labels.length} horas (${labels[0]} - ${labels[labels.length-1]})`);
    
    return {
      labels: labels,
      prices: prices,
      colors: colors,
      source: 'REE API',
      date: date.toLocaleDateString('es-ES'),
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    console.error('Error parseando datos REE:', error);
    return null;
  }
}

async function fetchRealWeatherData() {
  console.log(`ğŸŒ¤ï¸ Obteniendo datos meteorolÃ³gicos para ${currentLocation.name}...`);
  
  let lastError = null;
  
  // PRIORIDAD 1: Intentar datos del servidor local
  try {
    const serverData = await fetchServerWeatherData(currentLocation.name);
    if (serverData) {
      console.log(`âœ… Datos del servidor obtenidos para ${currentLocation.name}`);
      return {
        ...serverData,
        fromServer: true,
        source: 'Servidor Local'
      };
    }
  } catch (serverError) {
    lastError = serverError;
    console.log('â„¹ï¸ Servidor local no disponible, intentando otras fuentes...');
  }
  
  // PRIORIDAD 2: Usar cachÃ© existente
  const lat = currentLocation.lat;
  const lon = currentLocation.lon;
  const cacheKey = `weather_${lat}_${lon}`;
  
  const cachedData = cache.get(cacheKey);
  if (cachedData) {
    console.log('ğŸ’¾ Usando datos meteorolÃ³gicos desde cachÃ©');
    return {
      ...cachedData,
      source: 'CachÃ© Local',
      cached: true
    };
  }
  
  // PRIORIDAD 3: API directa con mÃºltiples fuentes
  const apis = [
    // API 1: Open-Meteo (gratuita, sin clave API)
    {
      name: 'Open-Meteo',
      key: 'none',
      url: `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,relative_humidity_2m,precipitation_probability&forecast_days=1&timezone=Europe/Madrid`
    },
    // API 2: WeatherAPI (gratuita hasta 1M llamadas)
    {
      name: 'WeatherAPI',
      key: 'f8c8a07ca4d14d6f8f994503241708',
      url: `https://api.weatherapi.com/v1/forecast.json?key=f8c8a07ca4d14d6f8f994503241708&q=${lat},${lon}&hours=8&lang=es`
    },
    // API 3: OpenWeatherMap (API vÃ¡lida confirmada)
    {
      name: 'OpenWeatherMap',
      key: '8631fe126bc353af0836dbc76cfac520',
      url: `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=8631fe126bc353af0836dbc76cfac520&units=metric&lang=es`
    },
    // API 4: OpenWeatherMap Forecast (pronÃ³stico horario)
    {
      name: 'OpenWeatherMap Forecast',
      key: '8631fe126bc353af0836dbc76cfac520',
      url: `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=8631fe126bc353af0836dbc76cfac520&units=metric&lang=es&cnt=8`
    }
  ];
  
  // FunciÃ³n para procesar diferentes formatos de respuesta API
  function processApiResponse(data, apiName) {
    try {
      switch (apiName) {
        case 'Open-Meteo':
          return processOpenMeteoData(data);
        case 'WeatherAPI':
          return processWeatherAPIData(data);
        case 'OpenWeatherMap':
          return processOpenWeatherMapData(data);
        case 'OpenWeatherMap Forecast':
          return processOpenWeatherMapForecastData(data);
        case 'Weatherstack':
          return processWeatherstackData(data);
        default:
          throw new Error('Formato de API no reconocido');
      }
    } catch (error) {
      console.error(`Error procesando datos de ${apiName}:`, error);
      throw error;
    }
  }
  
  // Verificar lÃ­mite de llamadas diarias
  if (!cache.canMakeWeatherCall()) {
    console.warn('âš ï¸ LÃ­mite diario de llamadas meteorolÃ³gicas alcanzado');
    throw new Error('LÃ­mite diario de llamadas meteorolÃ³gicas alcanzado. Usando datos de respaldo.');
  }
  
  // Intentar con cada API
  for (const api of apis) {
    try {
      console.log(`ğŸŒ¤ï¸ Intentando ${api.name}...`);
      
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000);
      
      const response = await fetch(api.url, {
        signal: controller.signal,
        headers: {
          'Accept': 'application/json',
          'User-Agent': 'PRECIO-LUZ-ESP/1.0'
        }
      });
      
      clearTimeout(timeoutId);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      // Incrementar contador de llamadas
      cache.incrementWeatherCallCounter();
      
      const data = await response.json();
      
      console.log(`âœ… Datos meteorolÃ³gicos obtenidos desde ${api.name}`);
      
      // Procesar los datos segÃºn el tipo de API
      const weatherData = processApiResponse(data, api.name);
      
      // AÃ±adir metadatos
      weatherData.source = api.name;
      weatherData.cached = false;
      weatherData.timestamp = new Date().toISOString();
      
      // Guardar en cachÃ© por 30 minutos
      cache.set(cacheKey, weatherData, CACHE_CONFIG.WEATHER_TTL);
      
      return weatherData;
      
    } catch (error) {
      lastError = error;
      console.warn(`âŒ Error con ${api.name}: ${error.message}`);
      continue; // Intentar siguiente API
    }
  }
  
  // Si llegamos aquÃ­, todas las APIs fallaron
  console.error('âŒ Todas las APIs meteorolÃ³gicas fallaron');
  throw new Error(`Error en APIs meteorolÃ³gicas: ${lastError?.message || 'APIs no disponibles'}`);
}

// ===== PROCESADORES DE DATOS POR TIPO DE API =====

// Procesador para Open-Meteo API
function processOpenMeteoData(data) {
  if (!data || !data.hourly) {
    throw new Error('Datos de Open-Meteo invÃ¡lidos');
  }
  
  const hours = data.hourly;
  const maxItems = Math.min(8, hours.time.length);
  
  const labels = [];
  const temperatures = [];
  const humidity = [];
  const precipitation = [];
  
  for (let i = 0; i < maxItems; i++) {
    const date = new Date(hours.time[i]);
    labels.push(`${date.getHours().toString().padStart(2, '0')}:00`);
    temperatures.push(Math.round(hours.temperature_2m[i]));
    humidity.push(Math.round(hours.relative_humidity_2m[i]));
    precipitation.push(Math.round(hours.precipitation_probability[i] || 0));
  }
  
  return {
    labels,
    temperatures,
    humidity,
    precipitation,
    current: {
      description: 'datos actuales de Open-Meteo',
      temp: temperatures[0],
      humidity: humidity[0],
      precipitation: precipitation[0],
      city: currentLocation.name
    }
  };
}

// Procesador para WeatherAPI
function processWeatherAPIData(data) {
  if (!data || !data.forecast || !data.forecast.forecastday) {
    throw new Error('Datos de WeatherAPI invÃ¡lidos');
  }
  
  const hours = data.forecast.forecastday[0].hour;
  const maxItems = Math.min(8, hours.length);
  
  const labels = [];
  const temperatures = [];
  const humidity = [];
  const precipitation = [];
  
  for (let i = 0; i < maxItems; i++) {
    const date = new Date(hours[i].time);
    labels.push(`${date.getHours().toString().padStart(2, '0')}:00`);
    temperatures.push(Math.round(hours[i].temp_c));
    humidity.push(Math.round(hours[i].humidity));
    precipitation.push(Math.round(hours[i].chance_of_rain || 0));
  }
  
  return {
    labels,
    temperatures,
    humidity,
    precipitation,
    current: {
      description: data.current?.condition?.text || 'datos actuales WeatherAPI',
      temp: temperatures[0],
      humidity: humidity[0],
      precipitation: precipitation[0],
      city: currentLocation.name
    }
  };
}

// Procesador para OpenWeatherMap
// Procesador para OpenWeatherMap - Clima Actual (endpoint weather)
function processOpenWeatherMapData(data) {
  if (!data || !data.main || !data.weather) {
    throw new Error('Datos de OpenWeatherMap (clima actual) invÃ¡lidos');
  }
  
  const now = new Date();
  const labels = [];
  const temperatures = [];
  const humidity = [];
  const precipitation = [];
  
  // Para clima actual, generar proyecciÃ³n horaria basada en el estado actual
  for (let i = 0; i < 8; i++) {
    const hour = new Date(now.getTime() + i * 3 * 60 * 60 * 1000);
    labels.push(`${hour.getHours().toString().padStart(2, '0')}:00`);
    
    // Simular variaciÃ³n horaria realista basada en el clima actual
    const tempVariation = (Math.random() - 0.5) * 3;
    temperatures.push(Math.round(data.main.temp + tempVariation));
    
    const humidityVariation = (Math.random() - 0.5) * 10;
    humidity.push(Math.round(Math.max(30, Math.min(90, data.main.humidity + humidityVariation))));
    
    // PrecipitaciÃ³n basada en las condiciones actuales
    const hasRain = data.weather[0].main.toLowerCase().includes('rain');
    precipitation.push(hasRain ? Math.round(Math.random() * 40 + 10) : Math.round(Math.random() * 10));
  }
  
  return {
    labels,
    temperatures,
    humidity,
    precipitation,
    current: {
      description: data.weather[0].description,
      temp: Math.round(data.main.temp),
      humidity: Math.round(data.main.humidity),
      precipitation: precipitation[0],
      city: currentLocation.name
    }
  };
}

// Procesador para OpenWeatherMap - Forecast (endpoint forecast)
function processOpenWeatherMapForecastData(data) {
  if (!data || !data.list || data.list.length === 0) {
    throw new Error('Datos de OpenWeatherMap (forecast) invÃ¡lidos');
  }
  
  const hourlyForecast = data.list;
  const maxItems = Math.min(8, hourlyForecast.length);
  
  const labels = [];
  const temperatures = [];
  const humidity = [];
  const precipitation = [];
  
  for (let i = 0; i < maxItems; i++) {
    const item = hourlyForecast[i];
    const date = new Date(item.dt * 1000);
    labels.push(`${date.getHours().toString().padStart(2, '0')}:00`);
    temperatures.push(Math.round(item.main.temp));
    humidity.push(Math.round(item.main.humidity));
    precipitation.push(Math.round((item.pop || 0) * 100));
  }
  
  return {
    labels,
    temperatures,
    humidity,
    precipitation,
    current: {
      description: hourlyForecast[0].weather[0].description,
      temp: temperatures[0],
      humidity: humidity[0],
      precipitation: precipitation[0],
      city: currentLocation.name
    }
  };
}

// Procesador para Weatherstack
function processWeatherstackData(data) {
  if (!data || !data.forecast) {
    throw new Error('Datos de Weatherstack invÃ¡lidos');
  }
  
  const current = data.current;
  const forecast = Object.values(data.forecast)[0]; // Primer dÃ­a
  
  // Weatherstack tiene datos por horas en formato diferente
  const labels = ['Ahora', '3h', '6h', '9h', '12h', '15h', '18h', '21h'];
  const temperatures = [current.temperature];
  const humidity = [current.humidity];
  const precipitation = [current.precip || 0];
  
  // Simular datos horarios basados en el actual (Weatherstack free no tiene datos horarios)
  for (let i = 1; i < 8; i++) {
    temperatures.push(Math.round(current.temperature + (Math.random() - 0.5) * 4));
    humidity.push(Math.round(Math.max(30, Math.min(90, current.humidity + (Math.random() - 0.5) * 10))));
    precipitation.push(Math.round(Math.max(0, current.precip + (Math.random() - 0.5) * 5)));
  }
  
  return {
    labels,
    temperatures,
    humidity,
    precipitation,
    current: {
      description: current.weather_descriptions[0] || 'datos Weatherstack',
      temp: Math.round(current.temperature),
      humidity: Math.round(current.humidity),
      precipitation: Math.round(current.precip || 0),
      city: currentLocation.name
    }
  };
}

// FunciÃ³n para llamada directa a la API de Madrid con configuraciÃ³n optimizada
async function fetchMadridWeatherDirect() {
  console.log('ğŸŒ¤ï¸ Realizando llamada directa para Madrid...');
  
  const madridLat = 40.4168;
  const madridLon = -3.7038;
  
  // Intentar primero con Open-Meteo (gratuita)
  try {
    console.log('ğŸŒ Intentando Open-Meteo para Madrid...');
    const openMeteoUrl = `https://api.open-meteo.com/v1/forecast?latitude=${madridLat}&longitude=${madridLon}&hourly=temperature_2m,relative_humidity_2m,precipitation_probability&forecast_days=1&timezone=Europe/Madrid`;
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 8000);
    
    const response = await fetch(openMeteoUrl, {
      signal: controller.signal,
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'User-Agent': 'PRECIO-LUZ-ESP/1.0'
      }
    });
    
    clearTimeout(timeoutId);
    
    if (response.ok) {
      const data = await response.json();
      console.log('âœ… Datos reales de Madrid obtenidos desde Open-Meteo');
      
      const weatherData = processOpenMeteoData(data);
      return {
        ...weatherData,
        source: 'Open-Meteo API Directa',
        cached: false,
        timestamp: new Date().toISOString()
      };
    }
  } catch (openMeteoError) {
    console.warn('âš ï¸ Open-Meteo fallÃ³, intentando OpenWeatherMap:', openMeteoError.message);
  }
  
  // Respaldo con OpenWeatherMap (clave API vÃ¡lida)
  try {
    console.log('ğŸŒ¤ï¸ Intentando OpenWeatherMap para Madrid...');
    const owmUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${madridLat}&lon=${madridLon}&appid=8631fe126bc353af0836dbc76cfac520&units=metric&lang=es`;
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000);
    
    const response = await fetch(owmUrl, {
      signal: controller.signal,
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Cache-Control': 'no-cache',
        'User-Agent': 'PRECIO-LUZ-ESP/1.0'
      }
    });
    
    clearTimeout(timeoutId);
    
    if (response.ok) {
      const data = await response.json();
      console.log('âœ… Datos reales de Madrid obtenidos desde OpenWeatherMap');
      
      const weatherData = processOpenWeatherMapData(data);
      return {
        ...weatherData,
        source: 'OpenWeatherMap API Directa',
        cached: false,
        timestamp: new Date().toISOString()
      };
    } else {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
  } catch (owmError) {
    console.error('âŒ Error en todas las APIs directas:', owmError.message);
    throw new Error('Todas las APIs directas fallaron');
  }
}

// FunciÃ³n para probar la conectividad de OpenWeatherMap con la clave API
async function testOpenWeatherMapAPI() {
  console.log('ğŸ§ª Probando conectividad con OpenWeatherMap...');
  
  const apiKey = '8631fe126bc353af0836dbc76cfac520';
  const testUrl = `https://api.openweathermap.org/data/2.5/weather?q=Madrid,ES&appid=${apiKey}&units=metric&lang=es`;
  
  try {
    const response = await fetch(testUrl, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'User-Agent': 'PRECIO-LUZ-ESP/1.0'
      }
    });
    
    if (response.ok) {
      const data = await response.json();
      console.log('âœ… OpenWeatherMap API funcionando correctamente');
      console.log(`ğŸ“ Datos obtenidos para ${data.name}: ${Math.round(data.main.temp)}Â°C, ${data.weather[0].description}`);
      return true;
    } else {
      console.error(`âŒ Error HTTP ${response.status}: ${response.statusText}`);
      return false;
    }
  } catch (error) {
    console.error('âŒ Error de conectividad:', error.message);
    return false;
  }
}

// FunciÃ³n para generar datos simulados especÃ­ficos y realistas para Madrid
function generateMadridSpecificWeatherData() {
  console.log('ğŸ™ï¸ Generando datos meteorolÃ³gicos especÃ­ficos para Madrid...');
  
  const now = new Date();
  const currentHour = now.getHours();
  const month = now.getMonth(); // 0-11
  const labels = [];
  
  // Generar etiquetas para las prÃ³ximas 8 horas (intervalos de 3h)
  for (let i = 0; i < 8; i++) {
    const hour = (currentHour + i * 3) % 24;
    labels.push(`${hour.toString().padStart(2, '0')}:00`);
  }
  
  // Temperaturas realistas para Madrid segÃºn la Ã©poca del aÃ±o
  let baseTemp;
  const isWinter = month === 11 || month === 0 || month === 1 || month === 2;
  const isSummer = month >= 5 && month <= 8;
  
  if (isWinter) {
    baseTemp = Math.random() * 10 + 5; // 5-15Â°C en invierno
  } else if (isSummer) {
    baseTemp = Math.random() * 15 + 25; // 25-40Â°C en verano
  } else {
    baseTemp = Math.random() * 10 + 15; // 15-25Â°C primavera/otoÃ±o
  }
  
  // VariaciÃ³n realista por hora del dÃ­a
  const temperatures = labels.map((_, i) => {
    const hour = (currentHour + i * 3) % 24;
    let tempVariation = 0;
    
    // Ciclo diario natural
    if (hour >= 6 && hour <= 12) tempVariation = 2; // MaÃ±ana
    else if (hour >= 13 && hour <= 16) tempVariation = 4; // Tarde (mÃ¡s calor)
    else if (hour >= 17 && hour <= 20) tempVariation = 1; // Atardecer
    else tempVariation = -3; // Noche (mÃ¡s frÃ­o)
    
    return Math.round(baseTemp + tempVariation + (Math.random() - 0.5) * 3);
  });
  
  // Humedad tÃ­pica de Madrid (continental)
  const baseHumidity = isWinter ? 65 : isSummer ? 35 : 50;
  const humidity = labels.map(() => {
    return Math.round(Math.max(20, Math.min(90, baseHumidity + (Math.random() - 0.5) * 20)));
  });
  
  // Precipitaciones (Madrid es bastante seco)
  const precipitation = labels.map(() => {
    if (Math.random() < 0.2) { // 20% probabilidad de lluvia
      return Math.round(Math.random() * 30); // 0-30% probabilidad
    }
    return Math.round(Math.random() * 5); // Generalmente bajo
  });
  
  return {
    labels,
    temperatures,
    humidity,
    precipitation,
    current: {
      description: 'datos estimados actuales',
      temp: temperatures[0],
      humidity: humidity[0],
      precipitation: precipitation[0],
      city: 'Madrid'
    },
    source: 'SimulaciÃ³n especÃ­fica Madrid',
    cached: false,
    timestamp: new Date().toISOString()
  };
}

// FunciÃ³n de emergencia para datos mÃ­nimos de Madrid
function generateMadridEmergencyWeatherData() {
  console.log('ğŸš¨ Generando datos meteorolÃ³gicos de emergencia para Madrid...');
  
  const now = new Date();
  const month = now.getMonth();
  
  // Temperaturas promedio histÃ³ricas para Madrid por mes
  const madridAvgTemps = [9, 11, 15, 17, 21, 26, 29, 28, 24, 18, 12, 9];
  const baseTemp = madridAvgTemps[month];
  
  return {
    labels: ['Ahora', '3h', '6h', '9h', '12h', '15h', '18h', '21h'],
    temperatures: [baseTemp, baseTemp + 2, baseTemp + 3, baseTemp + 1, baseTemp - 1, baseTemp - 2, baseTemp - 3, baseTemp - 1],
    humidity: [50, 52, 48, 45, 47, 50, 55, 53],
    precipitation: [0, 5, 0, 0, 10, 5, 0, 0],
    current: {
      description: 'datos histÃ³ricos promedio',
      temp: baseTemp,
      humidity: 50,
      precipitation: 0,
      city: 'Madrid'
    },
    source: 'Datos histÃ³ricos de emergencia',
    cached: false,
    timestamp: new Date().toISOString()
  };
}

function generateMockWeatherData() {
  console.log('ğŸ² Generando datos meteorolÃ³gicos de respaldo realistas...');
  
  const now = new Date();
  const currentHour = now.getHours();
  const labels = [];
  
  // Generar etiquetas para las prÃ³ximas 8 horas
  for (let i = 0; i < 8; i++) {
    const hour = (currentHour + i * 3) % 24;
    labels.push(`${hour.toString().padStart(2, '0')}:00`);
  }
  
  // Datos realistas basados en la ubicaciÃ³n y estaciÃ³n del aÃ±o
  const month = now.getMonth(); // 0-11
  const isWinter = month === 11 || month === 0 || month === 1 || month === 2;
  const isSummer = month >= 5 && month <= 8;
  
  // Temperatura base segÃºn ubicaciÃ³n (aproximada por latitud)
  let baseTemp = 15; // Default para centro de EspaÃ±a
  if (currentLocation.lat > 43) baseTemp = 12; // Norte (mÃ¡s frÃ­o)
  else if (currentLocation.lat < 37) baseTemp = 20; // Sur (mÃ¡s cÃ¡lido)
  
  // Ajuste estacional
  if (isWinter) baseTemp -= 8;
  else if (isSummer) baseTemp += 12;
  
  // Generar variaciÃ³n natural durante el dÃ­a
  const temperatures = labels.map((label, i) => {
    const hour = parseInt(label.split(':')[0]);
    let tempVariation = 0;
    
    // VariaciÃ³n tÃ­pica diaria
    if (hour >= 6 && hour <= 12) tempVariation = (hour - 6) * 0.5; // Subida matutina
    else if (hour >= 13 && hour <= 18) tempVariation = 3; // MÃ¡xima tarde
    else if (hour >= 19 && hour <= 23) tempVariation = 3 - (hour - 18) * 0.6; // Bajada nocturna
    else tempVariation = -2; // MÃ­nima madrugada
    
    return Math.round(baseTemp + tempVariation + (Math.random() - 0.5) * 3);
  });
  
  // Humedad tÃ­pica espaÃ±ola (varÃ­a segÃºn regiÃ³n)
  const baseHumidity = currentLocation.lat > 43 ? 70 : // Norte (mÃ¡s hÃºmedo)
                       currentLocation.lat < 37 ? 45 : // Sur (mÃ¡s seco)  
                       60; // Centro
  
  const humidity = labels.map(() => 
    Math.round(Math.max(30, Math.min(90, baseHumidity + (Math.random() - 0.5) * 20)))
  );
  
  // PrecipitaciÃ³n segÃºn regiÃ³n y estaciÃ³n
  const rainChance = currentLocation.lat > 43 ? 0.3 : // Norte (mÃ¡s lluvia)
                     isSummer ? 0.1 : // Verano seco
                     0.2; // Default
  
  const precipitation = labels.map(() => 
    Math.random() < rainChance ? Math.round(Math.random() * 80) : Math.round(Math.random() * 15)
  );
  
  // Condiciones actuales
  const currentTemp = temperatures[0];
  const currentConditions = [
    'cielo despejado', 'algunas nubes', 'nubes dispersas', 
    'muy nuboso', 'lluvia ligera', 'soleado'
  ];
  
  let description = currentConditions[0]; // Default: despejado
  if (precipitation[0] > 50) description = 'lluvia ligera';
  else if (precipitation[0] > 20) description = 'nubes dispersas';
  else if (Math.random() > 0.7) description = currentConditions[Math.floor(Math.random() * currentConditions.length)];

  const mockData = {
    labels,
    temperatures,
    humidity,
    precipitation,
    current: {
      description,
      temp: currentTemp,
      humidity: humidity[0],
      precipitation: precipitation[0],
      city: currentLocation.name
    },
    source: 'Datos de Respaldo',
    cached: false,
    timestamp: now.toISOString(),
    location: {
      name: currentLocation.name,
      lat: currentLocation.lat,
      lon: currentLocation.lon
    }
  };
  
  console.log(`ğŸ² Datos de respaldo generados para ${currentLocation.name}:`, {
    temp: `${currentTemp}Â°C`,
    humidity: `${humidity[0]}%`,
    description
  });
  
  return mockData;
}

function updateWeatherDisplay(element, data) {
  const { current } = data;
  const cityName = current.city || currentLocation.name || 'Madrid';
  
  // InformaciÃ³n sobre el origen de los datos
  const sourceInfo = data.fromServer ? 'ğŸ–¥ï¸ Servidor' : 'ğŸŒ OpenWeatherMap';
  const locationStatus = currentLocation.detected ? 'ğŸ“ Detectada' : 
                        currentLocation.name === 'Madrid' ? 'âš™ï¸ Por defecto' : 
                        'ğŸ‘† Seleccionada';
  
  // Generar alertas y recomendaciones
  const { alerts, recommendations } = generateWeatherAlerts(current, data);
  const energyTips = getEnergyRecommendations(current, globalPrices);
  
  element.innerHTML = `
  <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 25px; border-radius: 16px; margin: 15px 0; color: #2c3e50; position: relative; overflow: hidden; border: 2px solid #dee2e6;">
    
    <!-- Header con ubicaciÃ³n y fuente -->
    <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px; flex-direction: column; gap: 8px;">
      <h4 style="margin: 0; font-size: 1.3rem; text-shadow: none; color: #2c3e50;">
        ğŸ“ ${cityName}, EspaÃ±a
      </h4>
      <div style="display: flex; gap: 15px; font-size: 0.85rem; color: #6c757d;">
        <span style="background: rgba(52, 152, 219, 0.1); padding: 4px 8px; border-radius: 8px; border: 1px solid rgba(52, 152, 219, 0.2);">
          ${locationStatus}
        </span>
        <span style="background: rgba(40, 167, 69, 0.1); padding: 4px 8px; border-radius: 8px; border: 1px solid rgba(40, 167, 69, 0.2);">
          ${sourceInfo}
        </span>
      </div>
    </div>
    
    <!-- Grid principal con datos -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px;">
      
      <!-- Temperatura principal -->
      <div style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 12px; text-align: center; border: 2px solid rgba(52, 152, 219, 0.2);">
        <div style="font-size: 2.2rem; margin-bottom: 5px;">ğŸŒ¡ï¸</div>
        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 5px; color: #e74c3c;">${current.temp}Â°C</div>
        <div style="font-size: 0.9rem; opacity: 0.8; color: #2c3e50;">Temperatura</div>
      </div>
      
      <!-- Condiciones -->
      <div style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 12px; text-align: center; border: 2px solid rgba(52, 152, 219, 0.2);">
        <div style="font-size: 2.2rem; margin-bottom: 5px;">${getWeatherIcon(current.description)}</div>
        <div style="font-size: 1rem; font-weight: 600; margin-bottom: 5px; text-transform: capitalize; color: #2c3e50;">${current.description}</div>
        <div style="font-size: 0.9rem; opacity: 0.8; color: #2c3e50;">Condiciones</div>
      </div>
      
      <!-- Humedad -->
      <div style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 12px; text-align: center; border: 2px solid rgba(52, 152, 219, 0.2);">
        <div style="font-size: 2.2rem; margin-bottom: 5px;">ğŸ’§</div>
        <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; color: #3498db;">${Math.round(current.humidity)}%</div>
        <div style="font-size: 0.9rem; opacity: 0.8; color: #2c3e50;">Humedad</div>
      </div>
      
      <!-- Probabilidad de lluvia -->
      <div style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 12px; text-align: center; border: 2px solid rgba(52, 152, 219, 0.2);">
        <div style="font-size: 2.2rem; margin-bottom: 5px;">ğŸŒ§ï¸</div>
        <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; color: #3498db;">${Math.round(current.precipitation)}%</div>
        <div style="font-size: 0.9rem; opacity: 0.8; color: #2c3e50;">Prob. lluvia</div>
      </div>
      
    </div>
    
    <!-- Barra de sensaciÃ³n tÃ©rmica -->
    <div style="background: rgba(108, 117, 125, 0.1); padding: 12px; border-radius: 12px; border: 2px solid rgba(108, 117, 125, 0.2);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <span style="font-size: 0.95rem; font-weight: 600; color: #2c3e50;">ğŸŒ¡ï¸ SensaciÃ³n tÃ©rmica</span>
        <span style="font-size: 1.1rem; font-weight: bold; color: #e74c3c;">${getThermalSensation(current.temp, current.humidity)}</span>
      </div>
      <div style="background: rgba(108, 117, 125, 0.2); height: 8px; border-radius: 4px; overflow: hidden;">
        <div style="background: ${getThermalColor(current.temp)}; height: 100%; width: ${Math.min((current.temp / 50) * 100, 100)}%; border-radius: 4px; transition: width 0.3s ease;"></div>
      </div>
    </div>
    
    <!-- Alertas meteorolÃ³gicas -->
    ${displayWeatherAlerts(alerts, recommendations)}
    
    <!-- Recomendaciones energÃ©ticas -->
    ${energyTips.length > 0 ? `
      <div style="margin-top: 15px;">
        <h4 style="color: #2c3e50; margin-bottom: 10px; font-size: 1.1rem;">âš¡ Recomendaciones EnergÃ©ticas</h4>
        <div style="background: rgba(108, 117, 125, 0.1); padding: 12px; border-radius: 8px; border: 2px solid rgba(108, 117, 125, 0.2);">
          ${energyTips.map(tip => `
            <div style="font-size: 0.85rem; margin-bottom: 6px; display: flex; align-items: flex-start; gap: 6px; color: #2c3e50;">
              <span style="margin-top: 1px;">â€¢</span>
              <span>${tip}</span>
            </div>
          `).join('')}
        </div>
      </div>
    ` : ''}
    
    <!-- Footer con Ãºltima actualizaciÃ³n -->
    <div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(108, 117, 125, 0.2);">
      <div style="font-size: 0.85rem; opacity: 0.8; color: #6c757d;">
        ğŸ•’ Actualizado: ${new Date().toLocaleTimeString('es-ES')} | 
        ğŸ”„ PrÃ³xima actualizaciÃ³n en 10 min
      </div>
    </div>
    
  </div>
`;
}

// FunciÃ³n auxiliar para obtener iconos meteorolÃ³gicos
function getWeatherIcon(description) {
  const desc = description.toLowerCase();
  if (desc.includes('despejado') || desc.includes('claro')) return 'â˜€ï¸';
  if (desc.includes('nube')) return 'â˜ï¸';
  if (desc.includes('lluvia')) return 'ğŸŒ§ï¸';
  if (desc.includes('tormenta')) return 'â›ˆï¸';
  if (desc.includes('nieve')) return 'â„ï¸';
  if (desc.includes('niebla')) return 'ğŸŒ«ï¸';
  return 'ğŸŒ¤ï¸';
}

// FunciÃ³n para calcular sensaciÃ³n tÃ©rmica
function getThermalSensation(temp, humidity) {
  if (temp >= 35) return 'ğŸ”¥ Muy caluroso';
  if (temp >= 30) return 'ğŸŒ¡ï¸ Caluroso';
  if (temp >= 25) return 'ğŸ˜Š Agradable';
  if (temp >= 20) return 'ğŸ™‚ Templado';
  if (temp >= 15) return 'ğŸ˜ Fresco';
  if (temp >= 10) return 'ğŸ¥¶ FrÃ­o';
  return 'â„ï¸ Muy frÃ­o';
}

// FunciÃ³n para color de la barra tÃ©rmica
function getThermalColor(temp) {
  if (temp >= 35) return '#ff4757';
  if (temp >= 30) return '#ff6b35';
  if (temp >= 25) return '#ffa502';
  if (temp >= 20) return '#2ed573';
  if (temp >= 15) return '#70a1ff';
  return '#5352ed';
}

// ===== SISTEMA DE ALERTAS METEOROLÃ“GICAS =====
function generateWeatherAlerts(current, forecast) {
  const alerts = [];
  const recommendations = [];
  
  // Alerta por temperatura extrema
  if (current.temp >= 35) {
    alerts.push({
      type: 'danger',
      icon: 'ğŸ”¥',
      title: 'Alerta por Calor Extremo',
      message: `Temperatura muy alta: ${current.temp}Â°C`
    });
    recommendations.push('ğŸ’§ Mantente hidratado - bebe agua frecuentemente');
    recommendations.push('ğŸ  Evita actividades al aire libre entre 12:00 y 17:00');
    recommendations.push('â„ï¸ Usa el aire acondicionado en las horas mÃ¡s baratas de electricidad');
    recommendations.push('ğŸ‘• Usa ropa ligera y de colores claros');
  } else if (current.temp >= 30) {
    alerts.push({
      type: 'warning',
      icon: 'ğŸŒ¡ï¸',
      title: 'Temperatura Alta',
      message: `DÃ­a caluroso: ${current.temp}Â°C`
    });
    recommendations.push('ğŸ’§ Mantente hidratado');
    recommendations.push('ğŸŒ‚ Busca sombra si estÃ¡s al aire libre');
    recommendations.push('â„ï¸ Considera usar ventilaciÃ³n o aire acondicionado');
  }
  
  // Alerta por frÃ­o extremo
  if (current.temp <= 5) {
    alerts.push({
      type: 'danger',
      icon: 'â„ï¸',
      title: 'Alerta por FrÃ­o Extremo',
      message: `Temperatura muy baja: ${current.temp}Â°C`
    });
    recommendations.push('ğŸ§¥ AbrÃ­gate bien antes de salir');
    recommendations.push('ğŸ”¥ Usa calefacciÃ³n - revisa las tarifas elÃ©ctricas mÃ¡s baratas');
    recommendations.push('ğŸš— PrecauciÃ³n al conducir - posible hielo en carreteras');
  } else if (current.temp <= 10) {
    alerts.push({
      type: 'warning',
      icon: 'ğŸ¥¶',
      title: 'Temperatura Baja',
      message: `DÃ­a frÃ­o: ${current.temp}Â°C`
    });
    recommendations.push('ğŸ§¥ VÃ­stete con ropa de abrigo');
    recommendations.push('ğŸ”¥ Considera usar calefacciÃ³n');
  }
  
  // Alerta por lluvia
  if (current.precipitation >= 70) {
    alerts.push({
      type: 'warning',
      icon: 'ğŸŒ§ï¸',
      title: 'Alta Probabilidad de Lluvia',
      message: `${current.precipitation}% de probabilidad`
    });
    recommendations.push('â˜‚ï¸ Lleva paraguas o impermeable');
    recommendations.push('ğŸš— Conduce con precauciÃ³n');
    recommendations.push('ğŸ‘• Evita tender ropa al aire libre');
    recommendations.push('ğŸ  Cierra ventanas si hay viento');
  } else if (current.precipitation >= 40) {
    alerts.push({
      type: 'info',
      icon: 'ğŸŒ¦ï¸',
      title: 'Posible Lluvia',
      message: `${current.precipitation}% de probabilidad`
    });
    recommendations.push('â˜‚ï¸ Ten un paraguas a mano');
  }
  
  // Alerta por humedad
  if (current.humidity >= 80) {
    alerts.push({
      type: 'info',
      icon: 'ğŸ’§',
      title: 'Alta Humedad',
      message: `Humedad: ${current.humidity}%`
    });
    recommendations.push('ğŸŒ¬ï¸ Ventila tu hogar para reducir la humedad');
    recommendations.push('ğŸ‘• La ropa tardarÃ¡ mÃ¡s en secarse');
    if (current.temp >= 25) {
      recommendations.push('â„ï¸ La sensaciÃ³n tÃ©rmica serÃ¡ mayor - usa aire acondicionado');
    }
  }
  
  // Recomendaciones energÃ©ticas basadas en el clima
  if (current.temp >= 30 || current.temp <= 10) {
    recommendations.push('âš¡ Revisa los precios de electricidad para usar calefacciÃ³n/aire acondicionado en horas baratas');
  }
  
  // Recomendaciones para actividades
  if (current.temp >= 20 && current.temp <= 28 && current.precipitation <= 20) {
    recommendations.push('ğŸš´ Buen dÃ­a para actividades al aire libre');
    recommendations.push('ğŸ‘• Ideal para tender ropa');
  }
  
  return { alerts, recommendations };
}

// FunciÃ³n para mostrar alertas en la interfaz
function displayWeatherAlerts(alerts, recommendations) {
  if (alerts.length === 0 && recommendations.length === 0) {
    return '';
  }
  
  let alertsHTML = '';
  
  // Mostrar alertas
  if (alerts.length > 0) {
    alertsHTML += `
      <div style="margin-top: 20px;">
        <h4 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.1rem;">ğŸš¨ Alertas MeteorolÃ³gicas</h4>
    `;
    
    alerts.forEach(alert => {
      const bgColor = getAlertColor(alert.type);
      const textColor = getAlertTextColor(alert.type);
      alertsHTML += `
        <div style="background: ${bgColor}; padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 2px solid ${getAlertBorderColor(alert.type)};">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 1.2rem;">${alert.icon}</span>
            <div>
              <div style="font-weight: bold; font-size: 0.9rem; color: ${textColor};">${alert.title}</div>
              <div style="font-size: 0.85rem; color: ${textColor}; opacity: 0.9;">${alert.message}</div>
            </div>
          </div>
        </div>
      `;
    });
    
    alertsHTML += '</div>';
  }
  
  // Mostrar recomendaciones
  if (recommendations.length > 0) {
    alertsHTML += `
      <div style="margin-top: 15px;">
        <h4 style="color: #2c3e50; margin-bottom: 10px; font-size: 1.1rem;">ğŸ’¡ Recomendaciones</h4>
        <div style="background: rgba(52, 152, 219, 0.1); padding: 12px; border-radius: 8px; border: 2px solid rgba(52, 152, 219, 0.3);">
    `;
    
    recommendations.forEach(rec => {
      alertsHTML += `
        <div style="font-size: 0.85rem; margin-bottom: 6px; display: flex; align-items: flex-start; gap: 6px; color: #2c3e50;">
          <span style="margin-top: 1px; color: #3498db; font-weight: bold;">â€¢</span>
          <span>${rec}</span>
        </div>
      `;
    });
    
    alertsHTML += '</div></div>';
  }
  
  return alertsHTML;
}

// FunciÃ³n auxiliar para colores de alertas
function getAlertColor(type) {
  switch(type) {
    case 'danger': return 'rgba(231, 76, 60, 0.15)';
    case 'warning': return 'rgba(243, 156, 18, 0.15)';
    case 'info': return 'rgba(52, 152, 219, 0.15)';
    default: return 'rgba(108, 117, 125, 0.1)';
  }
}

function getAlertTextColor(type) {
  switch(type) {
    case 'danger': return '#c0392b';
    case 'warning': return '#d68910';
    case 'info': return '#2874a6';
    default: return '#2c3e50';
  }
}

function getAlertBorderColor(type) {
  switch(type) {
    case 'danger': return 'rgba(231, 76, 60, 0.3)';
    case 'warning': return 'rgba(243, 156, 18, 0.3)';
    case 'info': return 'rgba(52, 152, 219, 0.3)';
    default: return 'rgba(108, 117, 125, 0.2)';
  }
}

// FunciÃ³n para recomendaciones energÃ©ticas
function getEnergyRecommendations(current, prices) {
  const energyTips = [];
  const currentHour = new Date().getHours();
  
  if (!prices || prices.length === 0) return energyTips;
  
  const currentPrice = prices[currentHour] || 0.10;
  const minPrice = Math.min(...prices);
  const maxPrice = Math.max(...prices);
  const bestHour = prices.indexOf(minPrice);
  
  // Recomendaciones por temperatura
  if (current.temp >= 30) {
    if (currentPrice > minPrice * 1.5) {
      energyTips.push(`â„ï¸ Aire acondicionado: Espera hasta las ${formatTime(bestHour)}:00 para ahorrar ${((currentPrice - minPrice) * 3).toFixed(2)}â‚¬ por cada 3 kWh`);
    } else {
      energyTips.push(`â„ï¸ Buen momento para usar aire acondicionado - precio elÃ©ctrico favorable`);
    }
    energyTips.push(`ğŸŒ¡ï¸ Configura el A/C a 24-25Â°C para optimizar consumo`);
  }
  
  if (current.temp <= 15) {
    if (currentPrice > minPrice * 1.5) {
      energyTips.push(`ğŸ”¥ CalefacciÃ³n: Mejor esperar hasta las ${formatTime(bestHour)}:00 para ahorrar`);
    } else {
      energyTips.push(`ğŸ”¥ Momento ideal para usar calefacciÃ³n - precio elÃ©ctrico bajo`);
    }
    energyTips.push(`ğŸŒ¡ï¸ Configura calefacciÃ³n a 20-21Â°C para eficiencia Ã³ptima`);
  }
  
  // Recomendaciones por humedad
  if (current.humidity >= 70) {
    energyTips.push(`ğŸŒ¬ï¸ Usa deshumidificador en horas de precio bajo (${formatTime(bestHour)}:00)`);
  }
  
  // Recomendaciones generales
  if (currentPrice >= maxPrice * 0.8) {
    energyTips.push(`âš ï¸ Precio elÃ©ctrico alto - evita electrodomÃ©sticos potentes hasta las ${formatTime(bestHour)}:00`);
  }
  
  return energyTips;
}

// FunciÃ³n para generar datos meteorolÃ³gicos de 24 horas completas
function generateFullDayWeatherData(apiData) {
  const now = new Date();
  const currentHour = now.getHours();
  
  // Generar etiquetas para 24 horas
  const labels = [];
  for (let i = 0; i < 24; i++) {
    labels.push(`${i.toString().padStart(2, '0')}:00`);
  }
  
  const temperatures = new Array(24);
  const humidity = new Array(24);
  const precipitation = new Array(24);
  
  // Obtener temperatura actual real si estÃ¡ disponible
  const currentTemp = apiData.current ? apiData.current.temp : apiData.temperatures[0];
  const currentHumidity = apiData.current ? apiData.current.humidity : apiData.humidity[0];
  const currentPrecip = apiData.current ? apiData.current.precipitation : apiData.precipitation[0];
  
  // Llenar datos de API disponibles (generalmente prÃ³ximas horas)
  const apiHours = apiData.labels ? apiData.labels.length : 8;
  for (let i = 0; i < apiHours && i < 24; i++) {
    const apiHour = (currentHour + i * 3) % 24; // Los datos de API suelen ser cada 3 horas
    if (apiHour < 24) {
      temperatures[apiHour] = apiData.temperatures[i];
      humidity[apiHour] = apiData.humidity[i];
      precipitation[apiHour] = apiData.precipitation[i];
    }
  }
  
  // Establecer temperatura actual en la hora actual
  temperatures[currentHour] = currentTemp;
  humidity[currentHour] = currentHumidity;
  precipitation[currentHour] = currentPrecip;
  
  // Generar datos para horas pasadas (simulaciÃ³n basada en patrones realistas)
  for (let i = 0; i < currentHour; i++) {
    if (temperatures[i] === undefined) {
      // Simular temperaturas pasadas basadas en el patrÃ³n diario
      const hourDifference = currentHour - i;
      let tempVariation = 0;
      
      if (i >= 6 && i <= 12) tempVariation = -2; // MaÃ±ana mÃ¡s fresca
      else if (i >= 13 && i <= 16) tempVariation = 3; // Tarde mÃ¡s calurosa
      else if (i >= 17 && i <= 20) tempVariation = 1; // Atardecer
      else tempVariation = -4; // Noche mÃ¡s frÃ­a
      
      temperatures[i] = Math.round(currentTemp + tempVariation + (Math.random() - 0.5) * 2);
    }
    
    if (humidity[i] === undefined) {
      // Humedad tÃ­picamente mÃ¡s alta por la noche/madrugada
      const humidityVariation = (i >= 22 || i <= 6) ? 15 : -10;
      humidity[i] = Math.round(Math.max(30, Math.min(90, currentHumidity + humidityVariation + (Math.random() - 0.5) * 10)));
    }
    
    if (precipitation[i] === undefined) {
      // Precipitaciones generalmente mÃ¡s probables por la tarde/noche
      const precipVariation = (i >= 15 && i <= 21) ? 5 : -2;
      precipitation[i] = Math.round(Math.max(0, currentPrecip + precipVariation + (Math.random() - 0.5) * 5));
    }
  }
  
  // Generar datos para horas futuras si no estÃ¡n disponibles
  for (let i = currentHour + 1; i < 24; i++) {
    if (temperatures[i] === undefined) {
      // ProyecciÃ³n basada en tendencias tÃ­picas
      const hoursAhead = i - currentHour;
      let tempTrend = 0;
      
      if (currentHour < 14 && i <= 16) tempTrend = 2; // Calentamiento diurno
      else if (currentHour >= 16 && i >= 18) tempTrend = -3; // Enfriamiento nocturno
      else tempTrend = -1; // Tendencia general de enfriamiento
      
      temperatures[i] = Math.round(currentTemp + tempTrend + (Math.random() - 0.5) * 2);
    }
    
    if (humidity[i] === undefined) {
      const humidityTrend = (i >= 20 || i <= 6) ? 10 : -5; // Sube por la noche
      humidity[i] = Math.round(Math.max(30, Math.min(90, currentHumidity + humidityTrend + (Math.random() - 0.5) * 8)));
    }
    
    if (precipitation[i] === undefined) {
      precipitation[i] = Math.round(Math.max(0, currentPrecip + (Math.random() - 0.5) * 5));
    }
  }
  
  return {
    labels,
    temperatures,
    humidity,
    precipitation,
    currentHour
  };
}

function renderWeatherChart(ctx, data) {
  if (weatherChart) {
    weatherChart.destroy();
  }

  // Generar datos para 24 horas completas
  const fullDayData = generateFullDayWeatherData(data);
  const currentHour = new Date().getHours();
  
  // Separar datos en pasado y futuro
  const pastTemperatures = [];
  const futureTemperatures = [];
  const pastHumidity = [];
  const futureHumidity = [];
  const pastPrecipitation = [];
  const futurePrecipitation = [];
  
  fullDayData.labels.forEach((label, index) => {
    const hour = parseInt(label.split(':')[0]);
    
    if (hour <= currentHour) {
      pastTemperatures.push(fullDayData.temperatures[index]);
      futureTemperatures.push(null);
      pastHumidity.push(fullDayData.humidity[index]);
      futureHumidity.push(null);
      pastPrecipitation.push(fullDayData.precipitation[index]);
      futurePrecipitation.push(null);
    } else {
      pastTemperatures.push(null);
      futureTemperatures.push(fullDayData.temperatures[index]);
      pastHumidity.push(null);
      futureHumidity.push(fullDayData.humidity[index]);
      pastPrecipitation.push(null);
      futurePrecipitation.push(fullDayData.precipitation[index]);
    }
  });

  const datasets = [
    // Temperaturas pasadas (registradas)
    {
      label: "Temperatura Registrada (Â°C)",
      data: pastTemperatures,
      borderColor: "#2c3e50",
      backgroundColor: "rgba(44, 62, 80, 0.1)",
      fill: false,
      tension: 0.3,
      hidden: false,
      borderWidth: 3,
      pointBackgroundColor: "#2c3e50",
      pointBorderColor: "#ffffff",
      pointBorderWidth: 2,
      pointRadius: 4
    },
    // Temperaturas futuras (previstas)
    {
      label: "Temperatura Prevista (Â°C)",
      data: futureTemperatures,
      borderColor: "#3498db",
      backgroundColor: "rgba(52, 152, 219, 0.1)",
      fill: false,
      tension: 0.3,
      hidden: false,
      borderWidth: 2,
      borderDash: [5, 5],
      pointBackgroundColor: "#3498db",
      pointBorderColor: "#ffffff",
      pointBorderWidth: 2,
      pointRadius: 3
    },
    // Humedad pasada
    {
      label: "Humedad Registrada (%)",
      data: pastHumidity,
      borderColor: "#27ae60",
      backgroundColor: "rgba(39, 174, 96, 0.1)",
      fill: false,
      tension: 0.3,
      hidden: true,
      borderWidth: 3,
      pointBackgroundColor: "#27ae60",
      pointRadius: 3
    },
    // Humedad futura
    {
      label: "Humedad Prevista (%)",
      data: futureHumidity,
      borderColor: "#2ecc71",
      backgroundColor: "rgba(46, 204, 113, 0.1)",
      fill: false,
      tension: 0.3,
      hidden: true,
      borderWidth: 2,
      borderDash: [5, 5],
      pointBackgroundColor: "#2ecc71",
      pointRadius: 2
    },
    // Precipitaciones pasadas
    {
      label: "Precipitaciones Registradas (%)",
      data: pastPrecipitation,
      borderColor: "#e74c3c",
      backgroundColor: "rgba(231, 76, 60, 0.1)",
      fill: false,
      tension: 0.3,
      hidden: true,
      borderWidth: 3,
      pointBackgroundColor: "#e74c3c",
      pointRadius: 3
    },
    // Precipitaciones futuras
    {
      label: "Precipitaciones Previstas (%)",
      data: futurePrecipitation,
      borderColor: "#c0392b",
      backgroundColor: "rgba(192, 57, 43, 0.1)",
      fill: false,
      tension: 0.3,
      hidden: true,
      borderWidth: 2,
      borderDash: [5, 5],
      pointBackgroundColor: "#c0392b",
      pointRadius: 2
    }
  ];

  weatherChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: fullDayData.labels,
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          title: {
            display: true,
            text: "Hora del DÃ­a (24h)"
          },
          grid: {
            display: true,
            color: 'rgba(0,0,0,0.1)'
          }
        },
        y: {
          beginAtZero: true,
          max: 100,
          title: {
            display: true,
            text: "Valores"
          },
          grid: {
            display: true,
            color: 'rgba(0,0,0,0.1)'
          }
        }
      },
      plugins: {
        legend: { 
          display: true,
          position: 'top'
        },
        annotation: {
          annotations: {
            currentTime: {
              type: 'line',
              mode: 'vertical',
              scaleID: 'x',
              value: currentHour,
              borderColor: '#f39c12',
              borderWidth: 3,
              borderDash: [3, 3],
              label: {
                enabled: true,
                content: `Ahora (${currentHour}:${new Date().getMinutes().toString().padStart(2, '0')})`,
                position: 'top'
              }
            }
          }
        }
      },
      elements: {
        point: {
          hoverRadius: 6
        }
      },
      interaction: {
        intersect: false,
        mode: 'index'
      }
    }
  });
}

function setupWeatherControls() {
  const controlIds = ['temp-checkbox', 'humidity-checkbox', 'precipitation-checkbox'];
  const labelIds = ['temp-label', 'humidity-label', 'precipitation-label'];

  function updateVisibility(activeMetric) {
    if (!weatherChart) return;
    
    // Tenemos 6 datasets: [0,1] temperatura, [2,3] humedad, [4,5] precipitaciones
    // Cada par representa: [registrado, previsto]
    
    for (let i = 0; i < 6; i++) {
      const datasetMeta = weatherChart.getDatasetMeta(i);
      if (datasetMeta) {
        switch (activeMetric) {
          case 0: // Temperatura
            datasetMeta.hidden = !(i === 0 || i === 1); // Mostrar solo temperatura registrada y prevista
            break;
          case 1: // Humedad
            datasetMeta.hidden = !(i === 2 || i === 3); // Mostrar solo humedad registrada y prevista
            break;
          case 2: // Precipitaciones
            datasetMeta.hidden = !(i === 4 || i === 5); // Mostrar solo precipitaciones registradas y previstas
            break;
          default:
            datasetMeta.hidden = true;
        }
      }
    }
    
    // Actualizar etiquetas de los controles
    labelIds.forEach((labelId, index) => {
      const label = document.getElementById(labelId);
      if (label) {
        if (index === activeMetric) {
          label.classList.add('active');
        } else {
          label.classList.remove('active');
        }
      }
    });
    
    weatherChart.update();
  }

  // Configurar event listeners para los checkboxes
  controlIds.forEach((id, index) => {
    const checkbox = document.getElementById(id);
    if (checkbox) {
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          // Desmarcar otros checkboxes
          controlIds.forEach((otherId, otherIndex) => {
            if (otherIndex !== index) {
              const otherCheckbox = document.getElementById(otherId);
              if (otherCheckbox) otherCheckbox.checked = false;
            }
          });
          updateVisibility(index);
        } else {
          // Si se desmarca, mostrar temperatura por defecto
          updateVisibility(0);
          const tempCheckbox = document.getElementById('temp-checkbox');
          if (tempCheckbox) tempCheckbox.checked = true;
        }
      });
    }
  });

  // Inicializar con temperatura visible por defecto
  setTimeout(() => {
    const tempCheckbox = document.getElementById('temp-checkbox');
    if (tempCheckbox) {
      tempCheckbox.checked = true;
      updateVisibility(0);
    }
  }, 100);
}

// ===== MAP FUNCTIONALITY RESTRINGIDO A ESPAÃ‘A =====
let currentLocation = {
  name: 'Madrid',
  lat: 40.4168,
  lon: -3.7038,
  country: 'EspaÃ±a',
  detected: false // Indica si la ubicaciÃ³n fue detectada automÃ¡ticamente
};

// LÃ­mites geogrÃ¡ficos de EspaÃ±a (incluyendo islas)
const SPAIN_BOUNDS = {
  north: 43.8,    // Galicia/PaÃ­s Vasco
  south: 27.6,    // Islas Canarias  
  east: 4.3,      // CataluÃ±a/Baleares
  west: -18.2     // Islas Canarias (El Hierro)
};

// ===== GEOLOCATION FUNCTIONALITY =====
async function detectUserLocation() {
  console.log('ğŸŒ Intentando detectar ubicaciÃ³n del usuario...');
  
  return new Promise((resolve) => {
    // Verificar si el navegador soporta geolocalizaciÃ³n
    if (!navigator.geolocation) {
      console.log('âŒ GeolocalizaciÃ³n no soportada por el navegador');
      resolve(null);
      return;
    }

    // ConfiguraciÃ³n de geolocalizaciÃ³n
    const options = {
      enableHighAccuracy: true,
      timeout: 10000, // 10 segundos mÃ¡ximo
      maximumAge: 300000 // 5 minutos de cachÃ©
    };

    navigator.geolocation.getCurrentPosition(
      async (position) => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        
        console.log(`ğŸ“ UbicaciÃ³n detectada: ${lat}, ${lon}`);
        
        // Verificar si estÃ¡ en EspaÃ±a
        if (isWithinSpain(lat, lon)) {
          try {
            // Obtener informaciÃ³n de la ubicaciÃ³n
            const locationInfo = await getLocationInfo(lat, lon);
            if (locationInfo && locationInfo.name) {
              console.log(`âœ… UbicaciÃ³n espaÃ±ola detectada: ${locationInfo.name}`);
              resolve({
                name: locationInfo.name,
                lat: lat,
                lon: lon,
                country: 'EspaÃ±a',
                detected: true
              });
              return;
            }
          } catch (error) {
            console.log('âŒ Error obteniendo informaciÃ³n de ubicaciÃ³n:', error);
          }
        } else {
          console.log('âš ï¸ UbicaciÃ³n detectada fuera de EspaÃ±a, usando Madrid por defecto');
        }
        
        // Si no estÃ¡ en EspaÃ±a o hay error, usar Madrid
        resolve(null);
      },
      (error) => {
        console.log('âŒ Error de geolocalizaciÃ³n:', error.message);
        resolve(null);
      },
      options
    );
  });
}

// FunciÃ³n para observar cuando el mapa es visible y mostrar popup
function setupMapVisibilityObserver(marker) {
  const mapElement = document.getElementById('map');
  if (!mapElement) return;

  // Crear Intersection Observer
  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        // El mapa es visible, abrir popup del marcador
        setTimeout(() => {
          if (marker && marker.openPopup) {
            marker.openPopup();
            console.log('ğŸ“ Popup del mapa mostrado al llegar a la secciÃ³n');
          }
        }, 500); // PequeÃ±o delay para que la animaciÃ³n de scroll termine
        
        // Desconectar el observer despuÃ©s de mostrar el popup una vez
        observer.disconnect();
      }
    });
  }, {
    threshold: 0.3, // Activar cuando el 30% del mapa sea visible
    rootMargin: '-50px' // Margen para activar un poco antes
  });

  // Comenzar a observar el elemento del mapa
  observer.observe(mapElement);
}

// FunciÃ³n para mostrar popup solo si el mapa es visible o es acciÃ³n de usuario
function showPopupIfMapVisible(marker, isUserAction = false) {
  if (!marker || !marker.openPopup) return;
  
  const mapElement = document.getElementById('map');
  if (!mapElement) return;

  // Si es acciÃ³n del usuario (doble click, bÃºsqueda), mostrar inmediatamente
  if (isUserAction) {
    marker.openPopup();
    console.log('ğŸ“ Popup mostrado por acciÃ³n del usuario');
    return;
  }

  // Verificar si el mapa estÃ¡ visible en el viewport
  const rect = mapElement.getBoundingClientRect();
  const isVisible = rect.top < window.innerHeight && rect.bottom > 0;
  
  if (isVisible) {
    setTimeout(() => {
      marker.openPopup();
      console.log('ğŸ“ Popup mostrado - mapa visible');
    }, 500);
  } else {
    // Configurar observer para mostrar cuando sea visible
    setupMapVisibilityObserver(marker);
  }
}

async function initializeMap() {
  if (map) {
    map.remove();
  }

  // Intentar detectar ubicaciÃ³n del usuario primero
  const detectedLocation = await detectUserLocation();
  if (detectedLocation) {
    currentLocation = detectedLocation;
    console.log(`ğŸ¯ Usando ubicaciÃ³n detectada: ${currentLocation.name}`);
    updateLocationInfo(); // Actualizar la informaciÃ³n en el banner
  } else {
    console.log(`ğŸ  Usando ubicaciÃ³n por defecto: Madrid`);
    currentLocation.detected = false;
    updateLocationInfo(); // Actualizar la informaciÃ³n en el banner
  }

  // Centrar mapa en EspaÃ±a
  map = L.map('map').setView([39.5, -4.0], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors',
    maxZoom: 18
  }).addTo(map);

  // Marcador en la ubicaciÃ³n actual (detectada o por defecto)
  let currentMarker = L.marker([currentLocation.lat, currentLocation.lon])
    .addTo(map)
    .bindPopup(`ğŸ“ ${currentLocation.name}, ${currentLocation.country}`);

  // Si se detectÃ³ ubicaciÃ³n, centrar el mapa en ella
  if (currentLocation.detected) {
    map.setView([currentLocation.lat, currentLocation.lon], 10);
  }

  // Mostrar popup solo cuando el mapa sea visible
  showPopupIfMapVisible(currentMarker, false);

  // Dibujar los lÃ­mites de EspaÃ±a como referencia visual
  drawSpainBounds();

  // Variables para manejar clicks simples vs dobles
  let clickTimer = null;
  let clickDelay = 300; // ms para distinguir entre click simple y doble

  // Event listener para clicks simples en el mapa (SOLO MOSTRAR INFORMACIÃ“N)
  map.on('click', function(e) {
    // Cancelar si hay un timer de doble click activo
    if (clickTimer) {
      return;
    }
    
    clickTimer = setTimeout(async () => {
      try {
        console.log('ğŸ–±ï¸ Click simple en mapa:', e.latlng);
        
        // Verificar si estÃ¡ dentro de EspaÃ±a
        if (!isWithinSpain(e.latlng.lat, e.latlng.lng)) {
          showLocationPreview(e.latlng, null, false);
          return;
        }
        
        // Mostrar preview de la ubicaciÃ³n sin cambiar datos
        const locationInfo = await getLocationInfo(e.latlng.lat, e.latlng.lng);
        showLocationPreview(e.latlng, locationInfo, true);
        
      } catch (error) {
        console.error('âŒ Error en preview de ubicaciÃ³n:', error);
        showLocationPreview(e.latlng, null, false);
      } finally {
        clickTimer = null;
      }
    }, clickDelay);
  });

  // Event listener para DOBLE CLICK (SELECCIONAR UBICACIÃ“N)
  map.on('dblclick', async function(e) {
    // Cancelar el timer de click simple
    if (clickTimer) {
      clearTimeout(clickTimer);
      clickTimer = null;
    }

    try {
      console.log('ğŸ–±ï¸ğŸ–±ï¸ Doble click en mapa - Seleccionando ubicaciÃ³n:', e.latlng);
      
      // Mostrar loading inmediatamente
      const weatherElement = document.getElementById("weather");
      showLoading("weather");
      
      // Verificar si estÃ¡ dentro de EspaÃ±a
      if (!isWithinSpain(e.latlng.lat, e.latlng.lng)) {
        hideLoading("weather");
        showSpainOnlyAlert();
        return;
      }
      
      // Obtener informaciÃ³n de la ubicaciÃ³n
      const locationInfo = await getLocationInfo(e.latlng.lat, e.latlng.lng);
      
      // Verificar que la ubicaciÃ³n estÃ© en EspaÃ±a
      if (locationInfo && isLocationInSpain(locationInfo)) {
        // Actualizar ubicaciÃ³n actual
        currentLocation = {
          name: locationInfo.name,
          lat: e.latlng.lat,
          lon: e.latlng.lng,
          country: 'EspaÃ±a',
          detected: false // Marcada como seleccionada manualmente
        };
        
        // Actualizar informaciÃ³n de ubicaciÃ³n en el banner
        updateLocationInfo();
        
        // Remover marcador anterior
        if (currentMarker) {
          map.removeLayer(currentMarker);
        }
        
        // AÃ±adir nuevo marcador
        currentMarker = L.marker([e.latlng.lat, e.latlng.lng])
          .addTo(map)
          .bindPopup(`ğŸ“ ${locationInfo.name}, EspaÃ±a`);
        
        // Mostrar popup inmediatamente porque es acciÃ³n del usuario
        showPopupIfMapVisible(currentMarker, true);
        
        // Actualizar toda la informaciÃ³n de la pÃ¡gina
        await updateAllDataForLocation();
        
        // Mostrar confirmaciÃ³n de selecciÃ³n
        showLocationSelectedNotification(locationInfo.name);
        
        console.log('âœ… UbicaciÃ³n espaÃ±ola seleccionada:', currentLocation);
      } else {
        hideLoading("weather");
        showSpainOnlyAlert();
      }
      
    } catch (error) {
      console.error('âŒ Error al seleccionar ubicaciÃ³n:', error);
      hideLoading("weather");
      alert('Error al obtener informaciÃ³n de la ubicaciÃ³n. Intenta con otra ubicaciÃ³n dentro de EspaÃ±a.');
    }
  });

  // Mostrar instrucciones al usuario
  setTimeout(() => {
    showMapInstructions();
  }, 2000);
}

// FunciÃ³n para verificar si estÃ¡ dentro de EspaÃ±a
function isWithinSpain(lat, lon) {
  return (
    lat >= SPAIN_BOUNDS.south && 
    lat <= SPAIN_BOUNDS.north && 
    lon >= SPAIN_BOUNDS.west && 
    lon <= SPAIN_BOUNDS.east
  );
}

// FunciÃ³n para verificar si una ubicaciÃ³n es espaÃ±ola
function isLocationInSpain(locationInfo) {
  const country = locationInfo.country?.toLowerCase() || '';
  const fullData = locationInfo.fullData || {};
  const address = fullData.address || {};
  
  const spanishIdentifiers = [
    'espaÃ±a', 'spain', 'espagne', 'spagna', 
    'es', 'esp', 'spanish', 'espaÃ±ol'
  ];
  
  return spanishIdentifiers.some(identifier => 
    country.includes(identifier) || 
    address.country?.toLowerCase().includes(identifier)
  );
}

// FunciÃ³n para dibujar lÃ­mites de EspaÃ±a
function drawSpainBounds() {
  const spainRectangle = L.rectangle([
    [SPAIN_BOUNDS.south, SPAIN_BOUNDS.west],
    [SPAIN_BOUNDS.north, SPAIN_BOUNDS.east]
  ], {
    color: '#3498db',
    weight: 2,
    opacity: 0.3,
    fillOpacity: 0.05,
    fillColor: '#3498db'
  }).addTo(map);
  
  spainRectangle.bindPopup('ğŸ‡ªğŸ‡¸ Ãrea de cobertura: EspaÃ±a (incluyendo Baleares y Canarias)');
}

// Funciones de preview y notificaciones
function showLocationPreview(latlng, locationInfo, isInSpain) {
  const existingPreview = document.querySelector('.location-preview');
  if (existingPreview) {
    existingPreview.remove();
  }

  const preview = document.createElement('div');
  preview.className = 'location-preview';
  preview.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: ${isInSpain ? 'linear-gradient(45deg, #27ae60, #2ecc71)' : 'linear-gradient(45deg, #e74c3c, #c0392b)'};
    color: white;
    padding: 15px 25px;
    border-radius: 25px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    z-index: 10000;
    font-weight: 600;
    font-size: 0.9rem;
    animation: slideUp 0.3s ease-out;
    max-width: 90%;
    text-align: center;
  `;

  const lat = latlng.lat.toFixed(4);
  const lon = latlng.lng.toFixed(4);

  if (isInSpain && locationInfo) {
    preview.innerHTML = `
      <div>
        <span>ğŸ“ ${locationInfo.name}</span>
        <span style="opacity: 0.8; font-size: 0.8rem;">(${lat}, ${lon})</span>
        <br>
        <span style="font-size: 0.8rem;">ğŸ–±ï¸ğŸ–±ï¸ Doble click para seleccionar</span>
      </div>
    `;
  } else if (isInSpain) {
    preview.innerHTML = `
      <div>
        <span>ğŸ“ UbicaciÃ³n espaÃ±ola</span>
        <span style="opacity: 0.8; font-size: 0.8rem;">(${lat}, ${lon})</span>
        <br>
        <span style="font-size: 0.8rem;">ğŸ–±ï¸ğŸ–±ï¸ Doble click para seleccionar</span>
      </div>
    `;
  } else {
    preview.innerHTML = `
      <div>
        <span>ğŸš« Fuera de EspaÃ±a</span>
        <span style="opacity: 0.8; font-size: 0.8rem;">(${lat}, ${lon})</span>
        <br>
        <span style="font-size: 0.8rem;">Solo ubicaciones espaÃ±olas</span>
      </div>
    `;
  }

  document.body.appendChild(preview);

  setTimeout(() => {
    if (preview.parentNode) {
      preview.style.animation = 'slideDown 0.3s ease-in';
      setTimeout(() => {
        if (preview.parentNode) {
          preview.remove();
        }
      }, 300);
    }
  }, 4000);
}

function showLocationSelectedNotification(cityName) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(45deg, #27ae60, #2ecc71);
    color: white;
    padding: 18px 25px;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    z-index: 10000;
    font-weight: 600;
    animation: slideInRight 0.4s ease-out;
    max-width: 300px;
  `;
  
  notification.innerHTML = `
    <div style="display: flex; align-items: center; gap: 12px;">
      <span style="font-size: 1.5rem;">âœ…</span>
      <div>
        <div style="font-size: 1rem; margin-bottom: 3px;">UbicaciÃ³n seleccionada</div>
        <div style="font-size: 0.85rem; opacity: 0.9;">${cityName}, EspaÃ±a</div>
        <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 3px;">Actualizando datos...</div>
      </div>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentNode) {
      notification.style.animation = 'slideOutRight 0.3s ease-in';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 300);
    }
  }, 4000);
}

function showMapInstructions() {
  const instructions = document.createElement('div');
  instructions.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(52, 73, 94, 0.95);
    color: white;
    padding: 25px 30px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    z-index: 10000;
    text-align: center;
    max-width: 400px;
    animation: fadeInScale 0.5s ease-out;
    backdrop-filter: blur(10px);
  `;
  
  instructions.innerHTML = `
    <div style="font-size: 2rem; margin-bottom: 15px;">ğŸ“</div>
    <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 15px;">Â¿CÃ³mo usar el mapa?</div>
    <div style="font-size: 0.95rem; line-height: 1.6; margin-bottom: 20px;">
      <p style="margin-bottom: 10px;"><strong>ğŸ–±ï¸ Click simple:</strong> Ver informaciÃ³n</p>
      <p style="margin-bottom: 10px;"><strong>ğŸ–±ï¸ğŸ–±ï¸ Doble click:</strong> Seleccionar ubicaciÃ³n</p>
      <p style="margin-bottom: 10px;"><strong>ğŸ” BÃºsqueda:</strong> Ciudad espaÃ±ola</p>
    </div>
    <button onclick="this.parentNode.remove()" style="
      padding: 10px 25px; 
      background: linear-gradient(45deg, #3498db, #2980b9); 
      border: none; 
      border-radius: 8px; 
      color: white; 
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
    ">Â¡Entendido!</button>
  `;
  
  document.body.appendChild(instructions);
  
  setTimeout(() => {
    if (instructions.parentNode) {
      instructions.style.animation = 'fadeOutScale 0.3s ease-in';
      setTimeout(() => {
        if (instructions.parentNode) {
          instructions.remove();
        }
      }, 300);
    }
  }, 8000);
}

function showSpainOnlyAlert() {
  const alert = document.createElement('div');
  alert.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(45deg, #e74c3c, #c0392b);
    color: white;
    padding: 20px 30px;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    z-index: 10000;
    font-weight: 600;
    text-align: center;
    max-width: 400px;
    animation: alertBounce 0.5s ease-out;
  `;
  
  alert.innerHTML = `
    <div style="font-size: 2rem; margin-bottom:  10px;">ğŸ‡ªğŸ‡¸</div>
    <div style="font-size: 1.2rem; margin-bottom: 15px;">Solo EspaÃ±a</div>
    <div style="font-size: 0.95rem; line-height: 1.4;">
      Esta aplicaciÃ³n solo funciona en territorio espaÃ±ol porque los precios 
      elÃ©ctricos son especÃ­ficos del mercado PVPC espaÃ±ol.
    </div>
    <button onclick="this.parentNode.remove()" style="
      margin-top: 15px; 
      padding: 8px 20px; 
      background: rgba(255,255,255,0.2); 
      border: 1px solid white; 
      border-radius: 6px; 
      color: white; 
      cursor: pointer;
      font-weight: 600;
    ">Entendido</button>
  `;
  
  document.body.appendChild(alert);
  
  setTimeout(() => {
    if (alert.parentNode) {
      alert.remove();
    }
  }, 5000);
}

// Funciones de bÃºsqueda y ubicaciÃ³n
async function buscarCiudad() {
  const cityInput = document.getElementById("ciudad");
  const city = cityInput.value.trim();

  if (!city) {
    alert("Por favor, ingresa el nombre de una ciudad espaÃ±ola.");
    return;
  }

  try {
    console.log('ğŸ” Buscando ciudad espaÃ±ola:', city);
    
    showLoading("weather");
    
    const response = await fetch(
      `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(city)},EspaÃ±a&format=json&addressdetails=1&limit=10&accept-language=es&countrycodes=es`
    );
    
    if (!response.ok) {
      throw new Error('Error en bÃºsqueda de ciudad');
    }
    
    const results = await response.json();
    
    if (results.length === 0) {
      alert('No se encontrÃ³ la ciudad en EspaÃ±a. Intenta con:\nâ€¢ Madrid\nâ€¢ Barcelona\nâ€¢ Valencia\nâ€¢ Sevilla\nâ€¢ Bilbao');
      hideLoading("weather");
      return;
    }
    
    let bestResult = null;
    for (const result of results) {
      if (result.address && result.address.country) {
        const country = result.address.country.toLowerCase();
        if (country.includes('espaÃ±a') || country.includes('spain')) {
          bestResult = result;
          break;
        }
      }
    }
    
    if (!bestResult) {
      alert('La ciudad no se encontrÃ³ en territorio espaÃ±ol.');
      hideLoading("weather");
      return;
    }
    
    const lat = parseFloat(bestResult.lat);
    const lon = parseFloat(bestResult.lon);
    
    if (!isWithinSpain(lat, lon)) {
      alert('La ubicaciÃ³n estÃ¡ fuera del territorio espaÃ±ol.');
      hideLoading("weather");
      return;
    }
    
    const address = bestResult.address || {};
    const cityName = address.city || address.town || address.village || 
                     address.municipality || bestResult.display_name.split(',')[0];
    
    currentLocation = {
      name: cityName,
      lat: lat,
      lon: lon,
      country: 'EspaÃ±a',
      detected: false // Marcada como seleccionada manualmente
    };
    
    // Actualizar informaciÃ³n de ubicaciÃ³n en el banner
    updateLocationInfo();
    
    if (map) {
      map.setView([lat, lon], 12);
      
      map.eachLayer(function (layer) {
        if (layer instanceof L.Marker) {
          map.removeLayer(layer);
        }
      });
      
      const marker = L.marker([lat, lon])
        .addTo(map)
        .bindPopup(`ğŸ“ ${cityName}, EspaÃ±a`);
      
      // Mostrar popup inmediatamente porque es acciÃ³n del usuario
      showPopupIfMapVisible(marker, true);
    }
    
    await updateAllDataForLocation();
    
    cityInput.value = "";
    
    console.log('âœ… Ciudad encontrada:', currentLocation);
    
  } catch (error) {
    console.error('âŒ Error en bÃºsqueda:', error);
    hideLoading("weather");
    alert('Error al buscar la ciudad. Verifica que sea una ciudad espaÃ±ola.');
  }
}

async function getLocationInfo(lat, lon) {
  try {
    const response = await fetch(
      `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1&accept-language=es`
    );
    
    if (!response.ok) {
      throw new Error('Error en geocoding');
    }
    
    const data = await response.json();
    
    const address = data.address || {};
    const name = address.city || address.town || address.village || address.municipality || 
                 address.county || address.state || 'UbicaciÃ³n';
    const country = address.country || '';
    
    return { name, country, fullData: data };
    
  } catch (error) {
    console.error('Error en geocoding:', error);
    return null;
  }
}

async function updateAllDataForLocation() {
  try {
    console.log('ğŸ”„ Actualizando datos para:', currentLocation);
    await updateWeatherForLocation();
  } catch (error) {
    console.error('âŒ Error actualizando datos:', error);
    hideLoading("weather");
  }
}

async function updateWeatherForLocation() {
  const weatherElement = document.getElementById("weather");
  const weatherCtx = document.getElementById("weather-chart").getContext("2d");

  try {
    const realWeatherData = await fetchWeatherDataForLocation(currentLocation.lat, currentLocation.lon);
    
    updateWeatherDisplay(weatherElement, realWeatherData);
    renderWeatherChart(weatherCtx, realWeatherData);
    setupWeatherControls();
    
    hideLoading("weather");
    
    console.log('âœ… Datos actualizados para:', currentLocation.name);
    
  } catch (error) {
    console.error('âŒ Error obteniendo datos:', error);
    
    const mockWeatherData = generateMockWeatherDataForLocation();
    updateWeatherDisplay(weatherElement, mockWeatherData);
    renderWeatherChart(weatherCtx, mockWeatherData);
    setupWeatherControls();
    
    hideLoading("weather");
    weatherElement.innerHTML += `<br><small style='color: #e74c3c;'>âš ï¸ Usando datos de ejemplo para ${currentLocation.name}</small>`;
  }
}

async function fetchWeatherDataForLocation(lat, lon) {
  const apiKey = '8631fe126bc353af0836dbc76cfac520';
  const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=es&cnt=8`;
  
  console.log(`ğŸŒ¤ï¸ Obteniendo datos para ${currentLocation.name}...`);
  
  const response = await fetch(url);
  
  if (!response.ok) {
    throw new Error(`Error en API: ${response.status}`);
  }
  
  const data = await response.json();
  console.log('âœ… Datos obtenidos para:', currentLocation.name);
  
  const hourlyForecast = data.list;
  
  return {
    labels: hourlyForecast.map(item => {
      const date = new Date(item.dt * 1000);
      return `${date.getHours().toString().padStart(2, '0')}:00`;
    }),
    temperatures: hourlyForecast.map(item => Math.round(item.main.temp)),
    humidity: hourlyForecast.map(item => Math.round(item.main.humidity)),
    precipitation: hourlyForecast.map(item => {
      return Math.round((item.pop || 0) * 100);
    }),
    current: {
      description: hourlyForecast[0].weather[0].description,
      temp: Math.round(hourlyForecast[0].main.temp),
      humidity: Math.round(hourlyForecast[0].main.humidity),
      temp: Math.round(hourlyForecast[0].main.temp),
      humidity: hourlyForecast[0].main.humidity,
      precipitation: Math.round((hourlyForecast[0].pop || 0) * 100),
      city: currentLocation.name
    }
  };
}

function generateMockWeatherDataForLocation() {
  const labels = ['00:00', '03:00', '06:00', '09:00', '12:00', '15:00', '18:00', '21:00'];
  
  const baseTemp = currentLocation.lat > 40 ? 18 : (currentLocation.lat > 35 ? 25 : 30);
  const temperatures = labels.map((_, i) => baseTemp + Math.sin(i * Math.PI / 4) * 8);
  const humidity = [65, 70, 75, 60, 45, 40, 50, 60];
  const precipitation = [10, 15, 20, 5, 0, 0, 5, 10];

  return {
    labels,
    temperatures: temperatures.map(t => Math.round(t)),
    humidity,
    precipitation,
    current: {
      description: 'datos estimados regionales',
      temp: Math.round(baseTemp + 5),
      humidity: 50,
      precipitation: 5,
      city: currentLocation.name
    }
  };
}

// ===== SAVINGS CALCULATOR =====

// FunciÃ³n para actualizar el contexto de la calculadora segÃºn la tarifa seleccionada
function updateCalculatorContext() {
  const tariffElement = document.getElementById('calculator-tariff-type');
  const contextDiv = document.getElementById('calculator-context');
  
  if (!tariffElement || !contextDiv) {
    console.warn('âš ï¸ Elementos de calculadora no encontrados');
    return;
  }
  
  const tariffType = tariffElement.value;
  
  const contexts = {
    'pvpc-discrimination': {
      text: 'â€¢ PerÃ­odos: Valle (00:00-08:00) ~25% mÃ¡s barato, Llano intermedio, Punta (10:00-14:00, 18:00-22:00) ~25% mÃ¡s caro',
      tip: 'MÃ¡ximo ahorro programando electrodomÃ©sticos en madrugada'
    },
    'pvpc-flat': {
      text: 'â€¢ Precio Ãºnico todo el dÃ­a segÃºn mercado oficial â€¢ Sin variaciÃ³n horaria',
      tip: 'No hay optimizaciÃ³n horaria posible, pero precio oficial sin mÃ¡rgenes'
    },
    'fixed': {
      text: 'â€¢ Precio fijo establecido por la comercializadora â€¢ No varÃ­a con el mercado ni horario',
      tip: 'Previsibilidad total, pero sin aprovechar bajadas del mercado'
    },
    'indexed': {
      text: 'â€¢ Precio PVPC oficial + margen fijo de la comercializadora â€¢ Sigue las variaciones del mercado',
      tip: 'Aprovecha horarios valle como PVPC pero con coste adicional'
    },
    'weekend': {
      text: 'â€¢ Precio especial (a menudo gratuito) fines de semana â€¢ Precio normal laborables',
      tip: 'Concentra mÃ¡ximo consumo en sÃ¡bados y domingos'
    }
  };
  
  const context = contexts[tariffType];
  contextDiv.innerHTML = `
    ${context.text}<br>
    <strong style="color: #1565c0;">ğŸ’¡ ${context.tip}</strong>
  `;
}

function calcularAhorro() {
  const consumoInput = document.getElementById("consumo");
  const resultadoDiv = document.getElementById("resultado-ahorro");
  const tariffType = document.getElementById("calculator-tariff-type")?.value || 'pvpc-discrimination';
  
  const consumo = parseFloat(consumoInput.value);
  
  if (isNaN(consumo) || consumo <= 0) {
    alert("Por favor, introduce un consumo vÃ¡lido en kWh.");
    return;
  }

  // Inicializar datos si no estÃ¡n disponibles
  if (globalPrices.length === 0) {
    if (!currentPricesData) {
      initializeDefaultPricesData();
    }
    if (currentPricesData && currentPricesData.hourlyPrices) {
      globalPrices = currentPricesData.hourlyPrices;
    } else {
      resultadoDiv.innerHTML = `
        <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; text-align: center;">
          <p><strong>âŒ No hay datos de precios disponibles</strong></p>
          <p>Presiona "OBTENER PRECIOS REALES" para cargar datos actuales de REE.</p>
        </div>
      `;
      return;
    }
  }

  const currentHour = new Date().getHours();
  let hourlyPrices = [...globalPrices];
  
  // Aplicar modificaciones segÃºn tipo de tarifa
  if (tariffType === 'pvpc-discrimination') {
    // Aplicar factores de discriminaciÃ³n horaria sobre PVPC
    hourlyPrices = hourlyPrices.map((price, hour) => {
      if (hour >= 0 && hour < 8) return price * 0.75; // Valle
      if ((hour >= 10 && hour < 14) || (hour >= 18 && hour < 22)) return price * 1.25; // Punta
      return price; // Llano
    });
  } else if (tariffType === 'fixed') {
    // Tarifa fija - usar promedio
    const avgPrice = globalPrices.reduce((a, b) => a + b, 0) / globalPrices.length;
    hourlyPrices = Array(24).fill(avgPrice * 1.1); // +10% tÃ­pico de tarifas fijas
  } else if (tariffType === 'indexed') {
    // PVPC + margen
    hourlyPrices = hourlyPrices.map(price => price + 0.015); // +1.5 cÃ©ntimos tÃ­pico
  } else if (tariffType === 'weekend') {
    const isWeekend = [0, 6].includes(new Date().getDay());
    if (isWeekend) {
      hourlyPrices = Array(24).fill(0.01); // Casi gratis el fin de semana
    } else {
      hourlyPrices = hourlyPrices.map(price => price * 1.15); // +15% laborables
    }
  }
  // pvpc-flat no necesita modificaciÃ³n

  const currentPrice = hourlyPrices[currentHour];
  const minPrice = Math.min(...hourlyPrices);
  const maxPrice = Math.max(...hourlyPrices);
  const bestHour = hourlyPrices.indexOf(minPrice);
  const worstHour = hourlyPrices.indexOf(maxPrice);

  const currentCost = consumo * currentPrice;
  const bestCost = consumo * minPrice;
  const worstCost = consumo * maxPrice;
  const savings = currentCost - bestCost;
  const maxSavings = worstCost - bestCost;
  const savingsPercentage = ((maxSavings / worstCost) * 100);

  // Obtener nombre de la tarifa para mostrar
  const tariffNames = {
    'pvpc-discrimination': 'PVPC con discriminaciÃ³n horaria',
    'pvpc-flat': 'PVPC sin discriminaciÃ³n',
    'fixed': 'Tarifa fija comercial',
    'indexed': 'Tarifa indexada (PVPC + margen)',
    'weekend': 'Tarifa plana fin de semana'
  };

  resultadoDiv.innerHTML = `
    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 12px; margin-top: 15px;">
      <h4 style="margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 1.5rem;">ğŸ“Š</span>
        <span>AnÃ¡lisis de Ahorro - ${tariffNames[tariffType]}</span>
      </h4>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">Tu consumo</div>
          <div style="font-size: 1.4rem; font-weight: bold;">${consumo} kWh</div>
        </div>
        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">Coste actual (${currentHour.toString().padStart(2,'0')}:00)</div>
          <div style="font-size: 1.4rem; font-weight: bold;">${currentCost.toFixed(3)}â‚¬</div>
        </div>
        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">Mejor momento (${bestHour.toString().padStart(2,'0')}:00)</div>
          <div style="font-size: 1.4rem; font-weight: bold; color: #00ff88;">${bestCost.toFixed(3)}â‚¬</div>
        </div>
        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
          <div style="font-size: 0.9rem; opacity: 0.9;">Ahorro mÃ¡ximo posible</div>
          <div style="font-size: 1.4rem; font-weight: bold; color: #00ff88;">${maxSavings.toFixed(3)}â‚¬ (${savingsPercentage.toFixed(1)}%)</div>
        </div>
      </div>
      
      <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;">
        <h5 style="margin: 0 0 10px 0;">ğŸ’¡ Recomendaciones especÃ­ficas:</h5>
        <ul style="margin: 0; padding-left: 20px; line-height: 1.6;">
          <li><strong>Mejor hora:</strong> ${bestHour.toString().padStart(2,'0')}:00 - ${(bestHour+1).toString().padStart(2,'0')}:00 (${formatPrice(minPrice)} â‚¬/kWh)</li>
          <li><strong>Evitar:</strong> ${worstHour.toString().padStart(2,'0')}:00 - ${(worstHour+1).toString().padStart(2,'0')}:00 (${formatPrice(maxPrice)} â‚¬/kWh)</li>
          <li><strong>Ahorro mensual estimado:</strong> ${(maxSavings * 30).toFixed(2)}â‚¬ (si optimizas siempre)</li>
          <li><strong>Ahorro anual estimado:</strong> ${(maxSavings * 365).toFixed(2)}â‚¬ (potencial mÃ¡ximo)</li>
        </ul>
      </div>
    </div>
  `;
}

// ===== NUEVAS FUNCIONES PARA COMPARACIÃ“N HORARIA DE TARIFAS =====

// ===== NUEVAS FUNCIONES PARA COMPARACIÃ“N HORARIA PRECISA =====

function updateTimeDisplay() {
  // Solo actualiza los campos de visualizaciÃ³n de tiempo, sin ejecutar comparaciones
  const requiredElements = ['start-hour', 'start-minute', 'duration-hours', 'duration-minutes'];
  const missingElements = requiredElements.filter(id => !document.getElementById(id));
  
  if (missingElements.length > 0) {
    console.warn(`âš ï¸ Elementos faltantes para calculadora de tiempo: ${missingElements.join(', ')}`);
    return;
  }
  
  updateEndTimeDisplay();
  updateDurationDisplay();
}

function calculateTimingAndComparison() {
  // FunciÃ³n completa que incluye la comparaciÃ³n de tarifas
  const requiredElements = ['start-hour', 'start-minute', 'duration-hours', 'duration-minutes'];
  const missingElements = requiredElements.filter(id => !document.getElementById(id));
  
  if (missingElements.length > 0) {
    console.warn(`âš ï¸ Elementos faltantes para calculadora de tiempo: ${missingElements.join(', ')}`);
    return;
  }
  
  updateEndTimeDisplay();
  updateDurationDisplay();
  calculatePreciseHourlyComparison();
}

function updateEndTimeDisplay() {
  const startHourElement = document.getElementById('start-hour');
  const startMinuteElement = document.getElementById('start-minute');
  const durationHoursElement = document.getElementById('duration-hours');
  const durationMinutesElement = document.getElementById('duration-minutes');
  const endTimeDisplay = document.getElementById('end-time-display');
  
  // Verificar que todos los elementos existan
  if (!startHourElement || !startMinuteElement || !durationHoursElement || !durationMinutesElement || !endTimeDisplay) {
    console.warn('âš ï¸ Elementos de calculadora de tiempo no encontrados');
    return;
  }
  
  const startHour = parseInt(startHourElement.value);
  const startMinute = parseInt(startMinuteElement.value);
  const durationHours = parseInt(durationHoursElement.value);
  const durationMinutes = parseInt(durationMinutesElement.value);
  
  // Calcular hora de finalizaciÃ³n
  let totalMinutes = (startHour * 60) + startMinute + (durationHours * 60) + durationMinutes;
  
  // Manejar dÃ­as que cruzan medianoche
  const endDay = Math.floor(totalMinutes / (24 * 60));
  totalMinutes = totalMinutes % (24 * 60);
  
  const endHour = Math.floor(totalMinutes / 60);
  const endMinute = totalMinutes % 60;
  
  const endTimeStr = `${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`;
  const dayIndicator = endDay > 0 ? ` (+${endDay} dÃ­a${endDay > 1 ? 's' : ''})` : '';
  
  endTimeDisplay.value = endTimeStr + dayIndicator;
  
  return {
    startHour,
    startMinute,
    endHour,
    endMinute,
    durationHours,
    durationMinutes,
    totalDurationHours: (durationHours * 60 + durationMinutes) / 60,
    crossesDay: endDay > 0
  };
}

function updateDurationDisplay() {
  const durationHoursElement = document.getElementById('duration-hours');
  const durationMinutesElement = document.getElementById('duration-minutes');
  const durationDisplay = document.getElementById('duration-display');
  
  // Verificar que todos los elementos existan
  if (!durationHoursElement || !durationMinutesElement || !durationDisplay) {
    console.warn('âš ï¸ Elementos de duraciÃ³n no encontrados');
    return;
  }
  
  const durationHours = parseInt(durationHoursElement.value);
  const durationMinutes = parseInt(durationMinutesElement.value);
  
  // Formatear duraciÃ³n
  let durationText = '';
  if (durationHours > 0 && durationMinutes > 0) {
    durationText = `${durationHours} hora${durationHours > 1 ? 's' : ''} y ${durationMinutes} minuto${durationMinutes > 1 ? 's' : ''}`;
  } else if (durationHours > 0) {
    durationText = `${durationHours} hora${durationHours > 1 ? 's' : ''}`;
  } else if (durationMinutes > 0) {
    durationText = `${durationMinutes} minuto${durationMinutes > 1 ? 's' : ''}`;
  } else {
    durationText = 'Sin duraciÃ³n';
  }
  
  durationDisplay.value = durationText;
}

function calculatePreciseHourlyComparison() {
  const applianceSelector = document.getElementById('appliance-selector');
  const consumptionInput = document.getElementById('appliance-consumption');
  const resultDiv = document.getElementById('hourly-comparison-result');
  
  const appliance = applianceSelector.value;
  const consumption = parseFloat(consumptionInput.value);
  
  // Obtener tiempos precisos
  const timing = updateEndTimeDisplay();
  
  // Validaciones
  if (!appliance) {
    resultDiv.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <span style="font-size: 3rem;">âš ï¸</span>
        <p>Selecciona un electrodomÃ©stico primero</p>
      </div>
    `;
    return;
  }
  
  if (isNaN(consumption) || consumption <= 0) {
    resultDiv.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <span style="font-size: 3rem;">âš ï¸</span>
        <p>Introduce un consumo vÃ¡lido</p>
      </div>
    `;
    return;
  }
  
  if (timing.totalDurationHours <= 0) {
    resultDiv.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <span style="font-size: 3rem;">âš ï¸</span>
        <p>La duraciÃ³n debe ser mayor a 0</p>
      </div>
    `;
    return;
  }
  
  // Obtener precios PVPC (usar datos globales o generar si no existen)
  let pvpcPrices = [];
  if (globalPrices && globalPrices.length > 0) {
    pvpcPrices = globalPrices;
  } else {
    // Generar precios de respaldo realistas
    for (let hour = 0; hour < 24; hour++) {
      let price = 0.12; // Precio base
      if (hour >= 0 && hour < 8) price *= 0.8;        // Valle
      else if ((hour >= 10 && hour < 14) || (hour >= 18 && hour < 22)) price *= 1.4; // Punta
      else price *= 1.1; // Llano
      pvpcPrices.push(price);
    }
  }
  
  // Calcular consumo total del electrodomÃ©stico
  const totalConsumption = consumption * timing.totalDurationHours;
  
  // Obtener tarifa actual del usuario (de la secciÃ³n del calculador de horarios)
  const companySelector = document.getElementById('hourly-company-selector');
  const tariffSelector = document.getElementById('hourly-tariff-selector');
  const selectedCompany = companySelector ? companySelector.value : 'pvpc';
  const selectedTariff = tariffSelector ? tariffSelector.value : '2.0A';
  
  // Calcular costo real con la tarifa del usuario
  let realCost = calculatePreciseCost(timing, pvpcPrices, consumption, selectedCompany, selectedTariff);
  let userTariffName = 'PVPC 2.0A';
  let userTariffCompany = 'Estado EspaÃ±ol (PVPC)';
  
  // Obtener informaciÃ³n de la tarifa seleccionada
  if (selectedCompany && companySelector && tariffSelector) {
    const selectedCompanyOption = companySelector.options[companySelector.selectedIndex];
    const selectedTariffOption = tariffSelector.options[tariffSelector.selectedIndex];
    if (selectedCompanyOption && selectedTariffOption) {
      userTariffCompany = selectedCompanyOption.textContent;
      userTariffName = selectedTariffOption.textContent;
    }
  }
  
  // Encontrar mejores horarios del dÃ­a
  const hourlyData = pvpcPrices.map((price, hour) => ({ hour, price }));
  hourlyData.sort((a, b) => a.price - b.price);
  const bestHours = hourlyData.slice(0, 3);
  const worstHours = hourlyData.slice(-3);
  
  // Crear objeto con informaciÃ³n completa
  const costAnalysis = {
    realCost: realCost,
    tariffName: userTariffName,
    tariffCompany: userTariffCompany,
    appliance: appliance,
    consumption: consumption,
    timing: timing,
    bestHours: bestHours,
    worstHours: worstHours,
    currentHourPrice: pvpcPrices[timing.startHour] || 0
  };
  
  // Generar resultado visual enfocado en costo real
  displayRealCostAnalysis(costAnalysis);
}

function calculatePreciseCost(timing, pvpcPrices, consumption, companyType, tariffType) {
  let totalCost = 0;
  
  // Calcular el costo minuto a minuto
  const startTotalMinutes = timing.startHour * 60 + timing.startMinute;
  const durationMinutes = timing.durationHours * 60 + timing.durationMinutes;
  
  for (let minute = 0; minute < durationMinutes; minute++) {
    const currentMinute = (startTotalMinutes + minute) % (24 * 60);
    const currentHour = Math.floor(currentMinute / 60);
    
    let hourlyPrice = pvpcPrices[currentHour] || 0;
    let factor = 1.0;
    let margin = 0;
    
    // Aplicar factores y mÃ¡rgenes segÃºn tipo de compaÃ±Ã­a y tarifa
    if (companyType === 'pvpc') {
      // Tarifas PVPC oficiales
      switch (tariffType) {
        case '2.0A':
          factor = 1.0; // Sin discriminaciÃ³n horaria
          break;
        case '2.0DHA':
          if (currentHour >= 0 && currentHour < 8) factor = 0.75;  // Valle
          else if ((currentHour >= 10 && currentHour < 14) || (currentHour >= 18 && currentHour < 22)) factor = 1.25; // Punta
          else factor = 1.0; // Llano
          break;
        case '2.0DHS':
          if (currentHour >= 0 && currentHour < 8) factor = 0.65;  // Supervalle
          else if ((currentHour >= 10 && currentHour < 14) || (currentHour >= 18 && currentHour < 22)) factor = 1.35; // Punta
          else factor = 1.0; // Llano
          break;
      }
    } else if (companyType.includes('-cor')) {
      // Tarifas COR (con pequeÃ±o margen sobre PVPC)
      margin = 0.005; // +0.5 cÃ©ntimos sobre PVPC
      switch (tariffType) {
        case '2.0A':
          factor = 1.0;
          break;
        case '2.0DHA':
          if (currentHour >= 0 && currentHour < 8) factor = 0.75;
          else if ((currentHour >= 10 && currentHour < 14) || (currentHour >= 18 && currentHour < 22)) factor = 1.25;
          else factor = 1.0;
          break;
        case '2.0DHS':
          if (currentHour >= 0 && currentHour < 8) factor = 0.65;
          else if ((currentHour >= 10 && currentHour < 14) || (currentHour >= 18 && currentHour < 22)) factor = 1.35;
          else factor = 1.0;
          break;
      }
    } else {
      // Tarifas de mercado libre
      switch (companyType) {
        case 'iberdrola':
          margin = 0.025; // +2.5 cÃ©ntimos
          break;
        case 'endesa':
          margin = 0.022; // +2.2 cÃ©ntimos
          break;
        case 'naturgy':
          margin = 0.020; // +2.0 cÃ©ntimos
          break;
        case 'repsol':
          margin = 0.018; // +1.8 cÃ©ntimos
          break;
        case 'totalenergies':
          margin = 0.024; // +2.4 cÃ©ntimos
          break;
        case 'holaluz':
          margin = 0.028; // +2.8 cÃ©ntimos (100% renovable)
          break;
        case 'edp':
          margin = 0.021; // +2.1 cÃ©ntimos
          break;
        case 'asenergy':
          margin = 0.019; // +1.9 cÃ©ntimos
          break;
        case 'factorenergia':
          margin = 0.017; // +1.7 cÃ©ntimos
          break;
        case 'lucera':
          margin = 0.016; // +1.6 cÃ©ntimos
          break;
        case 'somenergia':
          margin = 0.015; // +1.5 cÃ©ntimos (cooperativa)
          break;
        case 'octopus':
          margin = 0.014; // +1.4 cÃ©ntimos (competitivo)
          break;
        case 'nexus':
          margin = 0.023; // +2.3 cÃ©ntimos
          break;
        case 'gana':
          margin = 0.016; // +1.6 cÃ©ntimos
          break;
        case 'pepeenergy':
          margin = 0.013; // +1.3 cÃ©ntimos (muy competitivo)
          break;
        case 'curenergia-cor':
          margin = 0.005; // +0.5 cÃ©ntimos (es COR pero se maneja aquÃ­)
          break;
        default:
          margin = 0.020; // +2.0 cÃ©ntimos promedio
          break;
      }
      
      // Aplicar discriminaciÃ³n horaria si corresponde
      switch (tariffType) {
        case 'fija':
          factor = 1.0;
          hourlyPrice = 0.12; // Precio fijo promedio
          margin = 0; // Ya incluido en precio fijo
          break;
        case 'indexada':
          factor = 1.0; // Sigue precios del mercado
          break;
        case '2.0DHA':
          if (currentHour >= 0 && currentHour < 8) factor = 0.75;
          else if ((currentHour >= 10 && currentHour < 14) || (currentHour >= 18 && currentHour < 22)) factor = 1.25;
          else factor = 1.0;
          break;
        case '2.0DHS':
          if (currentHour >= 0 && currentHour < 8) factor = 0.65;
          else if ((currentHour >= 10 && currentHour < 14) || (currentHour >= 18 && currentHour < 22)) factor = 1.35;
          else factor = 1.0;
          break;
      }
    }
    
    // Calcular precio final para este minuto
    const finalPrice = (hourlyPrice * factor) + margin;
    const minuteConsumption = consumption / 60; // kWh por minuto
    totalCost += finalPrice * minuteConsumption;
  }
  
  return totalCost;
}

function displayRealCostAnalysis(analysis) {
  const resultDiv = document.getElementById('hourly-comparison-result');
  
  const cost = analysis.realCost;
  const costInCents = Math.round(cost * 100);
  const costPerKwh = cost / analysis.consumption;
  
  // Determinar si es hora cara o barata
  const currentHourRank = analysis.bestHours.findIndex(h => h.hour === analysis.timing.startHour);
  let hourQuality = '';
  let hourIcon = '';
  let hourColor = '';
  
  if (currentHourRank >= 0 && currentHourRank < 3) {
    hourQuality = 'Hora BARATA';
    hourIcon = 'ğŸŸ¢';
    hourColor = '#27ae60';
  } else if (analysis.worstHours.some(h => h.hour === analysis.timing.startHour)) {
    hourQuality = 'Hora CARA';
    hourIcon = 'ğŸ”´';
    hourColor = '#e74c3c';
  } else {
    hourQuality = 'Hora INTERMEDIA';
    hourIcon = 'ğŸŸ¡';
    hourColor = '#f39c12';
  }
  
  const html = `
    <div style="background: linear-gradient(135deg, ${hourColor}, ${hourColor}dd); color: white; padding: 25px; border-radius: 12px; text-align: center; margin-bottom: 20px;">
      <h3 style="margin: 0 0 15px 0; font-size: 1.6rem;">ğŸ’° Costo Real de tu Consumo</h3>
      <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; margin-bottom: 15px;">
        <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 5px;">${cost.toFixed(4)}â‚¬</div>
        <div style="font-size: 1.1rem; opacity: 0.9;">Por usar ${analysis.appliance || 'el electrodomÃ©stico'}</div>
        <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 5px;">${costInCents} cÃ©ntimos</div>
      </div>
      <div style="font-size: 1.2rem;">
        ${hourIcon} <strong>${hourQuality}</strong> para consumir
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
      <!-- Detalles del uso -->
      <div style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; border-radius: 10px;">
        <h4 style="margin: 0 0 15px 0;">ğŸ“‹ Detalles del Uso</h4>
        <div style="line-height: 1.8;">
          <div style="margin-bottom: 8px;"><strong>âš¡ ElectrodomÃ©stico:</strong><br>${analysis.appliance || 'No especificado'}</div>
          <div style="margin-bottom: 8px;"><strong>ğŸ”‹ Consumo:</strong><br>${analysis.consumption} kWh</div>
          <div style="margin-bottom: 8px;"><strong>â±ï¸ DuraciÃ³n:</strong><br>${analysis.timing.totalDurationHours.toFixed(2)} horas</div>
          <div><strong>ğŸ• Horario:</strong><br>${analysis.timing.startHour.toString().padStart(2, '0')}:${analysis.timing.startMinute.toString().padStart(2, '0')} - ${analysis.timing.endHour.toString().padStart(2, '0')}:${(analysis.timing.endMinute || 0).toString().padStart(2, '0')}</div>
        </div>
      </div>
      
      <!-- Tu tarifa -->
      <div style="background: linear-gradient(135deg, #8e44ad, #9b59b6); color: white; padding: 20px; border-radius: 10px;">
        <h4 style="margin: 0 0 15px 0;">ğŸ’¼ Tu Tarifa</h4>
        <div style="text-align: center;">
          <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 8px;">${analysis.tariffName}</div>
          <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 15px;">${analysis.tariffCompany}</div>
          <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
            <div style="font-size: 1.1rem; font-weight: bold;">${costPerKwh.toFixed(4)}â‚¬/kWh</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">Precio promedio en este horario</div>
          </div>
        </div>
      </div>
    </div>
    
    <div style="background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 25px; border-radius: 12px;">
      <h4 style="margin: 0 0 20px 0; text-align: center;">ğŸ’¡ Recomendaciones para HOY</h4>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <!-- Mejores horas -->
        <div style="background: linear-gradient(135deg, #27ae60, #2ecc71); padding: 18px; border-radius: 10px;">
          <h5 style="margin: 0 0 12px 0; color: white; font-weight: 700;">ğŸŸ¢ Mejores Horas HOY</h5>
          ${analysis.bestHours.map(h => `
            <div style="margin-bottom: 8px; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px;">
              <strong>${h.hour.toString().padStart(2, '0')}:00 - ${(h.hour + 1).toString().padStart(2, '0')}:00</strong>
              <br><span style="font-size: 0.9rem; opacity: 0.9;">${h.price.toFixed(3)}â‚¬/kWh</span>
            </div>
          `).join('')}
          <div style="margin-top: 12px; font-size: 0.9rem; opacity: 0.9; text-align: center;">
            ğŸ’° <strong>Ahorro estimado:</strong> ${((analysis.currentHourPrice - analysis.bestHours[0].price) * analysis.consumption * analysis.timing.totalDurationHours).toFixed(4)}â‚¬
          </div>
        </div>
        
        <!-- Peores horas -->
        <div style="background: linear-gradient(135deg, #e74c3c, #c0392b); padding: 18px; border-radius: 10px;">
          <h5 style="margin: 0 0 12px 0; color: white; font-weight: 700;">ğŸ”´ Evita Estas Horas</h5>
          ${analysis.worstHours.map(h => `
            <div style="margin-bottom: 8px; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px;">
              <strong>${h.hour.toString().padStart(2, '0')}:00 - ${(h.hour + 1).toString().padStart(2, '0')}:00</strong>
              <br><span style="font-size: 0.9rem; opacity: 0.9;">${h.price.toFixed(3)}â‚¬/kWh</span>
            </div>
          `).join('')}
          <div style="margin-top: 12px; font-size: 0.9rem; opacity: 0.9; text-align: center;">
            ğŸ’¸ <strong>Costo extra:</strong> +${((analysis.worstHours[0].price - analysis.currentHourPrice) * analysis.consumption * analysis.timing.totalDurationHours).toFixed(4)}â‚¬
          </div>
        </div>
      </div>
      
      <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
        <div style="font-size: 0.95rem; margin-bottom: 8px;">
          ğŸ’¡ <strong>Consejo del dÃ­a:</strong> 
          ${analysis.bestHours[0].hour < 12 ? 
            `Programa tus electrodomÃ©sticos antes de las ${analysis.bestHours[2].hour + 1}:00 para mÃ¡ximo ahorro.` :
            `Las horas de la madrugada (${analysis.bestHours[0].hour}:00-${analysis.bestHours[2].hour + 1}:00) son las mÃ¡s baratas.`
          }
        </div>
        <div style="font-size: 0.85rem; opacity: 0.8;">
          âš¡ Los precios cambian cada hora segÃºn la demanda nacional de electricidad
        </div>
      </div>
    </div>
  `;
  
  resultDiv.innerHTML = html;
}

function displaySimpleComparison(comparison, timing, appliance, consumption) {
  const resultDiv = document.getElementById('hourly-comparison-result');
  
  const userCost = comparison.userTariff.cost;
  const pvpcCost = comparison.pvpcTariff.cost;
  const difference = comparison.difference;
  const isUserCheaper = difference < 0;
  const absPercentage = Math.abs(comparison.percentageDiff);
  
  const resultColor = isUserCheaper ? '#27ae60' : '#e74c3c';
  const resultIcon = isUserCheaper ? 'ğŸ’š' : 'ğŸ’¸';
  const resultText = isUserCheaper ? 'PAGAS MENOS' : 'PAGAS MÃS';
  
  const html = `
    <div style="background: linear-gradient(135deg, ${resultColor}, ${isUserCheaper ? '#2ecc71' : '#c0392b'}); color: white; padding: 25px; border-radius: 12px; text-align: center; margin-bottom: 20px;">
      <h3 style="margin: 0 0 15px 0; font-size: 1.5rem;">${resultIcon} ${resultText} que el PVPC Oficial</h3>
      <div style="font-size: 1.2rem; margin-bottom: 10px;">
        <strong>${Math.abs(difference).toFixed(4)}â‚¬ ${isUserCheaper ? 'menos' : 'mÃ¡s'}</strong> por este uso especÃ­fico
      </div>
      <div style="font-size: 1rem; opacity: 0.9;">
        (${absPercentage.toFixed(1)}% ${isUserCheaper ? 'de ahorro' : 'mÃ¡s caro'} vs PVPC)
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
      <!-- Tu Tarifa -->
      <div style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; border-radius: 10px; text-align: center;">
        <h4 style="margin: 0 0 10px 0;">ğŸ’¼ Tu Tarifa Actual</h4>
        <div style="font-size: 1.1rem; margin-bottom: 8px;"><strong>${comparison.userTariff.name}</strong></div>
        <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 15px;">${comparison.userTariff.company}</div>
        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
          <div style="font-size: 1.4rem; font-weight: bold;">${userCost.toFixed(4)}â‚¬</div>
          <div style="font-size: 0.9rem; opacity: 0.9;">Por este uso</div>
        </div>
      </div>
      
      <!-- PVPC Oficial -->
      <div style="background: linear-gradient(135deg, #8e44ad, #9b59b6); color: white; padding: 20px; border-radius: 10px; text-align: center;">
        <h4 style="margin: 0 0 10px 0;">ğŸ›ï¸ PVPC Oficial</h4>
        <div style="font-size: 1.1rem; margin-bottom: 8px;"><strong>PVPC 2.0TD</strong></div>
        <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 15px;">Estado EspaÃ±ol (Mayorista)</div>
        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
          <div style="font-size: 1.4rem; font-weight: bold;">${pvpcCost.toFixed(4)}â‚¬</div>
          <div style="font-size: 0.9rem; opacity: 0.9;">Por este uso</div>
        </div>
      </div>
    </div>
    
    <div style="background: linear-gradient(135deg, #34495e, #2c3e50); color: white; padding: 20px; border-radius: 10px;">
      <h4 style="margin: 0 0 15px 0;">ğŸ“Š Detalles del CÃ¡lculo</h4>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div>
          <div style="font-size: 0.9rem; opacity: 0.8;">ElectrodomÃ©stico:</div>
          <div style="font-weight: bold;">${appliance || 'No especificado'}</div>
        </div>
        <div>
          <div style="font-size: 0.9rem; opacity: 0.8;">Consumo:</div>
          <div style="font-weight: bold;">${consumption} kWh</div>
        </div>
        <div>
          <div style="font-size: 0.9rem; opacity: 0.8;">DuraciÃ³n:</div>
          <div style="font-weight: bold;">${timing.totalDurationHours.toFixed(2)} horas</div>
        </div>
        <div>
          <div style="font-size: 0.9rem; opacity: 0.8;">Horario:</div>
          <div style="font-weight: bold;">${timing.startHour.toString().padStart(2, '0')}:${timing.startMinute.toString().padStart(2, '0')} - ${timing.endHour.toString().padStart(2, '0')}:${(timing.endMinute || 0).toString().padStart(2, '0')}</div>
        </div>
      </div>
    </div>
  `;
  
  resultDiv.innerHTML = html;
}

function displayPreciseComparison(tariffComparisons, timing, appliance, consumption) {
  const resultDiv = document.getElementById('hourly-comparison-result');
  
  // Obtener ganadora y calcular ahorros
  const winner = tariffComparisons[0];
  const mostExpensive = tariffComparisons[tariffComparisons.length - 1];
  const maxSavings = mostExpensive.cost - winner.cost;
  const savingsPercentage = (maxSavings / mostExpensive.cost) * 100;
  
  // Generar resultado visual
  const applianceName = document.getElementById('appliance-selector').options[document.getElementById('appliance-selector').selectedIndex].text;
  const startTime = `${timing.startHour.toString().padStart(2, '0')}:${timing.startMinute.toString().padStart(2, '0')}`;
  const endTimeElement = document.getElementById('end-time-display');
  const endTime = endTimeElement ? endTimeElement.value : '00:00';
  const durationText = timing.durationHours > 0 && timing.durationMinutes > 0 
    ? `${timing.durationHours}h ${timing.durationMinutes}m`
    : timing.durationHours > 0 
      ? `${timing.durationHours}h`
      : `${timing.durationMinutes}m`;
  
  let html = `
    <div style="background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px;">
      <div style="text-align: center; margin-bottom: 20px;">
        <h4 style="margin: 0 0 10px 0; font-size: 1.5rem;">ğŸ† TARIFA GANADORA</h4>
        <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px;">
          <div style="font-size: 2rem; margin-bottom: 10px;">${winner.logo}</div>
          <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 5px;">${winner.name}</div>
          <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 15px;">${winner.company}</div>
          <div style="font-size: 2.2rem; font-weight: bold; color: #00ff88;">
            ${winner.cost.toFixed(4)}â‚¬
          </div>
          <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 10px;">
            ${applianceName}<br>
            ${startTime} â†’ ${endTime} (${durationText})<br>
            ${consumption}kWh total en ${timing.totalDurationHours.toFixed(2)}h
          </div>
        </div>
      </div>
      
      <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
        <strong>ğŸ’° Ahorro mÃ¡ximo: ${maxSavings.toFixed(4)}â‚¬ (${savingsPercentage.toFixed(1)}%)</strong><br>
        <span style="opacity: 0.9;">vs la tarifa mÃ¡s cara (${mostExpensive.name}: ${mostExpensive.cost.toFixed(4)}â‚¬)</span>
      </div>
    </div>
    
    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
      <h4 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">ğŸ“Š ComparaciÃ³n Precisa de Tarifas</h4>
      
      <div style="display: grid; gap: 15px;">
  `;
  
  // Mostrar todas las tarifas
  tariffComparisons.forEach((tariff, index) => {
    const isWinner = index === 0;
    const extraCost = tariff.cost - winner.cost;
    const extraPercentage = winner.cost > 0 ? (extraCost / winner.cost) * 100 : 0;
    
    html += `
      <div style="
        background: ${isWinner ? 'linear-gradient(45deg, #e8f5e8, #f0f8ff)' : '#f8f9fa'};
        border: ${isWinner ? '3px solid #27ae60' : '2px solid #dee2e6'};
        border-radius: 12px;
        padding: 20px;
        position: relative;
      ">
        ${isWinner ? '<div style="position: absolute; top: -10px; right: 20px; background: #27ae60; color: white; padding: 5px 15px; border-radius: 15px; font-size: 0.8rem; font-weight: bold;">ğŸ† MEJOR</div>' : ''}
        
        <div style="display: grid; grid-template-columns: auto 1fr auto auto; gap: 15px; align-items: center;">
          <div style="font-size: 2rem;">${tariff.logo}</div>
          
          <div>
            <div style="font-weight: bold; color: #2c3e50; margin-bottom: 5px;">${tariff.name}</div>
            <div style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 3px;">${tariff.company}</div>
            <div style="color: #6c757d; font-size: 0.85rem;">${tariff.description}</div>
          </div>
          
          <div style="text-align: right;">
            <div style="font-size: 1.4rem; font-weight: bold; color: ${isWinner ? '#27ae60' : '#2c3e50'};">
              ${tariff.cost.toFixed(4)}â‚¬
            </div>
            ${!isWinner && extraCost > 0 ? `
              <div style="color: #e74c3c; font-size: 0.9rem; font-weight: 600;">
                +${extraCost.toFixed(4)}â‚¬
              </div>
            ` : ''}
          </div>
          
          <div style="text-align: center; min-width: 60px;">
            ${!isWinner && extraCost > 0 ? `
              <div style="color: #e74c3c; font-size: 0.9rem; font-weight: 600;">
                +${extraPercentage.toFixed(1)}%
              </div>
            ` : isWinner ? `
              <div style="color: #27ae60; font-size: 0.9rem; font-weight: 600;">
                MEJOR
              </div>
            ` : ''}
          </div>
        </div>
      </div>
    `;
  });
  
  html += `
      </div>
    </div>
  `;
  
  resultDiv.innerHTML = html;
}

function updateApplianceConsumption() {
  const selector = document.getElementById('appliance-selector');
  const consumptionInput = document.getElementById('appliance-consumption');
  
  if (!selector || !consumptionInput) {
    console.warn('âš ï¸ Elementos de electrodomÃ©sticos no encontrados');
    return;
  }
  
  if (selector.value && selector.value !== 'personalizado') {
    const selectedOption = selector.options[selector.selectedIndex];
    const consumption = selectedOption.getAttribute('data-consumption');
    if (consumption) {
      consumptionInput.value = consumption;
      // Solo actualizar los campos de tiempo, no ejecutar la comparaciÃ³n completa
      updateTimeDisplay();
    }
  }
}

function updateHourlyTariff() {
  const companySelector = document.getElementById('hourly-company-selector');
  const tariffSelector = document.getElementById('hourly-tariff-selector');
  
  if (!companySelector || !tariffSelector) {
    console.warn('âš ï¸ Selectores de compaÃ±Ã­a/tarifa no encontrados');
    return;
  }
  
  const selectedCompany = companySelector.value;
  
  // Actualizar las opciones de tarifa segÃºn la compaÃ±Ã­a seleccionada
  tariffSelector.innerHTML = '';
  
  if (selectedCompany === 'pvpc') {
    // Tarifas PVPC
    tariffSelector.innerHTML = `
      <option value="2.0A">PVPC 2.0A (Sin discriminaciÃ³n)</option>
      <option value="2.0DHA">PVPC 2.0DHA (DiscriminaciÃ³n horaria)</option>
      <option value="2.0DHS">PVPC 2.0DHS (Supervalle)</option>
    `;
  } else if (selectedCompany.includes('-cor')) {
    // Tarifas COR
    tariffSelector.innerHTML = `
      <option value="2.0A">COR 2.0A (Sin discriminaciÃ³n)</option>
      <option value="2.0DHA">COR 2.0DHA (DiscriminaciÃ³n horaria)</option>
      <option value="2.0DHS">COR 2.0DHS (Supervalle)</option>
    `;
  } else {
    // Tarifas mercado libre
    tariffSelector.innerHTML = `
      <option value="fija">Tarifa Fija</option>
      <option value="indexada">Tarifa Indexada</option>
      <option value="2.0DHA">DiscriminaciÃ³n Horaria (2 perÃ­odos)</option>
      <option value="2.0DHS">DiscriminaciÃ³n Horaria + Supervalle</option>
    `;
  }
}

// ===== FUNCIONES OBSOLETAS (mantenidas para compatibilidad) =====

function updateDurationDisplay() {
  // FunciÃ³n obsoleta - redirigir a la nueva funciÃ³n
  updateEndTimeDisplay();
}

function calculateHourlyComparison() {
  // Esta funciÃ³n estÃ¡ obsoleta y no debe ejecutar comparaciones automÃ¡ticamente
  // Solo actualizar campos de tiempo si es necesario
  console.log('ğŸ”§ FunciÃ³n calculateHourlyComparison() llamada - no ejecutando comparaciÃ³n automÃ¡tica');
}

// ===== SCROLL FUNCTIONALITY =====
function scrollToSection(sectionId) {
  const element = document.getElementById(sectionId);
  if (element) {
    element.scrollIntoView({ 
      behavior: 'smooth',
      block: 'start'
    });
    
    // Efecto visual de highlight
    element.classList.add('scroll-highlight');
    setTimeout(() => {
      element.classList.remove('scroll-highlight');
    }, 2000);
  }
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸš€ DOM cargado');
  console.log('ğŸ“‹ IDs encontrados:', 
    Array.from(document.querySelectorAll('[id]')).map(el => el.id)
  );
  
  // Inicializar estado del cachÃ©
  updateCacheStatus();
  
  initializeClock();
  loadElectricityPrices();
  
  // Inicializar selectores del calculador de horarios
  setTimeout(() => {
    updateHourlyTariff();
  }, 500);
  
  // Fallback: Inicializar comparaciÃ³n despuÃ©s de un delay
  setTimeout(() => {
    console.log('ğŸ”„ Ejecutando updateDailyComparison como fallback...');
    updateDailyComparison();
  }, 3000);
  
  // Debug: Verificar que los selectores estÃ©n disponibles
  setTimeout(() => {
    const companySelector = document.getElementById('user-company-selector');
    const tariffSelector = document.getElementById('user-tariff-selector');
    console.log('ğŸ” Debug selectores:', {
      companySelector: !!companySelector,
      tariffSelector: !!tariffSelector,
      companies: !!SPANISH_ENERGY_COMPANIES
    });
    
    if (companySelector) {
      console.log('âœ… Selector de compaÃ±Ã­as encontrado');
    } else {
      console.error('âŒ Selector de compaÃ±Ã­as NO encontrado');
    }
  }, 1000);
  
  // Configurar event listeners para elementos que siguen en index.html
  // (Ya no hay elementos de meteorologÃ­a aquÃ­)

  const consumoInput = document.getElementById('consumo');
  if (consumoInput) {
    consumoInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        calcularAhorro();
      }
    });
  }
});

// AÃ±adir estilos para animaciones
const style = document.createElement('style');
style.textContent = `
  @keyframes alertBounce {
    0% { 
      transform: translate(-50%, -50%) scale(0.5); 
      opacity: 0; 
    }
    50% { 
      transform: translate(-50%, -50%) scale(1.05); 
    }
    100% { 
      transform: translate(-50%, -50%) scale(1); 
      opacity: 1; 
    }
  }
`;
document.head.appendChild(style);
  </script> <!-- Cierre del script existente -->
</body>
</html>